[{"content":"Number porting can sometimes be a tedious process but Microsoft actually does a really good job with their Porting Wizard in the Microsoft Teams Admin Center (TAC). I recently had to port a lot of numbers from a previous carrier to Microsoft. As you may know, there are two main types for numbers with Calling Plans and Operator Connect: Subscriber and Service numbers. Subscriber numbers can be assigned to users and Service numbers are for use with voice apps (auto attendants and call queues) or dedicated conference bridges. By default, all numbers are created in your tenant as Subscriber numbers but you will be able to change the usage to Service for specific numbers during the port order creation process.\nWhen you\u0026rsquo;re porting hundreds of numbers, it\u0026rsquo;s easy to forget or overlook an important number that should have been labelled as Service but unfortunately, was missed. Once the port order has been submitted, there\u0026rsquo;s no way of changing the usage anymore until the numbers have been fully ported to your tenant. I confirmed this with Microsoft through a PSTN Service Desk support request. At this point, your only two options are to either cancel the port order request and start over or accept that you can only change the usage after the numbers have been ported. Since cancelling and starting over will mean that there will be an unwelcome delay of at least a couple of days, that\u0026rsquo;s not really a viable option in most cases. Today, I\u0026rsquo;m going to show you a very easy workaround how you can make sure that your auto attendant or call queue will still be reachable by their phone number as soon as the port order has completed.\nWorkaround When a number gets created as a Subscriber number, you won\u0026rsquo;t be able to assign it to an auto attendant or a call queue. But you can still create the resource account that\u0026rsquo;s linked to the voice app in advance. All you need to do to ensure that the voice app is reachable via it\u0026rsquo;s phone number is to create a temporary routing rule. To do so, navigate to Voice\\Phone numbers in TAC and switch to Routing rules. Click + Add to create a new rule. Give the rule a name and fill out the description. Then choose Single number and enter your number. Under Routing options choose Voice application and select your auto attendant or call queue from the list. If you already have other rules, set the Evaluation order to a value that\u0026rsquo;s not already in use. If you don\u0026rsquo;t already have other rules with a lower evaluation order and which use regular expressions which could also match your number, it doesn\u0026rsquo;t really matter what you set this value to.\nIt\u0026rsquo;s very important that you don\u0026rsquo;t assign this number to any user. The rule is only effective for unassigned numbers. Usually, it takes a couple of hours until these rules become effective but if you do it at least one day before the porting date, you should be fine. Of course you could also set up a temporary user and forward all calls to that user to your voice app but that requires more work and more importantly a paid license.\nIf somebody calls that number before you were able to change the usage to Service and assign it to the voice app, the calls will show as unassigned_in in the PSTN usage report in TAC. However, the calls will be routed to the voice app you specified in your routing rule without any issues. Service numbers can receive a lot more concurrent calls than subscriber numbers can. However, I made some tests and was able to establish 10 concurrent calls to a call queue where each call was routed through an unassigned routing rule.\nIn any case, I recommend to change the usage and assign the number to a resource account as quickly as possible. Using a routing rule is only a temporary workaround.\nOnce the numbers have been ported, you can go to Voice\\Phone numbers in TAC again and search for the number in question. Sometimes you can change the usage directly from TAC. If you don\u0026rsquo;t see that option, create a new support request at the PSTN service desk. They\u0026rsquo;re usually quite fast and will change the usage within a couple of hours after creating the request.\nWhen you receive confirmation from Microsoft that the usage has been changed, you can assign the number to the resource account of the voice app directly and delete the routing rule. As soon as the number is assigned to the resource account, the unassigned routing rule will not match anymore. This little workaround will allow you to keep the downtime to a minimum. In fact, you won\u0026rsquo;t have any downtime except the time it takes your old carrier to switch the routing to Microsoft.\nCaveats The only caveat you have to consider is when you want to use that number as an outgoing caller ID. Since you can\u0026rsquo;t assign it to a resource account before the usage was switched to Service, you won\u0026rsquo;t be able to configure it as caller ID for call queues or to a Caller ID policy. If you can live with the fact that you can\u0026rsquo;t use the number as outgoing caller ID for a couple of hours, there\u0026rsquo;s really no reason to panic and cancel the port request because you forgot to change the usage of some numbers.\nClosing Words To me that was a gentle reminder that mistakes can happen to all of us. But as always, I tried to keep a clear head and look for a solution and most importantly share it with the awesome Teams community so all of you can take advantage of this knowledge as well.\n","date":"2024-02-03T00:00:00Z","permalink":"https://heusser.pro/p/minimize-downtime-when-porting-numbers-to-microsoft-teams-calling-plans-ix1vcwlfjbyr/","title":"Minimize Downtime when Porting Numbers to Microsoft Teams Calling Plans"},{"content":"Not too long ago I wrote this blog post about the ultimate Teams shared voicemail solution. This solution assumed a full blown call flow with on-call coverage and an advanced notification mechanism. Today I\u0026rsquo;m going to show you a simplified but yet optimized version of my Power Automate Flow. While the previous solution works without any issues, it\u0026rsquo;s not really scalable. If you have a lot of queues, you probably don\u0026rsquo;t want to create a dedicated shared mailbox for every queue that needs shared voicemail access via Teams and Adaptive Cards. That just adds unnecessary management overhead to your Teams phone environment.\nI\u0026rsquo;ve got some good news for you. I found a way to do it all without the need of shared mailbox. The flow is now directly triggered by a new email to the Microsoft 365 Group instead of a new email to the shared mailbox. Furthermore, all other mail related actions in the flow have been updated to use the Office 365 Groups Mail connector as well.\nCall Flow Diagram Let\u0026rsquo;s look at the scenario first. This time around, it\u0026rsquo;s a very simple call flow which consists of an auto attendant, a call queue and a Microsoft 365 Group as shared voicemail target.\nFlow Trigger The flow is now triggered by When a new email arrives to a group.\nFlow Actions Using the Office 365 Groups Mail connector is not as straight forward as retrieving an email from a shared mailbox or a normal user mailbox. There are conversations, threads and thread posts. Everything must be queried in the correct order to receive all the data that\u0026rsquo;s needed.\nThis is how it\u0026rsquo;s done.\nBecause this call flow doesn\u0026rsquo;t have an on-call option, the flow uses way less actions. However, there\u0026rsquo;s still a parallel branch needed. Once the Adaptive Card has been posted to the Teams channel, the flow waits for a reply so the messageId of the message containing the Adaptive card is still unknown to the flow. That\u0026rsquo;s where the parallel branch comes into play. It will get the messageId and then the userId of each Team member. Finally, the flow will send a Teams activity feed notification for the new Adaptive Card to each Team member. By using the flow to send the notifications we don\u0026rsquo;t need to worry about users not enabling notifications for all new channel posts. They\u0026rsquo;ll have no excuse if they ever forget to call somebody back.\nResult in Teams This is how the notification looks like for end users in Teams. In case the audio player on the card is not working for whatever reason, I\u0026rsquo;ve also included an additional button called Open MP3 which will open the audio file in Microsoft Stream when it\u0026rsquo;s clicked.\nFinal Notes If you have an on-call option in your call flow but you still want to take advantage of the simplified trigger without the shared mailbox, you can just import both flows into your Power Automate Environment and build a new flow from scratch which combines the best of both worlds. The Microsoft Edge split screen feature and Power Automate\u0026rsquo;s copy/paste feature are a great help for that.\nSummary The initial scenario which included the on-call notification mechanism was designed for a very specific use case. This iteration of my Teams Shared Voicemail solution should fit a lot more customer scenarios. It\u0026rsquo;s easier to understand and implement and also has less moving parts. Feel free to download the basic version of my flow from here and give it a try. Just make sure to replace anything that\u0026rsquo;s specific to my lab tenant with your actual values.\nIf you need help importing the flow, please read this section in the initial article first.\nIf this blog provides additional value to you or your company, I want you to know that you can always show your support by donating on my GitHub Sponsors profile.\n","date":"2024-01-17T19:59:21.988Z","image":"https://heusser.pro/p/teams-shared-voicemail-for-basic-call-flows-1qru2qqlx0ju/cover_hu28492fa5d2bc203e9449ee66080cd141_51573_120x120_fill_box_smart1_3.png","permalink":"https://heusser.pro/p/teams-shared-voicemail-for-basic-call-flows-1qru2qqlx0ju/","title":"Teams Shared Voicemail for Basic Call Flows"},{"content":"In June last year I wrote about handling Teams shared voicemail more efficiently. Although the principle is the same today, a couple of things have changed which has allowed me to build a much more elegant version of this Power Automate flow.\nAbout a year ago, I also wrote about shared voicemail now supporting not just Microsoft 365 groups but also distribution lists and mail enabled security groups. While it‚Äôs great to have more options, that doesn‚Äôt solve the issue at its core.\nMy main complaint about shared voicemail in Teams is that it‚Äôs hard to keep an overview over which voicemails have already been processed (as in the person who left the message has been called back). You either train people to regularly check their Microsoft 365 group inboxes or you enable follow in inbox for all the group\u0026rsquo;s members. Follow in inbox will make sure that no voicemail/email gets lost, but it also means that more communication is required within a team to make sure that the caller is not called back multiple times or not at all (because everybody believes that someone else will call back). My Power Automate Flow solves this issue by delivering the voicemails directly into a Teams channel.\nCall Flow¬†Diagram This is the example scenario. A relatively simple call flow with an auto attendant which routes calls to a call queue during business hours and redirects to a second auto attendant after hours. The second auto attendant offers callers a choice to either leave a message or get connected to the on-call service.\nI purposely used a dedicated auto attendant for the after-hours so it can be re-used if the call flow is extended in the future. You can see that the after-hours call flow of the main auto attendant (PS Test EV Enabled AA) only plays the greeting Welcome to heusser.pro. You‚Äôre calling us outside of our business hours. And PS Test EV Enabled On Call AA does the actual after-hours routing. By splitting the greeting, I could also use the IVR of the second auto attendant for another call queue or for holidays configured on the main auto attendant. This way, I won‚Äôt have to build a new/the same IVR per holiday call handling which saves time and reduces management effort.\nThe second reason I built it like this is that the name of the auto attendant includes the keyword On Call. Because the on-call call queue uses the same naming convention. This means that the email containing the voicemail includes the name of the voice app in which the call was sent to voicemail, which makes it easy to determine if a voicemail was left during business hours or during on-call/after hours.\nShared Voicemail As you can see in the diagram, in every case where a call cannot be answered, it goes to the same shared voicemail group. This Microsoft 365 group is the same group that‚Äôs linked to the Team which also hosts the two voice enabled channels which are linked to the call queues.\nInstead of relying on people either checking the group mailbox for new voicemail messages or subscribing to the group mailbox, we‚Äôre going to build a Power Automate flow to deliver voicemail messages directly into a Teams channel.\nThe first thing we need to do is to create or define a shared mailbox so we can subscribe it to new messages of the M365 group. The flow will only process emails which have attachments, and the attachments name must end with¬†.mp3¬†. But I still strongly recommend to create a dedicated shared mailbox which will only receive emails from the M365 group. To keep things clean, I would also deter from sending any kind of other emails to the M365 group. If you also use a dedicated Team for your call queues, that shouldn‚Äôt be an issue.\nOnce the shared mailbox is created, we need to give the user which will own the Flow full access to it.\nYou will need the PowerShell module ExchangeOnlineManagement and need to run Connect-ExchangeOnline before you can run these commands.\n# Create shared mailbox\nNew-Mailbox -Shared -Name \u0026ldquo;PS Test EV Enabled SharedVoicemail\u0026rdquo; -DisplayName \u0026ldquo;PS Test EV Enabled SharedVoicemail\u0026rdquo; -Alias \u0026ldquo;PSTestEVEnabledSharedVoicemail\u0026rdquo;\nStart-Sleep -Seconds 30\n# Grant full mailbox access to the flow owner\nAdd-MailboxPermission -Identity \u0026ldquo;PSTestEVEnabledSharedVoicemail\u0026rdquo; -User \u0026ldquo;mozzie@mozzism.ch\u0026rdquo; -AccessRights FullAccess -InheritanceType All\nSubscribing the Shared Mailbox to the M365 Group¬†Inbox Next, we add the newly created shared mailbox as a member of the group and then also subscribe it to the group‚Äôs inbox.\n# Add the shared mailbox as a member to the M365 group\nAdd-UnifiedGroupLinks -Identity $groupId -LinkType Members -Links \u0026ldquo;PSTestEVEnabledSharedVoicemail\u0026rdquo;\n# Subscribe the shared mailbox to the M365 group\u0026rsquo;s emails (enable follow in inbox)\nAdd-UnifiedGroupLinks -Identity $groupId -LinkType Subscribers -Links \u0026ldquo;PSTestEVEnabledSharedVoicemail\u0026rdquo;\nWe can verify that the shared mailbox is indeed subscribed by using this code. (I have no idea why it says UserMailbox though‚Ä¶)\nPS V:\\GitHub\\TeamsPhoneAutomation\u0026gt; Get-UnifiedGroupLinks -Identity $groupId -LinkType Subscribers\nName RecipientType\n-\u0026mdash; \u0026mdash;\u0026mdash;\u0026mdash;\u0026mdash;-\nPS Test EV Enabled SharedVoicemail UserMailbox\nThe idea here is that only the shared mailbox gets new voicemails in its mailbox. None of the users should get the voicemails in their personal inbox because they receive them in Teams. This allows for much better and efficient collaboration.\nThe Result This is the Team I created for this call flow. Channels 1 and 2 are linked to the queues which receive calls. 3 and 4 are the ones which receive the voicemails. As explained earlier in this article, the flow can easily determine at which stage in the call flow (during business hours or on-call/after hours) a voicemail was left. That‚Äôs why we have two separate voicemail channels.\nVoicemail During Business¬†Hours Adaptive Cards in Teams now support media. This means that we can now embed an audio file which is stored on SharePoint directly on an adaptive card and we‚Äôll get a neat little Stream powered media player inside Teams.\nThe card will include the number or the email address of the user who left the voicemail.\nAfter members of the channel have listened to a voicemail, they can call the person who left a voicemail back directly from the channel.\nUpdated Adaptive¬†Cards Once a team member has called back, a card can be marked as completed. This will update the card so that all other team members can see that there‚Äôs no action left to take. It‚Äôs even possible to see who has marked a card as completed.\nCompleted cards don‚Äôt show the media player anymore. However, the Voicemail Details button will reveal the original card including the audio file again. This is helpful in case somebody needs to listen to a message again or the Call Completed button was clicked by accident.\nUsers don‚Äôt really need to worry about this, but technically, the files get uploaded to the channel‚Äôs folder in the Teams‚Äô SharePoint site.\nCompleted cards also feature a Show Metrics button which will tell you when a voicemail was received, when it was completed and how many hours and minutes it took until it was marked as completed. Based on that, it will display a different emoji.\nLess or equal 1 hour = üòä\nLess or equal 2 hours = üòê\nMore than 2 hours = üòû\nVoicemail During After Hours (On¬†Call) Voicemails which were left outside business hours will go into the Voicemail On Call channel. When a voicemail is left during on-call hours, it means that the people who are on-call missed a call and should call back as soon as possible. Thus, we want to have an appropriate alerting system in place.\nI‚Äôm using a shift which is linked to my Call Queue Team which defines which user is on call on which days.\nThe great thing about using Shifts is that this will automatically create a Tag with the Shift name in the Team which is linked to the shift and update the members of the Tag dynamically. In other words, the tag always includes only the users which have a currently active shift assigned.\nWhen a new voicemail is received in the On Call channel, all members of the On Call Shift Tag will get notified about new voicemails every 15 minutes for 4 hours if a card is not completed sooner. As soon as card is completed, the notifications stop.\nIn case of an on-call voicemail the flow will take at least 15 minutes to complete, even if the card was marked as completed sooner. This is because there‚Äôs a delay action which waits for 15 minutes before it checks again if the card has been completed.\nBecause the flow is still waiting on the card to be completed in the on-call scenario, there‚Äôs no way to get the message Id of the adaptive card that was sent to the channel from a subsequent step in the flow. Instead, the flow needs to retrieve the latest message which was sent to the channel in a parallel branch.\nBecause of that, I strongly recommend turning on channel moderation and prohibit members from posting new messages to the On Call Voicemail channel. This way, we can make sure that the newest message in the channel is always the adaptive card which was sent by the flow and not something posted by a user.\nChannel members should only be allowed to reply to messages so that they can e.g. mention a team member who should carry out a call back action.\nI changed the delay action from 15 minutes to 15 seconds for demonstration purposes. Here you can see three Teams activity feed notifications which link directly to the channel message containing the voicemail. Using a Teams activity feed notification instead of a channel message reply has two main advantages. It doesn‚Äôt clutter the channel feed and members don‚Äôt need to specifically enable notifications for all channel messages to get the alerts.\nThe Flow The flow has become quite large and Power Automate keeps reminding me that it contains too many actions to use the new AI-powered designer. üôÉ\nTo make it easier for you, I exported the flow and made it available for download here. To import it, go to https://make.powerautomate.com and select Import and then Import Package (Legacy).\nSelect an existing or set up a new connection for each of the resources listed before you click Import.\nUnfortunately, you still need to expand every action and check if you need to modify/update the values. To make it easier for you, I added a note to all the actions which need to be updated. Here are some examples.\nYou get the gist. At least you won‚Äôt have to create all the actions manually.\nSummary Even though it took me days to finally get this right, I had so much fun building this. Besides that, I also learned a lot of new stuff about Power Automate. In fact, this was the very first parallel branch I ever built. It‚Äôs awesome that Adaptive Card in Teams now support media. I think this is a really great example of how powerful Adaptive Cards can be. They not only look beautiful, but they also provide a fantastic user experience since users will be able to interact with them directly in Teams.\nI‚Äôd be lying if I said that I wasn‚Äôt a little proud of the flow and process I built. The only thing I‚Äôm still missing with this solution is to be able to create Teams deep links which also specify which outbound caller id should be used when a call back link is clicked. Wouldn‚Äôt it just be great if we could say that users should always use the queue‚Äôs/attendant‚Äôs phone number when they call somebody back from a voicemail card?\nWhat‚Äôs funny is that the Teams mobile apps actually prompt users which have multiple calling line identities assigned to select an identity before the call is made.\nAs you can tell, I‚Äôm pretty excited about all of this. I hope you like it too and that you can implement it for your users or customers as well.\n","date":"2023-12-06T20:59:21.988Z","permalink":"https://heusser.pro/p/the-ultimate-teams-shared-voicemail-solution-5dd2ce57facc/","title":"The Ultimate Teams Shared Voicemail Solution"},{"content":"Microsoft has announced that anybody that‚Äôs still using Teams Classic (old Teams) will be updated to Teams 2.1 (new Teams) after March 31, 2024.\nAs more and more people start to use the new Teams, it‚Äôs time to explore how the client cache for Teams 2.1 can be cleared on Windows devices.\nAs of writing this article, the official Microsoft Learn article still only includes the procedure for Teams classic. In today‚Äôs blog, I‚Äôm going to show you how you can clear the cache for Teams 2.1\nClear the Cache via Windows¬†Settings The easiest way is to just go to Windows Settings (Win + I ) and go to Apps \u0026gt; Installed Apps. Either scroll down and find Microsoft Teams (work or school) or search for it. Once you‚Äôve found it, click on the three dots and then Advanced options.\nScroll down to Reset and click Reset and then click Reset again.\nThis will remove all the cached files including custom backgrounds from the folder below.\n%LOCALAPPDATA%\\Packages\\MSTeams_8wekyb3d8bbwe\nClear the Cache via PowerShell I‚Äôve created a PowerShell script which will automatically close Teams, clear the cache but keep custom backgrounds and start Teams automatically again.\nThe script works for both versions of Teams. It will only clear the cache of the Teams version that‚Äôs running when the script is launched.\nThe cache of Teams Classic is located in the folder listed below.\n%APPDATA%\\\\Roaming\\\\Microsoft\\\\Teams\nCustom backgrounds must be stored in the folders below to be retained.\nTeams 2.1: %LOCALAPPDATA%\\Packages\\\\MSTeams\\_8wekyb3d8bbwe\\LocalCache\\\\Microsoft\\MSTeams\\\\Backgrounds\\Uploads\nTeams Classic: %APPDATA%\\Roaming\\Microsoft\\Teams\\Backgrounds\\Uploads\nHere‚Äôs the script.\nI hope this helps.\n","date":"2023-12-01T18:39:59.076Z","permalink":"https://heusser.pro/p/clear-teams-2-1-cache-windows-11-be3e76ff6ea2/","title":"Clear Teams 2.1 Cache (Windows 11)"},{"content":"I think it‚Äôs safe to say by now that this project has been a success. I‚Äôve received lots of positive feedback about this from the community.\nThat didn‚Äôt stop me from going even further and adding more features to this project though.\nNew Features and Improvements Localized / Formatted Phone¬†Numbers As you may know by now, I consider myself a data driven guy. What I really dig about Teams phone is the fact that every number is a full E.164 number in every case. This kind of absoluteness provides great safety because each number is unique. Just as with user principal names or GUIDs, there‚Äôs no funny business going on.\nThat safety comes at the cost of readability though. If you‚Äôve seen this article before, then you already know that I came up with a solution to format phone numbers in their local format using Python.\nThe runbook logic powering the list can now also leverage Python to store the formatted phone number in an additional column. This way you always have both, the E.164 number and a prettified version of it readily available.\nFor US numbers or numbers from other countries such as Japan or Israel which typically use hyphens, you might have noticed that I‚Äôm removing the hyphens, even though they‚Äôre included after a number has been formatted using the phonenumbers library. I do this so that every number in the list contains only digits and a plus sign. Also, it‚Äôs how Teams Admin Center displays the numbers.\nWrite back Teams Phone Number to Entra¬†ID When you view a user‚Äôs profile card in Teams, Outlook or anywhere else in Microsoft 365, it doesn‚Äôt display the phone number which is actually configured as LineURI in Teams. Instead, the information is taken from Entra ID. I‚Äôve created a variable inside the runbook which controls if the BusinessPhones property of Entra ID users should be set to the assigned LineUri in Teams. I‚Äôll explain how to turn this on or off later in this article.\nWith the current permissions/scopes assigned to the Entra ID App registration, this only works for users which don‚Äôt have any administrator roles assigned in Entra ID. If a user has an admin role, you‚Äôll get an error.\nPrevious User¬†Column I‚Äôve added a new column which shows the UPN of the previous user/owner of a number after it has been removed. This is achieved by an update I made to the Power Automate Flow. Note that the flow will now also retain the value of the Comment column.\nThe reason for this column is that you have a better overview over who has previously used a number. I‚Äôm sure you don‚Äôt want to assign the previous CEO‚Äôs number to a new intern.\nUnassigned Routing¬†Rules When people leave, we sometimes want to forward their unassigned number to another person in the company or to the main number. This is done by routing rules. But do we typically remember or even know that such rules have been created in the past‚Ä¶? Now we do!\nEvery number is checked against all routing rules a tenant has configured and if there are any matches, they‚Äôre reflected on the list. The name of the matching rule gets stored in the User Name column. (Because this column isn‚Äôt used for the flow trigger condition.)\nThis even works if a number is reserved. In this case, the status will be changed to Reserved (Routing Rule).\nImproved Number Assignment Capabilities I‚Äôve also made some improvements to assigning numbers. If a number has a status of Reserved (Routing Rule) or Assignment Error, the script will try to assign the number as well. In the case of an assignment error, the script will try to assign the number again with each new job. This is helpful in scenarios where e.g. a license hasn‚Äôt been assigned yet.\nFurthermore, you can now also reserve a number and enter the user‚Äôs UPN in the User Principal Name column. This is great if the account does not exist yet (so you can‚Äôt fill in the User Profile) but you already know the UPN of a soon to be created user. All of these changes make it easier for you to plan ahead and have the runbook take care of everything automatically, once a user has been created and licensed.\nOperator Column Last but not least, the list now also displays the name of the Operator. This works for all types, including Direct Routing. You will have to manually list the operator name for each Direct Routing number in your source CSV though.\nUpdating All the Components I will most likely update the deployment script at some point to deploy everything from scratch including all the updates. If I can find enough time, I may also create an update script to update an existing deployment.\nBut today, I‚Äôll show you how to implement all the changes manually in an existing deployment which consists of an Azure automation account, a list, a flow and your local source files.\nTo do these steps, you should have followed and deployed everything as described in this article and implemented all the updates described in this article.\nAdd New¬†Columns Add the following columns to the SharePoint list. All columns must be of type text.\nComment Previous User Operator Phone Number Add the phonenumbers Python Package to the Automation Account Go to this website and download the built distribution (*.whl) file to your PC. Then go to your automation account in Azure Portal and upload the file under Python packages.\nAdd Automation Variables to Automation Account Add the following variables to your automation account. Since you‚Äôll need to enter a value, just type a dot (‚Äú.‚Äù). Leave the integer value at 0.\nTeamsPhoneNumberOverview_AllCsOnlineNumbers (String) TeamsPhoneNumberOverview_PrettyNumbers (String) TeamsPhoneNumberOverview_TotalNumberCount (Integer) Add Operator info to your Direct Routing¬†Numbers If you have direct routing numbers, you‚Äôll need to update your source list. The old structure only had one column called PhoneNumber. Now there‚Äôs PhoneNumber and Operator.\nPhoneNumber;Operator\n4144520xxxx;Test Provider 1\n4144512xxxx;Test Provider 2\n4144512xxxx;Test Provider 3\nPlace your updated CSV in¬†.\\Resources\\DirectRoutingNumbers-V2.csv and then run this script to update your automation variable in Azure.\nAlternatively, you can also run the below code and paste the content into your TeamsPhoneNumberOverview_DirectRoutingNumbers automation variable.\n\u0026ldquo;\u0026rsquo;\u0026rdquo; + (Import-Csv -Path .\\Resources\\DirectRoutingNumbers-V2.csv -Delimiter \u0026ldquo;;\u0026rdquo; | ConvertTo-Json | Out-String) + \u0026ldquo;\u0026rsquo;\u0026rdquo; | Set-Clipboard\nCreate a Python¬†Runbook Go to your runbooks in your automation account and click Create a runbook. Name it Format-TeamsPhoneNumbers and choose Python as runbook type and 3.10 (preview) as runtime version.\nGrab this code and paste it into the Azure portal. Save and publish the runbook.\nSetup a Managed Identity and Permissions Every time the main runbook runs, it will check if the total number count is still the same by comparing the current count to the count of the previous job which is stored in the TeamsPhoneNumberOverview_TotalNumberCount variable. If the count of numbers is different compared to the previous job, the main runbook will start the python runbook. The python runbook will use the phonenumbers library to format all your phone numbers to their localized format.\nHowever, we must first allow the runbook to start another runbook job using a managed identity. In the automation account, go to Identity and flip the toggle switch for System assigned (managed identity) to On. Then click Save.\nClick Azure role assignments and then Add role assignment (Preview). Set the scope to Resource group, select your subscription and resource group and choose Automation Operator as role.\nClick Save.\nUpdate the Main¬†Runbook Replace the code in the TeamsPhoneOverview runbook with this code. Make sure to change the **$localTestMode** variable to **$false** before you save and publish the runbook. Also update the names of your automation account and resource group on lines 95‚Äì97.\nIf you don‚Äôt want to write back user‚Äôs LineURIs to Entra ID BusinessPhones, change syncTeamsPhoneNumbersToEntraIdBusinessPhones to $false on line 6.\nUpdate the¬†Flow Finally, go to your flow and make the last small changes. In here, add the values for the new columns that we created. If you need a refresher, this is the part where the flow deletes numbers which were unassigned because there‚Äôs no way to remove the user profile. We then recreate the list entry with all the information except the User Profile Claims. Because the user profile stays, we can use the User Profile Email and write it to the Previous User column. Comments in the comment field will also be added again, once a deleted entry has been recreated.\nUpdate the Flow Trigger Condition The current trigger condition checks if a user‚Äôs email address is equal to the user principal name. As much as I want this to always be the case, the reality is sometimes different. Some readers have reported that their Flow gets stuck in an infinite trigger loop because of that.\nI‚Äôve slightly tweaked the trigger condition, so it doesn‚Äôt compare the email address to the UPN anymore. Instead, the UPN is extracted from the user profile using a split operation and then compared to the UPN from the list column. Here‚Äôs the updated trigger condition. Make sure to update it on your flow as well as it will be more robust than the old one.\n@or(\nand(\nnot(equals(triggerOutputs()?[\u0026lsquo;body/User_x0020_Principal_x0020_Name\u0026rsquo;], \u0026lsquo;Unassigned\u0026rsquo;)),\nnot(contains(triggerBody(), \u0026lsquo;UserProfile\u0026rsquo;))\n),\nnot(equals(toLower(triggerOutputs()?[\u0026lsquo;body/User_x0020_Principal_x0020_Name\u0026rsquo;]), split(toLower(triggerOutputs()?[\u0026lsquo;body/UserProfile\u0026rsquo;][\u0026lsquo;Claims\u0026rsquo;]),\u0026rsquo;|\u0026rsquo;)[2])),\nand(\ncontains(triggerBody(), \u0026lsquo;UserProfile\u0026rsquo;),\nnot(equals(triggerOutputs()?[\u0026lsquo;body/User_x0020_Principal_x0020_Name\u0026rsquo;], \u0026lsquo;Unassigned\u0026rsquo;)),\nnot(contains(triggerBody(), \u0026lsquo;TeamsAdminCenter\u0026rsquo;))\n)\n)\nThat‚Äôs all. If you‚Äôve followed all the steps, you should now be able to make use of all the new features I created. Like I said, I‚Äôll try to find some time and create a new deployment script which deploys the version 2 from scratch. I hope you enjoy the list as much as I do.\n","date":"2023-11-16T10:30:16.14Z","permalink":"https://heusser.pro/p/teams-phone-number-management-list-part-3-e083a320004d/","title":"Teams Phone Number Management List Part 3"},{"content":"It‚Äôs that time of the year again. The holidays are right around the corner. Which begs the question: Did you update the holiday schedules for your Teams Auto Attendants already? And if so, are you sure they‚Äôre configured correctly?\nNo? Me neither. But I do remember that I wrote a comprehensive guide about Everything You Ever Wanted to Know About Teams Holidays about a year ago. This is a great resource to read up on some of my personal best practices and some lesser-known things about Teams Holidays and how they work.\nIf you‚Äôd rather outsource this to end users for next year, this article might be interesting to you as well.\nWhat is today‚Äôs blog post all¬†about? I recently built a very large follow the sun type of call flow which consists of about ten different Auto Attendants and Call Queues. Each Auto Attendant has different business hours, and many Auto Attendants have a different time zone configured as well. This can get quite complicated to build, verify and troubleshoot. How can something like this be tested and verified that it works as intended?\nSince this was not live yet, I started out by adding a greeting to each Call Queue which said the name of the Queue whenever a call was routed to a Call Queue. Then I just made a couple of test calls during the day to see if calls were routed to the correct Queue.\nBut then I thought of something much better. I‚Äôve already got the M365 Call Flow Visualizer script in place which is capable of reading all nested voice apps recursively from any starting point. I only had to code some additional stuff to check whether an Auto Attendant is currently in business hours, after hours or in a holiday schedule. The best part about this is that it works for any date. Past, present and future. And of course, any date and time is converted to the time zone which is configured on each Auto Attendant in your call flow. Just as if you would call the Auto Attendant.\nDemo Call¬†Flow This is the demo call flow I‚Äôll be using to demonstrate and explain the new feature. Nothing crazy, just an Auto Attendant with two holiday call handlings and schedules and some business hours.\nNote that the Auto Attendant is configured in Pacific Standard Time while I live in W. Europe Standard Time.\nHow to Check Business Hours and¬†Holidays To check if any Auto Attendant is currently in business hours or after hours or in a holiday schedule, simply run the M365 CFV script with the switch parameter -CheckCallFlowRouting¬†.\nNote that the-CheckCallFlowRouting parameter is not mutually exclusive from the Visualizer. You can generate a diagram and check business hours/holiday in the same script run.\n. .\\M365CallFlowVisualizerV2.ps1 -CheckCallFlowRouting -Identity edde8e13-1a73-434b-a724-xxxxxxxxxxxx\nThis will use your local system time and convert it to whatever time zone is set on the Auto Attendant. The script will output the local and the Auto Attendant time and time zones.\nAs you can see, it‚Äôs already Tuesday in Switzerland but it‚Äôs still Monday in Pacific Standard Time. Since the business hours for Monday are only configured to 17:45 PST the Auto Attendant is closed.\nFurther down in the output, we‚Äôll see the information about holidays as well. In this case, the Auto Attendant has actually multiple holidays which match my local date and time. While an Auto Attendant can‚Äôt have two holidays with the same start date, it‚Äôs possible to have holidays which enclose others and/or have the same end date. In that case, the holiday which is most precise (smallest time range) will be active. (This is also explained in the Everything You Ever Wanted to Know About Teams Holidays article linked at the beginning of this post.)\nIn PST, it‚Äôs still Monday, November 6th and there are three holidays starting on this date. One starts at 00:00:00 one at 17:15:00 and one at 17:30:00¬†. The time in PST is currently 23:50:00 so it‚Äôs already past all start times of the aforementioned holidays which means, the one starting at 17:30:00 is the currently active one, because its start time is closest to the current time. You can see the name of the active holiday call handling and holiday schedule in the output. But that‚Äôs not all. You can also see that it lists the actual time range of the schedule on the line which starts with Holiday Schedule:¬†.\nIf nobody can answer a call, during business hours, after hours, this demo Auto Attendant (USA Toll Free Test) just forwards to another Auto Attendant called Main Number Busy AA which will just play a greeting and disconnect. This Auto Attendant does not have any business hours or holidays configured, which is also visible in the console output when the -CheckCallFlowRouting switch is used.\nIt even tells you that it‚Äôs a nested Auto Attendant and which was the initially queried Auto Attendant.\nAdvanced Check Obviously, we won‚Äôt always have the time or the patience to stay up all night just to verify that business hours or holidays are configured correctly on an Auto Attendant which serves customers on the other end of the world.\nTo check the call flow routing for any specific date we can just pass an additional parameter to the script. It doesn‚Äôt matter if the date lies in the past or in the future.\n-CheckCallFlowRouting -CheckCallFlowRoutingSpecificDate \u0026quot;07.11.2024 17:00:01\u0026quot;\nThe only thing you need to consider is that you need to enter it in a format which is expected by your system. This depends on your regional settings in Windows.\nFor me that would be dd.MM.yyyy HH:mm:ss¬†. You can test this using the following code.\nGet-Date -Date \u0026ldquo;08.11.2023 17:00:01\u0026rdquo;\nIf you for example, typically use MM/dd/yyyy HH:mm:ss you have to specify it like this.\nGet-Date -Date \u0026ldquo;11/08/2023 17:00:01\u0026rdquo;\nAs long as this doesn‚Äôt throw an error and the returned date is correct, you should be fine.\nWhen I queried the Auto Attendant in the first example it was 08:50:00 in my local time. Now, I‚Äôm going to query the same Auto Attendant again but this time, I‚Äôm specifying a date and time which was 7 hours before at 07.11.2023 01:50:00.\n. .\\M365CallFlowVisualizerV2.ps1 -CheckCallFlowRouting -Identity edde8e13-1a73-434b-a724-xxxxxxxxxxxx -CheckCallFlowRoutingSpecificDateTime \u0026ldquo;07.11.2023 01:50:00\u0026rdquo;\nAt this time, which is 16:50:00 in PST, the Auto Attendant was still open. Even though there are multiple schedules configured for Monday (which are also listed in the output) the script is still able to determine which time range from the Monday schedule is the currently active one.\nAnd because it‚Äôs not 17:15:00 or 17:30:00 in PST yet, there are only two matching holiday schedules returned now.\nLet‚Äôs check what happens if we query it again after the holiday on 18.11.2023 has ended. Pacific Standard Time is currently -9 hours from W. Europe Standard Time. So, I need to check for 18.11.2023¬†.\nIf I check for 18.11.2023 00:00:00 it‚Äôs still in the holiday schedule.\nBut if I check for 18.11.2023 00:00:01 the holiday is over, but since this is a Saturday, the Auto Attendant is closed because of business hours anyway.\nLet‚Äôs try Monday 20.11.2023 17:15:00.\nLooks good, the Auto Attendant is open again. However, there is one caveat. There is another holiday scheduled on 20.11.2023 (which can be seen in the diagram above as well). Holidays always take precedence over business hours.\nThe M365 CFV was built in a way, where it first checks the business hours and then the holidays. So, there‚Äôs no easy way to properly reflect that in the output, because the script is unaware of possible holidays at the time it outputs the information about business hours. I‚Äôm sure it‚Äôs possible somehow but I don‚Äôt know how much work that would require.\nFor now, we must accept that and just pay attention to all the output. If there‚Äôs an active holiday, business hours will be disregarded until that holiday is over. On the other hand, I think it‚Äôs great to get all the information, so one could check how the call would have been routed at that date and time, if it weren‚Äôt a holiday.\nLet‚Äôs do one more check to see if everything will be back to normal on 21.11.2023¬†.\nI set the time to 21.11.2023 23:30:00 so that it would be 21.11.2023 14:30:00 in PST which is covered by the second date time range on Tuesday‚Äôs schedule. Looks good to me.\nDeep Dive on Auto Attendant Schedules There‚Äôs one more thing I want to mention. You might have noticed the Complement: Enabled output in the screenshots above. This is a parameter which belongs to New-CsOnlineSchedule or Set-CsOnlineSchedule which is used to create/update business hours schedules for Auto Attendants. You can find the official parameter description here.\nAs of writing this article, it says the following:\nThe Complement parameter indicates how the schedule is used. When Complement is enabled, the schedule is used as the inverse of the provided configuration. For example, if Complement is enabled and the schedule only contains time ranges of Monday to Friday from 9AM to 5PM, then the schedule is active at all times other than the specified time ranges.\nIf you think about this from looking at Teams Admin Center and how business hours are configured under Call flow for after hours in TAC it makes sense. There is no way to configure business hours under Call flow (which is the default call flow). So, when you configure Business and after hours, the time ranges you define will be the times during which the default call flow is active. Outside of the configured times, the after hours call flow will be active. This is 100% in line with what the docs say for the -Complement switch parameter.\nIt‚Äôs not possible to set ComplementEnabled to $false using Teams Admin Center. It‚Äôs only possible through PowerShell. This will set ComplementEnabled to $false on an Auto Attendant‚Äôs after hours schedule.\n# Define Auto Attendant\n$aaId = \u0026ldquo;b74da106-ea89-4786-b8aa-xxxxxxxxxxxx\u0026rdquo;\n$aa = Get-CsAutoAttendant -Identity $aaId\n# Get schedule\n$schedule = Get-CsOnlineSchedule -Id $aa.Schedules.Id\n# Disable ComplementEnabled\n$schedule.WeeklyRecurrentSchedule.ComplementEnabled = $false\n# Check value in schedule variable\n$schedule.WeeklyRecurrentSchedule\n# Set new (disabled) value for the schedule\nSet-CsOnlineSchedule -Instance $schedule\n# Check result\n$aa = Get-CsAutoAttendant -Identity $aaId\n$aa.Schedules.WeeklyRecurrentSchedule\nIn this case, the after hours call flow will be active during the specified time ranges.\nThis is where it gets complicated. Any time you change business hours in Teams Admin Center, complement will be ENABLED again without any warning. I haven‚Äôt figured out changing which properties exactly trigger TAC to reset the Complement setting but it‚Äôs definitely not just editing business hours. A change to the default and after hours call flow greeting resulted in TAC overwritting ComplementEnabledto $true too.\nAlso, Teams Admin Center won‚Äôt display open/closed hours correctly when complement is off. When I view the after hours call flow in TAC, it says, it‚Äôs closed during that time when in fact it should say open.\nI verified that the schedule is in fact not inverted by calling the Auto Attendant at 11:26 which is within the defined time range of 09:30-12:00¬†. I was indeed able to hear the greeting which was configured for the after hours call flow. To summarize: setting ComplementEnabled to $false through PowerShell is working, but TAC won‚Äôt display it correctly.\nI‚Äôve enabled complement again to verify if there‚Äôs any change in how TAC displays things. There isn‚Äôt. TAC simply doesn‚Äôt care if ComlementEnabled is enabled or disabled.\nAfter I enabled ComplementEnabled I called the Auto Attendant again, still between 09:30-12:00 and was able to hear the greeting which is configured for the default call flow.\nSadly, I didn‚Äôt consider this in the CFV so here, the output was wrong, when Complement is disabled.\nWhen Complement is disabled, the Yes and No nodes should be switched.\nThe output of the CheckCallFlowRouting is correct though. Even though the checked time of 11:41 is within the schedule 09:30:00-12:00:00 it says it‚Äôs closed because Complement is disabled. In this case, the colors (red/green) are also inverted, and it says Active After Hours Time Range instead of Active Business Hours Time Range.\nWhen I check it for 13:49 which is not part of the specified schedule, the Auto Attendant is open, and the default call flow is active.\nLuckily, it was easy enough to fix the CFV and add support for Complement disabled schedules in Version 3.1.1. Even when you don‚Äôt use the CheckCallFlowRouting paraemeter, you‚Äôll still see a warning when ComplementEnabled is $false¬†.\nHere we can see an Auto Attendant, which has two nested AAs. One has Complement disabled and the other one enabled and everything is displayed correctly now. You can see that on the left side, for Complement Disabled AA the Yes option for the business hours goes to the after hours call flow greeting. On the right side for Complement Enabled AA it‚Äôs the opposite. (This is the standard.)\nAnd here you can see, that the after hours call flow greeting in TAC for Complement Disabled AA says: This is the after hours greeting.\nYou can get Version 3.1.1 of the M365 CFV from my GitHub.\nAnyway, this doesn‚Äôt change the fact that I strongly recommend not to use **ComplementEnabled: $false** in any case. There‚Äôs no point in using it since TAC won‚Äôt display it correctly and even more important, will always set it to $true again if you update the Auto Attendant through TAC.\nUsing schedules with Complement enabled (inverted) schedules makes total sense because the business hours are configured under Call flow for after hours and the title says Set business hours in TAC, so, it‚Äôs only logical that the schedules are inverted and that the after hours call flow is active outside of the configured business hours and business hours (default call flow) are active during the specified time ranges.\nI hope that this new feature, to check any Auto Attendant‚Äôs schedules for any given date and time, also helps you to verify and troubleshoot complex call flows more efficiently. By the way, thanks to a Pull Request from a community member, the CFV now also supports export to PDF!\nIf you like my work, feel free to consider sponsoring my work through my GitHub Sponsors Profile.\n","date":"2023-11-07T13:41:33.218Z","permalink":"https://heusser.pro/p/advanced-teams-auto-attendant-troubleshooting-2b6ec32fc9cb/","title":"Advanced Teams Auto Attendant Troubleshooting"},{"content":"As you may know, I try to blog at least once a month. Although I‚Äôm a little behind this month, I‚Äôm still well on track to reach my goal in 2023 again.\nI still got plenty of topics to blog about in my backlog but what I like most is when I discover something new and get so hyped out about it that I can‚Äôt just not blog about it right away.\nThanks to my awesome Discord community (join here) which is full of enthusiastic Teams Phone admins like myself, it was brought to my attention that Microsoft is making some changes to how normalization rules in Teams dial plans are applied.\nTLDR; I‚Äôve created an app which allows you to call any phone number which has been copied to the clipboard simply by clicking an app on the taskbar or by pressing a hotkey. Skip to the bottom of this post if you‚Äôre only interested in the app.\nWhat are Dial Plans and Normalization Rules? Normalization rules are regular expressions which change certain phone numbers before they‚Äôre dialed in Teams. An easy example is e.g. that any Swiss phone number which is entered in the national format (with a leading 0) is converted to E.164.\nE.g. 044 123 45 67 is changed to +41441234567 before it‚Äôs dialed.\nThis rule is actually part of the system dial plans which are already included in Teams. Admins can create their own dial plans by creating so called Tenant Dial Plans.\nYou can view the built-in dial plans by entering the following in a Teams PowerShell session. Replace CH with the country you want to check.\nGet-CsDialPlan -Identity CH\nTenant Dial¬†Plans With tenant dial plans, it‚Äôs possible to create much more complex rules such as this one which contains a monster regular expression created by no other than Ken Lasko (UCDialPlans.com‚Ää‚Äî‚ÄäDial Plan Tools).\nI don‚Äôt know why there are still people on this planet who think it‚Äôs a good idea to list a phone number in a format in which it simply does not exist. +41 (0) 44 123 45 67 or +41 0 44 123 45 67 are not valid phone numbers. That‚Äôs effectively the same as if I told people that my email address is mozzie(0)@heusser.pro when in fact it‚Äôs mozzie@heusser.pro¬†. It‚Äôs either +41 44 123 45 67 (when calling internationally) or 044 123 45 67 (when calling from the same country).\nFrom my experience many people also don‚Äôt know that you can dial an E.164 number even when calling from the same country. I wouldn‚Äôt be surprised if there is an exception to this rule in some countries, but it works in almost every case.\nUnfortunately, the normalization rules which are built into Teams, don‚Äôt fix these numbers for us. If people dial a number with an illegal zero after the international prefix, the call will fail, since it‚Äôs an invalid number.\nSince we can‚Äôt possibly knock some sense into every website owner that lists their phone number incorrectly or access and fix everybody‚Äôs precious personal Outlook contacts, adding Ken‚Äôs rule to a tenant dial plan was a great way of solving this particular issue.\nBut now Microsoft is taking this away from us.\nThis was the link that was shared on Discord:¬†M365 Changelog: (Updated) Changes in Normalization‚Ää‚Äî‚ÄäPetri IT Knowledgebase\nThere is a Message Center post about this as well: MC536885. It mentions the following:\nStopping normalization on number that starts with plus sign (+)\nNormalization in Microsoft Teams was not designed to do normalization when the phone number starts with plus sign (+) as documented, but we‚Äôve never enforced this in the Teams desktop or Web client. We are planning to enforce this in the future but for now we recommend avoiding this pattern.\nWe are making this change to align with our Calling Service, other Teams services, Azure Communication Services SDKs, and other Microsoft services. Numbers that start with a plus sign (+) will not pass through any normalization rules.\nUpdate 10.11.2023\nThe Message Center post was updated by Microsoft. They‚Äôre not following through with this anymore.\nUpdated November 2, 2023: Based on customer feedback we will not be moving forward with this change at this time. You can safely disregard this message. Thank you for your feedback.\n/Update\nTesting with PowerShell I‚Äôve noticed that something was not right, when the PowerShell commands to test dialed numbers against a tenant dial plan stopped matching numbers which start with a plus.\nI have a tenant dial plan in Teams which contains Ken Lasko‚Äôs awesome normalization rule.\nWe can use the following PowerShell command to test a user‚Äôs normalization rules.\nGet-CsEffectiveTenantDialPlan -Identity user@domain.com | Test-CsEffectiveTenantDialPlan -DialedNumber +410441234567 -TenantScopeOnly\nAs you can see in the screenshot below, the number starting with + does not match any rules despite the fact the rule exists. The number starting with 00 is matched by another rule in the same dial plan.\nVerifying Ken Lasko‚Äôs regular expression with regex101.com proves that it‚Äôs 100% correct.\nWhat about the Teams¬†Client? Interesting enough, the Teams client still seems to match the rule from the tenant dial plan.\nHowever, I suspect it‚Äôs only a matter of time before this stops working too.\nStarting Calls from¬†Outlook If Teams is registered as the chat app for Microsoft 365 Apps (such as Outlook) we can call numbers which are stored on Outlook contacts.\nThe problem with this is that classic Outlook does not apply any normalization rules either. The number is called as it‚Äôs stored on the contact.\nWhen I try to call this number, the call fails. You can see that the illegal zero was not dropped in the title bar of the call window.\nIt‚Äôs noteworthy that clicking a number in the old Outlook will start a call directly without prompting you to start the call in Teams.\nIn my tests with the new Outlook, the number was normalized correctly, even for a user who didn‚Äôt have a tenant dial plan assigned. This makes me believe that it‚Äôs actually the new Outlook which is applying the normalization rules. When you click a number in the new Outlook, you‚Äôll get a prompt to start the call in Teams.\nHowever, every time a number is clicked in the new Outlook, an annoying blank pop up is opened and it doesn‚Äôt even close once you have made the call.\nTime to look for alternatives.\nAlternative Solutions Dialing phone numbers from other apps and links or even through a hotkey is not an uncommon ask from users.\nIf you‚Äôve received this request before, you‚Äôve probably stumbled upon this free app called Teams Wizard. This will allow you to start Teams PSTN calls by selecting a phone number and pressing the configured hotkey.\nIn Teams Wizard‚Äôs settings, there‚Äôs a setting called Enable normalization of phone numbers (Normalisierung der Telefonnummern aktivieren).\nOn first sight, it looks like this only goes as far as the Teams built in dial plans and won‚Äôt drop the illegal zero after the E.164 prefix.\nHowever, when you click on Yes (Ja) the number appears correct in Teams, even if the user does not have a special tenant dial plan assigned.\nSo far so good. But the hotkey only works when you‚Äôve selected a phone number with your mouse. Although it‚Äôs possible to just select a contact in old Outlook and then press the hotkey, the success rate is quite low. First of all, many contacts hold multiple numbers and it‚Äôs not possible to tell Teams Wizard which number should be called. Secondly, it‚Äôs not possible to select a number with your mouse in old Outlook. They can only be copied. But Teams Wizard does not monitor your clipboard. And copy/paste the number into another app (like Notepad) just to select it and then press the hotkey seems like one step too many.\nWhile it‚Äôs possible to select phone numbers of contacts in the new Outlook, the experience isn‚Äôt great either. Because the new Outlook is also based on web technology, selecting a number with your mouse without triggering the calling link is a very tricky undertaking. And don‚Äôt forget all the ugly blank pop ups this will open.\nIf the new Outlook really does (and keeps on doing) number normalization, then I guess this problem will be mitigated at some point in the future. But a future where everybody only uses the new Outlook is likely still very far off. But I don‚Äôt even want to go into a discussion of new vs. classic Outlook and how some folks will cope (or not) with the new Outlook.\nTherefore, I don‚Äôt think that it hurts to prepare ourselves for a world in which we can apply normalization rules outside of Teams and Outlook.\nAll of this got me thinking‚Ä¶ wouldn‚Äôt it be awesome if we could have a way to instantly normalize and dial any number that has been copied to the clipboard‚Ä¶?\n‚Ä¶Because copying a number with only one click is possible in both the new and the old Outlook.\nCopying the number before calling it also provides great flexibility. Be it multiple numbers on a single contact or any phone number in any app or website. Heck, we could even use PowerToys‚Äô text extractor feature (Win + Shift + T ) or the new Snipping Tool to extract and copy phone numbers from screenshots which got sent our way by people who were too lazy to put the number in a reusable format.\nI Proudly Present: Teams Clipboard Dialer I don‚Äôt know how to write and compile a proper app, but I like to think that I do know my way around PowerShell. And I think I‚Äôve come up with a very neat solution here.\nThe Teams Clipboard Dialer consists of a PowerShell script and a Desktop shortcut which calls that script. The script reads phone numbers from the clipboard, normalizes the number, and then passes it to Teams to start the call.\nAll you have to do to start a call is to copy a phone number and either click the icon on the taskbar or press the configured hotkey.\nIf your clipboard is empty or doesn‚Äôt contain a phone number, a notification will be shown.\nIf your clipboard does contain a phone number, Teams will launch and ask you to start the call.\nIt‚Äôs even possible to call 1‚Äì4 digit long extension numbers or emergency numbers. Because these numbers don‚Äôt start with a + the Teams tenant dial plan (if you have one configured) will still apply the normalization rules and convert the extensions to full E.164 numbers.\nAnd no, there‚Äôs no browser pop up. Teams is opened directly. Luckily, I remembered that I blogged about creating Teams calling deep links a while ago, so I already knew how to create calling deep links. The part about how I can open Teams directly (without the detour in Edge) and have it start a call, I figured out by mere luck.\n# Launch Teams to dial the number\nStart-Process ms-teams \u0026ldquo;https://teams.microsoft.com/l/call/0/0?users=4:$phoneNumber\"\nI‚Äôve only tested the Teams Clipboard Dialer on Windows 11 and Teams 2.1.\nSetup I also created an install script which copies the script to $env:APPDATA\\OneDrive\\TeamsClipboardDialer and creates a shortcut in $env:OneDrive\\Desktop¬†. Unfortunately, I didn‚Äôt find a way to automatically pin the app to the taskbar. When you run the script, you‚Äôll see a pop up message which will pause the script and give you time to pin the app manually to the taskbar.\nBy default, the hotkey Ctrl + Shift + F8 is assigned to launch the app and dial numbers. You can change this by running the Createshortcut.ps1 script with the parameter -HotKey \u0026quot;Your hotkey combo\u0026quot;¬†.\nYou can find all the files in my GitHub repo. Also make sure to read the script headers carefully for more information on the available parameters.\nIf you‚Äôre interested in what normalization rules are applied, you can examine the script here. Basically, it removes any special characters like whitespaces, brackets, hyphens, dots etc. from copied phone numbers and then also applies Ken Lasko‚Äôs rule to get rid of those damn illegal zeros. You can read more about it in detail here.\nBy applying the normalization rules outside of Outlook and Teams, we get more control over it since we can do whatever we want. I guess if Microsoft won‚Äôt let us match numbers starting with + any longer, we have to do it ourselves. Compared to the Teams Wizard, my solution gives us way more flexibility and visibility in terms of how numbers are normalized before they‚Äôre dialed.\nHold on‚Ä¶ I Am Not Done¬†Yet! When I realized that I was on to something, I just couldn‚Äôt let it go. I replicated the whole functionality in an iOS shortcut. I don‚Äôt know why but every time an Android Fanboy asks me why I prefer the iPhone over Android I forget to mention Shortcuts. It‚Äôs literally the most underrated feature of iOS.\nThe shortcut uses the exact same regular expressions as the PowerShell script to normalize the numbers. (Yes, that‚Äôs possible in Shortcuts.) It also gets the phone number from the clipboard and will display the same hints if there‚Äôs no phone number stored in the clipboard.\nOnce the number has been normalized, the Shortcut will ask you to start or cancel the call. On iOS this step is handled by the Shortcut and not in the Teams app itself like it is the case on the Teams desktop client.\nGet the¬†Shortcut You can download and import the Shortcut via iCould.\nI‚Äôve tested the shortcut on an iPad and an iPhone both running iOS/iPad OS 17.0.3. When you run it for the first time, you will need to confirm a couple of privacy prompts and allow it to run all the actions without asking again. After that, you‚Äôre good to go.\nShowtime This animated gif demonstrates how it works on iOS. The number has already been copied to the clipboard before the shortcut was executed.\nSummary When I first read the MC post about normalization rules no longer matching numbers starting with a + I panicked a little. But now that I‚Äôve done the research and came to the conclusion that having an app which normalizes and calls numbers from the clipboard, is actually a very nice and versatile solution and I‚Äôm very much relieved. And having the same functionality on iOS is an awesome bonus.\nI hope you like what I‚Äôve done and that you can make use of it as well. As always, all the code for the Teams Clipboard Dialer is provided free of charge. If you would still like to support my work, feel free to buy me a coffee over at GitHub Sponsors.\n","date":"2023-10-26T19:22:01.74Z","permalink":"https://heusser.pro/p/teams-clipboard-dialer-c5cb737f37f3/","title":"Teams Clipboard Dialer"},{"content":"Microsoft recently introduced a big update to call delegation in Microsoft Teams. The last substantial change was when Microsoft rolled out Set-CsUserCallingSettings and the possibility to change a Teams user‚Äôs call forwarding settings through Teams Admin Center.\nThe new features include the ability for delegates or delegators to pick up held calls or join active calls. There‚Äôs a small catch though. When a new delegate is added through TAC or PowerShell, permission to join active calls can‚Äôt be granted. It needs to be granted by the delegator itself or through the workaround I will teach you in this blog.\nIn TAC, it‚Äôs only possible to flip a toggle switch for Allow changing call settings. There‚Äôs no specific option for join or pickup calls yet.\nIt‚Äôs the same in PowerShell unfortunately.\nTest Scenario I‚Äôve added the user Bill Stearn as a delegate of Mike Wagner in this case. As Bill, I can view the granted permissions in his Teams client.\nHere we can see that Join active calls is disabled and greyed out because the delegate permissions were granted by an admin through TAC and not by the delegator himself.\nMike has set up Wendy Rhoades as an additional delegate. This delegate was added through TAC as well, so her permissions look exactly the same and she can‚Äôt enable Join active calls either.\nLet‚Äôs take a look at Mike‚Äôs call settings in Teams. From there, he would be able to enable the Join active calls permission for his delegates.\nHere‚Äôs the thing though. Because both delegates were granted the Allow changing call settings permission through TAC, they‚Äôre both allowed to change Mike‚Äôs call settings, which does in fact allow them to set the delegate permissions as well.\nIf you want to do Ninja IT and set up full delegate permissions without bothering Mike at all, you‚Äôll need to set up two delegates and they‚Äôll need to enable the missing permission of each other.\nLet‚Äôs see how Wendy would enable Bill to join Mike‚Äôs active calls. From Manage delegates she‚Äôll need to click on the three dots on Mike‚Äôs entry and select Change delegates.\nIn Mike‚Äôs delegate settings, she then has to click the three dots on Bill‚Äôs entry and select Edit permissions.\nThis will allow Wendy to enable Join active calls on Mike‚Äôs delegate permissions for Bill.\nIf Bill now goes back to view his delegate permissions for Mike, he can see that Join active calls was enabled.\nAs you can see, multiple delegates can help each other set up full delegate permissions for their shared boss without bothering them as long as at least one delegate is added by an admin through TAC.\nIf there‚Äôs only going to be one delegate, you can temporarily add your own Teams account as a delegate through TAC. Then you can use your own Teams client to add the real delegate with full permissions and remove your own account through TAC again.\nI hope that Microsoft will soon update TAC so that the new permission can be granted without the need of my workaround.\nNew Delegate User Interface Finally, here are some screenshots of how the new UI for call delegation works. Mike‚Äôs call settings are configured to also ring his delegates for these example calling scenarios.\nThe new delegate tabs in the Calls app are available in both the new and the old Teams client.\nDelegates can also see other people supporting the same person. In this case, Wendy can see that Bill is supporting Mike as well.\nAn inbound call which is intended for a delegator but forwarded to delegates will look like this.\nFor the record, this is how it looked in the old Teams client.\nThe new Teams client will also show an indicator for missed calls on a delegator‚Äôs line.\nJoin and Pick Up¬†Calls In this example, Mike (the delegator) accepted the call himself. Wendy can see that there‚Äôs an active call in Mike‚Äôs call tab. She can also see that the call is managed by Mike himself. If need be, she could join the call too.\nIf Mike puts the call on hold, Wendy can see that, and the Join button changes to a Resume button.\nOf course, the call cannot just be picked up by Wendy but by all of Mike‚Äôs delegates who have that permission. Or he could just resume the call himself.\nIn this example, Bill who is another delegate picked up the call and Wendy can see that Mike‚Äôs call is connected to Bill now.\nIf Mike decides to Join the call with the external caller and Bill, Wendy will be able to see that too, and she still has the option to join the three people who are already on the call.\nThis works in the opposite direction too. If Wendy answers a call which was forwarded to her by Mike and puts that call on hold, Mike will be able to pick up the call.\nAnd last but not least, delegates can also see the call history of their delegators and for example see when another delegate answered a call of their shared delegator.\nWrapping Up The new delegate features are a huge improvement and finally fill a big void in Microsoft Teams Phone. Everything is super easy and intuitive. The new Teams client is looking great as well, and I really like the style of the new calling notifications. The fact that missed calls on a delegator line are only visible in the new Teams client makes me believe that we‚Äôre going to see lots of calling related improvements in the new Teams over the next coming months. Exciting times lie ahead. The only thing that remains a little cumbersome is that you can‚Äôt grant the Join active calls permission through TAC or PowerShell yet. However, the workaround outlined in this article should do the trick until Microsoft adds official support in TAC and PowerShell.\n","date":"2023-09-18T08:28:01.644Z","permalink":"https://heusser.pro/p/pick-up-held-and-join-active-calls-for-boss-delegate-scenarios-in-microsoft-teams-4cb1d4965424/","title":"Pick Up Held and Join Active Calls for Boss/Delegate Scenarios in Microsoft Teams"},{"content":"Many companies have internal emergency response teams which often also have their own internal/local emergency number. Businesses usually want these numbers to be very prominently placed on a user\u0026rsquo;s computer, like in the taskbar, the start menu or on the desktop. What about Microsoft Teams though? Can we place a link to start a call to a phone number on the Teams side rail? (The left rail where all the apps like Activity, Chat, Teams, Calendar, Calls etc. are pinned.)\nFrom this blog post, we already know how to construct a deep link which starts a call to a phone number.\nWhen I was researching something entirely different, I stumbled over this interesting blog post from Tech Peanuts. When I read this article, I noticed that all that the author is doing is executing a Teams deep link to a tab in a Teams channel. I immediately asked myself if this would work with a Teams calling deep link too?\nThe answer is yes. To do this, we need two things:\nA Teams App Any kind of web server to host one or multiple html files Create and host the html¬†file(s) Let‚Äôs start with the web server. This can be any kind of platform or service that can host and serve a html file publicly. Tech Peanuts uses an Azure storage account in their tutorial. It makes total sense since it‚Äôs amazingly easy to create and configure a storage account from within VS Code. You can refer to their article to learn how to upload files to Azure Storage directly from VS Code.\nHere‚Äôs the html code we need to create a calling deep link. Just replace the phone number after 4:%2b with your phone number. %2b is a + sign in URL encoded format.\nPlease note that storing the number with a leading plus sign did not work in the new Teams client yet. I had to replace the + with 00 to get it working. Even though it doesn‚Äôt look as nice as the plus does, at least 00 is working in both the old and the new Teams client.\nIf you want this to work in the new Teams client as well, use the following link format:\nhttps://teams.microsoft.com/l/call/0/0?users=4:0041123456789\nThen upload the file to your web server of choice. If you have multiple locations with different emergency numbers, you can create multiple html files with different names and numbers. You can still upload them to the same location as the first file. There‚Äôs no need to create a separate storage account or web app for each html file/number.\nCreate the Teams¬†App Next, go to https://dev.teams.microsoft.com and sign in with a Teams admin account.\nGo to Apps and click + New app and give your app a name.\nNext, fill out the Basic information portion of the app. You can copy your App ID and paste it under Application (client) ID.\nThen go to App features and click on Personal app and then Create your first personal app tab. Fill in the details such as the tab name and the content URL. The content URL is the link to where your html file is hosted. If you have multiple files and don‚Äôt use an index.html file, the url must be an absolute path. Set the scope to personal and the context to personalTab and confirm.\nSave your tab app.\nThat‚Äôs it. If you want to, you can click Preview in Teams if you want to test it in the Teams web client.\nIf you want to test it in the Teams client, click on Publish and then Download the app package.\nIn Teams, go to Apps, Manage your apps and then select Upload an app to upload your app.\nNote: Your admin must allow sideloading apps for this.\nSee it in¬†Action Now you have an app in the siderail which can start a call. The only thing that‚Äôs left to do is to publish the app in your tenant.\nIf you‚Äôve never published an app in Teams before, I suggest starting with this Microsoft Learn article. If you only have one location, it will be fairly easy to add the app just to the global app setup policy.\nIf you have multiple offices in different locations or countries, it will be a little more complex. You will need to create a separate app for each number and then also create and assign different Teams app setup policies to the users based on their location. Each policy will then pin a different app where each app will ultimately link to a different html file (containing a different phone number) on your web server.\nSummary I think it‚Äôs really cool that we can leverage Teams deep links to pin different actions in Teams to the side rail instead of just normal apps. I really hope that Microsoft will fix the bug where the leading plus is not recognized in deep links. It not only looks bad, but it also causes calls to file.\nWhile pinning emergency numbers might be the most obvious use case, you could use this for any number. I could also see some companies wanting to pin their IT service desk hotline to the side rail for example.\nOne last thing I want to mention is to keep in mind that the phone number you put in the html file can theoretically be viewed/obtained by anybody with internet access. Of course, you must know the URL to access it but that probably won‚Äôt protect it from web scrapers or other data gathering tools. However, since your company‚Äôs main number is probably listed on your home page anyway, I don‚Äôt see too big of a risk here.\nIf you do think it‚Äôs a risk, Anthony Drozdek might just have the solution for you. He suggests using a fake number, e.g. +4199... which is then translated into the real number using a Teams dial plan. You can read the original comment here.\n","date":"2023-09-10T11:08:37.549Z","permalink":"https://heusser.pro/p/how-to-pin-an-phone-number-to-the-teams-side-rail-539a230a55c7/","title":"How to Pin a Phone Number to the Teams Side Rail"},{"content":"I‚Äôve been assigning phone numbers in Teams for pretty much five years now. I remember when it all started for me with Direct Routing in 2018.\nNumbers were assigned by using something like this:\nSet-CsUser -Identity \u0026quot;user@domain.com\u0026quot; -OnPremLineUri \u0026quot;tel:+12345678900\u0026quot; -EnterpriseVoiceEnabled $true¬†. Later on, OnPremLineUri was replaced by the LineUri attribute before Microsoft finally introduced the new Set-CsPhoneNumberAssignment cmdlet.\nI don‚Äôt know how many phone numbers I‚Äôve assigned in Teams over the years but one thing I know for sure is that I‚Äôve had my fair share of assignment failures. Granted, it‚Äôs gotten way better and more reliable in recent years, but sadly, I still run into number assignment issues occasionally.\nBy assignment issues I mean that after a number has been assigned to users, they either don‚Äôt receive inbound calls, can‚Äôt make outbound calls or both. The nasty thing about this is that in Teams Admin Center or PowerShell everything looks ok. I can see that the users in question indeed have a phone number assigned.\nIn other words, you can‚Äôt always trust that a number is successfully assigned when you can see it in TAC or in PowerShell.\nBut when you check a user‚Äôs calls app in Teams or ask them to send you a screenshot of it, you notice that they don‚Äôt have a work phone number listed beneath the dial pad.\nNow obviously there are legit scenarios where users don‚Äôt have their own LineUri but in most cases, each user gets assigned a phone number.\nThis is how it‚Äôs supposed to look after a number has been assigned.\nThis is very much undocumented, but I believe that the Teams client and TAC/PowerShell are reading/pulling the number from different systems. It has to be this way since they both display different information.\nIf you‚Äôre setting up Teams phone for a bunch of users at once, it‚Äôs not like we can just go and ask each user if they can see the number in their Teams client. That would make IT look bad. On the other hand, trying to assign the number a few more times until it hopefully sticks doesn‚Äôt seem like an ideal solution either.\nReverse Number Lookup (RNL) to validate the assignment As you might know, I run a Discord Server for Teams Phone Admins. When the issue reoccurred for me earlier this year, I decided to ask the Discord community if they have a clever way of remotely checking if a phone number assignment has been successful?\nOur member Ashish Mishra suggested to type in the number in my own Teams client to see if anything comes up on the RNL (reverse number lookup). As it turns out, this is a genius idea.\nLast week, I stumbled over this issue again when a few users who have recently gotten a new Teams phone number reported to me that outbound calls were not working. Luckily, there were only a handful, and I was able to ask them directly if they could see the phone number in Teams. They couldn‚Äôt.\nI then went on to my Teams client and entered some of the numbers to see if they return anything or not.\nIf the number is not successfully (or not at all) assigned, only the number but no name will be returned.\nAs soon as the number is successfully assigned, the name of the user will be returned.\nBecause I‚Äôve encountered the issue before, I didn‚Äôt even bother to check the M365 service health dashboard. But apparently, there was indeed an issue related to numbers assigned during a time frame which matched my errors.\nTitle: Users can‚Äôt make or receive Public Switched Telephone Network (PSTN) calls in Microsoft Teams\nUser impact: Users couldn‚Äôt make or receive any PSTN calls from any connection method of Microsoft Teams.\nMore info: This only impacted users who had their phone numbers assigned between Monday, August 14, 2023 at 10:30 PM GMT+2¬†, and Wednesday, August 16, 2023 at 4:00 AM GMT+2.\nIn that particular case, I was able to fix the issue by reassigning the numbers. But that didn‚Äôt stop me from looking for a more practical, permanent solution.\nReverse engineering Once again, we go back to Microsoft Edge‚Äôs dev tools to see what‚Äôs going on when RNL is done. All it does is to send a request to the following endpoint:\nhttps://teams.microsoft.com/api/mt/emea/beta/phone/numbers/+41438833079/teamsidentity If there is a user found for the phone number, a user object Id will be returned.\nIf no users are found, the API returns an error.\nIt‚Äôs noteworthy that only numbers assigned in a user‚Äôs own tenant can be checked. You can‚Äôt use this API to scrape numbers of other tenants.\nIf we want to send these kinds of requests using PowerShell, we obviously need to get a valid bearer token first. For this, we can reuse much of the code I‚Äôve already written for this blog post. We‚Äôre using the same function to either create or read our encrypted credentials which we then use to get a token using the AADInternals PowerShell module/functions.\nPlease note that you don‚Äôt need the credentials of a Teams admin user. Since any Teams enterprise voice enabled user can dial a number and trigger RNL, non-admin credentials of any Teams phone enabled user work just fine.\nWhat‚Äôs interesting is that doing RNL through the API also worked using the bearer token of a user which isn‚Äôt even enterprise voice enabled.\nPlease bear in mind that this means that a user‚Äôs password and possibly an OTP secret (albeit both encrypted) are saved to your local disk. Treat the files with care and remove them once you don‚Äôt need them anymore!\nThe Script/Functions Finally, here‚Äôs the PowerShell code to make it all happen.\nPlease make sure that you clone the repository from my GitHub because of the dependencies. Simply copying the script from the gist won‚Äôt work.\n1 2 # Run this in PowerShell to clone the repository git clone https://github.com/mozziemozz/TeamsPhoneAutomation.git I made this in a way that you can use it in your own scripts. I purposely made this a lightweight function without any requests to Teams or Graph.\nI did, however, create an example script to show you how you can use the function to validate phone number assignments in bulk.\nIf you want to read users/numbers from a CSV or directly from Teams/Graph, you‚Äôll need to write your own code to build the $lineURIs array.\nUse -AdminUser to specify the user you want to get a Teams token for via the AADInternals module. Use either -MFA $true or -MFA $false to tell the function if the account specified is MFA enabled or not.\nThe example script will create an object in $results which includes all the checked phone numbers and if they‚Äôre assigned successfully. If a number is assigned correctly, the object id of the user will be included as well if you keep $hideObjectId $false.\nThe actual function doing the RNL can be found here.\nI hope that this bit of code helps you the next time you need to check if a Teams phone number is assigned 100% correctly.\n","date":"2023-08-25T12:22:29.179Z","permalink":"https://heusser.pro/p/how-to-validate-phone-number-assignments-in-teams-in-bulk-8a0909c7b5f5/","title":"How to Validate Phone Number Assignments in Teams (in Bulk)"},{"content":"\nWith the MicrosoftTeams PowerShell module version 5.4.0. Microsoft has added the possibility to set the emergency location on unassigned numbers.\nTypically, whenever new numbers are bought or ported to Microsoft, an admin needs to specify the emergency address which should be assigned to the new numbers. In some cases, this process can fail which means that you could end up with user/subscriber numbers which don‚Äôt have an emergency address linked to it.\nWhen you try to assign a number wich does not have an emergency location assigned, you‚Äôll get an error, and you need to assign it again, including the -LocationId¬†.\n1 Set-CsPhoneNumberAssignment -PhoneNumber $number.TelephoneNumber -LocationId $matchingEmergencyLocationId This is an operational risk since scripts that may have been working fine for months suddenly stop working properly for certain numbers and new users could end up without a phone number. To mitigate this risk, it‚Äôs best to make sure that all your numbers have an emergency address linked to them from the get-go.\nUp until now, the only way to solve this issue was to create a case for Microsoft‚Äôs PSTN service desk team and ask them to assign a location Id to your unassigned number.\nPreviously, I‚Äôve tackled this issue by making sure that my scripts checked if the number was assigned successfully. If it wasn‚Äôt I made sure that the number got assigned again including the location Id.\nI also thought about creating a dummy user and a script which I could (mis)use. The script would get all unassigned numbers which don‚Äôt have a location Id assigned and processes all numbers after each other. Each time, the user‚Äôs usage location would be set to the country of the current number, the number would be assigned to the dummy user including the location Id and then unassigned again. However, that sounded like a waste of time to me, so I never pursued that idea.\nThe possibilities now are much better, and the recent update allowed me to create a simple script which makes sure that all unassigned numbers also have a location Id assigned.\nPlease note that the script assumes that there‚Äôs only ever 1 emergency address per city and that there‚Äôs at least 1 other number which already uses the correct emergency address.\nIf your environment does not meet the above criteria, you can‚Äôt use this script without tailoring it specifically to your needs. Use it at your own risk!\nAlso note that you need to clone or download the GitHub repo since it depends on other functions present in the repo.\nI hope this helps you in streamlining and optimizing your phone number inventory.\n","date":"2023-08-11T16:23:20.709Z","permalink":"https://heusser.pro/p/powershell-script-set-emergency-location-for-unassigned-numbers-in-teams-5e00c61b4246/","title":"PowerShell Script: Set Emergency Location for Unassigned Numbers in Teams"},{"content":"Did you know that you can create new Microsoft 365 Group in six and a new Microsoft Teams Team in four different places? And I‚Äôm not even counting PowerShell‚Ä¶\nToday, I‚Äôm going to show you the differences in default settings when a Group/Team is created from a different place and what impact it could have.\nLet‚Äôs start with all the different admin portals and clients a Microsoft 365 Group can be created in.\nEntra ID Admin Center M365 Admin Center Exchange Admin Center Teams Admin Center SharePoint Admin Center Teams Client The bold ones are the ones where we can also create a Team alongside the Group.\nAs we all know, every Team includes a ‚Äúsurrounding‚Äù Microsoft 365 Group to manage access to the Team. You can have a Microsoft 365 Group without a Team, but you can‚Äôt have a Team without an associated Microsoft 365 Group.\nEntra ID Admin¬†Center If you create a new M365 Group in Entra ID, you won‚Äôt have the option to add a Team to the group during the creation process. The only reason why you‚Äôd want to use Entra ID to add an M365 Group with a Team is if you want to use a dynamic group. Entra ID is the only GUI where you can create dynamic M365 Groups. Also, you can‚Äôt configure the group‚Äôs visibility upon creation of the group. It has to be manually changed in M365 Admin Center after the group has been created in Entra ID.\nM365 Admin¬†Center If you create the M365 Group from the M365 Admin Center, the group‚Äôs visibility will default to PUBLIC, and you‚Äôll need to provide the group‚Äôs email address manually. The checkbox for Create a team for this group is enabled by default.\nExchange Admin¬†Center Creating the group from the Exchange Online Admin Center does essentially the same thing as creating it from the M365 Admin Center. The only difference is that you‚Äôll be able to create a Dynamic distribution group from Exchange. This option is not available in M365 Admin. However, M365 Admin Center allows you to create Security groups while the Exchange Admin Center won‚Äôt.\nTeams Admin¬†Center In Teams Admin Center, the default visibility/privacy is set to Private. Like in Entra ID, the email address of the M365 Group is also created for you with no option to change it during the creation process.\nSharePoint Admin¬†Center When you create a new Team Site in SharePoint Admin Center, a new Microsoft 365 Group is created as well. The group‚Äôs email address is set automatically and the default option for the visibility is private. In this case, you can adjust the group‚Äôs email address, if you want to.\nCreating the group from SharePoint Admin Center does not create a Team automatically. A Team can be added to the group in the Microsoft 365 Admin Center after the Team Site has been created.\nTeams Client In Teams Client, things look a little bit different. First, you need to decide whether you want to start from scratch or from another group or team. There are also some basic templates available.\nI chose From scratch for this blog post. Next, you‚Äôll be asked if you want to create a Private, Public or Org-wide Team. I tested all 3 types and all of them created a new M365 Group with the same settings. The group is always assigned, not even the Org-wide Team is created as dynamic group. The email address is derived from the Team name too, without the option to customize it during the creation process. The most important thing to note here is that if you create a Team from Teams itself, the group will be hidden in Outlook clients by default.\nComparison Chart I‚Äôve created a table which tells you what settings/defaults are applied for Teams created in each location.\nI think all the above except OwnerAddedAsMember and OwnerIsPartOfTeamWhileNotAMember should be self-explanatory.\nEvery group has owners and members. Owners are typically also members, but members don‚Äôt necessarily have to be owners as well.\nIf you add certain users only as an owner, they won‚Äôt be added to the group\u0026rsquo;s members unless you create the Team from Teams Admin Center or from the Teams Client. (OwnerAddedAsMember).\nHowever, even if they‚Äôre just owners, they can still see the Team in Teams (OwnerIsPartOfTeamWhileNotAMember).\nExample: Team Created in M365 Admin Center\nIf we compare this Team to one created in Teams Admin Center, we can see that it looks exactly the same in Teams.\nHowever, in M365 Admin Center we can see that the user is both an owner and a member of the group.\nTeams will display each user only once, under the highest privilege a user has while M365 Groups list owners and members separately, even if it‚Äôs the same user account.\nVoice Enabled Channels¬†Caveat For normal Teams usage, it shouldn‚Äôt be a problem if an owner is not also a member. However, there is one important thing to mention. If an owner is not also a member and the owner is part of a Team which is used for a Voice Enabled Channel in Teams, the owner won‚Äôt be added to the queue‚Äôs agent list, unless the owner is added explicitly as a member too.\nI‚Äôve linked a Team which I created from M365 Admin Center to this call queue. During the creation, I‚Äôve only added 1 owner and no members.\nWhen we check the call agents of this queue, we can see that it says zero.\nWhen I add the owner also as a member of the group in M365 Admin Center and save the queue again, we can see that it now has one call agent.\nYou can read more about Voice Enabled Channels and Call Queue Agent Lists here and here.\nWhere to Create New¬†Teams? So where is it best to create new Teams? Sadly, the answer is: It depends. The first question you should ask yourself is if the membership needs to be assigned or dynamic. If it should be dynamic, you must create it from Entra ID. Otherwise, there is no clear winner here. Each portal does it slightly different which creates unwanted and most likely also unnoticed differences in M365 Group settings. If you want to be consistent across all your Teams and Groups, I recommend defining one or multiple standards and then creating a PowerShell script which creates new Teams and Groups according to your needs.\nPowerShell Cheat-Sheet for M365¬†Groups Since we‚Äôve now learned that creating Groups or Teams from different Admin Centers can have different effects, I put together a little PowerShell cheat-sheet containing some handy one-lineres to help you quickly adjust M365 Group settings. Since these settings are applied to the M365 Group and not to the Team, they all require the Exchange Online PowerShell Module which can be installed using this code.\n# Install Module\nInstall-Module -Name ExchangeOnlineManagement\n# Connect to Exchange Online\nConnect-ExchangeOnline\nTo store the group object in $group we simply need to query a group like this.\n# Get group properties\n$group = Get-UnifiedGroup -Identity TeamCreatedinTACPublic@mvplab.ch\nTo disable the welcome email, which is sent to new group members, use this code.\n# Disable welcome message for new group members\nSet-UnifiedGroup -Identity $group.Identity -UnifiedGroupWelcomeMessageEnabled $false\nIf a Team has been created in the Teams Client, you can use this code to unhide the group from Outlook.\n# Unhide group from Outlook clients\nSet-UnifiedGroup -Identity $group.Identity -HiddenFromExchangeClientsEnabled:$false\nTo allow external email addresses to send emails to the group email address, use this code.\n# Enable let people outside this organization email this group\nSet-UnifiedGroup -Identity $group.Identity -RequireSenderAuthenticationEnabled:$false\nTo change the privacy of a group use either Private or Public as a value for the -AccessType parameter.\n# Change access type to private\nSet-UnifiedGroup -Identity $group.Identity -AccessType \u0026ldquo;Private\u0026rdquo;\nTo keep owners and members in sync or rather to make sure that all owners are added as members too, you can use this code.\n# Add group owners to group members if not already there\nConnect-MgGraph\n$group = Get-MgGroup -GroupId \u0026ldquo;\u0026rdquo;\n$groupOwners = Get-MgGroupOwner -All -GroupId $group.Id\n$groupMembers = Get-MgGroupMember -All -GroupId $group.Id\nforeach ($groupOwner in $groupOwners | Where-Object {$_.Id -notin $groupMembers.Id}) {\nNew-MgGroupMember -GroupId $group.Id -DirectoryObjectId $groupOwner.Id }\nNote: This uses the Microsoft.Graph.Groups PowerShell module and not ExchangeOnlineManagement.\nClosing Words I hope that this article and the comparison chart help you to better understand why some groups might have different settings than others. I also recommend to always add all owners as explicit members too, whenever you assign owners to a group. Hopefully, the last code snippet will make things easier for you to accomplish this.\n","date":"2023-08-07T13:10:37.649Z","permalink":"https://heusser.pro/p/everything-you-ever-wanted-to-know-about-creating-teams-and-microsoft-365-groups-cc069d920d43/","title":"Everything You Ever Wanted to Know About Creating Teams and Microsoft 365 Groups"},{"content":"Warning: This is another one of those proof of concept ‚Äúbecause I can‚Äù kind of things. I‚Äôm going to do some things which shouldn‚Äôt be done in production. It was just for the fun of it.\nMicrosoft recently released the new Work location feature in Teams and the new Outlook/Outlook on the web. This allows users to set their work location so co-workers can see if their colleagues are working in the office or remotely on any specific day. You can find more information here and here.\nI was extremely disappointed when I learned that there is no support for Microsoft Graph or Power Automate yet, so we could automatically set this each day based on e.g., an IP address or even through geo-fencing on a mobile device.\nOff I went to try and find a way to do it anyway. First, I opened Teams in Microsoft Edge and used the browser dev tools to see what kind of requests are sent to which APIs when the work location is changed.\nHere we can see that a PUT request is made to https://presence.teams.microsoft.com/v1/me/workLocation when the location is edited.\nIn this case the location was cleared with the following JSON payload.\nThe value 0 clears the location. 1 is used to set it to Office and 2 will map to Remote.\nNext, I inspected the token needed for this request with the help of jwt.ms.\n{ \u0026quot;typ\u0026quot;: \u0026quot;JWT\u0026quot;, \u0026quot;nonce\u0026quot;: \u0026quot;xxxxxxxxxxxxxxxxxxxxxxxxx\u0026quot;, \u0026quot;alg\u0026quot;: \u0026quot;RS256\u0026quot;, \u0026quot;x5t\u0026quot;: \u0026quot;-xxxxxxxxxxxxxxxxxxxxxxxxx\u0026quot;, \u0026quot;kid\u0026quot;: \u0026quot;-xxxxxxxxxxxxxxxxxxxxxxxxx\u0026quot; }.{ \u0026quot;aud\u0026quot;: \u0026quot;https://presence.teams.microsoft.com/\u0026quot;, \u0026quot;iss\u0026quot;: \u0026quot;https://sts.windows.net/4bffbf87-53a0-4fce-b58b-4179cb3a3b7d/\u0026quot;, \u0026quot;iat\u0026quot;: 1688763565, \u0026quot;nbf\u0026quot;: 1688763565, \u0026quot;exp\u0026quot;: 1688841846, \u0026quot;acr\u0026quot;: \u0026quot;1\u0026quot;, \u0026quot;aio\u0026quot;: \u0026quot;xxxxxxxxxxxxxxxxxxxxxxxxx\u0026quot;, \u0026quot;amr\u0026quot;: [ \u0026quot;pwd\u0026quot;, \u0026quot;mfa\u0026quot; ], \u0026quot;appid\u0026quot;: \u0026quot;5e3ce6c0-2b1f-4285-8d4b-75ee78787346\u0026quot;, \u0026quot;appidacr\u0026quot;: \u0026quot;0\u0026quot;, \u0026quot;family_name\u0026quot;: \u0026quot;Mozz\u0026quot;, \u0026quot;given_name\u0026quot;: \u0026quot;Mozzie\u0026quot;, \u0026quot;ipaddr\u0026quot;: \u0026quot;xxx.xxx.xxx.xxx\u0026quot;, \u0026quot;name\u0026quot;: \u0026quot;Mozzism Admin\u0026quot;, \u0026quot;oid\u0026quot;: \u0026quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\u0026quot;, \u0026quot;puid\u0026quot;: \u0026quot;10032000330C6A66\u0026quot;, \u0026quot;rh\u0026quot;: \u0026quot;xxxxxxxxxxxxxxxxxxxxxxxxx\u0026quot;, \u0026quot;scp\u0026quot;: \u0026quot;user_impersonation\u0026quot;, \u0026quot;sub\u0026quot;: \u0026quot;xxxxxxxxxxxxxxxxxxxxxxxxx\u0026quot;, \u0026quot;tid\u0026quot;: \u0026quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\u0026quot;, \u0026quot;unique_name\u0026quot;: \u0026quot;mozzie@mozzism.ch\u0026quot;, \u0026quot;upn\u0026quot;: \u0026quot;mozzie@mozzism.ch\u0026quot;, \u0026quot;uti\u0026quot;: \u0026quot;xxxxxxxxxxxxxxxxxxxxxxxxx\u0026quot;, \u0026quot;ver\u0026quot;: \u0026quot;1.0\u0026quot;, \u0026quot;xms_cc\u0026quot;: [ \u0026quot;CP1\u0026quot; ], \u0026quot;xms_ssm\u0026quot;: \u0026quot;1\u0026quot; }.[Signature]\rAADInternals Copying the token from the browser and using it to make a web request with PowerShell is easy. The hard thing was to figure out how I can obtain that token programmatically. Luckily, there‚Äôs this awesome PowerShell module called AADInternals by one Dr. Nestori Syynimaa. This is an amazing resource to test almost anything related to Azure AD and Graph authentication.\nThe documentation for this module can be found here. I discovered that the following command would give me a token for Teams.\n1 $teamsToken = Get-AADIntAccessTokenForTeams What‚Äôs really cool is that now, with PowerShell 7 the whole login process can be done through the CLI without any browser pop-ups! Even MFA is supported!\nEven though the audience for this token is https://api.spaces.skype.com and not https://presence.teams.microsoft.com it still works to change the work location in Teams.\nBecause everything can be done through the CLI I wondered if I could pass the credentials and the MFA secret to the AADInternals functions so that the login process could be automated to be 100% unattended.\nAfter some trial and error, I had that figured out too. Not all functions of the AADInternals module are exposed to the user so the key is to make them available to your current PowerShell session by dot sourcing some of the *.ps1 files included in the module.\n1 2 3 4 5 6 7 8 9 $functions = Get-ChildItem -Path \u0026#34;C:\\\\Program Files\\\\WindowsPowerShell\\\\Modules\\\\AADInternals\\\\0.9.0\u0026#34; -Filter \u0026#34;\\*.ps1\u0026#34; $functions = $functions | Where-Object {$\\_.Name -match \u0026#34;Teams\u0026#34; -or $\\_.Name -match \u0026#34;AccessToken\u0026#34; -or $\\_.Name -match \u0026#34;CommonUtils\u0026#34;} foreach ($function in $functions) { . $function.FullName } By executing this code which uses some of the not exposed functions from AADInternals, we can pass a credential object (and MFA secret) and then get an access token to write Teams presence.\n1 $teamsPresenceToken = Prompt-Credentials -ClientId $ClientId -Resource \u0026#34;https://presence.teams.microsoft.com\u0026#34; -Credentials $secureCreds -OTPSecretKey $passwordDecrypted Credentials I‚Äôve put together a script which does everything for you. However, you must install the AADInternals module first and you also need to clone the repo from my GitHub account since it has dependencies on other functions.\n1 git clone https://github.com/mozziemozz/TeamsPhoneAutomation.git Even though this was all part of some good Friday night hacking, we obviously don‚Äôt want to store the credentials and especially the MFA secret as plain text on our machines. Therefore, I‚Äôve added a couple of functions to help handle encrypted credentials. We want to be better than UBER.\nWhen encrypted credentials are stored on a Windows PC, they can only be decrypted using the same account and the same machine because of security identifiers (SID).\nIf you don‚Äôt trust me, see for yourself. Here‚Äô I‚Äôm retrieving the password I encrypted on my main PC using my user account.\nI copied the file to a virtual machine where I‚Äôm logged in with the same user. This code will let you decrypt the password if the key matches.\n(I found this code years ago, unfortunately I don‚Äôt have the source anymore‚Ä¶)\n[Runtime.InteropServices.Marshal]::PtrToStringAuto([Runtime.InteropServices.Marshal]::SecureStringToBSTR((Get-Content -Path .\\.local\\SecureCreds\\mozzie@mozzism.ch.txt | ConvertTo-SecureString))) | Out-String\rWhen I run this on another machine with the same logged in user, I get an error that the Key is invalid. Which is good.\nMy Function Get-MzzSecureCreds will automatically create a PS Credential Object when -AdminUser \u0026quot;user@domain.com\u0026quot; is specified. The username will be set as file name, and it will also be used as the username of the credential object.\nThe Final¬†Script Here‚Äôs the script to change your work location in Teams.\nIf you run it for the first time, you‚Äôll need to provide the username and password and possibly the MFA secret of the user for which you want to change the work location.\nAt this point I want to make clear again that this is a proof of concept. Even though the credentials are encrypted, you should not store production passwords on the device and most importantly, you shouldn‚Äôt store the MFA secret in the same place as the password.\nYou can determine if you‚Äôre working remotely or in the office by specifying either your local or public home/remote IP address.\nSince my private IP is 192.168.127.117, and I specified 192.168.1.10 my work location is set to Office.\nWhen I change the IP address to 192.168.127.117 the work location is set to remote because that matches my local subnet.\nIn case your office and your home network both use the same private address space, you can use -IpType Public and specify your home/remote public IP.\nThe Result The updated work location is then visible in both Teams and Outlook.\nEven though I won‚Äôt be using this in production, I had great fun developing this and I also learned a thing or two about AADInternals, Json Web Tokens and encrypted credentials in PowerShell.\n","date":"2023-07-08T08:50:29.101Z","permalink":"https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/","title":"Automate Setting Work Location in Teams/Outlook [PoC]"},{"content":"I am a very data and fact driven guy. I strongly believe that clean, consistent and structured data is a tremendously important aspect of information technology.\nAn example of inconsistency to which probably most Teams Phone admins can relate is that there is no relation between a Teams user‚Äôs LineURI and the BusinessPhones property of the same user in Azure AD.\nThe problem is that throughout Microsoft 365 only the values in Azure AD are published on profile cards. This includes Teams and Outlook. A different phone number in Azure AD than in Teams can create all kinds of problems. Inbound calls might not get routed to a Teams user or calls may be transferred to a wrong user if a call is placed via the number available on a profile card.\nHere‚Äôs an example of a profile card which shows the user‚Äôs phone number from Azure AD.\nIf we check the same user in Teams Admin Center, we can see that he has a different LineURI.\nWhen it comes to phone numbers in Teams, I view the LineURI as the single source of truth. Writing a simple script which mirrors the LineURI to Azure AD seemed like an easy task.\nBut then I realized that I can only get the raw value of the LineURI which doesn‚Äôt include any spaces which makes it hard to read or spell on profile cards.\nWhile the phone number is displayed nicely formatted according to the local and regional format in TAC or in the Teams Client, it looks like this in PowerShell.\nThe Teams Client also displays the number in the correct format.\nI started to dig around in the browser dev tools to try and see if I could find these formatted numbers anywhere. Not luck. I could only ever find the raw values. I did some more research and learned that there are a couple of already existing and well-established libraries for various programming languages such as Python or Node.JS.\nA few years ago, I made some attempts to learn the basics of Python but since I never really used it in real life, I kind of forgot everything. Thanks to ChatGPT I then learned that it‚Äôs actually possible to run python code inline in any PowerShell script. Good for me.\nNow I have a neat little script which not only copies the LineURI of all Teams Phone users to Azure AD, but it also prettifies them in the same way as TAC and the Teams client do!\nThe Script Note: The script has only been tested on Windows 11 using Python 3.11.1.\nPrerequisties Install Python on your machine Run the following command to install the phonenumbers library python -m pip install phonenumbers Clone the repository from my GitHub account¬†git clone [https://github.com](https://github.com)/mozziemozz/TeamsPhoneAutomation.git Make sure that the MicrosoftTeams and Microsoft.Graph PowerShell modules are installed Code This is the script. It connects to Teams and Graph, gets all Teams users with a LineURI and then prettifies each LineURI before it‚Äôs set on the user‚Äôs BuinessPhones property in Azure AD.\nIf you prefer connecting via Azure AD Service Principal, there‚Äôs also a version in the repo which supports that.\nKeep in mind that you need to make sure that your App has all required graph scopes added and consented and that the Service Principal is also assigned the Skype for Business Online Administrator role in Azure AD. For more information on how to set up and automated runbook, please refer to this article.\nResult The output of the script will look like this.\nAs we can see, the phone number of the Azure AD user object has now been changed to the same number as it is in Teams. For better readability and aesthetics, spaces have been added where users would expect them for a phone number from the respective region.\nUnfortunately, it can take multiple days until updated phone numbers are visible in Teams or Outlook due to heavy client-side caching.\nI hope that this script helps you to keep LineURIs and BusinessPhones in Azure AD in sync or that you can even use it to automate that process.\n","date":"2023-07-06T22:30:04.963Z","permalink":"https://heusser.pro/p/prettify-and-sync-teams-phone-numbers-to-azure-ad-e973755f83d5/","title":"Prettify and Sync Teams Phone Numbers to Azure AD"},{"content":"Working with Microsoft 365 and Azure AD licenses and understanding them can be quite the task for many system administrators. Did you know that the official Microsoft Learn article lists more than 3230 different SKU IDs and names as of June 1st 2023?\nThe problem is that Graph or PowerShell Modules never return a product name that actually means something to an admin. The names you‚Äôll see there are not the same ones we‚Äôre used to from the Azure or M365 Admin Portals.\nLet‚Äôs take a look at what the subscribedSkus Graph Endpoint returns.¬†This is how we get a list of all SKUs a tenant is subscribed to.\n1 $licenseSkus = Invoke-RestMethod -Method Get -Headers $Header -Uri \u0026#34;https://graph.microsoft.com/v1.0/subscribedSkus\u0026#34; Obviously, most tenants have many different SKUs. For the sake of simplicity, I‚Äôll just show the details of the last entry returned by Graph.\nPS C:\\Temp\\\\GitHub\\TeamsPhoneAutomation\u0026gt; $sku = $licenseSkus.value[-1] PS C:\\Temp\\\\GitHub\\TeamsPhoneAutomation\u0026gt; $sku accountName : company accountId : 4bffbf87-53a0-4fce-b58b-xxxxxxxxxxxx appliesTo : User capabilityStatus : Enabled consumedUnits : 7 id : 4bffbf87-53a0-4fce-b58b-xxxxxxxxxxxx_18181a46-0d4e-45cd-891e-60aabd171b4e skuId : 18181a46-0d4e-45cd-891e-60aabd171b4e skuPartNumber : STANDARDPACK subscriptionIds : {3474312c-2333-47bc-9d87-da1cfcb75f85} prepaidUnits : @{enabled=9; suspended=0; warning=0} servicePlans : {@{servicePlanId=a82fbf69-b4d7-49f4-83a6-915b2cf354f4; servicePlanName=VIVAENGAGE_CORE; provisioningStatus=PendingProvisioning; appliesTo=User}, @{servicePlanId=199a5c09-e0ca-4e37-8f7c-b05d533e1ea2; servicePlanName=MICROSOFTBOOKINGS; provisioningStatus=Success; appliesTo=User}, @{servicePlanId=b76fb638-6ba6-402a-b9f9-83d28acb3d86; servicePlanName=VIVA_LEARNING_SEEDED; provisioningStatus=Success; appliesTo=User}, @{servicePlanId=db4d623d-b514-490b-b7ef-8885eee514de; servicePlanName=Nucleus; provisioningStatus=Success; appliesTo=Company}...}\rThe skuPartNumber is what Microsoft calls String ID on their learn article. As we all know, Microsoft is no stranger to changing or rebranding product names. I have never seen them change an skuPartNumber though. Even though we can count on that name staying the same, it most likely won‚Äôt mean much to most people. Now what the heck is a STANDARDPACK!?\nA quick search on the Microsoft Learn article will do the trick and give us the desired information. STANDARDPACK = Office 365 E1.¬†But there‚Äôs a better way!\nWhat‚Äôs really nice is that Microsoft also provides a download link to a CSV file which contains all the SKUs, Ids and names. If it can be downloaded by using a browser, it can also be downloaded by PowerShell.\nAll we need to do is Invoke-RestMethod and use | ConvertFrom-CSV to convert the retrieved content to a PowerShell object.\n1 $translationTable = Invoke-RestMethod -Method Get -Uri \u0026#34;https://download.microsoft.com/download/e/3/e/e3e9faf2-f28b-490a-9ada-c6089a1fc5b0/Product%20names%20and%20service%20plan%20identifiers%20for%20licensing.csv\u0026#34; | ConvertFrom-Csv The SKU information retrieved by graph is already in our $sku variable. So, all that‚Äôs left to do is a simple one-liner to search the $translationTable.GUID for a matching $sku.skuId¬†.\n1 $skuNamePretty = ($translationTable | Where-Object {$\\_.GUID -eq $sku.skuId} | Sort-Object Product\\_Display\\_Name -Unique).Product\\_Display\\_Name This will translate the skuPartNumber to the familiar License name known from the admin portals.\nPS C:\\Temp\\GitHub\\TeamsPhoneAutomation\u0026gt; $skuNamePretty Office 365 E1\rI‚Äôve put all the above code snippets together and created a little more sophisticated, yet still very basic script which will output a table with all the available license names. Please note that you‚Äôll need an existing Azure AD App Registration/Service Principal which has at least the Organization.Read.All Graph permission.\nThe output will look like this.\nAs far as I understand, the download URL of the CSV should not be changed once a new version is uploaded. I verified this by viewing GitHubs commit history for that article.\nAs you can see, even though the date in the note was updated, the URL stayed the same. That‚Äôs why it should be safe to assume that we won‚Äôt need to update that URL in any script where we download that list.\nIf you‚Äôre wondering what my use case for this was‚Ä¶ I was creating an Azure runbook which monitors remaining free licenses and sends alerts to a Teams channel in case any of the licenses fall below a certain threshold. Obviously, I wanted to mention the well-known license name and not the string ID returned by Graph on the messages sent to Teams. Thanks to the CSV file hosted by Microsoft my scripts can now always grab the latest data and use that to transalte any license GUID into something more recognizable.\nI hope that this helps you too create more robust and better scripts when you need to deal with licensing in MS Graph or PowerShell.\n","date":"2023-06-02T19:57:48.615Z","permalink":"https://heusser.pro/p/translate-microsoft-365-license-guids-to-product-names-in-powershell-e8fa373ace16/","title":"Translate Microsoft 365 License GUIDs to Product Names in PowerShell"},{"content":"When configuring call flows in Microsoft Teams, one question I hear a lot is if a call can be forwarded to multiple external numbers at the same time.\nThis most likely applies to after-hours on-call scenarios where it‚Äôs absolutely crucial that somebody will eventually answer the call.\nCurrently, this is impossible with Teams call queues. However, this is by design. The purpose of a queue is that the call stays within the queue and the company has control over the call for the entire flow of the call. In other words, the queue makes sure that the call stays within company boundaries by ignoring all user configured call answering rules. So, if a user has configured his calls to immediately forward to a personal cell phone, the queue simply doesn‚Äôt care and will present the call to the user in Teams anyway.\nIf you must forward the call to multiple numbers at the same time, you can use regular Teams (Microsoft 365) users. I always suggest using dedicated, generic accounts for this, even though it‚Äôs an additional license cost. This will make management easier and ensures that no user is able to change the forwarding settings and mess with the call flow on their own.\nSince I did this in my lab, I used the users I already had to demonstrate this. This means that they have real sounding names and are not generically named accounts like I would use in a real-world scenario.\nHow To Configure It To configure forwarding to multiple external numbers simultaneously, identify where in your auto attendant or call queue the call must be forwarded.\nNext, think about to how many numbers the call must be forwarded. Create one Teams enterprise voice enabled user for each external target number. Then create one more Teams voice enabled user. On this user, configure a call group and add all the users which forward to external numbers immediately.\nSet this user‚Äôs call forwarding settings to either immediately forward to or also ring the call group.\nThe accounts which are members of the call group must all be configured like this.\nWhile the first user can be configured to either also ring or immediately forward to the call group, the call group members must be configured to immediately forward. If they‚Äôre set to also ring to an external number, it will not work.\nCall Flow¬†Diagram I updated the M365 Call Flow Visualizer and added two new parameters.\n-ShowNestedUserCallGroups Specifies if call groups of users should be expanded and included into the diagram. Required: false Type: boolean Default value: false -ShowNestedUserDelegates Specifies if delegates s of users should be expanded and included into the diagram. Required: false Type: boolean Default value: false\rThis allows us to indefinitely expand and display the user calling settings of call group members and delegates in the diagrams as well.\nPlease note that these features are currently only available in the DEV branch of the GitHub repo. I did my best to thoroughly test this but since there are basically unlimited possibilities of how users are interlinked within user call groups and delegates this is quite hard. There may still be some bugs, if you encounter any, please let me know.\nOther Options This also works if you use call delegation instead of a call group with both immediately forward and also ring on the first user. I tested it with Microsoft Calling Plans, but it should work with Direct Routing or Operator Connect as well. The maximum amount of simultaneous external forwards via call group I tested was three and that still worked as expected.\nI recommend using a call group over delegates because this gives you a little more flexibility. While delegates will always simultaneously ring all delegates, a call group can be configured for serial ring as well. In this case, it will always ring for 20 seconds per call group member before the next one is tried. This time out cannot be changed as of today.\nCaveats When you do this, you need to be aware of issues that might occur. At the beginning of this article, I briefly mentioned that the purpose of a queue is to stay in control of the call for the entire time. That‚Äôs not the case when using external forwarding on user calling settings. For example, if one of the external targets is not reachable by e.g. having a rather short voicemail timeout, is in flight mode or just has no reception, calls might get lost on personal voicemail boxes outside of a company‚Äôs control. Once a call hits any voicemail box, the call is technically connected and will stop ringing the other targets, even if parallel ringing is configured on the call group. This also applies to call groups configured in serial ring. If e.g. the first target is not reachable, and the call goes to voicemail the other targets won‚Äôt even be tried anymore.\nIt‚Äôs also noteworthy that user configured calling settings can become extremely complex and it‚Äôs easy for users (or admins for that matter) to build loops or enable forwards without knowing about it.\nThe same goes for the M365 Call Flow Visualizer, I don‚Äôt think that it‚Äôs possible to accurately display everything that‚Äôs configured in nested user calling settings. I tried my best to render call flows where a serial ring is configured on a user configured call group though. As an example, I configured the same call group which was already shown in the above diagram for serial ring. Now all the call group targets are displayed in chronological order, and you can see how the call trickles down to the next target after 20 seconds.\nUnlike with call queues and auto attendants, where the M365 Call Flow Visualizer does a fantastic job displaying things as they are, please take complicated nested user call groups and delegate flows with a grain of salt. At least for now.\nLook at this call flow for example. When the call gets to Bill Stearn it will also ring his call group in serial order. Thus, it will ring the mobile number +4178857**** for 20 seconds. Because there is an unanswered timeout of 20s configured for Bill the call will then be forwarded to his delegates where the call will be forwarded to Bobby and Mike and they have an immediate forwarding configured to their mobiles.\nAll the users who are members of the call group are linked after each other because the call group is configured in serial ring. The links which point from the delegate sub graph (which is always parallel ring) to the delegate users are still linked to the correct user but it‚Äôs not very easy to understand what‚Äôs going on.\nWhen we think about the delegate flow, the chaining from Bobby‚Äôs time out of 20s doesn‚Äôt actually apply anymore and the call won‚Äôt be forwarded to Mike because that part of the diagram only applies to the serial order of Bill‚Äôs call group.\nLast but not least, Wendy is also included in the call flow even though a call could never go this far in that specific call flow because of the applied time outs.\nUnfortunately, I currently don‚Äôt see any way I could solve this with the visualizer script.\nI‚Äôd like to point out that configuring both a call group and delegates on the same user seems extremely unlikely and is something I would generally refrain from.\nConclusion Although it‚Äôs not an ideal solution, using generic user accounts and call groups for certain scenarios is for sure a creative one. In some cases, this might help you solve a very specific niche scenario which previously seemed impossible.\nI do recommend using auto attendants and call queues to build your call flows whenever possible. If you must use call groups, I advise you to keep it simple and create generic accounts to which only Teams admins have access to. Otherwise, it‚Äôs free-for-all kind of situation and users can mess with your configuration as they please.\nIf you stick with simple scenarios (like shown in the first three diagrams in this article) and avoid building call group loops or timeouts which cancel each other out, I don‚Äôt see any issues why you shouldn‚Äôt do this if you really need to.\n","date":"2023-05-14T08:23:26.863Z","permalink":"https://heusser.pro/p/simultaneously-forward-calls-to-multiple-numbers-in-teams-d228adb805b7/","title":"Simultaneously Forward Calls to Multiple Numbers in Teams"},{"content":"This article builds on the following article.\nTeams Phone Number Management on a Budget | by martin heusser | Mar, 2023 | Medium\nPlease make sure you read that one first.\nAfter I built the list initially, I quickly realized that there‚Äôs still room for improvement. Especially a feature to assign and unassign phone numbers through the list would be incredibly handy. This would allow us to delegate this task to users without Teams Admin Center access.\nThe repository has been updated and already includes the code required for number assignment. If you‚Äôve already deployed it, just delete the resource group in Azure and re-deploy. Of course, you can also replace the existing files with the new scripts and variables by hand if you know what you‚Äôre doing. But since there‚Äôs a deployment script available, I recommend deleting and re-deploying.\nLet‚Äôs check out the new features first and go over the manual changes required later.\nNew Features Country All Calling Plan and Operator Connect phone numbers already include a country attribute. Therefore, I decided to use the property which is already known to Teams. The Country column now includes the two-digit ISO code instead of the country‚Äôs full name.\nFor consistency, the CountryLookupTable.json has been updated to include the ISO codes as well. Please see the Changes in V2 section of this article if the Country does not always match your direct routing numbers.\nCity The purpose of this list is to make the management of phone numbers easier. The more information you have, the better you can filter. That‚Äôs why I added a City column as well.\nNumber Reservation The Status column is now a drop-down list. Setting a number to Reserved won‚Äôt do anything yet, except letting other people which use the list know that this number should not be assigned to any user or resource account.\nBecause this is a SharePoint list, we can add a comment on that entry.\nThe runbook will not make any changes or updates to that entry until the number is assigned or the Status is changed by hand again.\nAssign a¬†Number To assign a number, simply set a number to Reserved and choose a User Profile from the people picker.\nThe list will then look like this. There‚Äôs a User Profile linked but the User Principal Name is still unassigned.\nThe next time the runbook runs, it will try to assign the number. If the assignment fails for any reason, the Staus will change to Assignment Error but the linked User Profile will be retained.\nCurrently, the list only reflects a generic error. The runbook output, however, does include more information.\nThe script will even assign a voice routing policy for direct routing numbers if you specify one in the CountryLookupTable.json file. I will show you how to do that at the end of this article.\nIf you really want to be on top of your game, you can also create a rule to notify you of failed assignments.\nUnassign a¬†Number To unassign a number, simply change the Status to Remove Pending.\nThe number will then be removed from the user, the next time the runbook is running.\nPerformance Improvements I‚Äôve also made some changes which will improve the performance of the script dramatically. I discovered a couple of redundant Graph requests which have now been reduced to the minimum required.\nChanges in¬†V2 Changes to the¬†List Edit the Status column of your list.\nChange the Type from Single line of Text to Choice and add the following choices.\nSave the changes to the Status column.\nNow add a new Text column.\nName it City and choose Type Single line of text.\nChanges to the¬†Flow Update Trigger Condition In your flow‚Äôs trigger condition, delete the existing condition and paste the following expression.\nUpdate 08.08.2023\nThanks to a community member of my Teams Phone Admin Discord Server I was made aware that the trigger condition can fail if the UPN and the email address case did not match. Below is the corrected trigger condition which includes a toLower() expression as well.\n/Update\n@or(\nand(\nnot(equals(triggerOutputs()?[\u0026lsquo;body/User_x0020_Principal_x0020_Name\u0026rsquo;], \u0026lsquo;Unassigned\u0026rsquo;)),\nnot(contains(triggerBody(), \u0026lsquo;UserProfile\u0026rsquo;))\n),\nnot(equals(toLower(triggerOutputs()?[\u0026lsquo;body/User_x0020_Principal_x0020_Name\u0026rsquo;]), toLower(triggerOutputs()?[\u0026lsquo;body/UserProfile\u0026rsquo;][\u0026lsquo;Email\u0026rsquo;]))),\nand(\ncontains(triggerBody(), \u0026lsquo;UserProfile\u0026rsquo;),\nnot(equals(triggerOutputs()?[\u0026lsquo;body/User_x0020_Principal_x0020_Name\u0026rsquo;], \u0026lsquo;Unassigned\u0026rsquo;)),\nnot(contains(triggerBody(), \u0026lsquo;TeamsAdminCenter\u0026rsquo;))\n)\n)\nThe expression is now also included in the repository for better readability. The line breaks will be automatically removed once you paste it in Power Automate.\nThis will also trigger the flow, when a User Profile was added manually through the list (not by the flow) which is what happens when a list user wants to assign a number to a new Teams User.\nAdd Another Condition I don‚Äôt know why it didn‚Äôt occur to me initially but instead of using the runbook to recreate items which have been deleted by the flow, we can just use the flow to do that as well. The reason why we need to delete and re-create is because setting the User Profile to null did not work in Power Automate.\nIn the first If yes action, we have to add another condition which checks if the Status Value is equal to Unassigned.\nThe existing Delete item action has to be copied to the clipboard, deleted, and then pasted inside the If yes action of the second condition again.\nAdd Create Item¬†Action In the second If yes action, add a Create item action after Delete item with the following dynamic values.\nHere‚Äôs a new screenshot of the complete flow with collapsed boxes.\nChanges to the CountryLookupTable.json Add More Precise¬†Prefixes There are some countries which use the same phone prefix. If multiple matches are found, the function always uses the last match which might be wrong in many cases. To solve this, just edit the Json file yourself.\nFor example, if you have Australian +61 numbers, but don‚Äôt have any numbers from Christmas Island or Cocos Islands (which also start with +61), just delete these entries from the Json.\nIn case you have e.g. numbers from Canada and USA, which both start with +1, you can also extend the prefix to include all digits which are common in all your number ranges from left to right.\nOriginal Entry\n{\n\u0026ldquo;Prefix\u0026rdquo;: \u0026ldquo;+1\u0026rdquo;,\n\u0026ldquo;CountryName\u0026rdquo;: \u0026ldquo;United States\u0026rdquo;,\n\u0026ldquo;Country\u0026rdquo;: \u0026ldquo;US\u0026rdquo;\n}\nPossible Entry Change\n{\n\u0026ldquo;Prefix\u0026rdquo;: \u0026ldquo;+1206\u0026rdquo;,\n\u0026ldquo;CountryName\u0026rdquo;: \u0026ldquo;United States\u0026rdquo;,\n\u0026ldquo;Country\u0026rdquo;: \u0026ldquo;US\u0026rdquo;\n}\nThis example assumes that you have Canadian direct routing numbers starting with +1 and have US direct routing numbers which all start with +1206.\nIf you have more prefixes from the same country in your number ranges, just add more entries with different prefixes but with the same country.\n{\n\u0026ldquo;Prefix\u0026rdquo;: \u0026ldquo;+1206\u0026rdquo;,\n\u0026ldquo;CountryName\u0026rdquo;: \u0026ldquo;United States\u0026rdquo;,\n\u0026ldquo;Country\u0026rdquo;: \u0026ldquo;US\u0026rdquo;\n},\n{\n\u0026ldquo;Prefix\u0026rdquo;: \u0026ldquo;+1323\u0026rdquo;,\n\u0026ldquo;CountryName\u0026rdquo;: \u0026ldquo;United States\u0026rdquo;,\n\u0026ldquo;Country\u0026rdquo;: \u0026ldquo;US\u0026rdquo;\n}\nAdd Voice Routing Policy¬†Names If you want to use the list for assignment of direct routing numbers, you‚Äôll have to add the name of your voice routing policy for each country to the CountryLookupTable.json file.\n{\n\u0026ldquo;Prefix\u0026rdquo;: \u0026ldquo;+41\u0026rdquo;,\n\u0026ldquo;CountryName\u0026rdquo;: \u0026ldquo;Switzerland\u0026rdquo;,\n\u0026ldquo;Country\u0026rdquo;: \u0026ldquo;CH\u0026rdquo;,\n\u0026ldquo;VoiceRoutingPolicy\u0026rdquo;: \u0026ldquo;Switzerland\u0026rdquo;\n}\nCurrently, this solution only supports one voice routing policy per country entry in the CountryLookupTable.json file.\nIf you have different voice routing policies for various locations within the same country, you‚Äôll have to try to find a way to match them via their prefixes and add multiple entries in the Json.\n{\n\u0026ldquo;Prefix\u0026rdquo;: \u0026ldquo;+4144\u0026rdquo;,\n\u0026ldquo;CountryName\u0026rdquo;: \u0026ldquo;Switzerland\u0026rdquo;,\n\u0026ldquo;Country\u0026rdquo;: \u0026ldquo;CH\u0026rdquo;,\n\u0026ldquo;VoiceRoutingPolicy\u0026rdquo;: \u0026ldquo;Switzerland-Zurich\u0026rdquo;\n},\n{\n\u0026ldquo;Prefix\u0026rdquo;: \u0026ldquo;+4131\u0026rdquo;,\n\u0026ldquo;CountryName\u0026rdquo;: \u0026ldquo;Switzerland\u0026rdquo;,\n\u0026ldquo;Country\u0026rdquo;: \u0026ldquo;CH\u0026rdquo;,\n\u0026ldquo;VoiceRoutingPolicy\u0026rdquo;: \u0026ldquo;Switzerland-Bern\u0026rdquo;\n}\nChanges to TeamsPhoneNumberOverview.ps1 Update 11.04.2023\nSorry, I totally forgot to mention that you‚Äôll also need to specify the name of the SharePoint User Information List in your language.\n# Set your language or add it to the switch statement\n# To find the name of your user information list, go to:\n# https://.sharepoint.com/sites//_catalogs/users/simple.aspx\n$spoLanguage = \u0026ldquo;German\u0026rdquo;\nswitch ($spoLanguage) {\nGerman {\n$localizedUserInformationList = \u0026quot;Benutzerinformationsliste\u0026quot; } English { $localizedUserInformationList = \u0026quot;User Information List\u0026quot; } Default { $localizedUserInformationList = \u0026quot;User Information List\u0026quot; } }\nI hope that you like the V2 upgrade of my budget number management list.\n","date":"2023-04-08T16:02:49.582Z","permalink":"https://heusser.pro/p/teams-phone-number-management-list-part-2-b5385e348a3a/","title":"Teams Phone Number Management List Part 2"},{"content":"After my last article turned into a twenty-minute read, I want to write a short blog post today. At least I‚Äôll try to. We are talking about managing Microsoft Teams Call Queues with PowerShell again.\nPretty much about one year ago, I wrote an article explaining how to force sync a Call Queue which uses a group or a Microsoft Team as its source of agent list.\nMicrosoft Teams Call Queue Agent Lists (And how to Force-Sync them) | by martin heusser | Medium\nSince then, I have refined the code a little bit to make it even easier. I wrote two functions which are available in a new PowerShell Module which is available in my TeamsPhoneAutomation repository on GitHub.\nTo import the module, simply run the following code after you have cloned the repository.\n$localRepoPath = git rev-parse \u0026ndash;show-toplevel\nImport-Module \u0026ldquo;$localRepoPath/Modules/TeamsPS.psm1\u0026rdquo; -Force\ngit rev-parse --show-toplevel will resolve the cloned repository‚Äôs root path to the absolute file path on your system. This is really helpful if different users clone the repo to different folders on their own machine.\nThere are two Call Queue related functions in the module:\nGet-MZZCQAgents Sync-MZZCQAgents Let‚Äôs start with the Get function.\nGet-MZZCQAgents This is essentially what this script mentioned in this article does. However, this function doesn‚Äôt have exporting capabilities and the code has been adapted so it plays nice with the Sync function.\nAs we already know, when we check a Call Queues¬†.Agent property, we will only see GUIDs instead of User Principal Names. Thus, my function. It will search for the users by Id and output UPNs instead of Object Ids.\nIf you run the function without parameters, you will be able to choose a Call Queue from a list.\nIf you already know the Id of your Call Queue, you can pass it via the -CQIdentity parameter.\nGet-MZZCQAgents -CQIdentity fe77ecb3-f5a5-47ee-9519-cbb3a52d5771\nSync-MZZCQAgents This Call Queue uses a Microsoft Teams Team as Agent List, but this also applies to Agents which are assigned to a queue via Security or M365 Groups.\nThink about a scenario where a Team owner adds a new employee to a Team which should also start to receive calls to the queue. Without interaction of a Teams Administrator, it‚Äôs going to take some time until that‚Äôs the case. It will most likely take multiple hours for the change to become effective.\nIf we want to speed up that process, we simply need to run Sync-MZZCQAgents¬†.\nIt‚Äôs the same for this function, if you do not specify -CQIdentity you will be asked to choose one or multiple queues from the list. To select multiple queues, just hold CTRL while selecting list entries.\nPlease note that Get-MZZCQAgents only accepts one selection at a time but Sync-MZZCQAgents can actually loop through multiple queues after each other if you want to force-sync all or some of your queues.\nThe cool thing about this is that the Sync function runsGet-MZZCQAgents before and after the queue‚Äôs agent list has been synced. This way you can know if the new agent(s) have already been added.\nIf you run the function too soon after the membership of a Team or an M365 Group has been updated, chances are that you will get the following output.\nFirst, let‚Äôs remove Mike, who is also an agent of the queue as a member of the Team. We can now see that Mike has been removed from the queue.\nNow let‚Äôs add Mike back but remove Bobby. You‚Äôll get a nice overview of all the agents that were removed or added.\nThere is no need to run Connect-MicrosoftTeams before you run either of these two functions because a login mechanism, similar to the one the M365 Call Flow Visualizer uses is already built into the function Connect-MZZTeams which is also part of the module. If you‚Äôre not already logged in, you‚Äôll be prompted to enter your Teams Admin Credentials.\nFor now, it‚Äôs only these two or rather three functions (if you count the login function) which are part of this module. I‚Äôm sure that I‚Äôll add more useful code over time, so stay tuned and follow me on Medium, Twitter or LinkedIn. And yes, the 117 in my LinkedIn URL is a reference to Master Chief.\n","date":"2023-04-04T19:42:18.872Z","permalink":"https://heusser.pro/p/manage-microsoft-teams-call-queues-with-powershell-force-sync-9919e2939552/","title":"Manage Microsoft Teams Call Queues with PowerShell (Force-Sync)"},{"content":"\nUpdate 08.04.2023\nI‚Äôve updated this solution to V2 which includes the capability to assign, unassign and reserve phone numbers along with other improvements.\nPlease read this article when you have finished reading this one.\n/Update\nEvery Teams Voice Admin that has deployed Direct Routing knows the struggle. There‚Äôs no way to manage Direct Routing numbers in Teams Admin Center. This makes it hard for us to get a clear overview of which numbers are still unassigned/free or even to see all the numbers we have.\nObviously, there‚Äôs a solution for anything. We can use PowerShell to export numbers and create our own lists in Excel or whatever. The challenge with that is to keep the list up to date, error free and make it centrally available for all people who need to work with it.\nThere are also lots of vendors which offer Teams phone number management platforms. Here are some of them:\nNumber Management for Microsoft Teams (callroute.com)\nClobba Range Manager‚Ää‚Äî‚ÄäDID Number Management‚Ää‚Äî‚ÄäCode Software\nNumber Connect (pure-ip.com)\nTeamsBoss\nThey all have powerful features‚Ää‚Äî‚Ääwhich come with a price. But what if we don‚Äôt need a full-fledged management solution and just want a simple overview which is dynamically updated?\nThat‚Äôs exactly what I‚Äôve been building in my spare time over the last few weeks.\nThe final product is a SharePoint list which gets automatically updated by an Azure Automation Runbook every hour.\nThis time around, I tried to automate everything I could. This means less work for you if you want to deploy it yourself. But before we get into the technical details of it, let‚Äôs look at the list.\nTL;DR\nIf you don‚Äôt care about the details and want to deploy straight away, you can grab the code from here.\nThe List The Columns The list can be viewed in SharePoint Online, Microsoft Lists or directly in Teams through Lists. It consists of the following columns.\nTitle = Phone Number Phone Extension = Extension if there is one configured Status = Assigned/Unassigned Number Type = Direct Routing / Calling Plan / Operator Connect User Name = Display Name of assigned account User Principal Name = UPN of assigned account Account Type = User Account / Resource Account / Conference Bridge Country = The country a number belongs to UserId = Object Id from Azure AD User Profile = Profile Card Teams Admin Center = Link to manage the user in TAC This should cover most of the relevant information somebody might want to know about their phone numbers.\nFiltering Having all that information available allows us to easily filter numbers which meet certain criteria. In this example, I filtered the list for all unassigned numbers from the UK.\nBecause this number is unassigned and it could be assigned to a Resource Account or a Conference Bridge, both types are included in the list.\nIf we compare that to an assigned service number, we can see that the Account Type is shown as Resource Account because the number is assigned to one.\nThe most common thing which people probably want to see at glance is which direct routing numbers are unassigned from a specific country. This can also be achieved very easily.\nI learned a lot during the development of this project, and I now want to share that with you. Let‚Äôs take a look at how the SharePoint list was built and how it automatically updates itself with the help of Azure Automation.\nDeployment There are very few manual tasks required to get this set up. I built a deployment script which will create all the required resources in Azure for you.\nClone The GitHub¬†Repo Start by cloning or downloading the GitHub Repo.\nmozziemozz/TeamsPhoneAutomation: Automation Scripts for Microsoft Teams Phone (github.com)\nIf you‚Äôve never worked with GitHub before, I highly recommend trying it instead of just downloading the repository as a zip file. All you need to do is sign up for an account, install the desktop client and clone the repo.\nOnce you have signed into GitHub Desktop, just head over to the repository URL and open it in GitHub Desktop.\nThen choose your local folder and click on clone. Make sure to select a folder which isn‚Äôt synchronized to any kind of cloud Storage like OneDrive. The constant syncing of files would impair your performance dramatically.\nThe repo contains the following files and folders.\nC:\\TEMP\\GITHUB\\TEAMSPHONEAUTOMATION\n‚îÇ .gitignore\n‚îÇ Deploy.ps1\n‚îÇ README.md\n‚îÇ\n‚îú‚îÄ‚îÄ‚îÄFunctions\n‚îÇ Connect-MgGraphHTTP.ps1\n‚îÇ Connect-MsTeamsServicePrincipal.ps1\n‚îÇ Get-CountryFromPrefix.ps1\n‚îÇ Get-CsOnlineNumbers.ps1\n‚îÇ\n‚îú‚îÄ‚îÄ‚îÄResources\n‚îÇ CountryLookupTable.json\n‚îÇ CreateList.json\n‚îÇ DirectRoutingNumbers.csv\n‚îÇ Environment.json\n‚îÇ\n‚îú‚îÄ‚îÄ‚îÄScripts\n‚îÇ TeamsPhoneNumberOverview.ps1\n‚îÇ\n‚îî‚îÄ‚îÄ‚îÄSetup\nSetup.ps1\nUpdateDirectRoutingNumbers.ps1\nEnvironment.json Before we do anything, we need to define a few things and names. In¬†.\\Resources open the Environment.json file and fill in your own information.\n{\n\u0026ldquo;TenantId\u0026rdquo;: \u0026ldquo;4bffbf87-53a0-4fce-b58b-xxxxxxxxxxxx\u0026rdquo;,\n\u0026ldquo;GroupId\u0026rdquo;: \u0026ldquo;aff7d27f-878d-422c-83bd-xxxxxxxxxxxx\u0026rdquo;,\n\u0026ldquo;MSListName\u0026rdquo;: \u0026ldquo;Teams Phone Number Overview Demo\u0026rdquo;,\n\u0026ldquo;ResourceGroupName\u0026rdquo;: \u0026ldquo;mzz-rmg-001\u0026rdquo;,\n\u0026ldquo;AutomationAccountName\u0026rdquo;: \u0026ldquo;mzz-automation-account-001\u0026rdquo;,\n\u0026ldquo;AzLocation\u0026rdquo;: \u0026ldquo;West Europe\u0026rdquo;\n}\nTenantId is your Tenant Id.\nGroupId is the Object Id of the Microsoft Teams Team which hosts the SharePoint site where the list should be created.\nMSListName will be the name of your List in SharePoint.\nResourceGroupName will be the name of the resource group which is created in Azure.\nAutomationAccountName will be the name of the automation account which is created within the new resource group.\nAzLocation is the Azure region where you want to deploy the resources.\nYou can find a list of all available regions and their names here.\nMake sure you save the file once you‚Äôve filled in all the information.\nDirectRoutingNumbers.csv Next, we need a list which contains all your direct routing numbers. This file can only contain one column called PhoneNumber. All the numbers must be in E.164 format but without the leading +¬†. The plus sign will be added by the script later. It just makes things easier in Excel if we don‚Äôt need to bother about the plus.\nThat‚Äôs it for the preparation.\nDeploy.ps1 Disclaimer: The script has been tested on a vanilla Windows 11 virtual machine where Windows Terminal is configured as default console host and sessions start in the parent process directory. No PowerShell modules were installed before the script was first executed on this system.\nYou will need an account with Global Administrator rights to successfully run this script. You also need local admin rights and need to make sure that running scripts is allowed on your machine.\nIn an elevated terminal, run the following code and close the terminal session once you have done so.\nSet-ExecutionPolicy Bypass\nTo start the deployment, you need to run the Deploy.ps1 file.\nThis will just call the¬†.\\Setup\\Setup.ps1 script which is the real deal.\nSetup.ps1 After all the module and components checks have been completed or the missing components have been installed, you will be prompted to sign into the M365 CLI.\nLet me explain what‚Äôs going on in the script. Our end goal is to have a SharePoint list. Since we need a script to automatically update the list anyway, we might as well just create the list through PowerShell and Microsoft Graph instead of creating it manually.\nTo provision all this stuff, we need a couple of Az.* PowerShell modules. We also need Node.JS so we can install the CLI for Microsoft 365 through NPM (Node Package Manager). If you miss any of the components on your machine, they will automatically be installed, if you can provide local admin rights.\nAzure AD App Registration \u0026amp; Service Principal The M365 CLI will create a new Azure AD App Registration and a Service Principal. It will also assign the Microsoft Graph permission scopes we need to create and modify SharePoint lists and manage Microsoft Teams to the Service Principal.\nBoth the App Registration and the Service Principal will use the name of the Automation Account. This way it‚Äôs easy to know where the assigned permissions are used within Azure.\nThe script also creates a new client secret for the App Registration.\nRemember, a client secret can only be viewed once, after it has been created in the portal. Because we used the CLI to create it, we can‚Äôt view it in the portal anymore. The secret is received by the script and saved in an encrypted state though. You‚Äôll also be prompted if you want to view it in case you want to copy and store it in a safe place.\nYou don‚Äôt have to do this if you don‚Äôt want to. You can always decrypt it again, as long as you\u0026rsquo;re using the same machine and user account which encrypted it. The secret is saved to¬†.\\.local\\AppSecret.txt¬†.\nIf you want to manually decrypt it later, you can use the following code.\n$AppSecret = [Runtime.InteropServices.Marshal]::PtrToStringAuto([Runtime.InteropServices.Marshal]::SecureStringToBSTR((Get-Content -Path .\\.local\\AppSecret.txt | ConvertTo-SecureString))) | Out-String\nAgain, you don‚Äôt have to if you don‚Äôt want to. The script will be able to decrypt the secret and upload it to the Azure Automation Account once it‚Äôs needed.\nOnce the permissions have been assigned to the Service Principal, the script uses the same Service Principal to connect to Microsoft Graph and assign the Skype for Business Administrator role to itself.\nThis is possible because the M365 CLI previously assigned the scope RoleManagement.ReadWrite.Directory to the Service Principal.\nThe role is needed for the SP to be able to manage Microsoft Teams via PowerShell. I learned this from Christian Frohn‚Äôs excellent blog article.\nIn case you‚Äôre wondering why no Microsoft.Graph modules are required; this is because I chose to work with PowerShell native Invoke-RestMethod commands instead of the *Mg* Cmdlets.\nProvisioning the Azure Resources The previous steps complete rather fast. The next steps are going to take a bit longer. First you need to sign in with an Account which has the appropriate permissions to create Azure resources within your subscription.\nI guess it would have been possible to also assign some RBAC roles to the Service Principal which would allow us to use it to sign into Azure as well. Since the script is run locally on demand, I see no problem with using a normal user account for this part. It actually gives us time to review the created App Registration and Service Principal before the script starts to deploy any resources to Azure. Furthermore, we don‚Äôt need to worry about being aware of yet another Service Principal which has permissions to deploy or remove Azure Resources.\nThe script will create a Resource Group with the name and location defined in Environment.json.\nIt will also create a new Automation Account within the Resource Group, also in the same region.\nAutomation Account Modules\nThe MicrosoftTeams Module is not added to Automation Accounts by default. Thus, the script needs to add it. This usually takes a couple of Minutes.\nOnce the module has finished importing, the script will continue.\nVariables\nThe main script which will create/update our SharePoint List needs access to all the data we initially defined in Environment.josn. This information is stored in Automation Variables which can be accessed through Azure Runbooks.\nThe client secret is stored as an encrypted variable and cannot be viewed or edited. Its content can only be accessed by using the internal Cmdlet Get-AutomationVariable¬†.\nWe can also see that we have a variable called TeamsPhoneNumberOverview_DirectRoutingNumbers. This variable stores all Direct Routing numbers in Json format. Because I ran into some issues with storing the Json content as a string, I needed to get creative and enclose it in single quotes: '{\u0026quot;Json\u0026quot;: \u0026quot;Example\u0026quot;}'¬†. These get removed when the variable is imported through the Runbook so that the Json can be converted to a PowerShell object.\nTeamsPhoneNumberOverview_CountryLookupTable contains a list with all countries and prefixes to determine the country of Direct Routing Numbers. To be consistent, this is also applied to Calling Plan and Operator Connect numbers, even though this information would be available through Get-CsPhoneNumberAssignment¬†.\nIf you would like to learn more about these internal Cmdlets for Automation Variables or Azure Runbooks in general, I recommend this article of mine.\nRunbooks\nWe also have a couple of Runbooks which were deployed by the Setup.ps1 script. The main script logic sits in TeamsPhoneNumberOverview.\nTo make the solution more modular some functions, like Connect-MgGraphHTTP or Connect-MsTeamsServicePrincipal are stored in separate Runbooks. This makes it easier to reuse them and means less work if we want to extend the Automation Account with other scripts.\nFor example, if you have another Runbook in the same Automation Account which needs to connect to MicrosoftTeams PowerShell as well, you can just use the following code.\n. .\\Connect-MsTeamsServicePrincipal.ps1\n$TenantId = Get-AutomationVariable -Name \u0026ldquo;TeamsPhoneNumberOverview_TenantId\u0026rdquo;\n$AppId = Get-AutomationVariable -Name \u0026ldquo;TeamsPhoneNumberOverview_AppId\u0026rdquo;\n$AppSecret = Get-AutomationVariable -Name \u0026ldquo;TeamsPhoneNumberOverview_AppSecret\u0026rdquo;\n. Connect-MsTeamsServicePrincipal -TenantId $TenantId -AppId $AppId -AppSecret $AppSecret\nAnd if you ever need to adjust something in the login function, you only need to change it in one script (Connect-MsTeamsServicePrincipal) and not in all your Runbooks.\nScript Logic\nThe code for the main script logic can be found here.\nTeamsPhoneAutomation/TeamsPhoneNumberOverview.ps1 at main ¬∑ mozziemozz/TeamsPhoneAutomation (github.com)\nI asked ChatGPT to explain what the script does. The result is astonishing.\nThis PowerShell script is designed to gather information about Microsoft Teams users who have phone numbers assigned to them, and store this information in a SharePoint list.\nThe script starts by importing four external functions, which are used later in the script. It then sets some variables by retrieving values from Azure Automation variables. These variables include the name of the SharePoint list where the data will be stored, as well as the credentials needed to connect to the Microsoft Teams and Graph APIs.\nNext, the script imports Direct Routing numbers and adds a leading plus sign to all of them. It also retrieves a list of existing SharePoint lists for a specific group ID, and checks if the desired SharePoint list already exists. If it does, the script retrieves its ID. If not, a new SharePoint list is created and its ID is retrieved.\nThe script then retrieves information about all Teams users who have a phone number assigned to them. For each user, the script determines if they are a user or resource account, and then extracts details about their phone number, such as the phone number itself, any extension, and the country associated with the number. The script also checks if the phone number is a Direct Routing number or a CsOnline number. Finally, it creates an object containing all of this information for each user, and adds this object to an array.\nOnce all of the user information has been gathered, the script writes it to the SharePoint list. Each object in the array is written to a new row in the list.\nThe only thing I would have added is to mention that the script only adds new entries to the list, only updates changed entries with the new values and removes entries from the list which no longer exist.\nSchedules\nThe setup script has also created a recurring schedule which runs every hour. The schedule is automatically linked to the TeamsPhoneNumberOverview Runbook by the script. This will result in the SharePoint list being updated once an hour.\nThat‚Äôs it. These are all the resources and components we need to create and update the SharePoint List.\nRunning the¬†Runbook The Runbook schedule is configured in UTC. The first start time needs to be at least 5 minutes after the schedule‚Äôs creation time. To be sure, I set the schedule to run at the next full hour + 2 hours. In case this does not work for you in your local time zone, please let me know.\nThis means that the SharePoint List won‚Äôt be created straight away. If you want to manually run the Runbook before the first scheduled start, just click on Start.\nThe job will just take a couple of minutes to complete.\nYou should then see the newly created List in SharePoint or Microsoft Lists.\nFinishing Touches Unfortunately, the Graph API has some limitations in terms of what types of fields can be added or updated in a list. I wanted to perfect my solution by also having a User Profile column and a link to Teams Admin Center for all assigned user numbers. These types can only be added manually.\nImportant: For this and the next part, it‚Äôs extremely important to follow my instructions very carefully. If the column names don‚Äôt match up with the Flow it will not work.\nAdd Two Additional Columns Click on + Add column.\nName the column User Profile and toggle Show profile photos.\nRepeat the steps and choose Hyperlink this time.\nName this column Teams Admin Center.\nNow let‚Äôs create the final part of our Number Overview Solution: A Power Automate Flow.\nCreate The¬†Flow Head over to Microsoft Power Automate and create a new Automated Cloud Flow. Name your flow and select When an item is created or modified (SharePoint) as the trigger.\nSelect the Site/Team where your list has been created from the drop-down menu in Site Address. Then choose your list from the drop-down.\nNext, click on the three dots and select Settings.\nAdd a Trigger Condition and add the following code exactly as it is.\n@or(and(not(equals(triggerOutputs()?[\u0026lsquo;body/User_x0020_Principal_x0020_Name\u0026rsquo;], \u0026lsquo;Unassigned\u0026rsquo;)),not(contains(triggerBody(), \u0026lsquo;UserProfile\u0026rsquo;))),not(equals(triggerOutputs()?[\u0026lsquo;body/User_x0020_Principal_x0020_Name\u0026rsquo;],triggerOutputs()?[\u0026lsquo;body/UserProfile\u0026rsquo;][\u0026lsquo;Email\u0026rsquo;])))\nThis is the most crucial step. Without a trigger condition, we would create an infinite trigger loop since we use When an item is created or modified as trigger and our final action will be Update item.\nAdd a Condition where it checks if the User Principal Name is equal to Unassigned.\nIf the condition is True or in other words, if the value of the User Principal Name field is unassigned, we want to delete the list item.\nKeep in mind that the flow is only triggered if our trigger condition is met. It took me quite some time and a lot of binging to figure out a working trigger condition for this scenario. (Yes, I really found the answer on Bing without any googling!).\nThe condition consists of an and operator and an or operator. In English, it checks for the following:\nThe User Principal Name is not Unassigned and the User Profile is empty.\nThis means that the flow will trigger if the number is assigned to a user, but the User Profile is not populated yet.\nor\nThe User Principal Name is not the same as the User Profile.\nThe flow also triggers if the User Profile is already populated but it doesn‚Äôt match the User Principal Name.\nI didn‚Äôt find a way to delete the User Profile if any given number changes from Assigned to Unassigned. Unfortunately, setting the filed to null via the flow did not work. Because of that we just delete the list item using Delete item. The number will be added back to the list with its up to date information as soon as the Runbook runs again.\nIn the If no action of the condition, we need to add another condition. This time, we want to check if the Account Type is equal to User Account. We only want to include a link to Teams Admin Center if it‚Äôs a user account.\nIn this condition, we only configure actions if it‚Äôs True. First, we update the list item. Select your Site Address and List Name again. Then fill in the ID and Title from dynamic content. And finally, in User Profile Claims select Enter custom value and choose User Principal Name from dynamic content. Leave all the other fields blank.\nAdd another action and choose Send an HTTP request to SharePoint. The Update item action only supports hyperlinks without a description so it would show the entire URL instead of a friendly name in the list. Although it‚Äôs more complicated, we can add a hyperlink with a friendly name using Send an HTTP request to SharePoint.\nFill in your Site Address again and set the Method to POST. The Uri must look like this:\n_api/web/lists/GetByTitle(\u0026lsquo;Teams Phone Number Overview Demo 10\u0026rsquo;)/items(@{triggerOutputs()?[\u0026lsquo;body/ID\u0026rsquo;]})\nMake sure to adjust the list name in case your list is named differently. Spaces inside the single quotes are supported in this field.\nClick the little icon next to the Headers field to engage Switch Headers to text mode and paste the following Json:\n{\n\u0026ldquo;Content-Type\u0026rdquo;: \u0026ldquo;application/json;odata=verbose\u0026rdquo;,\n\u0026ldquo;X-HTTP-Method\u0026rdquo;: \u0026ldquo;MERGE\u0026rdquo;,\n\u0026ldquo;IF-MATCH\u0026rdquo;: \u0026ldquo;*\u0026rdquo;\n}\nThen paste the following Json content in the Body:\n{\n\u0026ldquo;__metadata\u0026rdquo;: {\n\u0026ldquo;type\u0026rdquo;: \u0026ldquo;SP.Data.Teams_x0020_Phone_x0020_Number_x0020_Demo_x0020_10ListItem\u0026rdquo;\n},\n\u0026ldquo;TeamsAdminCenter\u0026rdquo;: {\n\u0026ldquo;Description\u0026rdquo;: \u0026ldquo;Teams Admin Center\u0026rdquo;,\n\u0026ldquo;Url\u0026rdquo;: \u0026ldquo;https://admin.teams.microsoft.com/users/@{triggerOutputs()?[\u0026lsquo;body/UserId\u0026rsquo;]}/account\u0026rdquo;\n}\n}\nAgain, make sure to adjust the list name to your own. There is no space or any other character between the end of the list name and ListItem¬†. All spaces in the list name must be replaced by _x0020_¬†.\nIf you look at the trigger condition again, you might have noticed that the field names like User Principal Name are all written like this: User_x0020_Principal_x0020_Name. I noticed that all columns which contain spaces and have been created via the Graph API are named this way. Teams Admin Center on the other hand has been created manually via SharePoint Online. This column\u0026rsquo;s reference name is now TeamsAdminCenter as you can see in the screenshot above.\nThat‚Äôs it, we finished building our flow. For reference, here‚Äôs the complete layout of the flow without expanded actions.\nForce Sync the¬†List The only problem now is that it won‚Äôt be triggered unless the User Principal Name field changes on any of the list entries. The easiest way to get these fields populated is to just delete all list entries of assigned user numbers and re-run the Runbook.\nFilter the list by Assigned numbers and Account Type: User Account.\nThen delete all the entries and wait for the action to complete.\nNow start the Runbook again or wait for the next scheduled job. Once the job has completed, wait another few minutes for the flow to be triggered.\nIn the flow‚Äôs run history, you should then be able to see a couple of successful flow runs. One for each assigned user number which was previously deleted from the list.\nIn the details of the flow run, we can see that both the item was updated, and that the HTTP request was made to SharePoint.\nIn our SharePoint List, we can now see that both the User Profile and the link to Teams Admin Center have been populated.\nUpdating the Direct Routing Numbers in¬†Azure Chances are that you‚Äôre going to have more/new Direct Routing numbers at some point. For that scenario, I created another script in¬†.\\Setup\\UpdateDirectRoutingNumbers.ps1¬†. This script will compare the contents of the local DirectRoutingNumbers.csv with what‚Äôs stored in the Azure Automation Variable. If the content is not the same, the script will overwrite the content of the Automation Variable with your new local source list. This means that you will always need to include all your Direct Routing numbers in the local CSV file, not just new numbers. If you remove numbers from the local source, they will also be removed from the Automation Variable. Hopefully, you won‚Äôt have to do this too often.\nTeamsPhoneAutomation/UpdateDirectRoutingNumbers.ps1 at main ¬∑ mozziemozz/TeamsPhoneAutomation (github.com)\nConclusion While this may be a read-only solution and it doesn‚Äôt have any management capabilities such as assigning or unassigning phone numbers, I still believe that there‚Äôs tremendous value in this. I think that this could be an interesting approach for smaller companies or non-profit organizations which might not have the cash to purchase an expensive number management solution. The costs for running a Runbook job every now and then should be fairly low. According to this website 500 minutes of Job run time is free every month.\nOf course, this depends on the amount of numbers you have. The more numbers you have, the longer it will take for a job to complete. If we assume that each job requires 5 minutes to run, that would be about $ 6.5 per month if the job runs every hour every day of a month.\nWith this, we can finally have a complete, dynamically updated list of all our phone numbers and their state regarding their type. On top of that, we can make it accessible easily for all users or admins who need to work with this kind of information. For example, we could also add the list as a Tab in a Microsoft Teams Channel.\nFinal Notes I invested a lot of time to perfect this project and I‚Äôm incredibly happy to be finally able to share it with the community and my readers on Medium. I tested both the deployment to Azure and the Runbook logic quite a few times so I‚Äôm fairly confident that this should work in other Tenants as well. Since I don‚Äôt have any Operator Connect numbers available, I couldn‚Äôt test that yet. If you are an Operator Connect customer and want to try this solution, feel free to let me know if it worked for you.\nI mainly tested populating and updating the list with about forty numbers of mixed types. I did make some quick tests (and adjustments) with a list of about 1000 Direct Routing numbers and that has worked well for me so far. If you manage a lot of phone numbers and want to try the solution yourself, I‚Äôm also happy if you can provide feedback on how it performs with even more numbers.\nAs always, I hope you like what I‚Äôve been up to!\n","date":"2023-03-23T13:05:11.692Z","permalink":"https://heusser.pro/p/teams-phone-number-management-on-a-budget-e25d53f65caf/","title":"Teams Phone Number Management on a Budget"},{"content":"I recently came across a very strange issue with Azure Runbooks and UTF-8 encoding. For most IT folks, it‚Äôs no issue if everything is in English but if you work with German speaking users, chances are that you‚Äôre going to run into encoding issues with Umlaute or other special characters eventually. For those who have no idea what I‚Äôm talking about, Umlaute are special characters like ‚Äú√§‚Äù, ‚Äú√∂‚Äù and ‚Äú√º‚Äù which are used very frequently in German.\nThe scenario is the following: I have a very simple Azure Runbook which sends a message card to a Teams channel.\n$uri = \u0026ldquo;YourWebhookUrl\u0026rdquo;\n$body = @\u0026rsquo;\n{\n\u0026ldquo;@context\u0026rdquo;: \u0026ldquo;https://schema.org/extensions\",\n\u0026ldquo;@type\u0026rdquo;: \u0026ldquo;MessageCard\u0026rdquo;,\n\u0026ldquo;themeColor\u0026rdquo;: \u0026ldquo;00A4EF\u0026rdquo;,\n\u0026ldquo;title\u0026rdquo;: \u0026ldquo;UTF8 Test\u0026rdquo;,\n\u0026ldquo;text\u0026rdquo;: \u0026ldquo;Hello W√∂rld!\u0026rdquo;\n}\n\u0026lsquo;@\nInvoke-RestMethod -uri $uri -Method Post -body $body -ContentType \u0026lsquo;application/json; charset=UTF-8\u0026rsquo;\nAs you can see, I purposely wrote ‚ÄúHello W√∂rld‚Äù instead of ‚ÄúHello World‚Äù to demonstrate this. If the runbook is run directly (meaning, there‚Äôs no child runbook involved), there‚Äôs no issue at all and the card is sent to Teams using the correct encoding.\nWorking With Child¬†Runbooks So far so good. In more complex scenarios, you might want to build modular runbooks. An example of that would be where you have some code and some parameters in one runbook (let‚Äôs call that main runbook or child runbook) and have a couple of other runbooks which call your main runbook inline. Let‚Äôs call these runner scripts because they‚Äôre only used to run the main runbook.\nThe advantage of such a setup is that you only need to change the code in one place if you need to update it. For example, if the URL of the webhook changes, we only need to edit the main runbook instead of all the other runbooks as well. You can also read more about that concept in this official Microsoft Learn article.\nWrong Encoding in Child¬†Runbooks However, I have found that somehow the encoding gets messed up and special characters are sent to Teams in the wrong format if a child runbook is called inline from another runbook which runs in front of it.\nIf you want to call another runbook from any runbook in the same automation account, you can just reference it by its name. All that‚Äôs needed is the following code which really just points to another script. Note that you do need to add¬†.ps1 at the end of your runbook name.\n. .\\SendMessageCardMain.ps1\nIt doesn‚Äôt make any difference if dot sourcing is used or not. The encoding will be wrong in either case.\nThis isn‚Äôt just about the message which is sent to Teams through a web request. The encoding is wrong in general and thus when using Write-Output as well.\nWorkaround The trick is to store the special characters inside a variable which is already known to the runner script (the one which will be submitted to the worker), and then calls the child runbook.\n$externalText = \u0026ldquo;W√∂rld\u0026rdquo;\n. .\\SendMessageCardMain.ps1\nThe word which contains the special character is replaced by the variable in the main script (child runbook).\n$uri = \u0026ldquo;YourWebhookUrl\u0026rdquo;\n$body = @\u0026rdquo;\n{\n\u0026ldquo;@context\u0026rdquo;: \u0026ldquo;https://schema.org/extensions\",\n\u0026ldquo;@type\u0026rdquo;: \u0026ldquo;MessageCard\u0026rdquo;,\n\u0026ldquo;themeColor\u0026rdquo;: \u0026ldquo;00A4EF\u0026rdquo;,\n\u0026ldquo;title\u0026rdquo;: \u0026ldquo;UTF8 Test\u0026rdquo;,\n\u0026ldquo;text\u0026rdquo;: \u0026ldquo;Hello $externalText!\u0026rdquo;\n}\n\u0026ldquo;@\nInvoke-RestMethod -uri $uri -Method Post -body $body -ContentType \u0026lsquo;application/json; charset=UTF-8\u0026rsquo;\nThis way, the first runbook already knows the correct encoding and it works, just like it did in the first example where we only had one runbook.\nLet‚Äôs assume that we have one main runbook which will just send Message Cards to Teams, but we also have many different runner scripts which will send different kind of messages to Teams.\nThis would make the code quite hard to maintain. Imagine if we want to replace the word ‚ÄúW√∂rld‚Äù with ‚ÄúZ√ºrich‚Äù for example. We‚Äôd have to do this for each runner script if the variable is stored inside each runner script.\nOptimized Workaround 1 (Using Automation Variables) Instead, we can just put the code into an Automation Variable as a string. Automation Variables are saved inside the Automation Account but outside of all the runbooks. This effectively gives us a location to store the code once but all runbooks inside that Automation Account will be able to access it.\nIn the runner script, we import the Automation Variable using the internal Cmdlet. This is only available in Azure Runbooks and does not require additional authentication.\n$AutomationVariableCode = Get-AutomationVariable -Name \u0026ldquo;AutomationVariableCode\u0026rdquo; | Out-String\nInvoke-Expression $AutomationVariableCode\n. .\\SendMessageCardMain.ps1\nThere‚Äôs no mention of $externalText inside the runbook but it‚Äôs set by Invoke-Expression¬†.\nThis allows us to change the value of the variable without touching any of our runner scripts which makes it a lot more scalable and easier to maintain while keeping the correct encoding.\nOf course, the Automation Variable could also contain more complex code like a switch statement to define different messages or contain the same message in different language. For demonstration purposes, I kept it simple by just using a single value variable.\nOn the downside, this makes editing the code complicated and error prone, since it‚Äôs just a string stored inside a variable without any kind of syntax checking. To tackle that issue, one would need to copy it to a local IDE (e.g. VS Code) each time the code is updated and paste it back into the Automation Variable once it‚Äôs done.\nOptimized Workaround 2 (Using PowerShell Runbooks) What about storing the code in yet another runbook? This would allow for easier editing and testing right in the browser. But is it possible\u0026hellip;? As it turns out, it is!\nTo be able to get the contents/code of what I call the content runbook we need to make sure that the modules Az.Accounts and Az.Automation are installed in our Automation Account.\nWe also need a Managed Identity to connect to Azure since we‚Äôll be using regularAz* Cmdlets and not internal ones this time around.\nLet‚Äôs add a little more code to our runner script. My Tenant Id is also stored inside an Automation Variable, thus it‚Äôs not visible in the code.\n$tenantId = Get-AutomationVariable -Name \u0026ldquo;tenantId\u0026rdquo;\n$azAccount = Connect-AzAccount -Identity -TenantId $tenantId\n$exportRb = Export-AzAutomationRunbook -AutomationAccountName \u0026ldquo;mzz-automation-account-001\u0026rdquo; -ResourceGroupName \u0026ldquo;mzz-rmg-001\u0026rdquo; -Name \u0026ldquo;SendMessageCardContent\u0026rdquo; -OutputFolder $env:temp\nGet-Content -Path $env:temp\\$exportRb -Encoding UTF8 | Out-String | Invoke-Expression\n. .\\SendMessageCardMain.ps1\nWith a Managed Identity, we don‚Äôt need to provide any kind of additional authentication. Everything is handled by the Automation Account using the Managed Identity automatically. We only need to provide Connect-AzAccount -Identity -TenantId $tenantId¬†.\nWe then export the runbook using Export-AzAutomationRunbook to $env:temp. Finally, we import the runbook‚Äôs content by using Get-Content and execute its code by piping it through to Invoke-Expression¬†.\nIn case I have lost you at this point, let‚Äôs recap very briefly.\nBy using Invoke-Expression instead of calling the runbook inline, we make sure that the externally stored code is running in the scope of the runner script and not the child runbook, which will keep the encoding intact.\nAnd we‚Äôre jumping through hoops here by storing the values of the variables in another runbook so that they can be updated without touching each of our runner scripts. If it helps, you can also think about a scenario where you‚Äôre hosting some kind of monitoring or reporting solution for different customers inside your own Tenant/Automation Account. Each customer has its own runner script with their own parameters but there‚Äôs only one main runbook which contains all the code.\nIf we need to update the script logic, only the main runbook needs to be updated. If we need to make changes to the content of the messages, only the runbook storing these values needs to be updated.\nNow let‚Äôs change the word inside the runbook to something else. Instead of editing an Automation Variable, we can just edit the runbook, which is a lot more user friendly.\nDon‚Äôt forget to publish the runbook. Otherwise, the values won‚Äôt be updated. As expected, this works like a charm.\nIf for some reason you don‚Äôt want to read your variables into memory in the runner script and do it in the child runbook instead, you can also use the Invoke-Expression method from there. This works as well, even if the child runbook is called inline by another runbook and the runner script doesn‚Äôt have any reference to the special character variables at all.\nI have no idea why it doesn‚Äôt work if special characters are included explicitly in child runbooks though. And it took me quite some time to figure out a workaround for this. I hope that this article is useful to you, if you‚Äôve been struggling with modular runbooks and encoding issues as well.\n","date":"2023-03-03T10:03:56.413Z","permalink":"https://heusser.pro/p/fix-utf-8-encoding-when-calling-azure-child-runbooks-inline-78644e6af242/","title":"Fix UTF-8 Encoding When Calling Azure Child Runbooks Inline"},{"content":"The M365 Call Flow Visualizer focuses on retrieving configurations of Teams Auto Attendants and Call Queues which have already been built. And it does so by using PowerShell.\nBut what about the opposite? Can we use PowerShell to create a new call flow from scratch in just a few minutes as well?\nIn this article, I‚Äôm going to show you how you can create a basic, yet fully functional call flow with PowerShell. The only thing you‚Äôll need to do yourself in the end is to add users to the Team.\nWhat is Needed to Build a Call Flow?\nBefore we get into the script, let‚Äôs look at what steps we need to take to build a call flow.\nCreate resource accounts License resource accounts (and set Usage Location) Assign a phone number (and voice routing policy if it‚Äôs a Direct Routing number) to the resource accounts Create a Microsoft 365 Group with a Team (For voice enabled channel and shared voicemail) Configure M365 Group for Follow in Inbox and Show in Outlook Create and configure the Call Queue Assign the Resource Account to the Call Queue Create the Auto Attendant and configure forwarding to the queue during business hours Assign the Resource Account to the Auto Attendant These are quite a few steps to conclude but the hardest part about this is remembering the correct order of all the steps so you can do it as fast as possible. For example, if you forget to set the Usage Location to the same country as the phone number you want to assign, you will have to go back and wait for the change to be propagated.\nAnother example is that you should always start at the back of your call flow. You can‚Äôt fully configure a Call Queue if you don‚Äôt have the Team or the M365 Group for shared voicemail yet. And you can‚Äôt finish configuring your Auto Attendant if you haven‚Äôt built the queue before.\nIf you want to learn more about resource accounts or shared voicemail, I suggest the following articles of mine.\nEverything You Ever Wanted to Know About Teams Resource Accounts | by martin heusser | Medium\nEverything you ever wanted to know about Microsoft Teams Phone and Shared Voicemail | by martin heusser | Medium\nSome Notes About This¬†Script The script follows my personal best practices when building call flows and considers all the aforementioned examples of steppingstones for maximum efficiency.\nThis is not intended to build super complex call flows. Instead, it is just an example of how one can write a deployment script, which does everything from A-Z in an efficient order. It can, however, build multiple call flows in a row.\nWhile it would be possible to make it even more efficient by, for example, creating and licensing all the resource accounts from the CSV entries first, then create all the Call Queues and at last all the Auto Attendants, I decided not to pursue this road for the sake of simplicity. Instead, the script will create each call flow after the other, which probably takes slightly longer to complete.\nThere are some steps where we need to wait for the previous steps to complete. For example, when a Resource Account is created, it usually takes a few seconds for the corresponding User Object in Teams to be created as well. Rest assured though; the script will handle all of that on its own. So don‚Äôt get spooked if you see some red error messages in PowerShell. These are just standard error messages, where the script tries to query a user which couldn‚Äôt be found yet.\nBecause we‚Äôre also querying a tenant‚Äôs domain names and modify licenses this script requires some additional scopes for Microsoft Graph. So be sure to have a Global Admin account ready to consent to these scopes.\nConnect-MgGraph -Scopes \u0026ldquo;User.ReadWrite.All\u0026rdquo;, `\n\u0026ldquo;Group.ReadWrite.All\u0026rdquo;, `\n\u0026ldquo;Domain.ReadWrite.All\u0026rdquo;, `\n\u0026ldquo;Organization.ReadWrite.All\u0026rdquo;, `\n\u0026ldquo;Directory.ReadWrite.All\u0026rdquo;\nTo configure the Microsoft 365 Group the script requires the ExchangeOnlineManagement PowerShell Module in addition to MicrosoftTeams and Microsoft.Graph**.** If you don‚Äôt have it already, you can use the following command to install it.\nInstall-Module ExchangeOnlineManagement\nHow Does it¬†Work? In my GitHub Repository, you will find a sample file called ‚ÄúVoiceAppList.csv‚Äù. All you need to do is to fill in your information there. And run the script.\nThese are the details which can be passed from the CSV file to the script.\nDepartmentName\nThis name of the queue or Team. It will be added to all elements in the call flow: Team, Channel, Resource Accounts, Auto Attendant, Call Queue. For example, if you set ‚ÄúMarketing‚Äù as your DepartmentName, your queue will be called ‚ÄúMarketing CQ‚Äù. TopLevelNumber\nThe number which is called by customers and assigned to the Auto Attendant. It must be an E.164 number. See this for more information. NumberType\nThis is required for the phone number assignment. Valid values: CallingPlan, OperatorConnect, DirectRouting, $null¬†. Leave the field empty in the CSV if you don‚Äôt want to assign a number just yet. VoiceRoutingPolicyName\nThis is only required if you want to assign a Direct Routing number. It‚Äôs only needed if the AA should be capable of external transfers later on. It‚Äôs only added as a precaution. You can read how to get the name of your voice routing policies here. UsageLocation\nThis must be the same as the Phone Number if your‚Äôre using Calling Plans. E.g. ‚ÄúCH‚Äù or ‚ÄúGB‚Äù. AgentAlertTime\nSet-CsCallQueue (SkypeForBusiness) | Microsoft Learn TimeoutThreshold\nSet-CsCallQueue (SkypeForBusiness) | Microsoft Learn PromptLanguage\nThis is the language of the text to speech prompt. See this MS Learn article for more information. You will be prompted by Out-GridView if you specify an invalid language Id. TimeoutSharedVoicemailPrompt\nSet-CsCallQueue (SkypeForBusiness) | Microsoft Learn AfterHoursDisconnectPrompt\nNew-CsAutoAttendantPrompt (SkypeForBusiness) | Microsoft Learn TimeZone\nThe time zone of the Auto Attendant. See this MS Learn article for more information. You will be prompted by Out-GridViewif you specify an invalid time zone Id. BusinessHoursStart1\nIf none of the business hours fields are populated, the script won‚Äôt create an after hours call flow for the Auto Attendant. If only BusinessHoursStart1 and BusinessHoursEnd1 are populated, the AA will only have one time slot. If BusinessHoursStart2 and BusinessHoursEnd2 are populated as well, the AA will have two time slots, e.g. lunch break.\nE.g. 08:00 BusinessHoursEnd1\nE.g. 12:15 BusinessHoursStart2\nE.g. 13:30 BusinessHoursEnd2\nE.g. 17:45 DomainSuffix\nBy default, the script will use your tenant‚Äôs default domain for resource account UPNs or MailNicknames. If you want to change that, you can specify and domain that‚Äôs available in your tenant as -DomainSuffix¬†. E.g. ‚Äúexample.onmicrosoft.com‚Äù. Running the script will deploy a simple call flow with an Auto Attendant, business hours and one Call Queue which uses a Voice Enabled Channel for each line in the CSV file. Outside of business hours, the Auto Attendants will play a message and disconnect the call.\nThe Call Queues will time out after the amount of seconds which is defined in -TimeoutThreshold and then forward the call to shared voicemail once the greeting has been played back.\nThe script automatically creates a new Team and a Channel for the Queue as well. I prefer to use dedicated over existing Teams and Channels because not all team members of an existing team are potentially going to answer calls.\nWhen a new Team is created and the Microsoft 365 Group has not existed before, the group is by default hidden from Outlook Clients. Because we want the agents of the queue to have access to the group mailbox in Outlook, the script will automatically enable the Follow in Inbox feature and unhide the group from Outlook Clients.\nShared voicemail is another reason I like to use dedicated groups. With a new group, we can make sure that the only kind of emails received in this group\u0026rsquo;s inbox are voicemails, and we can enable Follow in Inbox without any concern of potentially spamming dozens of other team members by sending all group emails to their personal inboxes.\nThe Script Finishing Up While the call flow is technically already able to receive calls after it has been deployed by the script, you‚Äôll still need to add members to the queue. Otherwise, the calls will never be signaled to any agent.\nRemember that only members of the Team who are also Enterprise Voice Enabled will be added to the queue‚Äôs agent list. If you don‚Äôt want to wait a few hours for the agent list to update after you have added the members, you might want to check out this article. It explains how to force sync an agent list of Call Queues.\nAs mentioned before, this is a mere example of a very simple call flow. However, if most of your call flows only consist of an Auto Attendant forwarding calls to a Call Queue (Like it‚Äôs common in many small businesses), PowerShell can still be immensely helpful to lay the ground works.\nNaturally, you can still go into TAC and adjust everything to your needs after the script has built your scaffolding. You just won‚Äôt have to bother adding resources accounts and associating them with your voice apps etc.\nCreating Auto Attendants with PowerShell is quite a complex process compared to Call Queues or other Microsoft resources. If you want to adjust my script to your specific needs, a good place to start is the official documentation from Microsoft. As far as I can tell, they recently added updated example scripts which might be helpful.\nNew-CsAutoAttendant (SkypeForBusiness) | Microsoft Learn\nSet-CsAutoAttendant (SkypeForBusiness) | Microsoft Learn\nNow go ask ChatGPT to write you a script that does the same.\n","date":"2023-02-18T17:24:32.469Z","permalink":"https://heusser.pro/p/bulk-deploy-microsoft-teams-call-flows-with-powershell-in-minutes-1a78099fe94f/","title":"Bulk Deploy Microsoft Teams Call Flows with PowerShell in Minutes"},{"content":"\nBy now, most people should have heard about HEIC (or HEIF) and HEVC. HEVC‚Ää‚Äî‚ÄäHigh Efficiency Video Codec is a video codec optimized for 4K content and HEIC is the file name extension for images saved with the High Efficiency Image File Format. Apple iPhones have supported these formats for quite some time now. However, they are mutually exclusive options to each other. Meaning, we can‚Äôt use HEVC for videos and JPG for photos. We can only choose if we want to use the new or the legacy formats in iOS.\nI back up / sync all my photos from my iPhone to OneDrive. Often, these are not just vacation pictures but also photos which I might need to share with others. While most modern systems can display and work with HEIF photos without issues, there are still some scenarios for which a JPG is simply better suited.\n![](*.HEIC image, chances are that the corporate IT department of some companies are lagging behind and might have blocked these AppDownloads. The only solution was to convert the images and send them again.)\nIf you bing ‚ÄúHEIC Converter‚Äù you‚Äôll be overwhelmed with the number of websites which claim to offer the best HEIC converter. However, I was looking for a much simpler way. All I want to do is to right click any HEIC image and have it converted to JPG.\nIn this post, I explained how the App Custom Context Menu can be used to create your own context menu entries in Windows 11.\nBefore we create a custom context menu entry for that, we need to install ImageMagick. This is a command line tool which lets you do all kinds of image conversion operations.\nOnce that is installed, create a new custom context menu entry like in this example.\nParam:\n\u0026ldquo;cmd /c \u0026ldquo;magick \u0026ldquo;{path}\u0026rdquo; \u0026ldquo;{parent}\u0026rdquo;\\{name}.jpg\u0026rdquo;\u0026rdquo;\nIf you like, you can also create a second one which will remove the original HEIC files after they have been converted to JPG.\nParam:\n\u0026ldquo;cmd /c \u0026ldquo;magick \u0026ldquo;{path}\u0026rdquo; \u0026ldquo;{parent}\u0026rdquo;\\{name}.jpg \u0026amp; del \u0026ldquo;{path}\u0026rdquo;\u0026rdquo;\u0026rdquo;\nMake sure to copy the params exactly as they are as the double quotes are important.\nOr alternatively, open your custom context menu folder by clicking the folder icon in the upper left corner and create a new *.json file for both the examples.\nExample: Keep Original Files\n{\n\u0026ldquo;title\u0026rdquo;: \u0026ldquo;HEIC to JPG (Keep Original Files)\u0026rdquo;,\n\u0026ldquo;exe\u0026rdquo;: \u0026ldquo;\\\u0026ldquo;C:\\\\Windows\\\\System32\\\\cmd.exe\\\u0026rdquo;\u0026rdquo;,\n\u0026ldquo;param\u0026rdquo;: \u0026ldquo;\\\u0026ldquo;cmd /c \\\u0026ldquo;magick \\\u0026quot;{path}\\\u0026rdquo; \\\u0026quot;{parent}\\\u0026rdquo;\\\\{name}.jpg\\\u0026rdquo;\\\u0026quot;\u0026quot;,\n\u0026ldquo;icon\u0026rdquo;: \u0026ldquo;\\\u0026ldquo;C:\\\\Users\\\\marti\\\\OneDrive\\\\Bilder\\\\Icons\\\\Apps\\\\Gallery.ico\\\u0026rdquo;\u0026rdquo;,\n\u0026ldquo;acceptExts\u0026rdquo;: \u0026ldquo;.heic .heif\u0026rdquo;,\n\u0026ldquo;acceptDirectory\u0026rdquo;: false,\n\u0026ldquo;acceptFile\u0026rdquo;: true,\n\u0026ldquo;acceptMultipleFilesFlag\u0026rdquo;: 1,\n\u0026ldquo;pathDelimiter\u0026rdquo;: \u0026ldquo;\u0026rdquo;,\n\u0026ldquo;paramForMultipleFiles\u0026rdquo;: \u0026ldquo;\u0026rdquo;,\n\u0026ldquo;index\u0026rdquo;: 1\n}\nExample: Remove Original Files\n{\n\u0026ldquo;title\u0026rdquo;: \u0026ldquo;HEIC to JPG (Remove Original Files)\u0026rdquo;,\n\u0026ldquo;exe\u0026rdquo;: \u0026ldquo;\\\u0026ldquo;C:\\\\Windows\\\\System32\\\\cmd.exe\\\u0026rdquo;\u0026rdquo;,\n\u0026ldquo;param\u0026rdquo;: \u0026ldquo;\\\u0026ldquo;cmd /c \\\u0026ldquo;magick \\\u0026quot;{path}\\\u0026rdquo; \\\u0026quot;{parent}\\\u0026rdquo;\\\\{name}.jpg \u0026amp; del \\\u0026quot;{path}\\\u0026rdquo;\\\u0026quot;\\\u0026quot;\u0026quot;,\n\u0026ldquo;icon\u0026rdquo;: \u0026ldquo;\\\u0026ldquo;C:\\\\Users\\\\marti\\\\OneDrive\\\\Bilder\\\\Icons\\\\Apps\\\\Gallery.ico\\\u0026rdquo;\u0026rdquo;,\n\u0026ldquo;acceptExts\u0026rdquo;: \u0026ldquo;.heic .heif\u0026rdquo;,\n\u0026ldquo;acceptDirectory\u0026rdquo;: false,\n\u0026ldquo;acceptFile\u0026rdquo;: true,\n\u0026ldquo;acceptMultipleFilesFlag\u0026rdquo;: 1,\n\u0026ldquo;pathDelimiter\u0026rdquo;: \u0026ldquo;\u0026rdquo;,\n\u0026ldquo;paramForMultipleFiles\u0026rdquo;: \u0026ldquo;\u0026rdquo;,\n\u0026ldquo;index\u0026rdquo;: 2\n}\nSave and restart your PC.\nThe next time you need to quickly convert a HEIC file to JPG, simply right click the file (or files) and select one of the options from your custom context menu.\nHere‚Äôs a short demo of both actions.\nEven though it requires some steps to set up, this is by far the easiest and most convenient way to convert HEIC to JPG. There‚Äôs no need to install any annoying shareware or let alone pay for one.\n","date":"2023-02-10T21:10:34.741Z","permalink":"https://heusser.pro/p/the-easiest-way-to-convert-heic-images-to-jpg-on-windows-11-44fad1179e98/","title":"The Easiest Way to Convert HEIC Images to JPG (on Windows 11)"},{"content":"Are your Teams Auto Attendants, Call Queues and Resource Accounts a mess? Or have you lost track of who created which accounts or Voice Apps? You know what they say‚Ä¶\nToo Many Cooks Spoil the Broth.\nIt‚Äôs not really spring yet but who cares? Cleaning up your environment is always a good thing. Today we‚Äôre talking Teams Phone reporting again. In case you‚Äôve missed some of my previous articles, here‚Äôs an overview of what handy scripts I already released last year.\nReport on Teams Call Queue Opt In Status and Assignment Paths\nFind All Auto Attendants and Call Queues a User is Associated with\nAutomatically render Microsoft Teams Call Flow Diagrams\nHow To Export a Teams Call Flow to PNG\nI remember that somebody on social media asked me if it was possible to get a list of all Resource Accounts which are not assigned to any Auto Attendant or Call Queue. That‚Äôs why I wrote this script in December 2022.\nM365CallFlowVisualizer/FindUnassignedResourceAccounts.ps1 at main ¬∑ mozziemozz/M365CallFlowVisualizer (github.com)\nThis time, I‚Äôve taken it even further and used the M365 Call Flow Visualizer to not only find unused Resource Accounts but also Call Queues and Auto Attendants which are not in use.\nWhat Qualifies as Not in¬†Use? First of all, any Attendant or any Queue which does not have a Resource Account assigned, can‚Äôt be called, or transferred to. They exist, but they‚Äôre useless until a Resource Account is linked. This means that all Queues and Attendants which do not have a Resource Account assigned, will be included in the report.\nThe concept of how Resource Accounts work in combination with Queues and Attendants is explained in detail in the article linked below.\nEverything You Ever Wanted to Know About Teams Resource Accounts\nNext, the script checks for all Auto Attendants and Call Queues which have a Resource Account without Phone Number assigned. Of course, these are often nested behind top-level Voice Apps and thus can be called without issues. My new script runs the Visualizer (without creating any diagrams) for all top-level Voice Apps (Attendants and Queues with phone numbers) to create a list of all their nested Voice Apps.\nBecause the Visualizer is also able to read and process user calling settings, it will even detect if a Voice App is set as a user‚Äôs forwarding or unanswered target and thus also add it to the list of all nested Voice Apps.\nIf this list does not contain the current Voice App, it will be included in the report as well. In complex environments, this will save you a lot of time since you don‚Äôt need to click through all your Voice Apps manually to check them.\nLast but not least, it uses the same code bits from the original ‚ÄúFindUnassignedResourceAccounts.ps1‚Äù script to add any Resource Account which is not associated with any Voice App to the report.\nCaveats There‚Äôs one caveat though. In theory, you could have a Voice App (or multiple) which are only called internally by their SIP Address. In this case, the Voice App doesn‚Äôt need to be nested anywhere and it doesn‚Äôt need a phone number either. All it needs is to have a Resource Account assigned. These Apps will be included in the report as well, so make sure to be extra careful before you actually delete anything.\nUnder the¬†Hood During testing, I noticed that Voice Apps which are nested inside a Holiday Call Handling were not detected by the script either. I‚Äôve updated my M365 Call Flow Visualizer so that it will now also expand Auto Attendants and Call Queues which are part of a Holiday transfer action.\nInitially, I thought I‚Äôd only be able to do this for transfers to Call Queues and Auto Attendants. But with some persistence I was able to also display IVRs which are configured as part of a Holiday Call Handling! Yes, really! This means that the Visualizer can now render every possible call flow which can be configured. At least to my knowledge.\nHere‚Äôs an example of the new functionality. We can see that the Call Handling for National Swiss Holiday forwards to the Call Queue Ext Pstn Fwd Test inside the Holiday table. Unfortunately, linking both CQ Nodes together, would have messed up the left-right direction of the subgraph and instead made it a top-down one. Therefore, I had to get creative and just link the call flow of the Voice App to the Holiday Subgraph. As an exception, there are now two nodes for the Call Queue Ext Pstn Fwd Test. One is inside the Holiday table, and one is placed in the main diagram.\nIt‚Äôs basically the same for Holiday IVRs (Voice Menus). They include the name of the Holiday Call Handling in which they are configured. This makes it a little easier to spot the corresponding node in the main diagram.\nIf you want to try this for yourself, you need to add the following parameters when you call the script.\n-ShowNestedHolidayCallFlows $true\n-ShowNestedHolidayIVRs $true\nIf you‚Äôre interested in learning more about how Holidays work in Teams, consider giving this article a read.\nEverything You Ever Wanted to Know About Teams Holidays\nExample Output The script will generate a CSV file containing all unused components including the reason as to why they‚Äôre not in use.\nI struggled a bit to find a perfect naming for all the columns. The column ‚ÄúAssociation‚Äù tells you whether the Voice App has a Resource Account assigned or if the Resource Account is assigned to a Voice App. The other ones should be self-explanatory.\nFree Download The script is available for free in my GitHub Repo of the M365 Call Flow Visualizer. Make sure that you clone it or download the whole repository as Zip file since there are dependencies.\nM365CallFlowVisualizer/FindUnusedVoiceAppsAndResourceAccounts.ps1 at main ¬∑ mozziemozz/M365CallFlowVisualizer (github.com)\nPlease use this script at your own risk, even though the script does not change or delete anything in your environment. (It only uses Get-* Cmdlets). Just promise to make sure that you verify that any Auto Attendant or Call Queues are indeed not needed anymore before you hit that delete button. Even if you still have to manually confirm and delete unused Voice Apps, I still hope that the output of the script makes it easier for you to identify them at scale.\n","date":"2023-02-01T20:43:08.759Z","permalink":"https://heusser.pro/p/teams-auto-attendant-and-call-queue-spring-cleaning-5e7e6d54b9ca/","title":"Teams Auto Attendant and Call Queue Spring-Cleaning"},{"content":"Today I discovered that there has been an update to Microsoft Teams Auto Attendants and Call Queues Shared Voicemail. In the past it was only possible to configure a Microsoft 365 Group as the transfer target of shared voicemail, as it‚Äôs described in this article.\nNow the search box in Auto Attendant or Call Queue Wizards also return Distribution Lists and Mail Enabled Security Groups.\nI don‚Äôt know when this change was implemented but there‚Äôs evidence out there that it has been around for at least some time or even since shared voicemail has been rolled out.\nSince all the official Microsoft documentation I could find (then and now) only mentioned Microsoft 365 Groups, I honestly never even tried to search for another group type.\nI feel like it‚Äôs been like this for a bit but I couldn‚Äôt tell you when.\n\u0026mdash; Robert Schoneman (@rschoneman) January 27, 2023 A customer insisted on trying it 2 years ago and to my surprise it worked\n\u0026mdash; Dario Woitasen üá¶üá∑üáÆüáπüá™üá∏ (@dariomws) January 27, 2023 Has always worked since shared voicemail was an option, could never understand why one would create a m365 group to route voicemail. The search exposed it the first time I went to set it.\n\u0026mdash; Michael LaMontagne (@RealTimeUC) January 28, 2023 The documentation is not updated yet. Better yet, it still says Office 365 instead of Microsoft 365 group.\nThe OverflowActionTarget parameter represents the target of the overflow action. If the OverFlowAction is set to Forward, this parameter must be set to a Guid or a telephone number with a mandatory ‚Äòtel:‚Äô prefix. If the OverflowAction is set to SharedVoicemail, this parameter must be set to an Office 365 Group ID. Otherwise, this parameter is optional.\nThe description in the Auto Attendant and Call Queue Wizard also still references Microsoft 365 Groups only. But it does return Distribution Lists and Mail Enabled Security Groups when we search for them.\nIt does not find security groups, which makes sense, since they‚Äôre not capable of receiving emails.\nTesting This begs the question: is it only possible to choose these new group types or are shared voicemails actually delivered to Distribution Lists too?\nLet‚Äôs find out‚Ä¶\nIt seems to be working just fine. Here‚Äôs a screenshot of the email received in Outlook.\nWhen hovering over the recipient\u0026rsquo;s address, we can see what type of group it is.\nNote that shared voicemail emails to Distribution Lists and Mail Enabled Security Groups look exactly the same in Outlook. Both are labeled as ‚ÄúDistribution list‚Äù, even though they are technically of different group types.\nPowerShell Nothing has changed on the PowerShell side of things. The OverflowAction is still called ‚ÄúSharedVoicemail‚Äù and the OverflowActionTarget.Type is still ‚ÄúMailbox‚Äù while OverflowActionTarget.Id remains the group‚Äôs Object Id.\nPS V:\\GitHub\\M365CallFlowVisualizer\u0026gt; $cq.OverflowAction SharedVoicemail\rPS V:\\GitHub\\M365CallFlowVisualizer\u0026gt; $cq.OverflowActionTarget Id Type -- ---- 413a7c2e-e359-4424-b2f7-xxxxxxxxxxxx MailBox\rThe Auto Attendant properties also remain unchanged.\nPS V:\\GitHub\\\\M365CallFlowVisualizer\u0026gt; $aa.DefaultCallFlow.Menu.MenuOptions Action : TransferCallToTarget DtmfResponse : Automatic VoiceResponses : {} CallTarget : Type = SharedVoicemail Id = 413a7c2e-e359-4424-b2f7-xxxxxxxxxxxx Prompt : Luckily, this means that I don‚Äôt have to update the M365 Call Flow Visualizer and everything continues to work like it did before.\nConfiguring via PowerShell What‚Äôs a bit worrisome is that I was able to set the Id of a Security Group as the Shared Voicemail Target for a Call Queue through PowerShell. It doesn‚Äôt look like PowerShell is evaluating the group type when the queue is saved.\nOnce the queue has been updated through PowerShell, TAC will even display the name of the Security Group in the Wizard. As long as we don‚Äôt remove the Security group from the Shared Voicemail Target, it‚Äôs even possible to edit and save the queue through TAC. The invalid group remains.\nWhen I delete the group and search for it again, nothing is returned anymore, as it should be.\nTo test this, I made a call to the queue. In this case, my overflow threshold was set to zero, so the call failed immediately with a busy tone.\nI then did the same for the timeout action target and called the queue again. As soon as the timeout was reached, I could hear the transfer beep and then the call failed with a busy tone too.\nLuckily, it‚Äôs a different story with Auto Attendants. When I tried the same thing there, an error was returned, like I expected for Call Queues in the first place.\nMicrosoft.Teams.ConfigAPI.Cmdlets.internal\\Set-CsAutoAttendant :\nA mail-enabled group with Id (da027ae9-467b-4334-829c-xxxxxxxxxxxx)\ncould not be found. Please give correct parameter value.\nConclusion While I wouldn‚Äôt implement this in a production environment until the official documentation is updated and we know for sure, that this is working as Microsoft intended, I think it‚Äôs a great feature update for Teams Phone. Only being able to just use Microsoft 365 Groups, also meant that we always had to make sure that users are subscribed to receive all group emails or enabled the Follow in Inbox feature for themselves.\nI will report the missing group type validation for Set-CsCallQueue to Microsoft and hope that they fix it soon. In the mean time, make sure that you‚Äôre extra careful and only configure Group Ids of M365 Groups, Distribution Lists or Mail Enabled Security Groups.\nI‚Äôll also see if I can update the Visualizer to include group type for shared voicemail in the diagrams.\n","date":"2023-01-27T21:57:19.053Z","permalink":"https://heusser.pro/p/microsoft-teams-shared-voicemail-now-supports-distribution-lists-and-mail-enabled-security-groups-cc6453f88f1/","title":"Microsoft Teams Shared Voicemail Now Supports Distribution Lists and Mail Enabled Security Groups"},{"content":"If you‚Äôre reading this article; it probably means that you‚Äôre wondering why suddenly some of your auto attendants are using male voices in greetings. Just as I was. You might also have noticed, that Microsoft introduced a few new supported languages for Teams auto attendant and call queue text-to-speech (TTS) greetings a couple of months ago.\nWhich is very nice‚Ää‚Äî‚Ääin theory. But in reality, they messed up, at least to some exent. All newly created or any existing auto attendant where you change the language will now default to a male voice in TTS greetings for many languages. Before that it was female for at least all the languages I had worked with in the past.\nWhy Is That a¬†Problem? There‚Äôs no option to change the VoiceId (female/male) from Teams Admin Center for either auto attendants or call queues. Call Queues still default to a female VoiceId while auto attendants now default to a male voice for most major languages. This means that if your call flow uses both, attendants and queues (like most call flows do), you will face a rather unpleasant inconsistency. In one part of the call flow, your callers will hear male voices and in other parts they will hear female voices in greetings and announcements. This is not a good user experience.\nWhat About PowerShell? While it‚Äôs possible to change the voice (female/male) on an auto attendant with PowerShell, it‚Äôs not possible to do the same for call queues.\nThis means that greetings of call queues will always be synthesized by a female voice. There‚Äôs not even a VoiceId property returned by PowerShell, only LanguageId. The only way to verify this is to actually call the queue and listen to the announcements.\nI did just that. I created a new call queue with en-US set as it‚Äôs language and configured a TTS welcome greeting. Once I called the number, I was indeed greeted by a female voice, like it‚Äôs always been.\nWelcome greetings are not the only greetings a caller can hear when interacting with a call queue though. Other scenarios are shared voicemail on timeout or overflow. The funny thing with the welcome TTS greeting is that as of the time of drafting this article, there‚Äôs still no option to set or even view this property in PowerShell. Not even in Teams PowerShell 4.9.1.\nIf you‚Äôre using TTS welcome greetings on your call queues in production, please read the following section very carefully. Because there‚Äôs no PowerShell support for TTS welcome greetings on call queues yet, any configured TTS welcome greeting will be deleted from your queues, every time you save a queue using PowerShell!\nDon‚Äôt believe me? I‚Äôm going to show you. Notice how I only changed the overflow threshold. This doesn‚Äôt even remotely have anything to do with greetings or language settings.\nAfter the queue has been updated by PowerShell, the TTS welcome greeting is gone. For Teams Voice Admins, this means that we either can‚Äôt use TTS welcome greetings, if we frequently use PS to update our queues, we can only use TAC to update queues or that we have to think about setting the greeting in TAC again, every time a change was made via PowerShell. None of them are good options and the last of them certainly defeats the purpose of PowerShell entirely. The only real option here is to use an audio file as welcome greeting until Microsoft has fixed this.\nWhat About Auto Attendants? So far, we‚Äôve established that call queues always use a female voice for TTS greetings. On auto attendants it‚Äôs actually possible to change the VoiceId by PowerShell.\nHere‚Äôs a newly created auto attendant with en-US language.\n$aa = Get-CsAutoAttendant -Identity 77b1706a-59a8-4832-9f49-f7ff80e0da97\n$aa\nIdentity : 77b1706a-59a8-4832-9f49-f7ff80e0da97\nTenantId : 4bffbf87-53a0-4fce-b58b-4179cb3a3b7d\nName : Test Voice\nLanguageId : en-US\nVoiceId : Male\nDefaultCallFlow : Test Voice Default call flow\nOperator :\nTimeZoneId : W. Europe Standard Time\nVoiceResponseEnabled : False\nCallFlows : Test Voice After hours call flow\nSchedules : After hours Test Voice\nCallHandlingAssociations : AfterHours(1)\nStatus :\nDialByNameResourceId :\nDirectoryLookupScope :\nApplicationInstances : {}\nAuthorizedUsers : {}\nTo change the VoiceId we can use the following code.\n$aa.VoiceId = \u0026ldquo;Female\u0026rdquo;\nSet-CsAutoAttendant -Instance $aa\nThis will return the following output. Notice how the VoiceId changed to Female.\nIdentity : 77b1706a-59a8-4832-9f49-f7ff80e0da97\nTenantId : 4bffbf87-53a0-4fce-b58b-4179cb3a3b7d\nName : Test Voice\nLanguageId : en-US\nVoiceId : Female\nDefaultCallFlow : Test Voice Default call flow\nOperator :\nTimeZoneId : W. Europe Standard Time\nVoiceResponseEnabled : False\nCallFlows : Test Voice After hours call flow\nSchedules : After hours Test Voice\nCallHandlingAssociations : AfterHours(1)\nStatus :\nDialByNameResourceId :\nDirectoryLookupScope :\nApplicationInstances : {}\nAuthorizedUsers : {}\nWhen I initially discovered this a couple of months ago, I could have sworn that every time I changed something in TAC, that the VoiceId was reset to male. While writing this article I did some further tests, and I was not able to reproduce this 100% or recognize a pattern anymore. Sometimes, it defaulted back to male, sometimes it stayed on female, no matter which setting I changed in TAC. Therefore, I‚Äôm going to leave it like that and just tell you to be extra careful, when updating auto attendants through TAC, if you want to keep a female voice. You definitely shouldn‚Äôt count on TAC preserving your configured VoiceId.\nOne thing is for sure though, every time you change the language of an auto attendant through TAC, it will default to male for all the affected languages. We‚Äôre going to see which they are in a bit.\nAgain, this is very bad news for Teams Voice Admins as this basically restricts us to either using TAC only (if we‚Äôre fine with male voices even though call queues use female voices) or using PowerShell only, if we want to make sure that we‚Äôre always using a female voice.\nWhy Has This Happened? Auto attendants and call queues use the Azure Cognitive Services TTS API, which is actually available to all Azure customers. You can try the different voices here. Many of them are also used by Teams. Over time, some of these voices get imporved or some languages even get entirely new voices. I don‚Äôt know when it happend exactly, but Microsoft added support for new voices a couple of months ago. For example, there‚Äôs an option for my native language, Swiss German available now.\nAvailable voices on Teams auto attendants are not particularly easy to find. There‚Äôs this Learn article which has some info on it though.\nBy using this code, we can get all the available voices for e.g., en-US.\nPS C:\\Temp\u0026gt; (Get-CsAutoAttendantSupportedLanguage -Identity \u0026ldquo;en-US\u0026rdquo;).Voices\nName : GuyNeural\nId : Male\nName : JessaNeural\nId : Female\nName : AriaNeural\nId : Female\nName : JennyNeural\nId : Female\nLet‚Äôs do the same for Swiss German, which is a newly supported language.\nPS C:\\Temp\u0026gt; (Get-CsAutoAttendantSupportedLanguage -Identity \u0026ldquo;de-CH\u0026rdquo;).Voices\nName : JanNeural\nId : Male\nName : LeniNeural\nId : Female\nThe docs say that we can retrieve the default voice used for any language by using this code.\nPS C:\\Temp\u0026gt; (Get-CsAutoAttendantSupportedLanguage -Identity \u0026ldquo;en-US\u0026rdquo;).Voices.Id[0]\nMale\nI can‚Äôt say for sure, but I‚Äôm fairly confident that TAC just reads the array of supported languages and uses whichever comes first as the default voice. That‚Äôs why en-US or de-CH now have male voices by default now.\nHere‚Äôs a little script I wrote to extract the default VoiceId for all the supported languages and export them to CSV.\nConnect-MicrosoftTeams\n$allLanguages = Get-CsAutoAttendantSupportedLanguage\n$languageVoiceTable = @()\nforeach ($language in $allLanguages) {\n$currentLanguageVoice = New-Object -TypeName psobject $currentLanguageVoice | Add-Member -MemberType NoteProperty -Name \u0026quot;LanguageId\u0026quot; -Value $language.Id $currentLanguageVoice | Add-Member -MemberType NoteProperty -Name \u0026quot;LanguageName\u0026quot; -Value $language.DisplayName $currentLanguageVoice | Add-Member -MemberType NoteProperty -Name \u0026quot;VoiceId\u0026quot; -Value $language.Voices\\[0\\].Id $languageVoiceTable += $currentLanguageVoice }\n$languageVoiceTable | Export-Csv -Path C:\\Temp\\autoAttendantLanguageVoiceTable.csv -Delimiter \u0026ldquo;;\u0026rdquo; -NoTypeInformation -Encoding UTF8 -Force\nHere‚Äôs the full list which should help you identify if you‚Äôre using any affected languages.\nLanguageId LanguageName VoiceId\nar-EG Arabic (Egypt) Female\nar-SA Arabic (Saudi Arabia) Female\nbg-BG Bulgarian (Bulgaria) Female\nca-ES Catalan (Spain) Female\ncs-CZ Czech (Czech) Male\ncy-GB Welsh (United Kingdom) Female\nda-DK Danish (Denmark) Female\nde-AT German (Austria) Female\nde-CH German (Switzerland) Male\nde-DE German (Germany) Female\nel-GR Greek (Greek) Female\nen-AU English (Australia) Male\nen-CA English (Canada) Male\nen-GB English (United Kingdom) Male\nen-IE English (Ireland) Male\nen-IN English (India) Male\nen-PH English (Philippines) Male\nen-US English (United States) Male\nen-ZA English (South Africa) Female\nes-ES Spanish (Spain) Female\nes-MX Spanish (Mexico) Female\net-EE Estonian (Estonia) Female\nfi-FI Finnish (Finland) Female\nfr-BE French (Belgium) Female\nfr-CA French (Canada) Female\nfr-CH French (Switzerland) Female\nfr-FR French (France) Female\nhe-IL Hebrew (Israel) Male\nhi-IN Hindi (India) Female\nhr-HR Croatian (Croatia) Female\nhu-HU Hungarian (Hungary) Female\nid-ID Indonesian (Indonesia) Female\nit-IT Italian (Italy) Female\nlt-LT Lithuanian (Lithuania) Male\nlv-LV Latvian (Latvia) Female\nja-JP Japanese (Japan) Female\nko-KR Korean (Korea) Female\nnb-NO Norwegian, Bokm√•l (Norway) Female\nnl-BE Dutch (Belgium) Female\nnl-NL Dutch (Netherlands) Female\npl-PL Polish (Poland) Female\npt-BR Portuguese (Brazil) Female\npt-PT Portuguese (Portugal) Female\nro-RO Romanian (Romania) Female\nru-RU Russian (Russia) Female\nsk-SK Slovak (Slovakia) Male\nsl-SI Slovenian (Slovenia) Female\nsv-SE Swedish (Sweden) Female\nth-TH Thai (Thai) Female\ntr-TR Turkish (Turkey) Female\nvi-VN Vietnamese (Vietnam) Female\nzh-CN Chinese (Simplified, PRC) Female\nzh-HK Chinese (Traditional, Hong Kong S.A.R.) Female\nzh-TW Chinese (Traditional, Taiwan) Female\nYou can use this one-liner to check if any of your existing auto attendants are currently using a male voice.\nGet-CsAutoAttendant -First 1000 | ft Name, LanguageId, VoiceId\nI really hope that Microsofts recognizes that this is a major annoyance and that they fix it rather sooner than later. In the meantime, I hope that I was able to provide you with some useful insight and hope that it helps you keeping the problem in check.\n","date":"2023-01-22T23:52:58.018Z","permalink":"https://heusser.pro/p/whats-up-with-teams-auto-attendants-suddenly-using-a-male-voice-for-tts-5c6f717d60a/","title":"What‚Äôs Up with Teams Auto Attendants Suddenly Using a Male Voice for TTS?"},{"content":"In the article ‚Äú11 Must-Have Apps for Windows 11‚Äù I talked about how much I love Windows 11 despite its few shortcomings. One of those is particularly annoying for IT folks like you and me. There‚Äôs no way of launching PowerShell or rather Windows Terminal as Administrator directly from File Explorer.\nWhile looking for a plausible solution, I stumbled upon a Windows App called Custom Context Menu. Despite the app being listed for $1, there‚Äôs an unlimited free trial. But please consider buying the app if you want to support the Dev.\nThis app allows you to create your own modern context menu entries for specific file types or folders. These are the settings which you need to add in order to add ‚ÄúOpen in Windows Terminal (Admin)‚Äù to your Windows 11 Context Menu.\nChoose C:\\Windows\\System32\\cmd.exe as your executable and use the following code as your Param. As with any syntax, the exact order and number of double quotes is extremely important here. It took me quite a few tries to get it right.\n1 \u0026#34;cmd /c \u0026#34;cd \u0026#34;{path}\u0026#34; \u0026amp; powershell Start-Process wt -verb runas\u0026#34;\u0026#34; Enter a path for whatever icon you want under Icon and only toggle the Match Folder switch.\nAlternatively, you can also click on the folder icon located in the top left corner and just create a new JSON file with the following content.\n1 2 3 4 5 6 7 8 9 10 11 12 13 { \u0026#34;title\u0026#34;: \u0026#34;Open in Windows Terminal (Admin)\u0026#34;, \u0026#34;exe\u0026#34;: \u0026#34;\\\u0026#34;C:\\\\Windows\\\\System32\\\\cmd.exe\\\u0026#34;\u0026#34;, \u0026#34;param\u0026#34;: \u0026#34;\\\u0026#34;cmd /c \\\u0026#34;cd \\\u0026#34;{path}\\\u0026#34; \u0026amp; powershell Start-Process wt -verb runas\\\u0026#34;\\\u0026#34;\u0026#34;, \u0026#34;icon\u0026#34;: \u0026#34;\\\u0026#34;C:\\\\Temp\\\\wtAdmin\\\\Terminal2.ico\\\u0026#34;\u0026#34;, \u0026#34;acceptExts\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;acceptDirectory\u0026#34;: true, \u0026#34;acceptFile\u0026#34;: false, \u0026#34;acceptMultipleFilesFlag\u0026#34;: 0, \u0026#34;pathDelimiter\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;paramForMultipleFiles\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;index\u0026#34;: 0 } If you like, you can give your context menu entry a custom name by clicking the gear icon in the bottom right corner.\nClick save and either restart explorer.exe or your PC. This is very important as the menu won‚Äôt load without a restart.\nHow It Looks and Behaves When you right click in any folder, you should see your custom context menu and choose ‚ÄúOpen in Windows Terminal (Admin)‚Äù or whatever name you entered.\nMake sure that you‚Äôve set the Starting directory of the PowerShell Profile in Windows Terminal to ‚ÄúUse parent process directory‚Äù. Otherwise, Windows Terminal will not start in the current folder where you right clicked in Explorer.\nAdding More Entries If you also want to add ‚ÄúOpen in VS Code‚Äù to the modern context menu in Windows 11, you can add a second entry using the following code or configuration.\n1 2 3 4 5 6 7 8 9 10 11 12 13 { \u0026#34;title\u0026#34;: \u0026#34;Open with VS Code\u0026#34;, \u0026#34;exe\u0026#34;: \u0026#34;\\\u0026#34;C:\\\\Users\\\\marti\\\\AppData\\\\Local\\\\Programs\\\\Microsoft VS Code\\\\Code.exe\\\u0026#34;\u0026#34;, \u0026#34;param\u0026#34;: \u0026#34;\\\u0026#34;{path}\\\u0026#34;\u0026#34;, \u0026#34;icon\u0026#34;: \u0026#34;\\\u0026#34;C:\\\\Users\\\\marti\\\\AppData\\\\Local\\\\Programs\\\\Microsoft VS Code\\\\Code.exe\\\u0026#34;,0\u0026#34;, \u0026#34;acceptExts\u0026#34;: \u0026#34;.json .txt .ps1 .cmd .bat .py .yaml .md .html .js\u0026#34;, \u0026#34;acceptDirectory\u0026#34;: true, \u0026#34;acceptFile\u0026#34;: true, \u0026#34;acceptMultipleFilesFlag\u0026#34;: 0, \u0026#34;pathDelimiter\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;paramForMultipleFiles\u0026#34;: \u0026#34;\u0026#34;, \u0026#34;index\u0026#34;: 3 } I hope that the option to launch Windows Terminal as admin or any other app really, also helps you be more productive. Initially, I discovered this app because I was looking for an easy way to bulk convert HEIC or HEIF images to JPG. Once I realized the potential of this App, I just had to figure out the correct params to launch WT as admin. I will definitely write another blog post about how to convert HEIC images to JPG using the same app and ImageMagick CLI.\n","date":"2023-01-06T08:23:26.863Z","permalink":"https://heusser.pro/p/launch-windows-terminal-as-admin-from-windows-11-context-menu-8eb2abe7b28b/","title":"Launch Windows Terminal as Admin from Windows 11 Context Menu"},{"content":"Hello everybody. At the beginning of this year, I set myself a goal of writing at least one article per month. Since I will meet my goal with today‚Äôs article, I‚Äôll make sure to take a break over the holidays and recharge.\nBut before I do that, we‚Äôre going to talk about some lesser-known stuff about Teams Cloud PBX features. Over the years, auto attendants and call queues have gotten a lot of new or updated features. Did you know that there‚Äôs a dedicated Cmdlet to see what features are enabled for your tenant? Use the following code to get the complete list.\n(Get-CsAutoAttendantTenantInformation).FlightedFeatures\nUpdate 29.06.2023\nI‚Äôve written a Bot which sends any new entries in this list to a channel on my Discord Server. If you want to stay up to date, you can join my Server using this link. If you want to learn more about my Discord Server, check this link.\n/Update\nAt the time of drafting this article, this is what‚Äôs returned by the Cmdlet. Unfortunately, many of these features were added without an MCP (Message Center Post) or a M355 Road Map entry. I‚Äôll try to decipher it and explain what each of these entries mean.\nBackupConfigInBvd\nNgcProvisioning\nUserValidationViaAdminService\nAutoAttendantSharedVoicemailEnabled\nAutoAttendantAnnouncementAsMenuOptionEnabled\nAuthorizedUsersEnabled\nCallQueueAllowPstnNumberAsTargetInCmdlets\nDirectorySearchByExtensionEnabled\nPstnTransferOutEnabled\nCallQueueSharedVoicemailEnabled\nCallQueueConferenceModeEnabled\nCallQueuePresenceAwareRoutingEnabled\nCallQueueLongestIdleRoutingEnabled\nGranularSchedulesEnabled\nAVSCallQueueZodiac\nCallQueueEnableResourceAccountsForOboV2\nEnableSharedVoicemailSystemPromptSuppression\nOboMobileFeatureEnabled\nAVSAdminEnableVerificationOfXMSUserIdHeader\nAVSEnableMenuOptionExpansion\nCallQueueEnableSharedVoicemailSystemPromptSuppression\nSupervisorDelegatedAdminPart1Enabled\nSupervisorDelegatedAdminPart2Enabled\nSupervisorDelegatedAdminPart3Enabled\nAutoAttendantAnnouncementAsMenuOptionEnabled This feature added the possibility to choose either a Text-To-Speech or an audio file announcement as auto attendant menu options. Once the announcement has been played back, the caller will be returned to the initial IVR greeting (this will create a loop).\nAuthorizedUsersEnabled As far as I can tell, this feature is not yet enabled yet, even though it already shows in flighted features. I can only assume that this will allow admins to delegate certain admin tasks to non-admin users.\nThere are also three other references which look related to this.\nSupervisorDelegatedAdminPart1Enabled SupervisorDelegatedAdminPart2Enabled SupervisorDelegatedAdminPart3Enabled CallQueueAllowPstnNumberAsTargetInCmdlets I am not 100% sure with this one but the name kind of suggests that this added the possibility to set an external PSTN number as overflow or timeout target on call queues using PowerShell, after PSTN transfer had been rolled out for auto attendants.\nPstnTransferOutEnabled If I remember correctly, transfer to PSTN was enabled for auto attendants before call queues. Thus, there‚Äôs another entry for that feature next to CallQueueAllowPstnNumberAsTargetInCmdlets.\nDirectorySearchByExtensionEnabled This feature allows inbound callers to reach people who have an extension through an auto attendant. The caller will enter a person\u0026rsquo;s extension followed by #and the auto attendant will forward the call to the recipient. The extension must be configured in Azure AD (Phone Number) and not in Teams (LineURI) for it to work.\nAs you can see, the user does not have an extension set for it‚Äôs LineURI.\nWe do not need to set any dial keys if we only want Dial by extension without any other options.\nAny auto attendant can only be enabled for dial by extension or dial by name. If you want both to be available to your callers, you will need to follow the example on Microsoft Learn.\nIf you want to use both the Dial by name and Dial by extension features, you can assign a dial key on your main auto attendant to reach an auto attendant enabled for Dial by name. Within that auto attendant, you can assign the 1 key (which has no letters associated with it) to reach the Dial by extension auto attendant.\nIt‚Äôs also possible to limit the dial scope to certain groups.\nBonus Tip: You can directly dial an extension from some phones by adding¬†,,\u0026lt;extension\u0026gt;# at the end of the number. At least an iPhone will dial the keys automatically once the announcement has been played back. This is the same technique which Microsoft uses for Calling Links in Teams Meetings which support audio conferencing.\nCallQueueSharedVoicemailEnabled This feature enabled the much-requested shared voicemail on call queues. Before that, we had to license users which would permanently forward to voicemail which was super painful because there‚Äôs still no way to upload an audio file for voicemail greetings on user accounts. The voicemail greeting needs to be recorded using the Teams client. If you want to know more about Teams shared voicemail, I recommend to check out this very comprehensive article.\nAutoAttendantSharedVoicemailEnabled This feature was also enabled for auto attendants after it has been enabled for call queues.\nCallQueueConferenceModeEnabled Conference mode will create a meeting when a call is connected to an agent which vastly improves the connection time. This means that agents will hear callers much sooner / without delays. The default value was changed from false to true in 2022. The docs were updated accordingly on August 15 2022 in this commit.\nCallQueuePresenceAwareRoutingEnabled The default value for Presence based routing was also changed from false to true in the same commit linked above.\nCallQueueLongestIdleRoutingEnabled I think that these names are sometimes a little misleading. While I assume that CallQueueConferenceModeEnabled and CallQueuePresenceAwareRoutingEnabled refer to the new default values, this one can‚Äôt since it‚Äôs not a boolean value. Here‚Äôs the description from Microsoft Learn.\nThe RoutingMethod defines how agents will be called in a Call Queue. If the routing method is set to Serial, then agents will be called one at a time. If the routing method is set to Attendant, then agents will be called in parallel. If routing method is set to RoundRobin, the agents will be called using Round Robin strategy so that all agents share the call-load equally. If routing method is set to LongestIdle, the agents will be called based on their idle time, i.e., the agent that has been idle for the longest period will be called.\nI can‚Äôt remember if Longest Idle was always there or if it was added later on. But since there‚Äôs an entry in flighted features, I assume it was added at some point.\nGranularSchedulesEnabled I‚Äôve been working with Teams Voice since the beginning, when we still had to use Skype for Business Online Admin Center to configure auto attendants and call queues (v1). From there, it was super easy to select business hours from a timetable. This only supported 30 minutes increments though.\nWhen auto attendants were moved to TAC, they only supported 30 minutes increments at first too. 15 minutes increments were added quite early on though.\nBecause business hours now support 15 minutes increments, the drop-down list is awfully long which makes it kind of time intensive to configure. I‚Äôve published an article and an accompanying PowerShell script to combat this here.\nAVSCallQueueZodiac Zodiac was the code name for Voice Enabled Channels which is also known as Collaborative Calling. I don‚Äôt know how this name made it into production. üôÉ\nThis update was mentioned rather briefly in this TechNet blog post under calling.\nVoice-enabled channels\nVoice-enabled channels allow connecting a call queue to a channel in Microsoft Teams. Users can collaborate and share information within the channel while taking calls in the queue. This feature is ideal for scenarios such an IT help desk or HR hotline. IT admins can quickly connect call queues to specific channels, and team owners can manage the settings.\nCallQueueEnableResourceAccountsForOboV2 With Voice Enabled Channles, it was finally possible to make outbound calls using a number of a resource account. This only worked if you used the dialer located in the channel but not standard dialer from the Calls app at first. I‚Äôm guessing ‚ÄúObo‚Äù stands for Outbound something and V2 also enabled this feature in the Calls App dialer. This was mentioned in Roadmap entry 86992.\nUpdate 03.06.2023\nI‚Äôm now fairly confident that Obo stands for On behalf of.\n/Update\nEnableSharedVoicemailSystemPromptSuppression When a call goes to voicemail on an auto attendant, a so-called system greeting is being played back by default. In English it sounds like this.\nPlease leave a message after the tone. When you have finished, please hang up.\nSince many companies use professionally recorded audio files for their announcements, it can be disturbing that a custom greeting is followed by the system greeting which will be Text-To-Speech. Because of that, Microsoft has added the ability to suppress it.\nWhen suppressing the system greeting on an auto attendant, you have to be careful though. There will be two different beep tones because the auto attendant forwards the call to shared voicemail, which will play back the first beep and then play onther (different sounding) one as a ‚Äúready to leave a message‚Äù indicator. I‚Äôve also covered that in more detail under ‚ÄúOne Last Caveat‚Äù here.\nCallQueueEnableSharedVoicemailSystemPromptSuppression When you read the article linked above, you will find the following paragraph.\nFor call queues, this is slightly different. There is no option to suppress the system greeting. A call queue‚Äôs primary purpose is to route calls to agents so there are only routing options for overflow or timeout scenarios. This also means that there‚Äôs no option to configure a greeting inside the scope of an overflow or a timeout action.\nWhen you upload your own audio file, the system greeting is automatically suppressed by the call queue. There‚Äôs no option to enable it. (Why would you anyway?)\nAt the time of writing, this was true. But now Microsoft has added the option to suppress the system message for TTS greetings and not suppress it for audio files on call queues as well. Remember that you can always use my M365 Call Flow Visualizer to see exactly which greetings are configured on any call flow.\nOboMobileFeatureEnabled I‚Äôd be lying if I said that I knew what this references to. My best guess is that it‚Äôs related to Operator Connect Mobile.\nAVSEnableMenuOptionExpansion I have no idea what that is. It would be a lot easier if we would see at which dates these entries have been added. The only thing I can think of is support for pound and asterisk key on auto attendant menu options.\nBackupConfigInBvd As far as I know, BVD stands for Business Voice Directory and it is an internal Microsoft system. This is most likely an internal service update which has no impact on admin exposed settings.\nOther Entries There are a couple of entries where I really don‚Äôt have the slightest idea what they could mean.\nNgcProvisioning UserValidationViaAdminService AVSAdminEnableVerificationOfXMSUserIdHeader Conclusion Get-CsAutoAttendantTenantInformation allows us to get a vague overview of which features have been added or might be added soon. It won‚Äôt help you configure or unlock anything, but I still hope that I was able to explain some things which you might not have known before.\nI wish you all happy holidays. See you next year!\n","date":"2022-12-20T11:04:41.675Z","permalink":"https://heusser.pro/p/teams-auto-attendant-stuff-you-didnt-know-about-4888a20df0fb/","title":"Teams Auto Attendant Stuff You Didn‚Äôt Know About"},{"content":"A few days ago, I wrote ‚ÄúHow To Handle Password and 2FA Madness Like a Pro‚Äù. In this article I explained why I think it‚Äôs better to use a full-fledged password manager instead of a basic Authenticator App such as Microsoft or Google Authenticator to handle your 2FA codes.\nThese types of apps work well when the service for which you want to enable 2FA allows you to add a secret key to your authenticator app. But what about services which don‚Äôt support such apps and instead only send you an SMS with a verification code? Unfortunately, there are still some services which will only allow one-time codes sent by SMS.\nIf you‚Äôre using an iPhone and a MAC for example, this shouldn‚Äôt be too big of an issue since you can seamlessly sync your clipboard across devices (at least that‚Äôs what I‚Äôve heard).\nIf you‚Äôre using an Android phone together with Phone Link on Windows, you can easily access your SMS from there. But if you use an iPhone and a Windows PC, there‚Äôs no way to seamlessly transfer a code received by SMS on your iPhone to your PC.\n![]( which allows you to transfer content between an iPhone and a Windows PC through their Chromium extension.)\nWhen you use this method, you must open the message containing the verification code and manually select and copy it. Once the code is in your iPhone\u0026rsquo;s clipboard, you need to open Clipt and click Send. The copied content will be added to your PCs clipboard automatically and you‚Äôre ready to paste it.\nI didn‚Äôt quite like the manual steps involved on the iPhone. So I thought why not tinker around with Siri Shortcuts again, like I did in this article.\nSiri Automation Building the Automation The good thing is that there is a trigger for ‚ÄúWhen I get a message containing ‚Äù. The bad thing is that there‚Äôs no way of running it truly automated. You will still need to confirm running the automation each time it‚Äôs triggered.\nBut that‚Äôs only one manual interaction on the iPhone compared to four with Clipt (Open messages, copy code, open clipt, send content).\nI set the trigger to match all messages which contain the string ‚Äúverification code‚Äù. If that should not work for the messages you receive, you can adjust it to your liking or create multiple automations with different words.\nLet‚Äôs take a look at the actions. First, we‚Äôre going to use the regular expression \\d{6,} to match all strings which consist of only numbers and are at least six digits long.\nThen we‚Äôre going to create a note in Apple Notes with the extracted verification code. After 60 seconds, we‚Äôre going to delete the note.\nConfiguring iOS You might ask yourself what good does it do if the verification code is stored in Apple Notes when I want to access it on my PC?\nIf you configure your Outlook.com or work or school account as the default account for Notes in iOS settings, your notes will automatically synchronize with Microsoft Sticky Notes. Of course, I‚Äôm assuming that you‚Äôve already added a Microsoft Account to iOS at this point.\nDemo of the Automation in¬†Action To show off the automation, I just sent myself an SMS from Skype to my mobile number containing the following text.\nHere‚Äôs your verification code: 456789. Thanks for using it.\nI added the code between other text and added a full stop right after the code to demonstrate how powerful regular expressions are.\nThis is what it looks like on an iPhone. First there will be a notification for the new message. Shortly after, the automation will be triggered, and we‚Äôll need to click it, and then click ‚ÄúAusf√ºhren‚Äù (German for ‚ÄúRun‚Äù).\nAccessing Copied Codes on¬†Windows There are many Apps from which you access to your Sticky Notes on Windows.\nThe most obvious one is Sticky Notes of course.\nYou can also access them in Outlook or Outlook on the Web.\nAnd finally, they‚Äôre also available in your OneNote Feed.\nCopying the Verification Code Unfortunately, Stick Notes does not support copying the contents of a note from a right-click.\nWe need to open the note, select the text, and then copy it.\nThe new Outlook or Outlook on the Web or OneNote allow you to copy the contents of the note using a right-click though.\nThis also works well in the OneNote (for Windows 10) Feed. While it does work in the new, refreshed version of OneNote, it was quite buggy and sluggish for me. I‚Äôll let that slide since that‚Äôs an Insider Build.\nOneNote for Windows 10 is not listed in Microsoft Store Search anymore, but you can still get it from this link. I will keep using OneNote for Windows 10 until the new OneNote also supports vertical sections in March 2023.\nOnce the code has been copied from Outlook or OneNote for Windows 10, it will be in your clipboard as plain text without any trailing whitespaces or line breaks so that you‚Äôre ready to paste it wherever you need it.\nThis was not the case with the new OneNote App. In this case there were two line breaks before the code and one after.\nWhile it‚Äôs theoretically possible to also copy the code from the classic Outlook App, the experience is not the same as with the modern Outlook or OWA.\nWhen you copy the code from there, it will include additional, unwanted metadata such as the subject and date created.\nSubject Created Categories\n456789 So 27.11.2022 11:59\nI like the experience of copying the verification code from the modern Outlook or OWA the best. It will only show Sticky Notes and allows me to copy the raw code by a right-click. I usually have Outlook open all day anyway so it‚Äôs very convenient to just switch from inbox to notes to copy a new verification code.\nBecause the note is only used to store a temporary verification code and we want to avoid clutter, the Automation will remove the note 60 seconds after it has been created. This should give you plenty of time to copy it from your notes.\nConclusion Both methods, Clipt and Automation + Sticky Notes require manual user interaction, so none of them are perfect. Clipt requires you to do more manual tasks on the phone and Sticky Notes needs more actions on Windows. I like using the Automation + Sticky Notes more because I believe that working on a Desktop with mouse and keyboard is still king in terms of how fast things can get done. I also like that no additional apps or services are required, especially that no Chromium Extension which runs in the background, even when the browser is closed is needed.\n","date":"2022-11-27T12:46:25.67Z","permalink":"https://heusser.pro/p/forward-verification-codes-from-iphone-to-a-windows-pc-2c2b5eb762f5/","title":"Forward SMS Verification Codes From iPhone To a Windows PC"},{"content":"Every once in a while, I come across a random Twitter conversation where people share their struggles and frustrations about the current state of 2FA apps and migrating those codes to a new phone.\nThis sparked a private discussion between Andr√©s Gorzelany and me where he asked me if I had written a blog post about this already. I hadn‚Äôt, so here we are.\nFirst, let‚Äôs cover some of the abbreviations which I‚Äôm going to use in this article.\n2FA = Second Factor Authentication¬†(Password is not enough, you need to either enter a one time code or verify a login in a mobile app)\nMFA = Multi Factor Authentication¬†(Pretty much the same as 2FA, the term is primarily used by Microsoft)\nOTP = One Time Password\n_(Usually, a 6 to 8 digit long code received by email or SMS which can only be used once)\n_TOTP = Time Based One Time Password\n(Usually, a 6 to 8 digit long code which gets generated (and hashed against the current time) by an app. Usually, every code is only valid for 30 seconds)\nMicrosoft Authenticator I‚Äôm sure that many IT Pros use Microsoft Authenticator for all or most of their 2FA codes because that‚Äôs what they first used, when MFA was initially required by the company they work for. As of drafting this article, the app currently sits on #7 in Productivity on Apple‚Äôs App Store, so I assume it‚Äôs quite popular.\nAccount Setup If you head over to https://mysignins.microsoft.com/ you will be able to add or edit your MFA methods for a Microsoft work or school account.\nIf you click on Next, your account will be added using the ‚ÄúMicrosoft Authenticator‚Äù method. If you click on I want to use a different authenticator app your account will be added as a ‚Äúdifferent authenticator app‚Äù.\nLet‚Äôs take a look at Microsoft Authenticator first.\nIf you just scan the QR code, you won‚Äôt notice any difference between the two options. The account will just be added.\nHowever, if you click on Can‚Äôt scan image? More information will be revealed. Notice how there‚Äôs a code and an URL which also includes a code.\nAfter adding the account, this sign in method will show as Microsoft Authenticator under Security info.\nIf we do the same thing again but choose different authenticator app this time, we can see that there‚Äôs just a Secret key but no URL anymore.\nIf we look at the sign in methods again, we can see that the second one is called Authenticator App even though we also added it to the Microsoft Authenticator App.\nWhen we look at the mobile app itself, we can also see some differences between these two accounts. The App knows that the first one is a Microsoft work or school account. But it has absolutely no idea that the second one is in fact also a work or school account or even that it‚Äôs the same account.\nIt‚Äôs even clearer on the details page of each account. And because both accounts were added using different secrets, they also generate different codes.\nBacking up our Authenticator App Switching phones has become increasingly complicated since 2FA has gotten so popular (where 2FA becoming a standard is a good thing).\nBacking up Microsoft Authenticator Data requires a personal Microsoft Account (outlook.com/live.com/hotmail.com).\nRestoring Microsoft Authenticator If the app is deleted or if you switch phones, you can restore from your backup.\nAnd there it is: a big red warning appears for the work or school account we added using the Microsoft Authenticator method. The generic code was restored just fine.\nFrom what I could observe online, many people seemed annoyed (understandably) that there‚Äôs an action required for each work or school account which was added using the Microsoft Authenticator method.\nTo be honest, I don‚Äôt know if there‚Äôs a specific QR code to recover the account. To me it seems more like that the backup only stores your email address and that you need to go through the setup again on a new device.\nTo restore it, go back to the My-Sign-Ins page and add the Microsoft Authenticator App again.\nThe same is also possible from this website: https://aka.ms/mfasetup\nThe Restore button at the bottom of this page didn‚Äôt do anything for me. Since it‚Äôs a new device, you need to add it again.\nIf you deleted the app on your current phone and restore the backup to the same device, the old registration will stop working. In this case, both Authenticator apps will have the same description in the portal. Delete the one which is sorted last in the list. If you got a new phone and don‚Äôt use your old phone anymore or if you‚Äôve lost it, you can delete it from the sign-in methods.\nIf MFA is enforced by your organization, and if you‚Äôre not currently excluded from MFA prompts like you maybe would be in an office building/network you may need to provide an alternative 2FA method like an OTP received by SMS or email if you‚Äôre not already logged in on your desktop. If you still have your old phone at hand, you can also use the Microsoft Authenticator from there to approve the sign in.\nThis example just shows one work or school account for demonstration purposes. Just imagine that you work for dozens of companies as a consultant or freelancer‚Ä¶ In this case, you would need to repeat these steps in all of their tenants in order to recover your accounts.\nMicrosoft Authenticator only backs up 2FA codes for generic accounts and your personal Microsoft Account. All work or school accounts that were added using the Microsoft Authenticator method require that you go through the setup again. Basically, only the account name, tenant name and user principal name will be restored but not the trust relationship itself.\n2FA Codes From Other¬†Services 2FA is without doubt a great mechanism for securing your accounts and online identities. It should be used wherever possible. Without exceptions.\nMicrosoft even advertises their Authenticator App as an App in which you can store all your 2FA codes on the App Store.\nIf you‚Äôre going all-in on 2FA and want to potentially store hundreds of 2FA codes, you should seriously consider not using Microsoft Authenticator for that.\nCan you believe it? A statement like that from a Microsoft fan as big as me? The first thing you need to think about is that you will either need to read the code from the app and type it on your PC or you need to copy it from the app. Either way you need to find it in the app. Although Microsoft has recently added a search function to the app (which was long overdue to be honest) there‚Äôs still no option to create folders to better manage your accounts.\nThe second thing you should consider is lock-in. Once you‚Äôve added all your 2FA codes to Microsoft Authenticator, you can only restore them to another Microsoft Authenticator app. Unless you explicitly save the secret key to a safe place every time you add an account, you won‚Äôt be able to extract those secrets again after they‚Äôve been added to Microsoft Authenticator. If you didn‚Äôt do that and you want to move them to another app, for example to Google Authenticator or Twilio Authy, you will need to log into each service and setup 2FA again for the new app. Much like we need to do if we want to move a Microsoft work or school account to a new device.\nOn top of all that, finding and copying or typing 2FA codes is not a good user experience. Some services even force their users to use their specific authenticator app. In these cases, apps like these often support push notifications like Microsoft Authenticator does. While just tapping a button on the phone to verify a login is certainly a better experience than searching for a code and then typing it on your PC, having dozens of service-specific authenticator apps is not a viable solution either.\nOn the plus side, it‚Äôs great that Microsoft Authenticator offers a backup capability. Google Authenticator for example still doesn‚Äôt support backups. It only supports exporting your data via a QR code to another Google Authenticator App. The problem with that is that your codes will be lost if you lose your device.\nAuthy also offers backing up your 2FA codes. While Microsoft Authenticator requires a personal Microsoft Account to back up your data, Authy uses a separate password to protect your backup. But the lock-in problem remains. Since you can‚Äôt retrieve the secret keys from all these Authenticator Apps, your only option of migrating to another app is to go through the 2FA setup for each account again.\nI think not exposing the secret keys after an account has been added makes sense for most users since secret keys need to be handled with absolute caution. If a secret key gets into the wrong hands, a malicious actor could generate the same TOTPs as you without you even knowing.\nHere I‚Äôve used the same secret/QR code to add an account to both Microsoft and Google Authenticator.\nUpping Your 2FA¬†Game So far, we‚Äôve established that using 2FA is a good thing. But we‚Äôve also seen that it can come at the cost of convenience which might put a lot of users off from using it. Weighing security against convenience is an extremely hard decision. But I have found a way wich works well for me and I‚Äôm confident that it will work well for others too.\nI know Microsoft, 1Password and other industry leaders are all talking about getting rid of passwords entirely but in reality, we‚Äôre just not there yet.\nAnother advantage of Microsoft Authenticator compared to other authenticator apps is that it now also offers password synchronization from Edge and auto-fill capabilities on mobile devices. While this is a good feature for many non tech savvy users, it‚Äôs still way worse than what a full-fledged password manager can offer. And by that, I mean Bitwarden.\nBitwarden Bitwarden differentiates itself quite a bit from competing services. First of all, it‚Äôs completely open source but still backed by a commercial company. While password managers like 1 Password, Dashlane or LastPass are all running on AWS Bitwarden runs on Azure. But most importantly, Bitwarden allows self-hosting for those who wish to do so. This means that you can be in control of your own vault data but won‚Äôt miss out on any of the awesome features like access and sync from anywhere, awesome mobile apps or browser extensions including auto-fill or even Windows Hello and Touch/FaceID support.\nAnd then there‚Äôs the super fair pricing options. Unlike many other password managers, their free tier supports unlimited passwords and devices and will stay free forever. It even supports vault sharing with one other user. This is because Bitwarden simply believes that anybody should be able to store their passwords securely and freely.\nTheir premium tier which also supports storing and generating 2FA codes only costs 10$ per year. By the way, I‚Äôm not sponsored by them in any way, but I‚Äôd gladly pay the 10$ per year even if the free version also included advanced 2FA features just to support their cause.\nPutting All Your Eggs in One¬†Basket Let‚Äôs get to the technical part. Using a password manager means that you will be storing all your passwords in the same place. People often refer to this as putting all your eggs in one basket. It‚Äôs a risk for sure but remembering hundreds of complex passwords is definitely not an option. And using more or less the same password for each website isn‚Äôt either.\nI‚Äôve had arguments about this where people claimed that there‚Äôs no real difference between using a master password to protect all your passwords or using the same password for each website. This not the case at all. Imagine if you use the same password for each website and one of those sites gets hacked and your password gets leaked on the internet. The chance of a password being compromised by a random website you signed up for is much higher than the chance of someone getting a hold of your master password.\nBesides, the master password is not the only thing needed to get into the vault of any sane person. You also need a 2FA code or a physical security key to access the vault. I think it was on Reddit where someone said that they call this ‚ÄúStaged 2FA‚Äù.\nUsing a Password Manager as an Authenticator App Maybe you think that I must be crazy for not only storing all my passwords but almost all of my 2FA codes in the same place as well. Bear with me and let me explain why I think that this is a good idea.\nThe idea of a second factor is that you need an additional physical device which generates a one-time code. This applies if you for example want to log into a website on your PC and then use the TOTP which only your phone/app can generate. But nowadays so much more is done on mobile devices too. So, if I log in to outlook.com on my phone, I don‚Äôt technically have a second factor since I can approve the sign-in request on the same device. In fact, if you think about it, most people probably have an app for their password manager and Microsoft Authenticator or another authenticator app on their phone which both can be unlocked biometrically.\nIf somebody wants to access your 2FA codes, they need access to your phone anyway. If they already have access to your phone, does it really matter if they get the 2FA codes from the Microsoft Authenticator App or from the password manager? Of course, this is a hypothetical worst-case scenario as physical violence or serious threats could be involved in order to get you to unlock your phone and apps with biometrics.\nThe key difference between storing your 2FA codes in an authenticator app or in a password manager is that a hacker would always need physical access to your phone if they‚Äôre stored in an authenticator app. But even if an attacker would be able to get these codes, the passwords which are protected in the password manager are still needed.\nTo get into the password manager, the uncrackable (at least until quantum computing becomes mainstream) master password is needed. Even if that had been obtained by somebody, physical access to my unlocked phone would still be needed. The way I see it, what really needs to be protected is the phone. Instead of only being a second factor it actually has become the weakest link since it often holds passwords and 2FA codes, regardless of if they‚Äôre accessible in different apps.\nSecurity Concept My security concept consists of two main security elements as I call them. One of them is Bitwarden, the other one is my personal Microsoft Account. Well, basically there‚Äôs also a third one which is my Apple Id (which of course is 2FA enabled as well). I don‚Äôt store anything from my Microsoft Account in Bitwarden. This is absolutely crucial. Even if a hacker would somehow get temporarily into my vault, they would not be able to take full control over it since they can‚Äôt get the 2FA code for the Bitwarden login. To get to the 2FA code, somebody would need to manage to sign into an iPhone with my Apple Id, restore the backup of my Microsoft Authenticator App from iCloud and then log into my Microsoft Account where both the Apple Id and my Microsoft Account are 2FA enabled and neither of the codes are stored in Bitwarden. All account related settings must be done in the Bitwarden Web Vault for which 2FA is required. The 2FA code for Bitwarden is only stored in my Microsoft Authenticator App. In my Microsoft Account there‚Äôs no information regarding Bitwarden except for the 2FA code (without the secret key). This means I only need to remember two complex passwords where the master password of Bitwarden is extremely complex (50+ characters).\nI only enter my master password about once per month to make sure that I don‚Äôt forget it. (I do have a backup plan in case I should forget it.) All the other times, I just use biometric authentication on Windows and iOS. Not using or typing the master password reduces the risk of it being obtained by anybody.\nI trust that my devices are secure, therefore I only use biometric authentication and choose to stay logged in (only biometric auth required) until I explicitly sign out of my Bitwarden Vault. This on the other hand exposes my PC to the same risk as my smartphone. If somebody puts a gun to my head and asks me to unlock Bitwarden on my Phone or my PC, they‚Äôd get everything. I‚Äôm sure I‚Äôll have bigger problems than that if that should ever happen.\nAs long as we‚Äôre excluding attack scenarios where a malicious actor physically attacks us or forces us to unlock our devices and apps, it doesn‚Äôt really matter if you store passwords and 2FA codes in the same place. I mean if we‚Äôre talking that somebody is targeting you remotely. They can‚Äôt get into your vault by using your master password unless they also have access to your authenticator app on your phone, which does exactly what it should‚Ää‚Äî‚Ääbeing a second factor.\nConvenience of Having 2FA Codes Stored in Bitwarden Let‚Äôs talk about some positive stuff. There are lots of advantages from a convenience point of view by storing all your 2FA codes (except Microsoft Account, Bitwarden and iCloud 2FA) in your password manager.\nThere‚Äôs no tedious searching for accounts/codes and no annoying typing of 6-digit codes each time you want to log into a website. Matching accounts will autmatically be detected by a websites base URL. All you have to do is to choose a matching account for any particular website and press Ctrl + V after the username and password have been auto-filled.\nI find that auto-fill with automatic copy/paste of the 2FA is actually even faster than approving a sign-in request on your phone. If you‚Äôre using a randomly generated password which is impossible to memorize, you need to use your password manager anyway. Thus, you might as well paste the 2FA code from the password manager as well. When you log into a website or an app on your PC, grabbing your mobile phone is only going to break your flow since you need to pick it up or even take it out of your pants. I for one always choose Bitwarden auto-fill over accepting sign-in requests on my phone.\nSecret Key Management in Bitwarden If you wish, you can also just store a TOTP without an associated password.\nYou can safely store secret keys and can always access them again if you want to move them to another app. There‚Äôs no need to sign into a website and setup 2FA again. You are your own master of keys.\nIf you‚Äôre the type of person who likes to organize stuff, you can create as many folders as you like and sort your credentials to fit your needs.\nMultiple Bitwarden Vaults If the idea of storing passwords and 2FA codes in the same place creeps you out, and you don‚Äôt mind manually copying or typing in 2FA codes, you could also consider creating a second Bitwarden Vault (account) with a different master password. With this approach you will lose a lot of convenience and ease of use but a dedicated password manager with support for 2FA codes still provides much more freedom and functionality than a classic authenticator app. But if we‚Äôre honest with each other you‚Äôre probably going to end up with both vaults synced to your phone anyway.\nConclusion If you‚Äôre struggling with your password and 2FA management and finding your current usability questionable I recommend the following basic principles to make your life a little easier.\nUse Microsoft Authenticator only for your personal Microsoft Account, for your main work or school account and for the 2FA code of your password manager. Keep it clean. Add all other 2FA codes to your password manager. Choose a super strong master password and type it only as often as necessary. Use biometric authentication whenever possible. Enable 2FA for your password manager. Use 2FA wherever possible without any exceptions. Make sure that you always have a backup plan in case you forget your master password, or you lose your phone. Never save your Microsoft Account password or 2FA code to your password manager. Use a different, strong, randomly generated password for each website. Follow me on Medium. ","date":"2022-11-26T03:04:56.129Z","permalink":"https://heusser.pro/p/how-to-handle-password-and-2fa-madness-like-a-pro-1647abaf96e6/","title":"How To Handle Password and 2FA Madness Like a Pro"},{"content":"Today‚Äôs blog post is a little bit different. It‚Äôs about how I use Windows 11 and some specific apps and features to achieve more. Don‚Äôt worry, I still have plenty of topics about Microsoft Teams in my backlog though.\nAccording to Twitter not everybody likes Windows 11. But perhaps, some people don‚Äôt like it because they don‚Äôt like change in the first place. I‚Äôve also seen a lot of people use their muscle memory as an excuse for not adopting new ways of doing things. But I believe that trying new things, breaking patterns, and questioning things we‚Äôve been doing a certain way for decades is exactly what keeps our mind fit and helps us get more efficient.\nFor example, I‚Äôve been using Win + R cmd since I can remember. What‚Äôs so bad about re-training my mind to enter wt instead. It‚Äôs even shorter!\nWhile Windows 11 may be far from complete or perfect it‚Äôs without doubt the best operating system Microsoft has ever made. It‚Äôs pretty clear that from now on Windows 11 will get all the love from Microsoft while Windows 10 sits basically on the side lines. There‚Äôs really no point in holding on to it. I‚Äôm not even mad that Windows 11 is only supported on 8th-Gen Intel Processors and later. In fact, I like that Microsoft is drawing a line and provides a modern OS for modern systems. I mean, 7th-Gen mobile CPUs are not even Quad-Core and 6th-Gen CPUs don‚Äôt even support hardware HEVC decoding. Should we really still be using devices which can‚Äôt even play back videos recorded in 4K on a modern iPhone?\nMaybe, I‚Äôd have a different opinion on that if not all of my devices except my 1st-Gen Surface Go already had a supported chip. But luckily, they have. I replaced the Surface Go with a Surface Go 3 just a few weeks ago. And that cost me about a third of what a new iPhone would have been.\nIf you haven‚Äôt already rage-quit this article, let‚Äôs take a look at some awesome Windows 11 apps and features.\n1‚ÄîWindows Clipboard Although this feature is also available in recent Windows 10 versions, it‚Äôs still noteworthy since not enough people know about it already.\nIf you‚Äôve never heard of the shortcut Windows + V drop everything you‚Äôre doing and press it now. Turn it on, thank me later.\nWhenever you press Windows + V instead of Ctrl + V Windows will now bring up a history of recently copied text and pictures. You can even pin frequently used text, so you‚Äôll still be able to access it after a reboot. Pinned items are at the bottom of the list. Just press End to quickly get there once the clipboard is open.\nIf you want to, you can even synchronize your clipboard to other devices.\nNow go tell your muscle memory that Win + V will replace Ctrl + V from now on.\n2‚ÄîPaste File for File¬†Explorer Believe it or not but I have never used a third-party screenshot app on my own devices. I totally understand why you would use one though.\nAnyway, it doesn‚Äôt matter as long as your preferred screenshot tool puts an image into your clipboard. Like Windows + Shift + S does.\n![](9PP2MWPBZFGH you‚Äôll be able to paste a screenshot from clipboard directly into a PNG file. Even though there are other, free alternatives, I decided to buy this app. It supports the modern Windows 11 context menu, looks nice and is able to create files without any confirmation dialogs.)\nBonus Tip: If you‚Äôre using a device with a pen or stylus, you can configure its button to take a screenshot.\n3‚ÄîNanaZip Gone are the days where WinRar nagged me to buy their license. I switched to the free alternative 7-Zip years ago. But 7-Zip doesn‚Äôt support the modern Windows 11 Context Menu. However, the free Microsoft Store App NanaZip, which is a fork of 7-Zip does.\n4‚Ää‚Äî‚ÄäSnipping¬†Tool ![](Pictures** folder as a PNG file. This kind of replaces some functionality of Paste File for File Explorer. But it also kind of doesn‚Äôt since you‚Äôll still be faster if you want to save your screenshot in a specific folder.)\nWhen you start Snipping Tool, you‚Äôll be presented a Hint about that feature now.\nOf course, it‚Äôs possible to disable this feature if you want to.\n5‚Ää‚Äî‚ÄäFiles Yes, the Windows File Explorer got tabs now. But there‚Äôs also a new kid on the block called Files.\nThis third-party file explorer puts a lot of empathies on aesthetic. I use it from time to time, but I don‚Äôt want to set it as my default file explorer because that could potentially mess up Windows. One noteworthy thing is that it supports pasting images in clipboard natively. Just click paste or use Ctrl + V.\n6‚Ää‚Äî‚ÄäMicrosoft Photos Photos finally got an update which was long overdue. The latest version also supports displaying your iCloud Photos, if iCloud for Windows is installed. Since I back up my photos to OneDrive (obviously) there are more interesting features and settings to me.\nAges ago, my go to photo viewers were IrfanView and later Picasa Photo Viewer. I liked that they could be quit by just pressing the ESC button. Up until now, this didn‚Äôt work in Photos. But it does now! If you also change the settings and configure the mouse wheel to flick through photos instead of zooming in or out, you‚Äôll have the perfect inbox photo viewer.\nMicrosoft makes it quite obvious that they‚Äôve acquired Clipchamp and that this is the recommended tool for video editing on Windows. However, the free version is limited to 1080p output. The Photos app actually includes a built-in video trim tool. This might seem like something ridiculously unimportant, but the point is that it supports trimming 4K HEVC HDR 60 fps videos.\nBeing able to trim a game clip which I recorded on my Xbox Series X without installing any other software is something which makes me happy. The best part about this is that the trimmed video will retain the original fps and resolution.\n7‚ÄîWindows Terminal Windows Terminal is one of my favorite and most used apps on Windows 11. Make sure you set it as your default terminal application to really start using it instead of legacy powershell.exe or cmd.exe.\nIf Windows Terminal is not already installed on your PC or if you don‚Äôt see the option to set the default terminal application, you can grab or update it from here.\nBonus Tip: If you enable Use parent process directory you can make launch Windows Terminal to the current directory. This is especially useful when you want to open PowerShell in the current directory from File Explorer.\nJust type wt in the address bar and press Enter.\nThis will launch Windows Terminal directly in that directory, as it was the case when entering cmd or powershell.\n8‚Ää‚Äî‚ÄäPowerToys PowerToys is so good that Microsoft should seriously consider to just bake some of these features into Windows.\nOne of the most powerful features of PowerToys is the Text Extractor.\nWhenever you need to extract Text from an image or when somebody was too lazy and sent you a screenshot instead of plain text, you can use Win + Shift + T to take a screen snipping. This works the same way as taking a screenshot with Win + Shift S. The difference is that instead of an image, the text which is present in an image/on screen will be copied to your clipboard.\nSince Apple introduced OCR for any photo in iOS 15, this is a super awesome feature to have on Desktops as well. It‚Äôs even more powerful because you can specify an exact range from which you want to extract text.\nOther noteworthy features are PowerToys Run and Keyboard Manager. For example, if you don‚Äôt like the Windows Start Search, you can configure PowerToys Run to launch with Win + Space.\nNow Win + Space is mapped to language input switching by default. But by leveraging the built-in Keyboard Manager, we can easily remap Win + Space to Win + Shift + Space.\nAfter that, we can configure the activation Shortcut of PowerToys run to Win + Space.\nPowerToys also offers an excellent overview of all its features called Welcome to PowerToys where each feature is explained.\n9‚ÄîDevToys DevToys is a must have Tool for Windows sys admins and developers.\nDevToys helps in everyday tasks like formatting JSON, comparing text, testing RegExp. No need to use many untruthful websites to do simple tasks with your data. With Smart Detection, DevToys is able to detect the best tool that can treat the data you copied in the clipboard of your Windows. Compact overlay lets you keep the app in small and on top of other windows. Multiple instances of the app can be used at once.\nIt‚Äôs essentially a one-stop-shop for all your coding and formatting needs. For example, I just recently copied a JSON template from a PDF which removed all indents. All I had to do to restore them was to paste it into DevToys‚Äô JSON Formatter.\n10‚ÄîMicrosoft Edge Ever since Microsoft Edge (Chromium) has been released, I never touched Chrome again. If you‚Äôre part of the people who get annoyed that Microsoft is trying to force Edge on you, I highly encourage you to give in and give it at least try it. It‚Äôs worth it.\nI admit that I was a little annoyed at first when Microsoft started advertising new Edge features such as Vertical Tabs or Collections. But once I tried them, there was no going back.\nIt‚Äôs no secret that Edge uses Google‚Äôs Chromium Engine, so some of these features are also available on Chrome. But Edge does have some unique features.\nVertical Tabs Vertical Tabs is a feature I only use in certain situations or in certain profiles. For example, when I‚Äôm browsing the web in my spare time / not at work, I usually have less than ten open tabs. But sometimes when I‚Äôm researching a topic, I suddenly have twenty, thirty or even more open tabs. That‚Äôs where vertical tabs come into play.\nVertical tabs can be turned on or turned off by the push of a button.\nTab Search There‚Äôs also a new feature which allows you to search tabs. Just press Ctrl + Shift + A to bring up s search box for open and recently closed tabs.\nYou can also quickly close open tabs which appear in search.\nTab Groups Did you know that you can also put tabs in a group? To do this, simply drag one tab over another to create a tab group.\nThis feature looks much better in vertical tabs though.\nCollections Collections was one of the features where I first thought that Microsoft should just stop and try to force it on me. Until I tried it. So many people still rely on favorites. As you can tell from the screenshots, so do I. But favorites can get messy over time. I don‚Äôt know how many times I bookmarked a site just because I thought I might need it again, even if that day is possibly still years away. Adding a site which I won‚Äôt access many times or never again to my favorites seems a bit like defeating the purpose, doesn‚Äôt it?\nThat‚Äôs why we have collections now. I use them for almost every type of website. For example, I have a collection for useful PowerShell articles or Stack Overflow threads, one for important Microsoft Learn articles. And I also have some temporary collections where I store items which I might want to purchase.\nThere are different ways of adding websites to collections. Simply press the collections icon and click the plus sign to add the current tab to an existing collection or start a new one.\nYou can also create a new collection from an open tab group.\nOr you can open all pages of a collection straight into a tab group.\nIt‚Äôs even possible to add notes to collections. This is super useful if you‚Äôre researching a topic for school or work. A collection might contain websites from the same domain or even use the same fav icon. With notes it will be easier to find the correct link again.\nQR Code¬†Share Another cool feature is the ability to generate a QR code for a specific website. Just press the QR icon in the address bar.\nThis will create a neat little QR code which points to the website.\nProfiles Profiles are without doubt one of the most useful features for browsers if they‚Äôre properly configured.\nLet‚Äôs say somebody at work sends you a YouTube video and you have Edge configured to open links with your work profile by default, but your personal profile is logged into your Google Account with a YouTube Premium Subscription.\nThere‚Äôs no need to copy the URL and paste it in your personal profile. It‚Äôs super easy to just right click the tab and select Move tab to Personal.\nIn settings, you can configure specific sites to always use a specific profile. The next time you open a YouTube link, it will automatically open in your personal profile.\nMicrosoft Editor Microsoft Editor is another example of why we need to be able to change and adapt to modern technology. For years we have right clicked on words which are underlined in red. Because that‚Äôs just how it worked. But so much more is done in a browser nowadays, and thus we need to use a left click now. It took me a few weeks to adjust but now I can‚Äôt imagine living without Editor anymore.\n11‚Ää‚Äî‚ÄäClipt ![]( is a Chromium Extension with a companion app on iOS and Android. The extension also works with Microsoft Edge. Instead of using WhatsApp or any other chat or email service to synchronize content between your devices, Clipt uses an encrypted file on your Google Drive to sync content.)\nCopy any text on your phone and send it through the Clipt App.\nOn your PC, you will receive a notification from Clipt and you will be able to paste what you just copied on your mobile without any further interaction.\nOf course, it‚Äôs also possible to send content the other way around.\nIf you enable auto copy in Clipt settings, everything you copy on your PC will be synced with your phone automatically.\nFinal Notes These are 11 awesome Windows 11 Apps I use almost daily. I get that change can be hard, but technology is changing faster than ever. If we don‚Äôt keep up with it, we‚Äôll lose out eventually. Microsoft is developing new features and changing things for a reason. Maybe not all changes that Microsoft has made to Windows 11 are completely understandable by an average user\u0026rsquo;s point of view‚Ää‚Äî‚Ääbut for most of them there‚Äôs another, easy, even easier or just as easy way of doing it‚Ää‚Äî‚Ääif you‚Äôre willing to work on yourself and embrace change.\nThe one change people absolutely hated was that it‚Äôs not possible to open Task Manager from the task bar anymore. While those in question spent their time shouting about it on Twitter, I‚Äôve long trained my brain to just use Ctrl + Shift + Esc to open Task Manager. Even when Microsoft brings this functionality back, I will most likely just continue to use the shortcut instead.\nI hope that I was able to tell you about some stuff you didn‚Äôt know already and that it helps you too to be more productive.\nTo many awesome Windows 11 updates, eliminating those legacy interfaces and dialogs one at a time.\n","date":"2022-11-14T23:31:22.182Z","permalink":"https://heusser.pro/p/11-must-have-apps-for-windows-11-2c362809db3/","title":"11 Must-Have Apps for Windows 11"},{"content":"Can you believe that it‚Äôs already the last day of October and that so far, I‚Äôve only published one article this month? And it wasn‚Äôt even about Teams‚Ä¶\nLet me change that. We‚Äôre almost at the end of the year already. You know what that means, right? Holidays! But before we can go on Holiday we need to add or update them on our Teams Auto Attendants. That‚Äôs exactly what I‚Äôm going to write about today.\nBest Practices Beware, these are not best practices which are documented anywhere officially. The recommendations outlined in this blog post are based on my learnings from working with Teams Auto Attendants in the past years.\nWhen you start planning or configuring Holidays in Teams, the first question you should ask yourself is the following:\nDo you want to treat every Holiday the same, or do you want to treat some holidays differently?\nThis applies to both actions and greetings. The greeting, of course, is the message which will be played back when somebody calls you on a Holiday. The action is what the Auto Attendant will do in terms of call routing on that Holiday. Examples are, disconnect, forward to voicemail, a person in your organization or to an external number.\nGreetings Depending on the answer to our core question, you either need one generic greeting which applies to all Holidays, or you need a different greeting for each or at least for some Holidays.\nA reason for an individual greeting per Holiday could be that you want to be very specific and include information when your company will resume business as usual.\nIf you opt for a generic greeting, I always tell my customers that their greeting should mention something like this.\nThank you for your call. Due to a Holiday, our office remains closed for today. Please try us again on the next working day.\nThe key take-away here is to use working day rather than tomorrow or the next day, since this could also be a Saturday or a Sunday.\nActions An action is where you configure what should happen to inbound calls which are received on Holidays. These are configured inside a so-called holiday call handling.\nIn TAC, actions are called Call routing options. In PowerShell they‚Äôre referred to as Action.\nScope Please note that the settings described in this article only apply to Auto Attendants. It‚Äôs currently not possible with Teams native features to configure a global schedule for all of your company‚Äôs numbers or to configure Holidays for Teams Users. To achieve something like this, you need to use Direct Routing and an SBC which offers time-based routing, like Anynode does for example.\nAgain, if you treat all your Holidays the same, for example play back a message and then forward to voicemail, your configuration will be much easier to build and maintain. You will only need to update the schedules once a year. There‚Äôs no need to touch the call handlings again with this approach.\nHoliday Lists The third thing we need is a Holiday list. The terminology might be a little confusing here. In TAC they‚Äôre simply called Holidays. In PowerShell they‚Äôre called Schedules.\nIf we add a new Holiday in TAC, it uses the singular form Holiday, even though this can have multiple entries. This essentially makes it a Holiday list from my point of view.\nWhile Holidays can be created from inside the configuration menu of an Auto Attendant, these lists are actually stored outside of an Auto Attendant. You can find them in Teams Admin Center under Voice\\Holidays.\nA Holiday list can be linked to multiple Auto Attendants. Because of that, I recommend to always edit Holiday schedules under Voice\\Holidays and not directly on the Attendant itself. This should minimize mistakes and confusion.\nI don‚Äôt recommend including the year into the schedule‚Äôs name. The year is already included in each entry. Besides that, it‚Äôs also highly likely that you will have a Holiday for New Year\u0026rsquo;s Eve which overlaps into the next year which kind of messes with the naming scheme.\nLimits A Holiday list can have up to ten entries. And an Auto Attendant can have up to 20 Holiday call handlings. While I haven‚Äôt verified this, it means that in theory, you should be able to have a maximum of 200 Holidays per Auto Attendant, assuming that each entry only spans one day. Only having 165 working days, what a life that would be.\nUnderstanding The¬†Dates A Holiday consists of a start and end date and a start and end time. This means that we can also configure partial Holidays which for example start at noon or later. Our Auto Attendant might have business hours which allow calls to get through until 5 p.m. If we configure a Holiday to start at 4 p.m. we can close the lines 1 hour earlier without touching our business hours.\nThe end date and time is usually 12:00 a.m. of the following day. So, if we want to close the Auto Attendant for the entire day on October 31st, we configure the Holiday like this:\nStart: 31.10.2022 12:00 AM\nEnd: 01.11.2022 12:00 AM\nThis is documented and recommended by Microsoft.\nWhen the new day begins, the Auto Attendant will go back to evaluating business hours as usual.\nIt‚Äôs important to point out that Holiday lists do not store any information about time zones. Time zones are configured on Auto Attendants. Remember that the same list can be associated with multiple Auto Attendants. This allows you to have consolidated Holiday lists which automatically adjust to the relevant time zones based on the Auto Attendant configuration.\nConfiguring Holidays on an Auto Attendant If you create a new call handling for an Auto Attendant, you need to select a Holiday (list/schedule) from your Holidays. This again means that if you want to have an individual greeting or action per Holiday, you can only have one Holiday per list. Thus, you need to take the limit of twenty call handlings per Attendant into consideration.\nIf you need to configure more than twenty call handlings, you will need to update the configuration sometime during the year. Without removing call handlings of past Holidays, you won‚Äôt be able to add new ones for the rest of the year.\nWhen I built my first Auto Attendants many years ago, I used to include the year in the name of the call handling. This was an awfully bad idea, and I learned my lesson. I had to update all the schedules and all call handling names.\nBecause of the administrative overhead, I usually recommend my customers to have one list for dynamic Holidays and one for fixed Holidays. Since I came up with these terms on my own, I‚Äôm not sure if they‚Äôre popular. But they should be self-explanatory. Dynamic days are the ones which occur e.g., every third Monday of April. Fixed days are the ones which fall on the same day each year. E.g., Fourth of July. Because there are usually more than ten Holidays in a year, we need two lists anyway. Splitting between dynamic and fixed days seemed like the most obvious way to me.\nIf you have more than ten fixed or dynamic Holidays, you can just create a second list and add a call handling with the same settings for those days as well. There‚Äôs no way around that.\nEditing a Holiday will open its own sub menu which has a Save button. Never forget to also click Submit on the Auto Attendant after you have saved a Holiday call handling. If you don‚Äôt save the Auto Attendant as well, changes to your Holidays won‚Äôt be saved.\nSome Exceptions If your company also has annual Holidays, which typically last one or two weeks, I suggest creating a separate list and call handling for these weeks.\nYou can create one entry for the entire timespan and configure a custom greeting because it isn‚Äôt obvious when the next working day will be.\nAlso, you can‚Äôt create multiple call handlings with the same start time on the same Auto Attendant. However, it is possible to create Holidays, where one Holiday occurs during another, multi-day Holiday. To test this, I‚Äôve created the following Holidays.\nThe date 31.10.2022 is also in the range of the following Holiday which starts one day before, on 30.10.2022.\nNext, I created another Holiday which wraps around both previous Holidays.\nI then created a call handling for each of them.\nTo find out, which call handling is effective, I called my Auto Attendant. Because I‚Äôve configured a different greeting for each of them, I was able to easily determine which one was active.\nIt turns out, that Teams is smart enough to always prioritize the one which is the most precise. In this case, it‚Äôs the one which only includes a single day.\nTo be absolutely sure, I even removed the other two call handlings and saved the Auto Attendant. I then added them again to see if the order in which they are configured makes a difference, but it doesn‚Äôt.\nIm not sure if this will be a feature that anyone will ever need but it‚Äôs still good to know. In theory we could set up a Holiday for an entire week but still have a different greeting and/or action on e.g. Wednesday if we configure a separate Holiday for it.\nFurther Reading If you‚Äôve found these insights about Auto Attendants and Holidays useful, please also see this article, where I explain how the entire process of updating (not creating) schedules can be outsourced to users without granting them Teams Administrator rights.\nAnd of course, Holiday Tables which are configured on an Auto Attendant can also be visually displayed using the M365 Call Flow Visualizer.\nBased on feedback from the community, I‚Äôve added the name of the call handling and the linked Holiday list to the diagram for more clarity.\nYou can see that there‚Äôs a name for both the Call Handling and the linked Holiday Schedule in the flow chart**.**\nFinal Note In Teams Admin Center, Holidays are chronologically configured and displayed after the business hours have been configured. But in practice, any Holiday gets prioritized over business hours. The M365 Call Flow Visualizer correctly represents this in its diagram outputs.\nI hope that this article helps you prepare for the Holidays so that you can leave for the Holidays with the peace of mind you need.\n","date":"2022-10-31T20:12:56.274Z","permalink":"https://heusser.pro/p/everything-you-ever-wanted-to-know-about-teams-holidays-2b5374667743/","title":"Everything You Ever Wanted to Know About Teams Holidays"},{"content":"Even though Microsoft Graph has been around for some years now, I‚Äôm going out on a limb here and say that it‚Äôs still quite new to a lot of engineers. This article won‚Äôt cover basic topics like what Graph is or how to get started. It focuses on a rather specific topic with which I struggled with at first: pagination (also known as paging).\nAs the name suggests, we‚Äôre talking about multiple pages of results, if a response is too large for one request/response or if the page size is ‚Äúhardcoded‚Äù by Microsoft. Microsoft also offers a dedicated article on Microsoft Learn about that.\nFor example, if we want to query all the users in an Azure AD tenant and that tenant has 10'000 users, it wouldn‚Äôt make sense to return all these objects in a single request.\nLet‚Äôs continue with the example of querying an organization‚Äôs Azure AD users. The official documentation, which also includes a note about the default page size can be found here.\nThe default and maximum page sizes are 100 and 999 user objects respectively.\nThis means that if we make a request like this:\n1 $aadUsers2 = (Invoke-RestMethod -Uri \u0026#34;https://graph.microsoft.com/v1.0/users\u0026#34; -Headers $Header -Method Get -ContentType \u0026#34;application/json\u0026#34;) Graph will only return the first 100 users, even though we didn‚Äôt include any filter in the request URL.\nIf there are less than 100 users, all users will be returned of course. We can see that this is the case because the variable $aadUsers2 does not contain an @odata.nextLink property.\nBecause Microsoft Graph uses the OData (Open Data Protocol) for their REST API, we can also specify the page size by including the $top filter. In fact, I need to use this to simulate and demonstrate paging because I don‚Äôt have more than 100 users in my test tenant.\nIn this example, I‚Äôm using¬†?`$top=5 to make Graph only return 5 objects per page. The ` before the $ sign is needed to escape the character.\n1 $aadUsers = (Invoke-RestMethod -Uri \u0026#34;https://graph.microsoft.com/v1.0/users?\\`$top=5\u0026#34; -Headers $Header -Method Get -ContentType \u0026#34;application/json\u0026#34;) Here we can see that the result now includes an @odata.nextLink property. If a Get request is made to this URL, we will receive the next 5 users.\nIn a more realistic scenario, a tenant may have tens of thousands of Azure AD users though. So, setting the top filter to 999 is more realistic but still wouldn‚Äôt return all the users. But what if we really need to get all the users?\nHow can we keep requesting the next page until we have received all the pages/objects?\nI‚Äôve come up with a very simple solution for this. We‚Äôll just use a do-until loop in PowerShell which will keep requesting the next page via the URL returned by the @odata.nextLink until there‚Äôs no @odata.nextLink property anymore. Once it‚Äôs done, we‚Äôll have all the users in the $allPages variable. And finally, we set the initial variable $aadUsers to the value of $allPages.\nPlease be aware that you will need to include your own Authorization Header before you are able to make any requests towards Microsoft Graph. A very comprehensive guide about that can be found here for example.\nFor most of these commands, like getting users, there are also PowerShell Modules and Cmdlets available. However, I like to use PowerShell web requests (Invoke-RestMethod ) to reduce dependencies. This way, I don‚Äôt need to install any modules if I ever need to run this code from another system or a serverless Azure Function, for example.\nLet me know what you think. Do you think that‚Äôs useful, or have you found a better way to handle paging in Microsoft Graph?\n","date":"2022-10-11T16:10:04.567Z","permalink":"https://heusser.pro/p/how-to-handle-microsoft-graph-paging-in-powershell-354663d4b32a/","title":"How To Handle Microsoft Graph Paging in PowerShell"},{"content":"It‚Äôs been a while since I‚Äôve used my Yealink MP56 Teams certified Desk Phone. I only bought it for testing purposes anyway‚Ä¶ But today I noticed that the call control UI has been completely revamped.\nI‚Äôm running Firmware Version 1449/1.0.94.2022090705/0907. (And yes, I used the awesome PowerToys Text Extractor (Win + Shift + T) to copy the text from the screenshot below.)\nAn incoming call now looks like this. If I remember correctly, the buttons used to be much smaller and located next to each other at the bottom of the screen.\nThe in-call controls also feature larger, centered buttons now.\nThe transfer button has been moved to the main screen, which means that you‚Äôll need one tap less to initiate a transfer now.\nThe menu for the actual transfer / search looks the same in both the new and the old UI.\nYou can still bring back the old view by tapping¬†‚Ä¶More. and then Change view.\nThis will transition into the old UI where everything is located at the bottom of the screen.\nFunny enough, there‚Äôs no option to switch back to the new look once you‚Äôve changed the view.\nThe only way to get back to the new view is if you tap the ‚Üê arrow and then Tap to return to call.\nThis will bring back the revamped UI for the active call. I suspect that the old UI will be removed entirely sooner or later. I don‚Äôt see any reason why one would need or want two different calling UIs. I also don‚Äôt think that Microsoft wants to maintain two different UIs. Especially if the new one features a lot of improvements and welcome changes.\nOh, and thanks to MVP James Cussen for the awesome Teams Phone Screen Capture Tool.\n","date":"2022-09-29T20:31:53.893Z","permalink":"https://heusser.pro/p/updated-calling-ui-on-teams-desk-phones-9e8f18790f5a/","title":"Updated Calling UI on Teams Desk Phones"},{"content":"At the beginning of September, I wrote this article, where I presented a way to quickly see all Call Queues and Auto Attendants any user is associated with by running a PowerShell script.\nToday, we‚Äôre going to wrap up September by taking a look at the other way around. We want to see all the agents which are part of a specific queue. Of course, the M365 Call Flow Visualizer will also show this information in the diagram but sometimes all we need is just a plain old CSV file.\nIf you‚Äôre using a Teams Voice Enabled Channel (also known as Collaborative Calling) you will be able to see which agents are currently opted in to the Queue in the Teams Client.\nHowever, this only works for Voice Enabled Channels and only agents which are part of the Queue can see this information. If you‚Äôre a Teams Voice Admin like me, you might want to see the opt in status of agents from other queues or check the assignment path (Direct, Groups or Channel) as well. If you‚Äôre confused about Call Queues and agent lists, please have a look at this article.\nThe Problem It has always been possible to retrieve some of the information about Call Queue agents by PowerShell. The problem is that the properties of a Call Queue will only display the Object Ids of agents but no Display Names.\nLet‚Äôs store the properties of a Call Queue in a variable.\n$callQueue = Get-CsCallQueue -Identity a3b9ffff-f74b-46bb-9743-0c5146a61f31\nWe can now view the agent list by accessing the Agents property. This will give us an output which looks like this.\nPS C:\\Temp\\M365CallFlowVisualizer\u0026gt; $callQueue.Agents\nObjectId OptIn\n-\u0026mdash;\u0026mdash;- \u0026mdash;\u0026ndash;\n61d8b739-2e10-4e47-8e63-e66cc73d0a24 True\nfa19b242-8bae-419d-a4eb-12796577c81f True\n76606d0b-4d28-4246-9c08-2a0f95f96141 True\n9a7c1bb4-49db-40ee-9d05-26f5dfd338c2 True\nWe can also see that two distribution lists (groups) are associated with this Call Queue by entering the following.\nPS C:\\Temp\\M365CallFlowVisualizer\u0026gt; $callQueue.DistributionLists\nGuid\n-\u0026mdash;\n57e8de46-1552-4271-9f93-a602216c32ad\n942d0869-2713-407d-8b6f-70b946039877\nSo far, we only know the Opt In status of the agents (without names) and that there are two groups linked to this Call Queue. But we still don‚Äôt know the user principal or display names of the agents, or if they‚Äôve been added to the queue by a group or a direct assignment. If they‚Äôve indeed been added by a group, we also don‚Äôt know from which one(s).\nThe Solution I‚Äôve created a PowerShell function inside a script which will give us just that. The script is available on my GitHub profile. Make sure that you download or clone the whole repository, since this re-uses the Connect-M365CFV function which is part of the Visualizer. Because some data, like group memberships can‚Äôt be retrieved by Teams PS alone, we also need to connect to Microsoft.Graph Powershell and thus need this function.\nHow To Run the¬†Script Basically, all the code is inside a single function. The script has a Cmdlet-Binding with two optional parameters though.\n-CallQueueId\n-Export\nThe CallQueueId can be the Id of any Call Queue. You can copy this from the URL in TAC for example.\nIf you don‚Äôt specify an Id, you will be able to select any Call Queue from a list.\nExport is a Validate Set where WorkingDir and CustomDir are valid inputs. WorkingDir will export a CSV file to your current working directory and CustomDir will prompt you to choose a destination folder.\nIf you don‚Äôt include any of the two values, no CSV file will be exported.\nIf we want to run the script from the root of the repository, we can do it like this.\n.\\Functions\\Get-CallQueueAgentsStatus.ps1\nOr like this.\n.\\Functions\\Get-CallQueueAgentsStatus.ps1 -Export CustomDir -CallQueueId b138ee51-75e0-4c39-b3a8-c14c01170ee0\nOutput of Different Scenarios Let‚Äôs check out some examples of the results.\nExample 1: Here, all the agents are assigned directly.\nExample 2: This one is a little more interesting. Here we can see that one user is assigned directly, two are assigned by two groups and one is assigned by only one group. We can also see that the first user does not have a direct phone number assigned.\nExample 3: And in this last example, all the agents have the same assignment path. Because only direct (users) and groups can be combined, all the agents are assigned by the same Team and Channel. Last but not least, we can see that the last user is currently not opted in to the queue.\nAs you can see, the output of my script provides a lot of valuable information about Call Queue agents which is nowhere to be found in Teams Admin Center.\nI hope that you enjoy my work and that you too‚Ää‚Äî‚Ääwill find this script useful.\n","date":"2022-09-29T17:22:31.236Z","permalink":"https://heusser.pro/p/report-on-teams-call-queue-opt-in-status-and-assignment-paths-93f177976485/","title":"Report on Teams Call Queue Opt In Status and Assignment Paths"},{"content":"Update 29.01.2023\nThis blog post is now obsolete. The M365 Call Flow Visualizer is now able to directly export PNG files using the -ExportPng $true parameter. Please make sure to install the prerequisites.\n/Update\nBack then, when I thought about making the M365 Call Flow Visualizer a reality I was looking for a way to generate a diagram from code. And Mermaid-JS was the answer. If you‚Äôre unfamiliar with Markdown, outputting diagrams to either Markdown, Mermaid or HTML files might look like an odd decision. However, my endgame always was to programmatically generate call flow diagrams and render them on a documentation website built with DocFx.\nHTML Output was only added later down the line because I thought that having an option to easily share these files with other, maybe non-tech-savvy people (who wouldn‚Äôt know what to do with a *.md file) would be a good option. Having clickable greeting nodes is another benefit of the HTML output option.\nBut of course, sometimes images are the easiest way of sharing things or including them in other documents or services such as Email, Word, or OneNote. While I haven‚Äôt found a way to automatically export a Teams Call Flow directly to an image, I‚Äôm going to show you what I think is the easiest way for the time being.\nExport to¬†PNG First, install the VS Code Extension Mermaid Editor from the Marketplace. Once installed, go to the extension settings, and configure them as you see fit. I suggest Type: ‚Äúpng‚Äù with a transparent background for the best results.\nNext, run the M365CallFlowVisualizerV2.ps1 script with the -DocType Mermaid parameter. This will output a Mermaid file instead of Mermaid code inside a Markdown file.\n1 . .\\M365CallFlowVisualizerV2.ps1 -theme custom -ObfuscatePhoneNumbers $true -DocType Mermaid In the above exmaple, I‚Äôm using the fairly new -ObfuscatePhoneNumbers parameter as well. This way, I can share call flow diagrams without worrying about getting spam calls to my test numbers.\nIn VS Code, navigate to your¬†.\\Output folder and look for the generated *.mmd (Mermaid) file and open it. You will now see an eye icon in the top right corner of VS Code. Click it.\nThis will preview the diagram in split-view.\nNow switch back to the *.mmd file and notice how a little download icon appears next to the eye icon.\nClick this icon to generate a PNG image from the Mermaid file. The image will be saved to the same directory as the original file.\nNow you have a nice PNG file, including a transparent background of your call flow.\nAppendix I am aware that https://mermaid.ink offers an API to directly output to SVG since I already made use of that to render Teams User Calling Settings. From what I can tell right now, it looks like an encoded call flow is just too big for the API to handle. I‚Äôm also looking into Mermaid CLI to see if this can be used in some form or another to make outputting images a little bit easier in the future. I still hope that exporting to PNG gives you more flexibility, even though it‚Äôs a manual process.\n","date":"2022-09-13T16:21:20.338Z","permalink":"https://heusser.pro/p/how-to-export-a-teams-call-flow-to-png-4d38a8c4f183/","title":"How To Export a Teams Call Flow to PNG"},{"content":"In my last few articles, I‚Äôve talked about building Teams Phone self-service solutions for end users. The reason one might want to do this is quite obvious: We don‚Äôt want to give users access to Teams Admin Center but as engineers, we don‚Äôt want to take on tedious tasks like updating an Auto Attendant‚Äôs Holiday list either.\nEven though pretty much everything that can be configured in TAC, including managing Holidays can be scripted with PowerShell, Holidays still require a fixed date and time range and can‚Äôt be renewed automatically or fetched from an external source. This results in a considerable administrative overhead for both Teams admins and end users.\nWhen I need to configure Teams Holidays, I always ask users to provide a list where each holiday is noted with an explicit date. I‚Äôm not going to do the work for them and go look up when exactly a Holiday takes place next year. (For Holidays which don‚Äôt have a fixed date at least.) I‚Äôve seen some lazy users try to take a shortcut and tell me to just add ‚Äúall lawful Bank Holidays‚Äù of Country/State/Canton XY. Unfortunately, that‚Äôs not how it works my dear users. I‚Äôd spend hours looking up this stuff and probably still end up with some wrong dates anyway. That‚Äôs why I set out and created a better solution. /rant\nIn this article, I‚Äôm going to show you a solution where the whole process of maintaining a Holiday List can be outsourced to end users. Admins only need to set up Holidays once initially.\nRecap Before we dive in, let‚Äôs recap what I‚Äôve published in my last articles to give you some context on Teams self-service solutions using Azure Automation and Adaptive Cards.\nIt all began with this article where I wrote about my take on a self-service solution which lets users manually open or close an Auto Attendant. This solution builds on the work of Microsoft MVPs which are linked in the original article.\nI then went on and published this piece which uses the same principle but lets users enable or disable immediate forwarding to an external number or update the external forwarding target number on a Call Queue.\nWe can use these examples and build on them to create something similar for Auto Attendant Holidays.\nHow Does it¬†Work? It‚Äôs important to understand that there needs to be an existing, initial configuration in your Tenant. This means that you as a Teams Phone admin need to sit down with the person in charge of the reception phone or whoever oversees Holidays at your company. You then need to configure either a single or multiple Holiday lists in TAC and link them to each Auto Attendant, where they‚Äôre required.\nMy solution currently doesn‚Äôt have an option to allow users to add new Holidays to a list. When a new Holiday needs to be added, users must still request the change at IT. After it has been added to the list, there‚Äôs no additional work required for the new Holiday to also support user self-serviced updating.\nI created an Azure Runbook which runs on a schedule. I suppose running it weekly will suffice. If you wish, you can even run it daily. The script checks if the difference between the run time of the Job and the end date of a Holiday is bigger than 24 hours. This is because Holiday dates/lists itself don‚Äôt have a time zone property. But Auto Attendants do have a time zone setting, thus, we need to make sure that a Holiday is not updated/deleted before the Holiday would end in an Attendant specific time zone. A buffer of 24 hours should work well considering that the largest UTC offset is +14 hours.\nWhen the script runs, it will send a Teams Message Card to a Channel for each Holiday which now lies in the past. (Even though they are technically Legacy Actionable Message Cards I will just refer to them as Adaptive Cards from now on.)\nMembers of the channel will be able to see the dates, the name of the Holiday schedule as well as all linked Auto Attendants on the Adaptive Card. Furthermore, the script will add one year to the current dates and pre-fill the dates of next year as a suggested value in the date picker.\nBecause we‚Äôre using Adaptive Cards, the date format will automatically adjust to the Teams Clients display language. In this example, the Teams Client was set to German (Switzerland).\nMembers can then review and accept the new dates or change them in case a Holiday falls on a different day next year.\nIf needed, they can also configure a start or end time, if for example, a Holiday only starts at noon.\nFinally, they will need to select their local time zone. This is due to the fact that the Adaptive Card will submit the date and time based on the time zone which is configured on the local PC where Teams is running.\nIn early testing stages of this solution, ‚Äú00:00‚Äù was always passed to the Azure Function as ‚Äú23:00‚Äù because I live in UTC-1. Without this information the Function wouldn‚Äôt be able to do its magic and convert it back to the correct date.\nI‚Äôve included all time zones which are supported on Windows Systems.\nNow all a user needs to do is to click ‚ÄúSubmit New Dates‚Äù. This will pass all the information to an Azure Function, Update the card, and fire up the Runbook.\nIn other words, users won‚Äôt need to bother you to update their Holidays anymore. After each time a Holiday has passed, they will get a card which allows them to update it for next year by themselves.\nPrerequisites Just as with my previous articles you need to have the following things ready in Azure.\nAn Azure Function App so that we can create a new Function An Azure Automation Account so we can create 2x new Runbooks Azure Automation Credentials with Teams Administrator Permissions An Incoming Teams Webhook If you struggle to set up any of these, I recommend reading my first article about this topic. I also suggest creating a dedicated Teams Channel where the webhook will be added. More on that later.\nAzure Runbook: CheckHolidaySchedules Let‚Äôs create the first Runbook. This will be the one which logs into Teams PowerShell and checks if there are any Holidays which already lie in the past compared to the time of the Runbook Job.\nEnter your $teamsWebhookUrl on line 2. If you like, you can change the $defaultLocalTimeZone on line 3 to the time zone where most of your users are located. Make sure you also adjust the name of your Credential if yours has a different name.\nLeave the $functionUrl empty for now since we don‚Äôt have that one yet.\nSave and publish the Runbook. Don‚Äôt forget to add a schedule to the Runbook. If you need a reminder on how to do that, please see here.\nAzure Runbook: UpdateHolidaySchedules This Runbook will receive all the information a user has entered on the Adaptive Card. Because we also want to update the card, but Runbooks don‚Äôt support that, we will pass all the information from the card to the Function first. This includes the old date time range (so the script knows which one needs to be replaced), the newly entered dates and the time zone of the user.\nThe Function will then pass the data to the Runbook. Because the script now has both the old and new dates, it will be able to remove the old values and add the new ones to the Holiday schedule.\nPaste your Teams Webhook URL on line 7 before you save.\nTo be able to call this Runbook from the Function, we‚Äôll need to add a Webhook trigger to it as it‚Äôs described here. Before you click Create, copy its URL.\nAzure Function: UpdateCardAndTriggerRunbook Now we can create the Function. Set $runBookUrl to the Runbook‚Äôs webhook URL on line 6 and save the Function.\nFor the last step, we need to copy the URL of the Function and go back to our first Runbook ‚ÄúCheckHolidaySchedules‚Äù.\nRunbook CheckHolidaySchedules (Again) Edit the Runbook and set the $functionUrl variable to the copied Function URL on line 1. Save and Publish the Runbook again.\nTest Drive During normal operation, we would need to wait for a Holiday to be over before anything happens. In our case, we can test by manually starting the Runbook.\nAfter a few seconds, we should start seeing some new Adaptive Cards in our channel. Keep in mind that triggering the Runbook for the first time will post a card for each Holiday which has already passed. We can also see which Auto Attendants are affected on the card.\nAfter new dates have been submitted by a user, the Function will update the card.\nAs soon as the Runbook has finished, it will post another card to the channel to confirm that the Holiday has been renewed for next year. For review purposes both the old and new dates are included. If anybody made a mistake, they could still contact IT to manually fix the dates.\nIf we switch to the Holiday list in TAC, we can see that the Runbook added the new Holiday and removed the old one.\nConclusion Out of all the Teams self-service automations I already did, I think that this is actually the coolest one. Not only does it provide a great user experience because everything can be done from within Teams, but it also makes sure nobody forgets to update the company‚Äôs Holiday list. No more last-minute support tickets just before you were about to leave for the Christmas break.\nAnd the best part is that we don‚Äôt need to grant any kind of admin permission. The only thing we need to make sure is that only the people who are allowed to update the Holidays have access to the Teams Channel.\nThe whole point of using a script to automatically notify us when a Holiday has passed instead of using the request a change on-demand approach like with the other two self-service examples is that nobody forgets about updating the Holidays. To make sure that users don‚Äôt miss the Adaptive Cards in Teams, I suggest using a dedicated channel and having them turn on notifications for all activity on said channel.\nBy using a dedicated channel for Holiday self-service, we don‚Äôt need to force users to turn on all notifications for channels which might have much more activity/trigger too many notifications.\n","date":"2022-09-07T10:19:11.116Z","permalink":"https://heusser.pro/p/automatically-notify-users-to-update-teams-holidays-for-next-year-cb1f6f9c6471/","title":"Automatically Notify Users to Update Teams Holidays for Next Year"},{"content":"One of the biggest pain points of Microsoft Teams Call Queues is that a configured time out is always honored, even if no agents are available to answer the calls. It doesn‚Äôt matter if they have opted out, are offline or even if the queue has no agents configured at all. The call will only be forwarded after the timeout has been reached.\nTo conquer this issue, I‚Äôve created a small PowerShell script which can be implemented and executed on a schedule as an Azure Runbook.\nThe idea is quite simple. The script loops through all Call Queues and checks if there‚Äôs at least one agent opted in. If all agents are opted out, the script will set the Queue‚Äôs overflow threshold to zero.\nIf there‚Äôs at least one agent who‚Äôs opted in, it will check if the overflow threshold is still zero. If that‚Äôs the case, the script will update the overflow threshold to any value you set in the script.\nThis means that every time the script detects a Queue where no agents are opted in, the configured overflow action will be active immediately. As soon as the script sees that agents are available again, the immediate overflow action is disabled again.\nI‚Äôve also added a simple alerting mechanism using Teams incoming webhooks. Messages will only be sent when something was changed.\nAzure Runbook Code¬†Example Here‚Äôs the example code. Please keep in mind that this is in fact only an example. All the Message Cards go into the same Teams Channel because there‚Äôs no link between a Queue and a Channel which it might be associated with (e.g., a Voice Enabled Channel). I‚Äôm also using the same $defaultOverFlowThreshold for all Call Queues.\nIf you‚Äôre not familiar with Azure Runbooks, Automation Credentials and Teams Webhooks, please refer to this article. The steps to create these things are the same.\nInsert your webhook URL on line 3 and make sure that the name of the Automation Credentials matches yours on line 5.\nUnless the examples of my previous articles, were the Runbooks were triggered by a webhook, we‚Äôll need to create a schedule for this one. I recommend a schedule which runs every 15 minutes. This should be good enough to cover most scenarios.\nIn the Azure Portal, switch to Schedules and click + Add a schedule.\nNext, click Link a schedule to your runbook.\nClick on + Add a schedule.\nGive it a name and use the settings below. The smallest increment Azure Runbooks support is hourly. If we want to run it every 15 minutes, we‚Äôll need to create four schedules where each schedule starts at a different time. Let‚Äôs start with the one which will run at every full hour.\nRepeat the same step three more times using the following start times (based on this example): 15:15, 15:30, 15:45.\nOnce you‚Äôre done, it should look like this.\nThe Runbook will now run every 15 minutes and automatically enable or disable the immediate overflow action based on agent availability (opt in status).\nLet me know if you would be interested in a more sophisticated solution of this Runbook. I‚Äôm thinking of a way where we can store and link information about individual Call Queues such as different webhook URLs, different overflow thresholds etc. or even the minimum number of agents which should be available before a Queue is being enabled again. I already have an idea in store how this could be achieved‚Ä¶\n","date":"2022-09-04T16:07:25.322Z","permalink":"https://heusser.pro/p/automatically-enable-overflow-action-on-call-queues-if-no-agents-are-opted-in-f1c9bea7cb87/","title":"Automatically Enable Overflow Action on Call Queues if No Agents are Opted In"},{"content":"I‚Äôd be lying if I said that many people have asked me about such a script. But one person has. Frankly, this was all the motivation I needed. The question was if there‚Äôs a way to see all call flows any user is associated with. I figured that I‚Äôd take a shot and see if I can come up with anything. And come up I did.\nFirst, let‚Äôs talk about where a Teams User could be configured in a call flow.\nAuto Attendant Holiday Call Handlings Auto Attendant Default Call Flows (transfer or IVR option) Auto Attendant After Hours Call Flows (transfer or IVR option) Auto Attendant Operator (IVR option) Call Queue Agent Call Queue Timeout Target (transfer or personal voicemail) Call Queue Overflow Target (transfer or personal voicemail) How Does it¬†Work? To achieve this, I‚Äôve modified the M365 Call Flow Visualizer Script. Since the Visualizer is already able to read configurations from Auto Attendants and Call Queues, this wasn‚Äôt too hard. All I had to do was to write another function which will pull the Ids of all Voice Apps into an array. I then loop through all the Ids and run the Visualizer for each Voice App. When the Visualizer detects that a call is forwarded to a User at any point in the call flow, the details of said forwarding will be added to a PSObject which will then be added to a variable which only exists in the new function. I called this variable $userLinkVoiceApps¬†. Because the Visualizer is running for each Voice App, this variable must exist outside of the main script. Otherwise, it would get overwritten after each run.\n. .\\Functions\\Find-CallQueueAndAutoAttendantUserLinks.ps1\n. Find-CallQueueAndAutoAttendantUserLinks -SearchScope All\nI‚Äôve added this script to my repository. Make sure you clone the whole repo or download it as a zip file so that all relative file paths work.\nIf you don‚Äôt specify the -SearchUserId you will be able to select a user from the Out-GridView Table. Otherwise, you can pass an Azure AD ObjectId to the function using this parameter. You can also limit the search scope to just AutoAttendantsor CallQueues¬†. By default, the search Scope All is used.\nThe M365CallFlowVisualizer.ps1 is run with the parameters shown below. The -FindUserLinks switch tells the script to write all user related information into the external $userLinkVoiceApps variable. Since we‚Äôre running the script for each Voice App anyway, there‚Äôs no point in expanding nested call flows. We don‚Äôt need to create diagrams either, therefore all diagram output options are disabled.\n. .\\M365CallFlowVisualizerV2.ps1 -Identity $searchScopeIncludedVoiceApp -FindUserLinks -SaveToFile $false -SetClipBoard $false -ExportHtml $false -ShowNestedCallFlows $false -ShowUserCallingSettings $false\nDepending on the amount of Voice Apps you have, it will take some time to finish. After all the information has been gathered, it will be exported to a CSV file at.\\Output\\VoiceAppsLinkedTo_$UserId.csv¬†.\nHere‚Äôs an example of the generated output (the actual output will also include User Ids and Voice App Ids). We‚Äôre now able to see to which Voice Apps and where in these Voice Apps a user is configured at a glance.\nGood to¬†Know The M365 Call Flow Visualizer does not support reading IVRs on Holiday Call Handlings. Thus, this script won‚Äôt be able to tell if a user is linked to an Auto Attendant on a Holiday IVR.\nThe Visualizer is built in a way in which it represents an accurate diagram of the active configuration of a Voice App. For example, if you‚Äôve configured an Operator but it isn‚Äôt linked to an IVR menu option, the Operator won‚Äôt be drawn in the diagram, even if it‚Äôs present in the configuration. The same goes for configured after hours call flows, which don‚Äôt use a schedule (in which case the default call flow is active all the time). Because of that, the script won‚Äôt include users which are configured on inactive configurations on Auto Attendants.\nFor Call Queues which are configured to either immediately time out or overflow it‚Äôs a little bit different. The Visualizer won‚Äôt draw the call distribution subgraph because there‚Äôs no distribution happening when zero-time outs or overflows are configured but the agent will still be included in the exported CSV file.\nHere we can see that the Call Queue ‚ÄúPS Test CQ‚Äù immediately overflows to an external number.\nIn Teams Admin Center, agents are assigned using a Team though.\nIf you would like to learn more about Call Queues and Agent Lists, please refer to this article.\nNevertheless, the CallFlowUserFinder.ps1 will still include this user in the exported table so that you can see all the Queues a user is associated with.\nI hope that this script/method helps you figure which Voice Apps a specific user is linked to.\n","date":"2022-09-04T11:12:16.321Z","permalink":"https://heusser.pro/p/find-all-auto-attendants-and-call-queues-a-user-is-associated-with-16710c3adf01/","title":"Find All Auto Attendants and Call Queues a User is Associated with"},{"content":"There was an issue with my code in this article. The solution described in this article assumes that your call queue overflow and timeout actions already forward to an external PSTN number. If it was set to any other option like voicemail or disconnect, the runbook failed. I‚Äôve updated the Runbook code sample on GitHub accordingly.\nOriginal Article A while ago I published this article which explains how we can build a self-service solution for changing the configurations of Auto Attendants and Call Queues using Azure Automation Tools. The main reason behind this is so that we don‚Äôt have to grant admin privileges to users which would like to manage Queues and Attendants.\nIn my last post, I provided an example how an Auto Attendant can be manually closed or opened. Today I‚Äôm going to show you an example of how we can let users change some settings on Call Queues.\nI‚Äôve written the code for the following changes:\nImmediately forward a Call Queue to an external number Disable the immediate forwarding again Change the external number for forwarding on Timeout Immediate forwarding is configured through an overflow Threshold of 0 and not a Timeout of 0. This is because, typically, Overflow Threshold is less used than timeout. I always recommend using Overflow Threshold 0 when you want to do an immediate forwarding. Unlike Timeout 0, the call is forwarded directly, without the Queue answering the call first when using Overflow. You can read more about that here.\nIf the immediate forwarding is disabled again, the value of the Overflow Threshold will be set to 50 again. This is the default value which is configured for new Call Queues. Of course, you change that in the Runbook code.\nThis is what the Message Card looks like when it‚Äôs sent by the Azure Function.\nLet‚Äôs Build¬†It To build this on your own, please refer to my first article since the configuration steps are the same. You just need to replace the code of the Azure Functions and Runbooks from the Gists below.\nRunbook Code Insert the Webhook URL of your Teams Channel on line 7 and make sure that you‚Äôve created the Automation Credentials as described in the article linked at the beginning of this post.\nRefresh Card Function¬†Code Insert the URL of your Azure Runbook Webhook trigger on line 11.\nRequest Card Function¬†Code To get a drop-down list with all your queues, we need to create one first.\nYou can use the following code to create a list, which we‚Äôll insert in our Function code later.\nThis will create part of the JSON code and put it in your clipboard. You‚Äôll need it later. If you‚Äôre already using Windows Clipboard, you will be able to pull it up by pressing Windows + V.\nHere‚Äôs the code for the Azure Function which will send the Update Call Queue Config stuff. Insert your URLs on line 6 and 7 and make sure to paste your list of Call Queue choices on line 27.\nAfter you‚Äôve inserted your list, it should look like this. Yours will show real Ids of course.\nThat‚Äôs all. Now your users will be able to request a config change card. Let‚Äôs go through the process again.\nFirst, the outgoing webhook is mentioned in a channel. The Function will then confirm that the request has been received.\nThe Function will also send the config change card.\nOnce the user has entered all the information, they will be able to submit the config. This will also update the card and confirm the settings.\nIt takes a while until the Runbook has finished. But one it has done its job, it will send us another card, confirming the settings.\nNote: Setting a new number as the Queue‚Äôs Timeout Action will also reset the configured Overflow Threshold to 50. (If the Overflow Threshold would still be 0, the Timeout settings would have no effect at all.)\nI hope that these code examples help you to build your own self-service solution for your users.\n","date":"2022-09-03T13:21:48.318Z","permalink":"https://heusser.pro/p/microsoft-teams-self-service-call-queue-solution-part-2-ab8201157831/","title":"Microsoft Teams Self-Service Call Queue Solution (Part 2)"},{"content":"Today we‚Äôre going to take a detailed look at Teams Resource Accounts.\nResource Accounts are special Azure AD Objects (or Microsoft 365 User Accounts, if you will) which can only be created from Teams Admin Center or via Teams PowerShell. It‚Äôs not possible to create such an account in M365 Admin or Azure AD. What‚Äôs funny though is that they can only be deleted from M365 Admin or AAD but not from Teams Admin Center or Teams PowerShell.\nThe Basics Currently, there are two different types of so called first-party (Microsoft) Resource Accounts. Call Queues and Auto Attendants. These accounts are then associated with corresponding types of Voice App, which are again, Call Queues or Auto Attendants.\nEach Resource Account can only be associated with one Voice App, but a Voice App can have multiple Resource Accounts associated. Just like with Teams users, each Resource Account can also only have one phone number assigned. For example, you can have an Auto Attendant which has multiple Resource Accounts assigned, where each Resource Account has a phone number from a different country. This way you can have an Auto Attendant which serves customers across multiple countries, but each customer will be able to call a local number.\nHow to Create a Resource¬†Account You can create new Resource Accounts from TAC. They are located under Voice\\Resource accounts.\nThere are a few things to consider here. The first one is naming. If you have a complex call flow, chances are that you will have many Auto Attendants, Call Queues and Resource Accounts. I always use a prefix and suffix system.\nThe Display Name is followed by the suffix ‚ÄúAA‚Äù or ‚ÄúCQ‚Äù. This way it will be easier to identify the correct Resource Account, when you associate it with a Voice App. The User Principal Name is led by the prefix ‚Äúra_aa_‚Äù or ‚Äúra_cq_‚Äù so that they can easily be filtered in AAD. Of course, this is only a suggestion, you‚Äôre free to name them however you want.\nUsually, I just use the *.onmicrosoft.com name of the Tenant as the domain suffix. External users won‚Äôt be able to interact with these kinds of accounts, so it doesn‚Äôt matter if you don‚Äôt use your default custom domain name.\nHere are the PowerShell equivalent commands to create Resoure Accounts.\nAuto Attendant:\n# App Id Auto Attendants: ce933385-9390-45d1-9512-c8d228074e07\nNew-CsOnlineApplicationInstance -UserPrincipalName \u0026ldquo;ra_aa_example_ps@domain.com\u0026rdquo; -ApplicationId \u0026ldquo;ce933385-9390-45d1-9512-c8d228074e07\u0026rdquo; -DisplayName \u0026ldquo;Example PS AA\u0026rdquo;\nCall Queues:\n# App Id Call Queues: 11cd3e2e-fccb-42ad-ad00-878b93575e07\nNew-CsOnlineApplicationInstance -UserPrincipalName \u0026ldquo;ra_cq_example_ps@domain.com\u0026rdquo; -ApplicationId \u0026ldquo;11cd3e2e-fccb-42ad-ad00-878b93575e07\u0026rdquo; -DisplayName \u0026ldquo;Example PS CQ\u0026rdquo;\nSearching for Resource¬†Accounts If you want to return all Resource Accounts by PowerShell, the MicrosoftTeams Module 4.6.0 now supports a parameter to only return Resource Accounts: Get-CsOnlineUser -AccountType ResourceAccount¬†. If we didn‚Äôt include a prefix or a suffix, there‚Äôs currently no way to tell if the returned objects are Queues or Attendants.\nFor that, we need to useGet-CsOnlineApplicationInstance¬†. This will return a list with some basic information like Display Name, UPN, Phone Number and Application Id.\nLicensing Resource¬†Accounts A Resource Account must be licensed in the following cases:\nIf you want to assign a phone number to it If the Resource Accounts needs to be able to transfer calls to external numbers Update 29.01.2023\nMicrosoft updated their documentation. From now on, every Resource Account must be licensed, regardless of if a phone number is assigned or not. You can find more info here.\nAn easy way to ensure that every Teams Resource Account is licensed properly is to use a dynamic user Azure AD Group which automatically assigns the license. The easiest way to do so is to filter on the Department attribute.\n(user.department -eq \u0026ldquo;Microsoft Communication Application Instance\u0026rdquo;)\nIf you need step-by-step instructions on how to create an Azure AD Group with a dynamic query, please consult this article and just replace the query with the one above.\n/Update\nUpdate 06.02.2023\nThanks to a reader comment, it was brought to my attention, that group based licensing actually requires an Azure AD Premium P1 license, for any user which takes advantage of the feature. This is documented here.\nI don‚Äôt know if a resource account qualifies as ‚Äúuser‚Äù because they are resource account and sign-in blocked. If you want to be absolutely sure, I recommend that you have a P1 license for each resource account or that you contact your account manager at Microsoft and ask them about this.\n/Update\nLicensing can‚Äôt be done from TAC. We need to use AAD or M365 Admin. As we can see, the account ‚ÄúExample AA‚Äù has now been created in AAD.\nBecause this is a special kind of account, it‚Äôs Sign-in blocked. This means that the account doesn‚Äôt support interactive sign-ins.\nAnother important info is that these accounts have ‚ÄúMicrosoft Communication Application Instance‚Äù set as their department. Just leave this as it is and don‚Äôt change anything.\nBased on my experience, it‚Äôs no problem to change its Display or User Principal Name though.\nIf you want to assign a phone number to a Resource Account, you will need to assign a license to it. Microsoft has recently renamed the old license ‚ÄúMicrosoft Teams Phone‚Ää‚Äî‚ÄäVirtual User‚Äù to ‚ÄúMicrosoft Teams Phone Resource Account‚Äù.\nWhat‚Äôs really nice about these licenses, is that their free. At least to some extent. If you have at least one Teams Phone license, you will get 25 Teams Phone Resource Account licenses for free. After that, you will get 1 Resource Account license for every 10 Teams Phone licenses. The ‚ÄúPowerShell Name‚Äù or rather the AccountSkuId of this license is still called ‚ÄúTenantName:PHONESYSTEM_VIRTUALUSER‚Äù. Unlike Teams Phone which needs a ‚Äúbase license‚Äù like a Business Premium or Enterprise E3, Resource Account licenses can be assigned as standalone licenses.\nHow to Assign Phone Numbers to Resource¬†Accounts Once you‚Äôve assigned a license to a Resource Account you can either use TAC or PowerShell to assign a phone number to the account.\nFor PowerShell, you can use the same command as you would with a normal user. You might stumble upon outdated articles which mention the following command.\nSet-CsOnlineApplicationInstance -Identity \u0026ldquo;ra_aa_example_ps@domain.com\u0026rdquo; -OnPremPhoneNumber +4144512xxxx\nThe new one is the following:\nSet-CsPhoneNumberAssignment -Identity \u0026ldquo;ra_aa_example_ps@domain.com\u0026rdquo; -PhoneNumber +4144512xxxx -PhoneNumberType DirectRouting\nEven though the Resource Account now has a phone number assigned to it, the number won‚Äôt be active until the Resource Account is associated with a Voice App. We‚Äôll get to that later.\nHow to Assign a Voice Routing Policy to a Resource¬†Account If the Resource Account should be able to transfer calls to external PSTN numbers using Direct Routing, we will also need to assign a Voice Routing Policy to it. This can also be done from TAC. Select your Resource Account and click on Edit. Now choose your desired Voice Routing Policy and click Save.\nDoing it with PowerShell is again, the same as if it was a normal user.\nGrant-CsOnlineVoiceRoutingPolicy -Identity \u0026ldquo;ra_aa_example_ps@domain.com\u0026rdquo; -PolicyName \u0026ldquo;Test\u0026rdquo;\nHow to Change the Type of a Resource¬†Account On that same ‚ÄúEdit resource account‚Äù window, it‚Äôs also possible to change the type of a Resource Account. This can also be done by PowerShell. Just use the Set-CsApplicationInstance cmdlet and include the -Identity and -ApplicationId parameters. Even though this should work in theory, I haven‚Äôt tested it myself since I recommend re-creating them, if ever needed. Also be careful when 3rd party resource accounts e.g. from Attendant Console or Contact Center vendors are in play. TAC only supports first party Application Ids and won‚Äôt allow you to save changes you made without choosing a Resource Account type. Use PowerShell if you need to assign an online voice routing policy to a 3rd party resource account.\nHow to Associate a Resource Account with a Voice¬†App In most cases, having one Resource Account per Queue or Attendant is enough. Let‚Äôs make a small detour and talk about naming again for a second. To avoid confusion, I always make sure that the Display Name for the Queue/Attendant and the Resource Account are the same. If a Voice App needs multiple resource accounts, I use numbering on the resource account names. It‚Äôs important to note that the Display Name of the Resource Account is the name which a recipient of a call which was transferred by an Attendant or a Queue will see on the Teams toast notification.\nHere we can see that this Call Queue is called ‚ÄúMS Test CQ‚Äù but the associated resource account is called ‚ÄúTeam Green CQ‚Äù.\nSince the toast will show the Display Name of the resource account, it will say that there‚Äôs a call for ‚ÄúTeam Green CQ‚Äù and not ‚ÄúMS Test CQ‚Äù.\nI talked about the importance of the AA/CQ suffix at the beginning of this post. Microsoft has improved TAC and now shows assigned phone numbers in the drop-down list, if we search for a Voice App redirection target.\nBut let‚Äôs assume that neither of these accounts had a phone number assigned and we didn‚Äôt use a suffix either. Good luck figuring out which one of these is the Auto Attendant and which one is the Call Queue.\nEnterprise Voice This is an interesting one. As far as I can tell, resource accounts which were created at least a few months ago, are still Enterprise Voice enabled, even if they don‚Äôt have a Teams Phone Resource Account License assigned.\nHere‚Äôs an example of such a relict. This resource account is Enterprise Voice enabled, despite not having a LineURI or a Feature Type. FeatureTypes is a relatively new property which is returned by Get-CsOnlineUser¬†.\nDisplayName : Support Number Business Hours AA\nEnterpriseVoiceEnabled : True\nLineUri :\nFeatureTypes : {}\nFor reference, here‚Äôs a screenshot of the M365 Admin Portal.\nIf we check ‚ÄúSupport Number AA‚Äù (which does have a license) by PowerShell using the search query below, we can see that it includes ‚ÄúVoiceApp‚Äù under FeatureTypes.\nGet-CsOnlineUser -Identity ra_aa_support_number@mozzism.ch | FL DisplayName, EnterpriseVoiceEnabled, LineURI, FeatureTypes\nOutput:\nDisplayName : Support Number AA\nEnterpriseVoiceEnabled : True\nLineUri : tel:+4144xxxxxxx\nFeatureTypes : {VoiceApp}\nIf we check a normal Teams user account, we can see that they‚Äôll have ‚ÄúPhoneSystem‚Äù and ‚ÄúTeams‚Äù included in their FeatureTypes.\nDisplayName : Ben Kim\nEnterpriseVoiceEnabled : True\nFeatureTypes : {PhoneSystem, Teams}\nBut beware that a user can also include the Feature Type ‚ÄúPhoneSystem‚Äù without actually being Enterprise Voice enabled. (In this case the user has a Teams Phone License but is not configured for EV yet.)\nDisplayName : Bill Stearn\nEnterpriseVoiceEnabled : False\nFeatureTypes : {PhoneSystem, Teams}\nI wasn‚Äôt able to reproduce this scenario. When I created a new resource account and didn‚Äôt assign a license, it was always set to Enterprise Voice enabled False.\nDisplayName : Example PS AA\nEnterpriseVoiceEnabled : False\nFeatureTypes : {}\nLet‚Äôs see how this looks, after we‚Äôve added a Microsoft Teams Phone Resource Account License to ‚ÄúExample PS AA‚Äù. After a few minutes, the Feature Type will be added, and EV will be set to True. I was spamming the Get-CsOnlineUser query so often, that I even managed to get an output right before and after the change.\nHere we can see that the Feature Type ‚ÄúVoiceApp‚Äù was added but Enterprise Voice was still disabled.\nDisplayName : Example PS AA\nEnterpriseVoiceEnabled : False\nFeatureTypes : {VoiceApp}\nLiterally seconds later, I ran it again and now Enterprise Voice has been enabled.\nDisplayName : Example PS AA\nEnterpriseVoiceEnabled : True\nFeatureTypes : {VoiceApp}\nAssigning the license will automatically set Enterprise Voice enabled to True. This is different than with normal user accounts. They will stay False until we either assign them a number through TAC or use Set-CsPhoneNumberAssignment -EnterpriseVoiceEnabled $true¬†.\nIf the license is removed from the resource account, EV will be disabled again.\nExternal PSTN Transfer from Resource¬†Accounts The official documentation of the technical requirements which are needed for external PSTN transfers can be viewed here. I‚Äôm only covering Direct Routing Scenarios in this article.\nThese requirements need to be met by all resource accounts which are associated with a Voice App. For example, if you have an Auto Attendant which has two resource accounts / numbers assigned and it forwards to an external number outside of business hours, both resource accounts will need to have a valid voice routing policy assigned. TAC won‚Äôt display a warning or an error message, even if none of the associated resource account have an online voice routing policy assigned. So, in other words: If a call is made to a Resource Account which doesn‚Äôt have a voice routing policy assigned, the call transfer will fail.\nWhat about nesting? Although I don‚Äôt think that this is officially documented, I have found that only the top-level resource account, which is the one with the number which is dialed, needs to be configured properly.\nLet‚Äôs take a look at the configuration of the resource accounts used in this scenario.\nObviously, the Call Queue ‚ÄúTest EV Enabled CQ‚Äù and not the ‚ÄúTest EV Enabled AA‚Äù does the PSTN transfer. But only the Auto Attendant is configured for outbound PSTN calling. The call transfer in this scenario works.\nDisplayName : Test EV Enabled AA\nEnterpriseVoiceEnabled : True\nFeatureTypes : {VoiceApp}\nOnlineVoiceRoutingPolicy : FirstTrunk\nDisplayName : Test EV Enabled CQ\nEnterpriseVoiceEnabled : False\nFeatureTypes : {}\nOnlineVoiceRoutingPolicy :\nIn the PSTN and SMS (preview) usage report in TAC, we can see that it‚Äôs the initially called resource account, rather than the one associated with the call queue which does the outbound call. Outbound Direct Routing calls from Voice Apps are labelled as ‚Äúdr_out_bot‚Äù.\nTo be absolutely sure, I created another configuration. This time the other way around. The top-level Auto Attendant does not have an online voice routing policy assigned, but the nested Call Queue does.\nWhen I called the number of the Auto Attendant, the PSTN transfer of the Call Queue did not work, even though the Queue is configured for outbound calling. When I called the number of the Queue directly, forwarding to PSTN worked perfectly.\nP.S. If you‚Äôre wondering, how I created that flow chart and didn‚Äôt get the memo before, besides blogging, I‚Äôm also the creator of this PowerShell Tool which allows anybody to automatically render these cool diagrams for free.\nFinding Auto Attendants and Call Queues in¬†Teams If you can‚Äôt find all your Auto Attendants and Call Queues when you search for them in Teams, you should definitely take a look at this article.\nOne Last¬†Thing Although it‚Äôs now possible to do most of the things, like assigning online voice routing policies or phone numbers in TAC, some things are still missing from TAC. For example, you won‚Äôt find your resource accounts under ‚ÄúManage users‚Äù. You can, however, replace the Object Id of a user in the URL, with an Object Id of a Resource Account. This will allow you to view some data, like recent calls.\nIf you‚Äôre too lazy to grab the Object Id, you can also click the Display Name of a Resource Account from the PSTN and SMS (preview) usage report.\nThis will yield an error message that TAC can‚Äôt get the policies of this account. But you‚Äôll still be able to see it‚Äôs call history under the ‚ÄúMeetings \u0026amp; calls‚Äù tab.\nI hope this article helps you better understand how Resource Accounts work in Teams Phone. Feel free to reach out if you have any questions left.\n","date":"2022-08-29T19:45:51.457Z","permalink":"https://heusser.pro/p/everything-you-ever-wanted-to-know-about-teams-resource-accounts-2ff9661fc489/","title":"Everything You Ever Wanted to Know About Teams Resource Accounts"},{"content":"Have you ever wondered why you or some of your users can‚Äôt see all Auto Attendants or Call Queues when you search for them in Teams? Start following me on Medium and wonder no more.\nThe users who can find them are most likely agents of the queues which show up when they search for it or have previously received a call forwarded by an Auto Attendant. Based on my testing, Auto Attendants and Call Queues only show up in search, if there has been some form of interaction between the user and the resource account before.\nHere‚Äôs an example where the resource account ‚ÄúExample AA‚Äù which is associated with an Auto Attendant can‚Äôt be found by a user.\nAnd here‚Äôs the same search query from a different user, which has interacted with ‚ÄúExample AA‚Äù before.\nSo, what can you do if you want your users to find Call Queues and Auto Attendants in Teams, if they‚Äôre not part of the queue or don‚Äôt get calls from an Auto Attendant?\nCertainly, adding all users to a queue or configuring an Auto Attendant a hundred times over and making actual calls to its number so that the user receives a call from the attendant is no option.\nLet‚Äôs explore other options.\nDeep Links / User Self-Service I‚Äôve blogged about deep links in Teams before. If we create a deep link to call a resource account‚Äôs user principal name, the resource account will somehow magically be added to the user‚Äôs Teams contacts, once the user clicks on the link. This user will then be able to find this Auto Attendant or Call Queue from search.\nLet‚Äôs call this a self-service approach. We as admins will provide our users a list with deep links and the users choose themselves, which accounts they want to add.\nA deep link will look like this:\nhttps://teams.microsoft.com/l/call/0/0?users=ra_aa_example@mozzism.onmicrosoft.com\rIf we copy this link and paste it in our favorite browser (which should be Microsoft Edge of course) we will see the following pop-up.\nNext, we need to click ‚ÄúOpen‚Äù in order to initiate the call in Teams. That‚Äôs all that‚Äôs needed already. We don‚Äôt actually need to call the Auto Attendant.\nNote: This will only work if the resource account is in fact associated with a voice app.\nIf we cancel and search for ‚Äúexample‚Äù again, the Auto Attendant / resource account now shows up, everywhere we could possibly search for it. This includes the search and action bar, the people picker on the dial pad and the new number or contact search field in call answering rules.\nWhat if we‚Äôve got hundreds of resource accounts? I‚Äôve got you covered here as well. Just use this code to generate a deep link for each resource account in your tenant.\nThis will read all first party resource accounts (Auto Attendants and Call Queues, other 3rd party resource accounts, such as Landis or Luware won‚Äôt be included) from your tenant, create a deep link for each account and put them in your clipboard.\nNow we can publish these links anywhere we want. I put mine in a Teams Wiki for example.\nAll that‚Äôs left to do for the users is to click on a link and then cancel or make the call.\nThat‚Äôs one way to do it. But what if you want to go the extra mile for your users and automatically make all your Attendants and Queues available for all your users?\nThe PowerShell Way / Going the Extra¬†Mile Although it‚Äôs possible to do this at scale, this method does come with a caveat. We‚Äôll see what that is later. Instead of launching a deep link to a call, we‚Äôre going to create a chat between the user and the resource account. But how can we create a chat with the resource account, if we can‚Äôt search for it in the first place?\nI have found that it‚Äôs possible to use Microsoft Graph to create a chat between a user and a resource account.\nHere‚Äôs an example script. Use it at your own risk. As I already stated in this article, the function to authenticate against MS Graph is baes on the work of Alex Asplund from this article. You will need an Azure App Registration with at least the following Application permissions: ‚Äúprofile‚Äù, ‚Äúopenid‚Äù, ‚ÄúUser.Read.All‚Äù, ‚ÄúChat.Create‚Äù.\nFill in $AppId¬†,$AppSecret and $TenantName with your own credentials and domain name on lines 4‚Äì6. Once you run the script, it will retrieve all your resource accounts and all users which have a Teams Phone Standard License assigned. This serves merely as an example. Of course, you can create your own filter for the variable $allTeamsPhoneUsers or import a CSV file etc.\nNext, the script will loop through all users, and create an empty chat with each resource account, which will ultimately make the resource accounts discoverable for the user.\nLet‚Äôs see the result. Again, before the script was executed, the account ‚ÄúUSA Toll Free Test AA‚Äù does not show up in this user‚Äôs search box.\nOnce the script has run for any Teams user, they will see a bunch of new, empty chats in their Teams chats. Unfortunately, I don‚Äôt know why Teams won‚Äôt show the Display Name here.\nFunny enough, the Display Name will show up if we switch to the Organization Tab in the chat.\nAnd of course, the account now shows up in search, which is what we want.\nSo, there you have it. Something which could be used to make all Auto Attendants and Call Queues discoverable in Teams for all your users. Because we‚Äôre only using the Graph permission ‚ÄúCreate.Chat‚Äù we can use Application permissions and don‚Äôt need to worry about delegation and user tokens. The only downside is that depending on the amount of voice apps you add, the users will see a boatload of new, unread chats, all titled with ‚ÄúUnkown User‚Äù. Depending on user activity in Teams, these could get moved down the list pretty quickly though. Or users can just choose to hide them if they don‚Äôt want a messy chats section.\nI hope that this article helps lighten some confusion around why only some users can search for voice apps. Furthermore, I hope that my script to programmatically add all resource accounts to Teams will help you make your users happy.\n","date":"2022-08-26T08:27:12.679Z","permalink":"https://heusser.pro/p/why-can-only-some-users-search-auto-attendants-and-call-queues-in-teams-940402164681/","title":"Why Can Only some Users Search Auto Attendants and Call Queues in Teams?"},{"content":"Changing the business hours on a Teams Auto Attendant can be quite cumbersome. Especially if you have multiple hours a day, like a lunch break. If you‚Äôve been working long enough with Teams, you probably remember how easy it was in Skype for Business Online Admin Center. There, we could just select opening hours from a timetable and be done with it. Nowadays we have to select the start and end time from a drop-down list for each day individually.\nTo speed up this process, I‚Äôve created a PowerShell Script. Right now, there are no parameters. After all, the idea is to be quicker and not make you pick times from a drop-down in PowerShell rather than in TAC.\nBy default, the script will allow you to set a time range for mornings and one for afternoons. These are defined in the variables $tr1 and $tr2 on line 7 and 8. You can adjust them to your liking, as long as they don‚Äôt overlap each other. Only 15minute increments are supported. You must use the 24-hour clock system.\nEdit (08.09.2022): I‚Äôve updated line 16 to look for the CallFlowId of the Auto Attendants CallHandlingAssociation with type ‚ÄúAfterHours‚Äù instead of the CallFlow Name matching ‚ÄúAfter hours call flow‚Äù.\nOnce you run the script, the defined time ranges will be applied to the Auto Attendant which was selected from the list.\nThis works for both, Auto Attendants which already have business hours configured and Auto Attendants which didn‚Äôt have business hours already. Your configured after hours call flow (e.g. forward to shared voicemail etc.) will not be impacted/overwritten. It will stay exactly the same as it was.\nIf your call flow has different business hours for specific days, just add more $tr variables and make sure to add/change them on line 40. For example, if your business closes early on Fridays but has no lunch break, create a $tr3 variable and change -FridayHours @($tr1,$tr2) to -FridayHours @($tr3)¬†.\nBy default, the script will not add any business hours for Saturday and Sunday. This means that the after hours call flow will be active on the weekend. If you also want to configure hours for these days, add them using the switch -SaturdayHours followed by the array @($tr4,$tr5)¬†.\nOn a final note, when changing business hours via PowerShell, we must use the -Complement switch. This will invert the time ranges. Meaning that the after hours call flow will be active during times which are outside of what is shown on the timetable. TAC displays the business hours, during which the Auto Attendant is open but it does so on the after hours call flow page. This can be a little misleading. When business hours are set through TAC, the complement flag is automatically enabled.\nI hope this helps you save some time as well.\n","date":"2022-08-23T18:21:59.224Z","permalink":"https://heusser.pro/p/change-business-hours-of-a-teams-auto-attendant-with-powershell-ed03a15881d2/","title":"Change Business Hours of a Teams Auto Attendant with PowerShell"},{"content":"Many companies use custom audio files like greetings, IVR announcements etc. in their call flows. Often these audio files are custom made by professionals. Hence, they provide a certain value to many customers. Unfortunately, sometimes people take the ‚Äúset and forget‚Äù approach and these files are then either deleted or can‚Äôt be found by the people who need them.\nSo, let‚Äôs assume that you have an auto attendant or a call queue in Teams which use custom audio files. Now you want to create a new call flow with the same greetings, but you can‚Äôt find the existing files anymore. The only place where they are stored is in Teams / the live configuration.\nDownload via¬†TAC Since a few weeks, it‚Äôs possible to download these files via TAC directly instead of just PowerShell. To do so, just go into the configuration of your auto attendant or call queue and locate the desired file you want to download.\nNow right click on the filename and select ‚ÄúSave link as‚Äù.\nThe suggested filename is actually the audio file id from the CsOnlineAudioFile but the extension is missing by default.\nNaturally, I tried to add¬†.mp3 as the filename extension since that‚Äôs what it says in TAC.\nOnce the file has been downloaded, it plays back just fine on my computer. However, when I try to upload it to another auto attendant or call queue (or even the same for that matter), I always receive the following error message.\nTeams supports MP3, WAV and WMA files which are smaller than 5 MB. So, the downloaded file should be supported. However, it looks like uploaded files are somehow converted by Teams, regardless of their source format. As soon as I renamed the downloaded mp3 file to¬†.wav, I was able to upload the file without any issues.\nDownload by PowerShell Previously, the only way to download existing audio files was by using PowerShell. If that‚Äôs what you‚Äôre interested in, you can use the Gist below to download already uploaded audio files. This handy snippet will retrieve all types of audio files (TenantGlobal, HuntGroup and OrgAutoAttendant), present them in an Out-GridView list (Windows only) and lets you choose a destination directory.\nNote: It‚Äôs the same case here, if an mp3 file is saved with an mp3 filename extension, Teams won‚Äôt accept the file. Thus, the PowerShell code saves¬†.mp3 and¬†.wma files as¬†.wav files.\nTLDR; All you have to do is to download the file and save it as *.wav regardless of the original filename extension. You‚Äôll then be able to easily export and reupload already existing audio files.\nI hope this article saves you some trouble next time somebody urgently needs an audio file which has mysteriously disappeared from SharePoint or your file server.\n","date":"2022-08-16T17:33:21.861Z","permalink":"https://heusser.pro/p/download-existing-audio-files-from-teams-admin-center-1839230eadb0/","title":"Download Existing Audio Files from Teams Admin Center"},{"content":"As you might have heard, Microsoft will soon be deprecating the MSOnline PowerShell Module. Even though Microsoft is giving us a little bit more time (now after December 2022 instead of June 2022) it‚Äôs time to move on and start working with the new, Microsoft.Graph PowerShell Module. I‚Äôm already using it in my Microsoft 365 Call Flow Visualizer.\nToday, I updated a Direct Routing provisioning script which I wrote at work. This script does everything that‚Äôs needed to set up Direct Routing in a tenant.\nAdd the FQDN of the SBC as a new Domain to the customer tenant Add the TXT verification DNS record to our Azure DNS zone Verify/confirm the domain in the customer tenant Create a resource account to activate the domain without a license Add the gateway, PSTN usage, voice route and voice routing policy Remove the activation user/resource account Prepare Graph PowerShell Before you can use Microsoft.Graph PowerShell you need to install the Module.\nInstall-Module Microsoft.Graph\nThis will install all Graph Modules. It‚Äôs also possible to install only select modules (e.g. Install-Module Microsoft.Graph.Users) but since many modules have dependencies (e.g. Authentication etc.) it‚Äôs easier to just install all Modules from the get-go.\nWhen you connect to Microsoft Graph PowerShell you need to provide the required scopes. For the Cmdlets shown in t his blog article you need at least the following:\nConnect-MgGraph -Scopes \u0026ldquo;User.ReadWrite.All\u0026rdquo;,\u0026ldquo;Domain.ReadWrite.All\u0026rdquo;\nIf you connect to Graph PowerShell for the first time, you will need to grant consent for the defined scopes. I‚Äôve also defined the scope ‚ÄúGroup.ReadWrite.All‚Äù, that‚Äôs why it also requests access for Read and write all groups.\nHere are the old MSOnline Cmdlets vs the new Microsoft.Graph Cmdlets for the relevant actions.\nAdd the¬†Domain MSol\nNew-MsolDomain -Name \u0026ldquo;sbc001.domain.com\u0026rdquo;\nMg\nNew-MgDomain -BodyParameter @{Id=\u0026ldquo;sbc001domain.com\u0026rdquo;;IsDefault=\u0026ldquo;False\u0026rdquo;}\nIsDefault is optional. The domain won‚Äôt be added as the new default domain, even if you don‚Äôt include this key in the hash table. You can still include it though, it might give you some sort of comfort.\nGet the Verification Text This was the only one which was a bit tricky since the actual value is hidden in the ‚ÄúAdditionalProperties‚Äù property which won‚Äôt be shown in the output.\nOutput:\nIf we use | Format-Lsit or | Select-Object * we will see that there‚Äôs a property called ‚ÄúAdditionalProperties‚Äù.\nThis code, however, will store the verification code in the $MgVerificationCode variable.\nMg\n$MgVerificationCode = (Get-MgDomainVerificationDnsRecord -DomainId \u0026ldquo;sbc001.domain.com\u0026rdquo; | Where-Object {$_.RecordType -eq \u0026ldquo;Txt\u0026rdquo;}).AdditionalProperties.text\nMsol\nWith Msol, the code did not include the first ‚ÄúMS=‚Äù why I needed to add it to the variable before getting the value. This is not the case with Graph anymore.\n$MsolVerificationCode = \u0026ldquo;MS=\u0026quot;+ (Get-MsolDomainVerificationDNS -DomainName $FQDNs.Values.FQDN).Label.Split(\u0026rdquo;.\u0026quot;)[0]\nVerify the¬†Domain If you use an Azure DNS zone you can now use Az.DNS to create a new TXT record which contains $MgVerificationCode as the value.\nNew-AzDnsRecordSet -Name \u0026ldquo;sbc001\u0026rdquo; -RecordType TXT -ResourceGroupName \u0026ldquo;ResourceGroupX\u0026rdquo; -TTL 3600 -ZoneName \u0026ldquo;domain.com\u0026rdquo; -DnsRecords (New-AzDnsRecordConfig -Value $MgVerificationCode)\nOnce the record is created, we can confirm the domain. This usually works within seconds if you use Azure DNS.\nMg\nConfirm-MgDomain -DomainId \u0026ldquo;sbc001.domain.com\u0026rdquo;\nMsol\nConfirm-MsolDomain -DomainName \u0026ldquo;sbc001.domain.com\u0026rdquo;\nRemvoe the¬†User When everything is set up, the activation user can be removed again.\nMg\nRemove-MgUser -UserId $UpnAA\nMsol\nRemove-MsolUser -UserPrincipalName $UpnAA -Force\nWhile we needed to specify the -Force parameter with MSol, we don‚Äôt need to specify anything when using Microsoft Graph. If you wish to make the script interactive and have a user confirm the deletion when using Remove-MgUser, you can use the -Confirm parameter instead.\nThat‚Äôs all for today. Don‚Äôt fear Microsoft.Graph and happy scripting everybody!\n","date":"2022-07-21T15:16:51.25Z","permalink":"https://heusser.pro/p/how-to-add-a-new-domain-to-m365-with-ms-graph-powershell-e6b41c02bfa3/","title":"How To Add a New Domain to M365 with MS Graph PowerShell"},{"content":"Just two days ago I published Set your Teams Status to In a Call when using other Calling \u0026amp; Meeting Apps on iOS. In this article, I explained how we can leverage Siri Shortcuts on iOS to call an Azure Function which then executes web requests against the Microsoft Graph API.\nToday I wanted to see if I‚Äôm able to get it working without the use of an Azure Function as a middleman. Spoiler alert: I totally was.\nYou can import the Siri Shortcut from here.\nOf course, you need to have an Azure App Registration with the desired permissions ready to use this. Once you‚Äôve imported the shortcut, just fill in the required information in the text fileds. We need the App Id, the App secret and the name (domain) or Id of the tenant.\nLet‚Äôs take a detailed look of what‚Äôs going on inside the Shortcut.\nFirst, an http POST request is made to request the access token. Client_id and client_secret are passed to the request body as variables from the Text fields you populated at the top of the Shortcut.\nThe Microsoft authentication endpoint returns a JSON string which is similar to what you get when you use Invoke-WebRequest instead of Invoke-RestMethod in PowerShell.\n{\u0026ldquo;token_type\u0026rdquo;:\u0026ldquo;Bearer\u0026rdquo;,\u0026ldquo;expires_in\u0026rdquo;:3599,\u0026ldquo;ext_expires_in\u0026rdquo;:3599,\u0026ldquo;access_token\u0026rdquo;:\u0026ldquo;eyJ0eXAixboxOiJKV1QiLCJub25jZSI6ITUROWEtpblE4THcwNVN1Z1JMOU1aUUpwdXlqedasd1VpQXNjU3ciLseriesCJhbGciOiJSUzI1NiIsIng1dCI6IjJaUXBKM1VwYmpBWVhZR2FYRUpsOGxWMFRPSSIsImtpZCI6IXjJaUXBKM1VBWVhZR2FYRUp\u0026rdquo;}\nThis means that we‚Äôll have to get the value of both the keys ‚Äútoken_type‚Äù and ‚Äúaccess_token‚Äù.\nThe access token is now stored in the variables token_type (Bearer ) and access_token (Actual token) and available to use in this Shortcut and subsequent web requests. To see if it‚Äôs working, we‚Äôre just going to make a GET request and return some Azure AD Users.\nHere you can see that we use both variables to include the access token in the Authorization Header.\nBecause this is an OData query, the values will be stored in the value key. So we need to get the value of the value key one more time to see some results.\nOf course, this is just an example to prove that the authentication is working without an Azure Function or any PowerShell code. Everything is running on an iOS device. Receiving data from Graph on an iPhone is probably not what people want to use this for, but it was the easiest example.\nUsing Shortcuts to make http Post requests is much more interesting. Think about all the possibilities here for a second. We could basically do any Post request we want. And then, we can add Shortcuts to the iPhone Homescreen, ask Siri to run Shortcuts or even launch them from an Apple Watch. Amazing.\n","date":"2022-07-16T11:46:03.826Z","permalink":"https://heusser.pro/p/use-siri-shortcuts-to-make-microsoft-graph-requests-3804f80adbfa/","title":"Use Siri Shortcuts to make Microsoft Graph Requests"},{"content":"Hello everybody. I try my best to blog about new and unique Microsoft Teams related stuff at least once a month. If you‚Äôre new to my stories, feel free to check out my previous articles here.\nToday we‚Äôre going to take a look at something very cool. A few months ago, I wrote this little code snippet which lets you change a Teams user‚Äôs presence by using PowerShell and the Microsoft Graph API. The API endpoint is documented here. You might be asking yourself: why would we want to do this in the first place? Teams already updates our presence if we‚Äôre in a call, a meeting or just busy because of an Outlook appointment, right?\nUse Cases Setting the presence of a user can be very useful if for example not all your users are on Teams yet. Let‚Äôs say that we‚Äôve still got a legacy PBX system with SIP devices registered to it, but we use Teams for internal calls. There‚Äôs no way to know that a user is already on the phone unless the user specifically updates his status to Busy or Do not disturb. A user can‚Äôt set his own status to ‚ÄúIn a call‚Äù or ‚ÄúIn a meeting‚Äù though.\nIf we‚Äôre using an anynode SBC for example, we could implement a Route Supervision which calls an Azure Function, whenever a user receives or starts a call on a legacy PBX system. The Azure Function would then send an http POST request to the Graph API to change the presence status of the user.\nSince Microsoft has now released the SIP Gateway the need for such a solution has significantly decreased because the SIP Gateway already handles Teams presence out of the box. If you‚Äôre interested in learning more about the SIP Gateway for Teams, please check out this session from Commsverse from my colleague Thorsten Pickhan.\nWhat about other use¬†cases? I know, we all love Teams but sometimes we do need to use other calling and meeting apps such as Skype, Zoom, WhatsApp, or Discord. Don‚Äôt you just hate it that Teams doesn‚Äôt know when you‚Äôre already on a call in another app? Today, we‚Äôre going to change that!\nThe Power of¬†Siri If you have an iPhone or iPad you probably know about Siri Shortcuts and Automations. If you don‚Äôt know them already, I highly recommend checking them out. Shortcuts and automations are like local Power Automate Flows which are created and executed on your iOS device. Today I discovered that you can actually do http POST requests with Shortcuts. How cool is that?\nGranted, coding or building shortcuts is quite a hassle on such a small screen but there‚Äôs an easy workaround for that. We‚Äôre just using the Shortcut to call an Azure Function and let the Function do all the work for us.\nCreating an Azure AD App Registration First, we need an Azure AD App where we can grant the required permissions to set and clear the Teams presence. There‚Äôs an exceptional tutorial here. (I also used the example code to acquire the token from this website.)\n‚ÄúPresence.ReadWrite.All‚Äù is the permission we need.\nCreate an Azure¬†Function Next, we create an Azure Function. If you‚Äôre not familiar with Azure Functions, please read this article. The creating of a Function App and a Function is described under ‚ÄúCreate the Refresh Card Function‚Äù.\nCopy and paste the following code into your function. Populate the variables on lines 10‚Äì14 with your tenant specific information.\nCreate the Siri¬†Shortcut Now, we‚Äôll create a new Siri Shortcut. Choose ‚ÄúGet contents of URL‚Äù as your first action. Now go back to your Azure Function and copy its URL.\nPaste the URL into the Shortcut. I always use Sticky Notes to quickly synchronize text between my Windows PC and my iPhone.\nNext, expand the action by clicking on the circled arrow which points right. This will reveal additional options. Change the Method to POST and add a key and a value (Text) to the Request Body. I used ‚ÄúName‚Äù: ‚ÄúAzure‚Äù.\nThat‚Äôs it for the shortcut. You should now be able to run the shortcut. Every time you do so, your iOS device will call the Azure Function which will request a token and then set the defined user\u0026rsquo;s presence to In a Call.\nBy now, I hope you can understand why I didn‚Äôt bother to try and also build the authentication flow using only Shortcuts.\nBuilding the Siri Automation The last piece we need to do is to create an Automation which will trigger the Shortcut. Unfortunately, there aren‚Äôt as many triggers as I had wished but using ‚ÄúWhen an App is opened‚Äù does the trick, sort of.\nIn Shortcuts, switch from My Shortcuts to Automation on the bottom. Click + to create a new Automation. You want to create a Personal Automation.\nSelect ‚ÄúApp‚Äù as your trigger and then select one or multiple calling Apps.\nThen, add an action and search for ‚ÄúRun Shortcut‚Äù. Click on Shortcut and select the previously created Shortcut from the list.\nClick Next and then Done. Leave ‚ÄúAsk Before Running‚Äù enabled. This way you‚Äôll be asked if you want to update your Teams presence each time you open one of the selected Apps. If you‚Äôre not making a call, you can just ignore or close the notification banner.\nNow you‚Äôre all set. Every time you open one of your selected Apps (just Skype in my case) the automation will be triggered and ask you, if you want to set your Teams presence to In a call.\nIf you like, you can repeat all the steps and create another Function, Shortcut and Automation to clear the presence again, if you‚Äôre done with your call on the other App.\nIn this case, just replace line 42‚Äì51 with this code in the ‚ÄúClear Presence Function‚Äù and choose ‚ÄúWhen an App is closed‚Äù as the Siri Automation trigger.\n$Body = @\u0026quot;\n{\n\u0026ldquo;sessionId\u0026rdquo;: \u0026ldquo;bf3cbc08-e5b0-47bb-a4f0-89e3e3f7adac\u0026rdquo;,\n}\n\u0026ldquo;@\nInvoke-RestMethod -Method Post -Uri \u0026ldquo;https://graph.microsoft.com/v1.0/users/$UserId/presence/clearPresence\" -Headers $Header -Body $Body -ContentType \u0026ldquo;application/json\u0026rdquo;\nDemo Here you can see the Automation in Action. At first, the user‚Äôs Teams presence is ‚ÄúAvailable‚Äù. When Skype is opened, the Automation is triggered and confirmed by the user. When Teams is opened again, we can see that the status has changed from ‚ÄúAvailable‚Äù to ‚ÄúIn a call‚Äù. Because Skype was closed/minimized when Teams was opened, the second Automation, which clears the Teams presence again is triggered and allowed to run. This resets the Teams presence to its original state. Teams is closed and opened again to force a refresh of the presence.\nWhat‚Äôs cool is that this even works when you‚Äôre getting an incoming call in an App like Skype, WhatsApp etc. When you accept the call, the App is opened and thus triggers the automation. I can‚Äôt record that on video because iOS screen recording is stopped if an incoming call gets accepted and the notification does not show up, when screen sharing through AirPlay is active.\nBonus Because we now have Shortcuts to set our Teams presence to ‚ÄúIn a call‚Äù or clear the presence again, we can also use Siri to execute these Shortcuts. All we have to say is Hey Siri, followed by the name of the Shortcut. E.g. ‚ÄúHey Siri, Set Teams Presence‚Äù or ‚ÄúHey Siri, Clear Teams Presence‚Äù.\n","date":"2022-07-14T21:59:48.037Z","permalink":"https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/","title":"Set your Teams Status to In a Call when using other Calling \u0026 Meeting Apps on iOS"},{"content":"In this article, I did a pretty hefty run down of all things shared voicemail in Microsoft Teams. I also teased another article about creating a Power Automate Flow to deliver shared voicemails into a Teams channel instead of receiving them just by email.¬†‚Ä¶which brings us to this article.\nThe idea behind all that is, that shared voicemails get posted as an adaptive card in a Teams channel, rather than that a few individuals receive shared voicemails by email.\nPreparations First, we need to identify or create a Microsoft 365 Group which will be configured as shared voicemail target on an auto attendant or a call queue. Next, we‚Äôll need to enable the follow in inbox feature for this group and add a shared mailbox of choice to this M365 Group. (If you need help with this, please check the linked article at the beginning of this story.)\nBuilding the¬†Flow Then we can start building our flow. Choose ‚ÄúWhen a new email arrives in a shared mailbox (V2)‚Äù (Office 365 Outlook) as your trigger and select the mailbox and its folder. (If this shared mailbox also receives other messages, you might want to include a subject filter under advanced options.)\nNext, we‚Äôll need to initialize some variables.\nThe value of this variable is the phone number which left the voicemail. We can get the number by splitting the from address at the ‚Äú@‚Äù character and selecting the first value of the splitted string. This is done with the following expression.\nsplit(triggerOutputs()?[\u0026lsquo;body/from\u0026rsquo;], \u0026lsquo;@\u0026rsquo;)[0]\nTo avoid duplicate files, we will create a time stamp with this expression. (Adjust the name of the time zone to your own time zone. If you‚Äôre not sure how your time zone is called, just run ‚ÄúGet-TimeZone‚Äù in PowerShell and copy it‚Äôs Id.)\nconvertTimeZone(utcNow(),\u0026lsquo;UTC\u0026rsquo;,\u0026lsquo;W. Europe Standard Time\u0026rsquo;, \u0026lsquo;yyyy-MM-dd HH:mm:ss\u0026rsquo;)\nAnd in the end, we will convert the ‚Äú+‚Äù sign into an URL friendly format with this expression.\nreplace(variables(\u0026lsquo;FromNumber\u0026rsquo;), \u0026lsquo;+\u0026rsquo;, \u0026lsquo;%2b\u0026rsquo;)\nNow we have all the variables which we need. Choose ‚ÄúGet Attachment (V2)‚Äù (Outlook Office 365) as your next action. This will automatically add an ‚ÄúApply to each‚Äù loop for this action. Let‚Äôs fill in the dynamic content of the trigger output such as ‚ÄúMessage Id‚Äù and ‚ÄúAttachment Id‚Äù. To be sure that only voicemails are uploaded to SharePoint, I‚Äôve added a condition which checks if the attachments filename ends with *.mp3.\nIf it does, we‚Äôll save the file to SharePoint. If it doesn‚Äôt, we won‚Äôt do any further processing and the flow ends there. Notice how we‚Äôll use the previously initialized variables to construct a unique filename consisting of the received date and the caller‚Äôs number. Once the file has been saved, we‚Äôll create a share link to later access the file.\nAll that‚Äôs left to do now is to post an adaptive card to a channel and wait for a reply.\nPaste the following JSON object into your flow and replace the variables with your own names if needed.\n{\n\u0026ldquo;$schema\u0026rdquo;: \u0026ldquo;http://adaptivecards.io/schemas/adaptive-card.json\u0026rdquo;,\n\u0026ldquo;type\u0026rdquo;: \u0026ldquo;AdaptiveCard\u0026rdquo;,\n\u0026ldquo;version\u0026rdquo;: \u0026ldquo;1.3\u0026rdquo;,\n\u0026ldquo;body\u0026rdquo;: [\n{\n\u0026ldquo;type\u0026rdquo;: \u0026ldquo;TextBlock\u0026rdquo;,\n\u0026ldquo;text\u0026rdquo;: \u0026ldquo;@{triggerOutputs()?[\u0026lsquo;body/subject\u0026rsquo;]}\u0026rdquo;,\n\u0026ldquo;size\u0026rdquo;: \u0026ldquo;Large\u0026rdquo;\n},\n{\n\u0026ldquo;type\u0026rdquo;: \u0026ldquo;TextBlock\u0026rdquo;,\n\u0026ldquo;text\u0026rdquo;: \u0026ldquo;New Voicemail from @{variables(\u0026lsquo;FromNumber\u0026rsquo;)}\u0026rdquo;\n},\n{\n\u0026ldquo;type\u0026rdquo;: \u0026ldquo;ActionSet\u0026rdquo;,\n\u0026ldquo;actions\u0026rdquo;: [\n{\n\u0026ldquo;type\u0026rdquo;: \u0026ldquo;Action.OpenUrl\u0026rdquo;,\n\u0026ldquo;title\u0026rdquo;: \u0026ldquo;Listen to Voicemail Message\u0026rdquo;,\n\u0026ldquo;url\u0026rdquo;: \u0026ldquo;@{outputs(\u0026lsquo;Create_sharing_link_for_a_file_or_folder\u0026rsquo;)?[\u0026lsquo;body/link/webUrl\u0026rsquo;]}\u0026rdquo;\n}\n]\n},\n{\n\u0026ldquo;type\u0026rdquo;: \u0026ldquo;ActionSet\u0026rdquo;,\n\u0026ldquo;actions\u0026rdquo;: [\n{\n\u0026ldquo;type\u0026rdquo;: \u0026ldquo;Action.OpenUrl\u0026rdquo;,\n\u0026ldquo;title\u0026rdquo;: \u0026ldquo;@{variables(\u0026lsquo;FromNumber\u0026rsquo;)} Call Back\u0026rdquo;,\n\u0026ldquo;url\u0026rdquo;: \u0026ldquo;https://teams.microsoft.com/l/call/0/0?users=4:@{variables(\u0026lsquo;CallBackNumber\u0026rsquo;)}\u0026rdquo;\n},\n{\n\u0026ldquo;type\u0026rdquo;: \u0026ldquo;Action.Submit\u0026rdquo;,\n\u0026ldquo;title\u0026rdquo;: \u0026ldquo;Call Completed\u0026rdquo;,\n\u0026ldquo;style\u0026rdquo;: \u0026ldquo;positive\u0026rdquo;\n}\n]\n}\n]\n}\nThe Result Let‚Äôs see how this looks from a user\u0026rsquo;s perspective. Whenever a new shared voicemail is received in the shared mailbox, the Flow will be triggered and sends an adaptive card into the channel.\nAll Team members will know that a new voicemail has been received and they can listen to it by clicking the button.\nThis will open the SharePoint link and the media can be played back in the browser.\nUnfortunately, playing back media on adaptive cards is not yet supported in Teams.\nBecause we‚Äôve inserted a calling deep link on the adaptive card, users will also be able to initiate a call directly from the card.\nAnd finally, once the customer has been called back the adaptive card can be completed by clicking the ‚ÄúCall Completed‚Äù button. This will refresh the card and let all other channel members know, that there is no action needed from their side anymore. They will also be able to see, who completed the card.\nI really hope that media cards will soon be supported to provide an even better user experience in Teams.\nAs always, I hope that you liked my article and that it helps you too, deliver a better user experience.\n","date":"2022-06-05T21:06:42.33Z","permalink":"https://heusser.pro/p/microsoft-teams-handle-shared-voicemail-more-efficiently-746ddeae6ac4/","title":"Microsoft Teams: Handle Shared Voicemail More Efficiently"},{"content":"Hi everybody.\nEvery week more customers are moving to a Microsoft Teams based telephone solution. With that, customers also want more flexibility in managing their auto attendants and call queues. Many of my customers also want their team managers or members to be able to change certain settings of their auto attendants and call queues by themselves. The problem is that all these changes currently require an administrator role for Microsoft Teams. Even though most of the things can be configured in an easy-to-understand GUI in TAC (Teams Admin Center), a user could still potentially break stuff if they‚Äôre not 100% aware of what they‚Äôre doing. Furthermore, some changes are not as straight forward as they could be. As an example: There‚Äôs no switch to manually ‚Äúopen‚Äù or ‚Äúclose‚Äù an auto attendant since the default and after hours call flows are linked to a weekly recurrent schedule.\nWhile Teams is certainly lacking in this area, there‚Äôs no denying that the advantages of a Teams Phone solution far outweigh the disadvantages. Microsoft also offers numerous awesome tools to cope with this very issue by allowing us to automate nearly everything. And that ladies and gentlemen, is one of the most awesome and fascinating things to me!\nLet‚Äôs dive in.\nCredits and Inspiration This article is inspired by the work of two other fantastic community members and bloggers: MVPs Luca Vitali and Alexander Holmeset. Both have written articles on self-service auto attendant and call queue management using Microsoft automation tools.\nI don‚Äôt think that I would have been able to come up with a solution of my own without their exceptional blog posts. At least not this fast.\nTo fully understand this blog post, please make sure you read their publications first.\nThe Ever-Present Licensing Dilemma Alex‚Äôs solution uses a combination of Microsoft Forms, Power Automate and an Azure Runbook. However, to use an HTTP request either as a trigger or an action in a Flow, you need a premium license for Power Automate. I can understand that requirement from Microsofts business perspective, but such a basic feature shouldn‚Äôt require a premium license. Since I don‚Äôt have any premium licenses at the moment anyway, I looked for other ways.\nLuca‚Äôs method uses an outgoing webhook in Teams. It‚Äôs a great way to invoke a Bot or script directly from Teams. There‚Äôs no need to install any apps and you don‚Äôt even need to open a website or an App to change some settings on an auto attendant or a call queue.\nThe problem is that Teams can‚Äôt really handle the response sent back by the Runbook. This means that a user will always get an error message, even if the Runbook was triggered successfully. This might be very confusing for end users and just doesn‚Äôt look nice.\nAzure Functions Instead of calling the Azure Runbook directly from the outgoing Teams webhook, I tried to call an Azure Function first. Azure Functions are serverless web services which can execute code once they‚Äôre called by a trigger. Much like the Runbook in Luca‚Äôs blog, my Function is also triggered by a web request by the outgoing webhook.\nFrom what I could find on the internet, the webhook expects a reply in JSON format containing \u0026quot;type\u0026quot;: \u0026quot;message\u0026quot; and \u0026quot;text\u0026quot;: \u0026quot;some message\u0026quot;. I didn‚Äôt find a way to customize the response of the Runbook but it‚Äôs easy with an Azure Function. I will show you how later in this post.\nOverride Auto Attendant Business¬†Hours Let‚Äôs start with the example from the introduction of this article. Let‚Äôs assume that we have a small company where the users who answer the phone need to be able to manually open or close an auto attendant.\nNote: This part assumes that you already have the following components set up. If you don‚Äôt have them already, please refer to the external websites linked in this post in order to set them up.\nA Microsoft Teams Auto Attendant A Microsoft Teams Team An Azure Automation Account An Azure Function App Also, it might be a little confusing at first, because we‚Äôre creating each component from the opposite direction in which they are chained together. This way, we only have to touch each component once though.\nPrepare the Auto Attendant The easiest way I could think of is to create a special holiday for this scenario. I called it ‚ÄúManual Override‚Äù. The reason I did it in this way is that the actual business hours don‚Äôt get changed. If there were multiple hours per day or different hours each day, it would be quite an effort to revert all the changes once the manual override should no longer be active.\nTo start configuring it, head over to TAC and switch to Voice\\Holidays. Now create a new holiday and set the dates to anywhere in the past.\nNow go to your auto attendant and link the holiday schedule.\nMake sure you click ‚ÄúSubmit‚Äù after you have saved the holiday. Otherwise, the auto attendant won‚Äôt be updated.\nThat‚Äôs all you need to do in order to prepare your auto attendant for this self-service solution.\nLater in this post, I will provide an example script which will log into Teams PowerShell and change the dates of the ‚ÄúManual Override‚Äù Holiday. When an auto attendant should be open, the holiday schedule will be set to past dates. Past dates won‚Äôt have any effect on the auto attendants routing decisions and therefore the auto attendant\u0026rsquo;s business hours schedule will be active.\nWhen the auto attendant should be manually closed before the configured business hours end, the holiday schedule will be updated to start at today‚Äôs date and end at the start of tomorrow‚Äôs date.\nThis means that it‚Äôs possible to close the attendant if the office closes before the regular business hours on that day. If it‚Äôs not manually opened again, it will resume to normal business hours as soon as the next day starts.\nWhile it‚Äôs possible to close or open the attendant during business hours (e.g., extended lunch break), it‚Äôs not possible to extend the configured business hours using the method used by the provided example script.\nPrepare your Teams¬†Channel First, we will need an incoming webhook in a channel to receive messages in Teams. We will use this webhook to receive message cards sent by an Azure Function or by a Runbook.\nGo to your desired channel and click on ‚ÄúConnectors‚Äù.\nNow add an Incoming Webhook.\nAfter clicking ‚ÄúAdd‚Äù the second time, the window will close. Open ‚ÄúConnectors‚Äù again and click ‚ÄúConfigure‚Äù.\nGive your Connector a name and upload an Icon (if you want to) and then click ‚ÄúCreate‚Äù.\nAfter you have created the webhook, its URL for your connector will be shown. Copy the URL and save it for later.\nCreate an Azure¬†Runbook Let‚Äôs create the Runbook which will change the settings on our auto attendant. This script will log into Teams PowerShell and manipulate the holiday schedule called ‚ÄúManual Override‚Äù. Because only the schedule is changed, there‚Äôs not even a need to specify an auto attendant explicitly. You could even add the ‚ÄúManual Override‚Äù holiday schedule to all your auto attendants (which are in the same time zone) and open or close them all at once.\nIf you don‚Äôt have an Azure Automation Account already, you can read how to create one here or in Luca Vitali‚Äôs article under chapter 1.\nFrom within your Automation Account, click ‚ÄúCreate a runbook‚Äù.\nName your Runbook and choose the following settings.\nPaste the following code in the editing pane. Make sure to also insert your webhook URL on line 7 between the double quotes.\nFor this to work, we obviously need credentials which have the Teams Administrator Role. These are imported on line 17. If you need guidance on how to add them to your automation account, please refer to Luca Vitali‚Äôs article under chapter 3.\nOnce you have pasted the script and inserted your webhook URL, save and publish the Runbook.\nNext, we will add a webhook to the Runbook as well.\nYou can also read in detail how to configure the webhook on Luca‚Äôs blog.\nCopy the webhook URL of the Runbook and save it for later.\nCreate the Refresh Card¬†Function Next, we will create a new Azure Function. This Function will be called when a user clicks on the ‚ÄúSubmit Config‚Äù button on a card which was sent by the first Function (which will be created later). Besides triggering the Runbook, it will also update the card which was sent by the first Function.\nFor this, go to portal.azure.com and select Function App. If you don‚Äôt have an Azure Function App already, you need to create one first.\nOnce the Function App has been deployed you can create the function.\nChoose ‚ÄúHTTP trigger‚Äù as the template, name your function and leave the Authorization level at ‚ÄúFunction‚Äù.\nIn the editing pane, paste the following code. Insert the URL from the Runbook webhook on line 8 in between the double quotes.\nSave the Function and copy the Function URL by clicking ‚ÄúGet function URL‚Äù.\nNote: the URL will include a key at the end. Because we‚Äôve chosen ‚ÄúFunction‚Äù as the Authorization level when we created the function, it will only be possible to call the function by including the key in the URL.\nCreate the Request Card¬†Function Now we create the second Function. This is the Function which will be called from the outgoing webhook in Teams and sends the ‚ÄúConfig Change‚Äù Card to the channel. It‚Äôs actually the Function which will be called first.\nPaste the following code in the Azure Portal. Again, make sure to populate the variables on line 6 and 7. $uri represents the URL of your Teams incoming webhook and $refreshURI represents the URL of your ‚ÄúRefreshCard‚Äù Azure Function.\nDon‚Äôt forget to save the Function.\nCreate an Outgoing Webhook in¬†Teams Finally, we need to create an outgoing webhook in Teams. Users will be able to mention the webhook in the channel. Once the ‚ÄúBot‚Äù is mentioned, a web request will be made to the ‚ÄúRequestCard‚Äù Function.\nTo set it up, go to your Team‚Äôs settings and switch to the Apps tab. From there, click on ‚ÄúCreate an outgoing webhook‚Äù on the bottom right.\nName your outgoing webhook and paste the Function URL of the ‚ÄúRequestCard‚Äù Function in the ‚ÄúCallback URL‚Äù field before you click ‚ÄúCreate‚Äù.\nYou can ignore the security token which will be shown after the webhook has been created. If you like you can still save it somewhere safe.\nSee it in¬†Action Now that we have everything set up, any member of the channel can request a card to manually open or close an auto attendant.\nHere‚Äôs the ‚ÄúManual Override‚Äù Holiday Schedule before the config change has been submitted. Today, as of writing this article it‚Äôs the 17th of May 2022. The holiday schedule is set to 15.05.2022‚Äì16.052022 so it‚Äôs non-effective.\nAnd here‚Äôs the chronological process:\nA user requests a card by mentioning the outgoing webhook.\nThis will call our first ‚ÄúRequestCard‚Äù Azure Function. The Function will then reply with a message that the config change request has been received.\nAt the same time, the Function will also send a new card to the channel which contains the options to open or close the auto attendant and a ‚ÄúSubmit Config‚Äù button.\nNote: Unfortunately, it‚Äôs not possible to send the card as an answer to the invocation of the webhook. This answer can only support text.\nOnce a user has chosen an option and submitted the config change, the ‚ÄúRefreshCard‚Äù Function will be called.\nThis Function will update the ‚ÄúConfig Change Request‚Äù card, trigger the Runbook, and lets the user know that their config change request has been received.\nOnce the Runbook has finished, it will also post a new card to the channel, informing the user that the auto attendant has been opened or closed.\nIf we check the holiday schedule again, we can see that it has been updated and set from 17.05.2022 to 18.05.2022. This means that any calls which are received by the auto attendant today, go into the holiday call handling and not into the default call flow. Thus, this auto attendant is now closed.\nSummary This is a great proof of concept on how to build a self-service auto attendant or call queue solution which doesn‚Äôt require any Premium Licenses for Power Automate or Power Apps. Of course, Azure Functions and Runbooks are not free either but I‚Äôm almost certain that it will still be much cheaper at scale.\nFrom my point of view this is a great showcase of what one can achieve with Azure Automation. I also like that everything stays in Teams from an end user perspective. There‚Äôs no need to open any other website or App and even Teams mobile App experiences are supported.\nThis article only scatched the surface by covering only one example of endless possible scenarios. For example, it‚Äôs also possible to write an Azure Function in a way in which it can receive parameters from the outgoing webhook. Instead of just mentioning the webhook by ‚Äú@RequestCard‚Äù we could also mention it like this: ‚Äú@RequestCard CQ ‚Äù or ‚Äú@RequestCard AA‚Äù and then respond with a different config change card, one for each type of voice app or even different change scenarios. Or we could even do stuff like check the username from which the outgoing webhook was invoked and do a security filtering on it by only allowing certain users to submit changes to auto attendants or call queues. The sky really is the limit.\n","date":"2022-05-17T20:39:01.706Z","permalink":"https://heusser.pro/p/microsoft-teams-self-service-auto-attendants-without-premium-connectors-27e6f1281851/","title":"Microsoft Teams Self-Service Auto Attendants (Without Premium Connectors)"},{"content":"Shared Voicemail has been available in Teams Phone for quite some time now. I still thought that it would be helpful to do a proper write up.\nThe Basics A shared voicemail always has to be a Microsoft 365 Group. This group doesn‚Äôt need to be Teams enabled but it can be. As of the time of writing, I do not know of a way to forward a call straight to shared voicemail without configuring an auto attendant or a call queue in front of it.\nUpdate 27.01.2023\nAs it turns out, it‚Äôs now possible to also set Distribution Lists or Mail Enabled Security Groups as shared voicemail targets. I‚Äôve put together a new article about that here.\n/Update\nSkimping on¬†Licenses If Teams Phone Standard‚Ää‚Äî‚ÄäVirtual User Licenses are scarce in your tenant, this trick might help you out. Teams Unassigned Number treatments are usually used to handle incoming calls to numbers which are not assigned to any user or resource account. Since you specify the matching rule with a regular expression, it‚Äôs also possible to match whole numbers explicitly.\nAn Unassigned Number Treatment can only be configured to forward to a resource account or an announcement. It‚Äôs not possible to forward directly to a shared voicemail. If you match the whole number without any wildcards, it‚Äôs possible to forward external calls to a shared voicemail without assigning a Teams Phone Standard‚Ää‚Äî‚ÄäVirtual User License. However, an auto attendant or a call queue is still needed to forward the call to voicemail.\nBonus Tip for Unassigned Number Treatments: While it‚Äôs possible to play back an announcement without having to setup an auto attendant or a call queue, an announcement will only play back the call and not disconnect the call after the announcement has been played back. If you want to automatically disconnect the call after playing back a message, choose an auto attendant to play back your announcement.\nSetup Shared Voicemail I won‚Äôt go into the details on how to setup a complete auto attendant or a call queue in this article. This is only to show you where you would configure a redirection to a shared voicemail. Anywhere where you can choose a redirection target on an auto attendant or a call queue, you can choose to forward to shared voicemail. Remember, this has to be a Microsoft 365 Group.\nNow let‚Äôs see where shared voicemails land, once a customer has left a message.\nMicrosoft 365¬†Groups Shared voicemails are delivered to M365 Group‚Äôs inboxes, not to a channel email address or similar. A customer might tell you which users need to be able to receive and access these voicemails. Naturally, you start adding members to this group in M365 Admin or Azure AD.\nBased on my personal experience this usually results in two problems.\n1. Group inboxes are often neglected or completely forgotten by users, even though they‚Äôre visible and accessible in most Outlook clients. This can lead to potentially unhappy customers because their calls are never returned.\nMicrosoft 365 Groups offer various settings which can be configured. Some of these settings can only be configured after the group has been created.\nBy default, the ‚ÄúSend copies of team emails and events to team member‚Äôs inboxes‚Äù is disabled.\nThis means that emails to this group will not find it‚Äôs way to the member‚Äôs inboxes. Members have to open the group mailbox proactively.\nFrom a user‚Äôs perspective, their settings look like this. This is the default setting for new groups.\nSo, let‚Äôs head back to M365 Admin and change the setting for ‚ÄúSend copies of team emails and events to team member‚Äôs inboxes‚Äù.\nAfter a few seconds, this change will be reflected in the user‚Äôs mailbox settings as well.\nOf course, a user can always override his own settings by going into groups and clicking on settings.\nWhen I last tested this about 1‚Äì2 years ago, the setting would only apply to new members for the group. Already existing member‚Äôs settings were not changed. It seems like Microsoft has updated this behavior which is a very welcome change. However, disabling it again from M365 Admin doesn‚Äôt seem to also disable it for the group\u0026rsquo;s members again.\nThe equivalent PowerShell parameter for this setting is still called AutoSubscribeNewMembersand the official documentation says the following.\nThe AutoSubscribeNewMembers switch specifies whether to automatically subscribe new members that are added to the Microsoft 365 Group to conversations and calendar events. Only users that are added to the group after you enable this setting are automatically subscribed to the group.\nBased on my testing, setting it via PowerShell really does not enable ‚ÄúFollow in Inbox‚Äù for existing users. The setting is only enabled if it‚Äôs configured via the portal. If you disable, save and enable it again from the portal, existing members will be subscribed to all emails again.\nWhile that solves the problem of users missing voicemails because they‚Äôre lost in a group inbox, it introduces problem number two.\n2. When multiple people get an email with a voicemail message, coordination and clear communication within the team is key to prevent either multiple people calling back a customer or nobody at all calling back a customer.\nWhat about Shared Mailboxes? Can‚Äôt we just use a shared mailbox as a target for shared voicemail where we already have established routines, rules and shifts on who processes which messages on which days etc.?\nThe answer is both yeas and no. Technically no. At least can‚Äôt we choose a shared mailbox as voicemail target in Teams Admin Center. It is however possible to just add a shared mailbox as the only member of a M365 Group and enable ‚ÄúFollow in Inbox‚Äù for the group\u0026rsquo;s members. This way, all voicemails will be delivered to a shared mailbox and the group‚Äôs actual inbox can be completely ignored without feeling guilty at all.\nVoicemails in Teams¬†Client Personal Voicemails Let‚Äôs check out all the places a user can see voicemail notifications. Even though this article is focusing on shared voicemail, I‚Äôll start with personal voicemails for a complete overview.\nThe first thing you will probably notice when you get a new voicemail is the Teams feed notification which looks like this.\nOf course, you can also go to the Calls app and filter your history by ‚ÄúVoicemail‚Äù.\nYou can also find your voicemails as an *.mp3 attachment in your personal inbox.\nThe Teams client actually searches your inbox for emails which meet certain criteria to display them in the Teams Client. Unfortunately, I don‚Äôt know the exact criteria Teams is evaluating but I‚Äôve seen some cases where voicemails did not show up in a user\u0026rsquo;s Teams Client because an external anti-virus solution was scanning emails and manipulated the message headers before they were delivered into the user‚Äôs inboxes. That is definitely something to keep in mind if you‚Äôre facing similar issues.\nShared Voicemails The interesting part is that this also applies to shared voicemails. If a user has subscribed to receive all group emails in their inbox, the shared voicemail will also be delivered into the personal inbox of the user.\nAs you can see, the email received at 19:17 is a shared voicemail. The subject contains ‚ÄúGeteilte Voicemail‚Äù which means ‚ÄúShared Voicemail‚Äù in English and also includes the Name of the Call Queue on which the voicemail was received.\nIn this case, it‚Äôs indeed the name of a call queue or auto attendant and not the display name of the resource account associated with one of the afore mentioned voice apps.\nHere you can see that I have a call queue named ‚ÄúMS Test CQ‚Äù but the associated resource account is actually called ‚ÄúTeam Green CQ‚Äù.\nAnd here you can see that the subject shows the call queue‚Äôs name.\nBut let‚Äôs get back to Teams. The call history now shows both the personal and the shared voicemail in the user‚Äôs personal call history. There‚Äôs no indication whatsoever that the voicemail received at 19:17 is a shared one. The user can only get this information in Outlook.\nVoice Enabled¬†Channels Teams Channels can also be configured as ‚ÄúVoice Enabled Channels‚Äù, also known as ‚ÄúCollaborative Calling Channels‚Äù. A channel becomes voice enabled if a Team and a Channel are used as a call queue‚Äôs agent list.\nHere you can see that I‚Äôve selected the ‚ÄúGeneral‚Äù channel from the Team ‚ÄúCQ Agents Escalation‚Äù as the call queue‚Äôs agent list.\nVoice enabled channels are only visible/available on Desktop Clients. Web, mobile or desk phones are not supported yet. It‚Äôs important to mention that this has absolutely no impact on the delivery of call queue calls. Even if a channel is used for the agent list, mobile, web and desk phone clients can still receive calls from the call queue. They just won‚Äôt be able to see the ‚ÄúCalls‚Äù tab inside the channel.\nOn the Desktop Client, the ‚ÄúCalls‚Äù tab is added automatically when a channel is configured to receive calls. This tab cannot be added from the Teams Client itself. Assigning it to a call queue in TAC is the only way to do it.\nThe Calls Tab includes its own call history. Unfortunately, this is a bit misleading. The history will only show incoming calls which were answered by the signed in user. It doesn‚Äôt show missed calls on the queue at all.\nIf notifications about missed calls on call queues are essential to you, I suggest to take a look at the service I developed at my previous employer which does just that.\nIf we switch the filter to Voicemail, it gets even weirder. Here we can see the same shared voicemail from 19:17.\nNote that I‚Äôve set a different group as shared voicemail target than the Team which is configured as voice enabled channel. It seems that the Teams Client is evaluating all the M365 Groups which are configured on this particular call queue and whether or not the signed in user is a member of these groups. A call queue can have a maximum of two different voicemail targets. One for the overflow action and one for the timeout action.\nRight now, I‚Äôve only configured shared voicemail as the overflow action.\nSince the signed in user is a member of that group, the voicemails will show up in the voice enabled channel.\nIf I remove the shared voicemail target from the queue in TAC and refresh the Teams Client, the entry is gone.\nThis call queue also has shared voicemail configured for its timeout action. The M365 Group for voicemail on timeout is called ‚ÄúAxe Capital Reception Voicemail‚Äù.\nThe signed in user is not a member of this group yet, hence the voicemails in the group mailbox do not show up in the calls tab. I‚Äôve now added the user to this group as well and signed out and in again in Teams.\nSuddenly, the user sees a lot more shared voicemails in the calls tab because they have been fetched from the M365 Group ‚ÄúAxe Capital Reception Voicemail‚Äù. The list is now aggregated across both M365 Groups which are configured in the call queue and the user is a member of. As you can see, the first entry is still the shared voicemail from the ‚ÄúShared Voicemail Demo‚Äù group from 19:17.\nBest Practices These are my recommendations for most shared voicemail scenarios.\nCreate a new, dedicated M365 Group without a Team for shared voicemails. Make sure ‚ÄúSend copies of team emails and events to team member‚Äôs inboxes‚Äù is enabled. Add an existing or new shared mailbox as the group‚Äôs only member. Manage responsibilities of calling back or delegating through existing processes and staff for already existing shared mailboxes. By creating a new, dedicated group instead of using an existing group or Team we can make sure that this group only ever receives voicemail messages and prevent unwanted emails from making its way into the shared mailbox.\nIf you‚Äôre going to use voice enabled channels, also use the same Team as shared voicemail target. Otherwise, you need to make sure that all the Team‚Äôs members are also members of the M365 groups used for shared voicemail. Different users seeing different voicemails in their Calls tab will only create confusion among them. Unless of course you deliberately want only select members of the Team to see shared voicemails.\nAnother way of efficiently handling shared voicemails would be to set up a Power Automate Flow which triggers on new emails in a shared mailbox, saves the audio files to SharePoint and sends an adaptive card with the link to the mp3 file to a channel. I plan to do a separate post about that though.\nBonus Tips Even though call queues and auto attendants are quite similar, there are some differences which can be quite significant to some customers.\nVoicemail on an Auto Attendant When you configure shared voicemail on an auto attendant, there‚Äôs no option to configure the greeting for the voicemail itself. Instead, you configure the greeting one layer above, on the call flow.\nBy default, an auto attendant will play a ‚Äúsystem greeting‚Äù after your custom greeting has been played back or synthesized by the Azure Text-To-Speech service. The system greeting will sound like this:\nPlease leave a message after the tone. When you have finished, please hang up.\nYou can suppress the system greeting by enabling the toggle switch for ‚ÄúSkip voicemail system message‚Äù. Because the greeting is configured outside of the scope of the call routing options, this can be configured for both TTS and audio file greetings.\nVoicemail on a Call¬†Queue For call queues, this is slightly different. There is no option to suppress the system greeting. A call queue‚Äôs primary purpose is to route calls to agents so there are only routing options for overflow or timeout scenarios. This also means that there‚Äôs no option to configure a greeting inside the scope of an overflow or a timeout action.\nWhen you upload your own audio file, the system greeting is automatically suppressed by the call queue. There‚Äôs no option to enable it. (Why would you anyway?)\nIf you‚Äôre using a TTS greeting, there‚Äôs no option to disable it. In this case the system greeting is always played back after your custom TTS greeting.\nIf you absolutely need to have a TTS greeting but also need to suppress the system greeting your only options are to use Azure Cognitive Services to generate and upload an audio file from your TTS greeting or to create another auto attendant which will have the sole purpose of playing back the TTS greeting and then forward to shared voicemail.\nUpdate 06.04.2023\nSkip voicemail system message is now available in TAC. It now supports both audio files and TTS greetings. I don‚Äôt remember when exactly it was added but it was a long time ago since I already wrote about it in this article in December 2023.\n/Update\nOne Last¬†Caveat But there‚Äôs another catch I recently discovered with this approach. If an auto attendant forwards to shared voicemail, the caller will hear two different beeps before the message can be recorded.\nThe auto attendant will play back the greeting and then transfer the call to shared voicemail. The caller will hear one beep for the transfer and most likely starts to record the message while the call is still being transferred to shared voicemail. Once the transfer has been completed, there will be a second beep which sounds slightly different. This is the actual beep which will indicate that the recording has started. This can be quite confusing for both the caller and the callee. It‚Äôs possible that the first one or two seconds or so are cut off from the recording or that the caller gets confused and loses focus because his recording is interrupted by the second beep.\nTo mitigate this issue, the only workaround at the moment is to forward the call to a call queue which goes straight to voicemail by using an overflow threshold of 0. But keep in mind that you can‚Äôt use a TTS greeting if you also want to suppress the system greeting when using this method. This will, however, play back one beep for the transfer to the queue, play back your configured greeting on the queue and then play the second beep to indicate that the recording has started.\nEven though these seem like minor issues, I hope that Microsoft addresses them in a timely manner. I think that‚Äôs all I know about Teams Phone and Voicemail. I hope it helped you demystify some stuff.\n","date":"2022-05-07T20:16:33.829Z","permalink":"https://heusser.pro/p/everything-you-ever-wanted-to-know-about-microsoft-teams-phone-and-shared-voicemail-4df01cb28e24/","title":"Everything you ever wanted to know about Microsoft Teams Phone and Shared Voicemail"},{"content":"This will be a quick one. I promise. In another blog post I claimed, or rather said, that I don‚Äôt know of any other way to check if a Teams user is enterprise voice enabled via GUI than to try to add the user to a call queue.\nGUI Method¬†1 If you try to add a user which is not EV enabled to a call queue, TAC will show the following error message:\nGUI Method¬†2 When I wrote this, I totally forgot about the diagnostic tool which is built into the Microsoft 365 Admin Portals ‚ÄúSupport‚Äù section. If you click the following button on Microsoft Docs, you will be redirected to the self diagnostic test tool within the Admin Portal.\nYou can also use this direct link or type ‚ÄúDiag: Teams Dial Pad Missing‚Äù in the search field when opening a new request.\nYou will then see a field where you need to enter the username of the user you‚Äôd like to check. Click on ‚ÄúRun Tests‚Äù to run the diagnostics.\nThis will also check if the user is enterprise voice enabled and tell you if that‚Äôs not the case.\nIt doesn‚Äôt seem to also check the licenses properly because this user already has a Teams Phone Standard License, but EV is not enabled yet.\nIf we run the same test for a user which is EV enabled, the diagnostics come up empty which means that there are no issues / EV is indeed enabled.\nOther Cases The diagnostics tool can also help you discover other issues like check for not assigned phone numbers or voice routing policies.\nPowerShell Method Of course, there‚Äôs always PowerShell. To query the information we need, we can just run the following:\nGet-CsOnlineUser -Identity user@domain.com | Format-Table DisplayName, EnterpriseVoiceEnabled, OnlineVoiceRoutingPolicy, LineURI, FeatureTypes\nThis will tell us all the interesting information like if the user is EV enabled, if it has an online voice routing policy and what kind of feature types are supported.\nNote: Microsoft recently introduced the FeatureTypes attribute in the MicrosoftTeams PowerShell module. (I‚Äôm using 4.2.0 as of writing this article). This means that there‚Äôs no need to check for a valid license via other PowerShell Modules like MSOnline, AzureAD or Microsoft.Graph anymore.\nUsers which don‚Äôt have a Teams Phone Standard license assigned, won‚Äôt show ‚ÄúPhoneSystem‚Äù in their supported feature types.\nSummary I‚Äôd still wish that TAC would reflect somewhere if a user is EV enabled or not. But at least there are some workarounds to check if a user is EV enabled if PowerShell isn‚Äôt available at a given time for any reason.\nEven though this tool has been around for quite some time, I don‚Äôt think that many Teams Admins know about it. How about you, did you know that something like this existed?\n","date":"2022-04-18T15:00:30.645Z","permalink":"https://heusser.pro/p/microsoft-teams-enterprise-voice-diagnostic-tool-9e01dbde26a0/","title":"Microsoft Teams Enterprise Voice Diagnostic Tool"},{"content":"Hello friends.\nA few weeks ago, Microsoft made a lot of Teams admins happy by rolling out a new feature which allows admins to change (or view) a Teams user‚Äôs calling settings directly from the Teams admin center. Gone are the days were we admins needed to be delegates of users to change these kinds of settings.\nThose of you who know me a little better might know that I don‚Äôt have much experience with Skype for Business and thus only ever heard stories about SEFAUtil (secondary extension feature activation). From what I can see, this new feature is basically SEFAUtil for Teams.\nI won‚Äôt go into detail about the functionalities in TAC as these has been covered plenty by other community bloggers already. As it‚Äôs often the case, this functionality has been available with PowerShell before it has made its way to the TAC. But anyways, here‚Äôs how it looks like in TAC.\nI haven‚Äôt used it much yet but one time I urgently needed to change a user‚Äôs forwarding settings, TAC was repeatedly throwing errors at me. I had no choice than to fall back to PowerShell.\nReading User Calling Settings with PowerShell Of course, we can not only set them by PS but also read them:\nGet-CsUserCallingSettings -Identity user@domain.com\nSince I‚Äôve already done much more complex things by generating a diagram of huge Auto Attendant and Call Queue call flows, I figured why not leverage PowerShell to also draw diagrams from user calling settings?\nI must admit that it turned out a little more complex than I anticipated. During final testing, I generated a diagram for each possible scenario, and I counted no less than 64 different ways an enterprise voice enabled user can configure his calling settings. This also includes simultaneous and serial ring for call groups. At least I already had a lot of practice on how to structure the code and how to draw the diagrams.\nUser Calling Settings Diagram¬†Examples Here are some examples, including the corresponding Teams client settings.\nIn this example, ‚ÄúAlso ring‚Äù and ‚ÄúIf unanswered‚Äù are the same. Call group is the only forwarding target which supports this scenario.\nHere‚Äôs one where immediate forwarding is enabled:\nWhen immediately forwarding to delegates, an ‚ÄúIf unanswered target is required‚Äù. ‚ÄúDo nothing‚Äù is not available in this case.\nIn this case, only ‚ÄúAlso ring‚Äù is configured and ‚ÄúIf unanswered‚Äù is set to ‚ÄúDo nothing‚Äù.\nAnd here, ‚ÄúAlso ring‚Äù is set to ‚ÄúNo one else‚Äù but ‚ÄúIf unanswered‚Äù is set to an external phone number with a timeout of 50 seconds.\nIf you like, you can check out all the examples here.\nRender and Export Diagrams like a¬†Pro! Or you can head over to my GitHub Repo to clone it from there to try it for yourself. For now, the function is intended for standalone usage. Meaning, it‚Äôs not yet implemented into the M365 Call Flow Visualizer.\nOnce the repo is cloned, you can import the function by dot sourcing it in your terminal:\n. .\\Functions\\Get-TeamsUserCallFlow.ps1\nAfter that, you can just run the function by either using the -UserPrincipalName or the -UserId parameter where -UserId expects an Azure AD User Object Id from your tenant.\nGet-TeamsUserCallFlow -UserPrincipalName user@domain.com\nThere are a few parameters to play with. By default, the function will generate an SVG image of the diagram and opens it in your default browser by leveraging the mermaid.ink service. It will also save the diagram to.\\Output\\UserCallingSettings by default. You can change this by specifying the -CustomFilePath parameter.\nAlthough it has cost me a lot of time, I was finally able to pull off directly exporting an SVG image without using any additional, local dependencies. I‚Äôm doing this by encoding the diagram in Base64 and calling mermaid.ink. During testing I noticed that mermaid.ink is quite picky when it comes to these base 64 encoded URLs. At first, a lot of my diagrams failed due to illegal padding characters and so on. I believe that I was able to fix most of that. If any of your diagrams fail to render on mermaid ink, please let me know.\nCreate a Diagram for all your¬†users I‚Äôve also included an example of how to draw a diagram for each enabled user in your tenant. You can copy it from this gist or run it directly from the root of the cloned repo.\nSome Notes on Recursive User Calling¬†Settings I do not support recursive user calling settings in my first release. I‚Äôm not sure if there is a strong enough need for it too. I know that some teams like to forward calls to each other if they‚Äôre not available. It would certainly be handy for troubleshooting purposes as we could detect infinite forwarding loops created by users much faster. On the other hand, diagrams could get huge and hard to read. What do you think, should I work on recursive diagrams for a future release? Let me know!\nWhat‚Äôs next There are a couple of changes planned for this project. If you pay close attention, you can see that I already moved some functions like ‚ÄúConnect-M365CFV‚Äù out of the main script and import it by dot sourcing instead. Since the main script still has more than 3000 lines of code (including carriage returns) I‚Äôm planning to move most of the functions to separate files and dot source them as well.\nWhen I get the time, I will also implement user calling settings into the main script. As an example, a call flow which forwards calls to a user will then render like this.\nWhereas it currently ‚Äústops‚Äù at the users and looks like this:\nI will also try to do the same with SVG export as I did for the user calling settings. I‚Äôm not entirely sure it will work with super large diagrams though.\nI hope that you enjoy automatically drawing diagrams of your users calling settings as much as I do.\nHappy Easter everyone!\n","date":"2022-04-17T10:38:04.544Z","permalink":"https://heusser.pro/p/automatically-render-diagrams-of-teams-user-calling-settings-551d6b12b0a7/","title":"Automatically Render Diagrams of Teams User Calling Settings"},{"content":"The purpose of a call queue in Teams is to distribute incoming calls to multiple call agents. Every call queue stores its own ‚ÄúAgent List‚Äù which is basically just an array of Microsoft 365 users object Ids. Incoming Teams or PSTN calls are then distributed to the call queue‚Äôs agents. In this post, we‚Äôll take a look at the types of agent lists which are available and how to configure them. We‚Äôll also explore some useful tips how to cope with unexpected behavior during configuration.\nAgent List¬†Types There are three (or four, depending how you look at it) different ways of adding Agents to a queue\nDirect user assignments Users are assigned by display name and will be visible directly in a queue‚Äôs settings. This method is suitable for small teams because you can see who‚Äôs in the queue in TAC without checking the group members in M365 Admin or AAD. Since you can‚Äôt control the order agents will be added in when using a group or channel based agent list, direct assignments are crucial when your queue is using serial routing. You can add up to 20 agents individually.\n2. Group assignments\nWith group assignments, you can add up to 200 agents but you can‚Äôt control the order in which the agents are added. Thus, you can‚Äôt control the order in which the users are signaled by the queue when using serial routing either. Based on my testing, the order of the agent list will correspond to the order in which the users show up when viewing it in AAD. Although it might not be a common scenario, you can even add multiple groups to the list. All common group types are supported.\n3. Combination of direct and groups\nIf you want to use a group but still need to add other users which are not a member of this group, you can add them individually. Here I‚Äôve got a group called ‚ÄúCQ Agents 1‚Äù which has two members.\nI‚Äôve also added Mike and Bobby as individual agents. Of course. the queue will add Mike only once.\nUnfortunately, querying the queue‚Äôs agents only yields object Ids and no display names.\n(Get-CsCallQueue -Identity a11d15d3-79d8-4bd2-8a35-xxxxxxxxxxxx).Agents\nOutput:\nObjectId OptIn -------- ----- 76606d0b-4d28-4246-9c08-xxxxxxxxxxxx True This is Bobby's Object Id 9a7c1bb4-49db-40ee-9d05-xxxxxxxxxxxx True This is Mike's Object Id fa19b242-8bae-419d-a4eb-xxxxxxxxxxxx True This is Wendy's Object Id\rAs you can see, individually added agents will be first in the list, just like TAC is displaying it (individual agents above groups).\nI have now replaced the direct assignment of Mike with Wendy and placed her on top.\nWhen we query the agent list again, we can see that Wendy is on top now, even though she would be added last if we‚Äôre using just a group.\nObjectId OptIn -------- ----- fa19b242-8bae-419d-a4eb-xxxxxxxxxxxx True This is Wendy's Object Id 76606d0b-4d28-4246-9c08-xxxxxxxxxxxx True This is Bobby's Object Id 9a7c1bb4-49db-40ee-9d05-xxxxxxxxxxxx True This is Mike's Object Id\r4. Teams channel assignment\nThe third and last option is to use a Teams Channel. In this case, the group type obviously needs to be a Team. Private or shared channels are not supported. From an agent list perspective this method is the same as a group-based assignment, except that you can‚Äôt add individual members or multiple groups as well.\nSummary and¬†Caveats In order for a user to be added as an agent, Enterprise Voice must be enabled. Having a Teams Phone Standard license is not enough. Unfortunately, there‚Äôs no straightforward way of checking if EV is enabled in TAC.\nYou might think that the ‚ÄúPhone System‚Äù Column in Teams Users will tell you that but that‚Äôs actually just evaluating if the user is licensed for Teams Phone Standard. (I hope Microsoft updates the column name at some point‚Ä¶).\nWhen you try to add a user which is not EV enabled to a queue, TAC will throw an error message:\nThis is the only way I know of to check if a user is EV enabled or not through a GUI based tool. It‚Äôs easy in PS though:\nGet-CsOnlineUser -Identity bill@domain.com | ft DisplayName,FeatureTypes,EnterpriseVoiceEnabled\nAgain, having a Teams Phone service plan, does not mean EV is enabled by default. A user‚Äôs feature types can be read from the¬†.FeatureTypes attribute (Teams PS 4.x.x and later).\nDisplayName FeatureTypes EnterpriseVoiceEnabled ----------- ------------ ---------------------- Bill Stearn {PhoneSystem, Teams} False\rDoes this mean we can only add groups to an agent list if all the members are already EV enabled? Certainly not. In this case, only EV enabled members will be added to a queue but you won‚Äôt see any warnings or errors if your group contains users without EV.\nI‚Äôve added Bill to the ‚ÄúCQ Agents 1‚Äù group:\nLet‚Äôs check our queue again by storing it‚Äôs properties in the variable $cq:\n1 $cq = Get-CsCallQueue -Identity a11d15d3-79d8-4bd2-8a35-xxxxxxxxxxxx By accessing $cq.DistributionListsLastExpanded we can verify that the queue has indeed updated its agent list when we saved it.\nAs expected, the object Id of bill does not show up when we check $cq.Agents. I‚Äôve also removed the direct assignments, that‚Äôs why we only see two object Ids now.\nObjectId OptIn -------- ----- fa19b242-8bae-419d-a4eb-xxxxxxxxxxxx True That's Wendy's Object Id 9a7c1bb4-49db-40ee-9d05-xxxxxxxxxxxx True That's Mike's Object Id\rWhat‚Äôs interesting is that even though the direct assignments were removed, the queue remembered the specific order we defined using direct assignments before. Wendy is still above mike.\nNo matter in which way the agents are added, in the end, all EV enabled agents will always be stored in one single array on the queue‚Äôs properties in the ‚ÄúAgents‚Äù attribute.\nAgent List¬†Sync Now you know what types of agent lists you can have and how to configure them. Let‚Äôs talk about syncing agent lists. With direct assignments, it‚Äôs easy. Every time you add or remove an agent and save the queue, the agent list is updated immediately.\nIf you‚Äôre adding a group which already has a bunch of users in it, that‚Äôs no problem either. But what about if you add a Team or a group which does not have any members yet, or if you add new users to an existing group which is already linked to a queue?\nI created a new, empty Team called ‚ÄúPS Test CQ‚Äù and added it to the queue‚Äôs agent list. As expected, TAC now says that this queue has zero agents.\nSo, let‚Äôs head over to Teams and add some members. After a browser refresh, TAC still shows zero call agents. Let‚Äôs check again with PowerShell:\n(Get-CsCallQueue -Identity a11d15d3-79d8-4bd2-8a35-xxxxxxxxxxxx) | ft Name, DistributionListsLastExpanded, Agents\nAlthough the output at least tells us when the agent list was last synchronized, it also shows no agents:\nName DistributionListsLastExpanded Agents ---- ----------------------------- ------ PS Test CQ 04/10/2022 09:12:22 +00:00 {}\rI don‚Äôt know the exact interval Teams uses to sync call queue agent lists. But I‚Äôm guessing it checks every few hours or so. Is there a way to force a sync?\nForce Agent List Sync using¬†TAC If we‚Äôre doing it via TAC, we must change any value of the queue to be able to save it. Otherwise, the submit button will be greyed out.\nIf you want to do it via TAC, I recommend changing a non-critical value like up the overflow threshold value by 1 and submit.\nThis will submit the new configuration which will also update the agent list. Now our queue has 1 agent (the one we added to the Team earlier).\nTo minimize service impact, remember to revert the change back to its original value and submit again.\nSince TAC evaluates if you changed anything before you‚Äôre allowed to save the queue and you always have to save the queue twice to force a sync, this is a pretty cumbersome way to do it.\nForce Agent List Sync by PowerShell Update 05.04.2023\nI wrote a new function to make this even easier. Please check out this article.\nManage Microsoft Teams Call Queues with PowerShell (Force-Sync) | by martin heusser | Apr, 2023 | Medium\n/Update\nLuckily, PowerShell allows us to save queues, even if none of the values have changed. To test this, I‚Äôve added another EV enabled user to the Team.\nWith this little code snippet, we will get all our call queues and set the OverflowThreshold value to the exact same value which was returned by PowerShell.\nTo use Set-CsCallQueue we need to provide at least one property and a value which should be changed. But unlike TAC, PS doesn‚Äôt care if the new value is the same as the old value. Hence, we only need to touch each queue once.\nTip: If you only want to sync queues which have no agents at all, just change the first line to:\n$callQueues = Get-CsCallQueue | Where-Object {$_.Agents.Count -lt 1}\nAfter running this foreach loop, our queue now shows two agents, and all the other queues settings remain unchanged.\nAddendum There‚Äôs also a Cmdlet called ‚ÄúSync-CsOnlineApplicationInstance‚Äù. Microsoft says the following:\nUse the Sync-CsOnlineApplicationInstance cmdlet to sync the application instance from Azure Active Directory into Agent Provisioning Service.\nBased on my testing, this had no effect on a queue\u0026rsquo;s agent list. Since it‚Äôs also the only Cmdlet containing *Sync-Cs* in its name, I assume that there currently is no easier workaround as the one described by me in this blog post.\nI hope that this information is useful to you when planning and deploying Microsoft Teams Phone solutions. But most importantly, I hope that you don‚Äôt get chills when all your queues show up with no agents even though you long added the Team or group members!\n","date":"2022-04-10T10:13:53.911Z","permalink":"https://heusser.pro/p/microsoft-teams-call-queue-agent-lists-and-how-to-force-sync-them-ef8092090df0/","title":"Microsoft Teams Call Queue Agent Lists (And how to Force-Sync them)"},{"content":"This blog post is now obsolete. Microsoft has now added Outlook Contacts to Teams Desk Phones.\nOutlook Contacts finally do show up on Teams Desk Phones!\nOriginal Story Since the second generation of Teams certified desk phones have been released, many things have been improved. They‚Äôre now much faster and also got a lot of software updates. They still have one major flaw though. They‚Äôre only able to show your ‚Äúnative Teams contacts‚Äù instead of all contacts which are synchronized from Outlook to Teams.\nThis article states the following for a previous software update:\nContacts whose numbers are saved in Outlook will be available in the People section of the Teams phones with read-only access. You‚Äôll still need to manually dial the number\nNo matter what I tried, I was not able to get any contacts which are synchronized by Outlook to Teams to show up on my desk phone.\nLet‚Äôs take a look at our contacts in the Teams client. Contacts which have been added using the Teams clients can be edited. Contacts which have been synchronized by outlook, can‚Äôt. You can see that the three dots are greyed out on the first entry while they‚Äôre not on the second entry.\nOn my desk phone, I can‚Äôt see the first contact (synchronized one) anywhere.\nI‚Äôm still not sure what that quoted sentence above means but I have an idea. Since they specifically say that numbers must be dialed manually, I believe that what they actually mean is that if you have synchronized contacts from outlook, their names (instead of their number) will be displayed if a saved contact calls your desk phone.\nA quick test confirmed this hunch. I created a contact with my work and my mobile number. I purposely set my work number as mobile and my mobile number as home phone. When synchronizing contacts from Outlook to Teams, Teams will always use the mobile number for the number shown in its contact list. If you‚Äôd like to learn more about this, Mark Vale has a great article covering this over at the Commsverse Blog.\nHere you can see the Outlook contact.\nThe number which is declared as Mobile will be showed in the Teams client.\nIf we right-click the call icon, the other numbers from the Outlook contact will also show up.\nSo, when I used my mobile to call my desk phone, the name of the Outlook contact indeed showed up on the desk phone, even though that contact is not visible anywhere on the desk phone. This also means that despite Teams is only showing, or at least preferring the mobile number of an Outlook contact in the contact list, it will still use numbers which are hidden behind a right-click for display name lookups.\nThat‚Äôs why I assume that that‚Äôs what Microsoft actually meant by that vague statement.\nSynchronize Outlook Contacts to¬†Teams That‚Äôs nice and all but it still doesn‚Äôt let us select and call our contacts directly from our Teams desk phones. Depending on the number of contacts we need on our phone, manually adding them is not an option either.\nIf Alexander Holmeset is able to add contacts to a user\u0026rsquo;s speed dial list by using PowerShell, why not use his method to read all our local contacts from Outlook and add them as native Teams contacts?\nWith a little help from this article, I was able to get all the users local Outlook contacts and then add them to Teams programmatically.\nSince our contacts might have multiple number types like Business, Mobile, Home etc. stored in one object, but Teams contacts support only one number, the script will create one contact for each number type. The number type will then be added as a suffix enclosed in square brackets.\nTo reduce dependencies, I‚Äôm not using the AAD Internals modules to get the user token which is needed to add the contacts. I slightly modified the example from this post. Instead of requesting the token for the Call Queue Opt In / Opt Out service, we‚Äôre just requesting a token for normal access to the Teams Web Client. For this to work, you or another user needs to enter his credentials once the login prompt appears. You also need to specify your Teams region by Read-Host. In my case that‚Äôs ‚Äúemea‚Äù.\nThe Script The script will only add a contact to Teams, if the phone number or the name is not already saved to another Teams contact. It will only look for contacts stored in a user\u0026rsquo;s Contacts folder inside the personal mailbox.\nThe Result Once the script has done its work. We can see that we now have editable contacts in Teams for all our local Outlook contacts. The downside is that there now are multiple entries because of the different sources.\nThe upside is that a Teams contact will always take precedent over a synchronized contact for incoming call notifications. This means that you‚Äôll always see the number type a person is calling you from.\nAnd of course, the biggest upside is that you‚Äôll finally have the comfort to use your desk phone to quickly call a contact from the tips of your fingers without manually entering the number first.\nI hope that this script helps you improve the experience for your end users of Teams certified desk phones until Microsoft provides a better contact management solution.\n","date":"2022-04-07T21:44:54.479Z","permalink":"https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/","title":"Sync Local Outlook Contacts to a Teams Desk Phone"},{"content":"When it comes to Azure AD and licensing, we usually use Azure AD Groups to assign certain licenses to group members. It‚Äôs an effective way to assign different licenses to different teams within your organization. For example, you could have a group which assigns a Microsoft 365 E5 license to all the IT-Staff.\nIs there a need to do the opposite? Add all users who have a specific service plan assigned to an Azure AD group? Although this scenario might not be as common as the first one, there‚Äôs certainly a use case for it.\nThink about a Teams call queue in a small to mid-sized firm which distributes incoming calls to, let‚Äôs say 5‚Äì10 call agents. If none of these agents are able to answer the call within a certain time, the call is then escalated to a second call queue which contains all the company‚Äôs Teams Phone Standard enabled users. A call queue can have up to two hundred call agents, if they‚Äôre added via a Teams Channel or a group.\nInstead of adding all phone enabled users manually we can create an Azure AD group which uses a dynamic query to include all users which have the service plan ‚ÄúMCOEV‚Äù assigned.\nHere‚Äôs how to do¬†it First, head over to portal.azure.com and go to Azure AD, Groups. Then click New group.\nYou can choose between a Microsoft 365 Group or a Security Group. For the Membership type, choose Dynamic User and then Add dynamic query.\nClick the Edit button on Rule syntax.\nNow enter the following query and click OK.\nUSER.ASSIGNEDPLANS -ANY (ASSIGNEDPLAN.SERVICEPLANID -EQ \u0026ldquo;4828c8ec-dc2e-4779-b502-87ac9ce28ab7\u0026rdquo; -AND ASSIGNEDPLAN.CAPABILITYSTATUS -EQ \u0026ldquo;ENABLED\u0026rdquo;)\nThe Id we are querying is the Id for the service plan ‚ÄúMCOEV‚Äù which can be seen here. Since we‚Äôre looking for the service plan Id, it doesn‚Äôt matter if the license is assigned to a user via the Teams Phone Standard add-on, E5 or even Common Area Phone SKU. With the second part of the query (-AND) we‚Äôre also making sure, that we‚Äôre only including users where the service plan is actually enabled.\nClick Save.\nAnd finally, click Create.\nIt will take a while until all the members have been added. We can check if our rule works by clicking on Dynamic membership rules and navigating to Validate Rules (preview). Let‚Äôs add some users and check if they meet the criteria.\nBy clicking View details we can examine the query and see exactly why a user will be included or not.\nHere‚Äôs an example of a user where the service plan is assigned and also enabled.\nThe user Bill has a Teams Phone Standard License but won‚Äôt be added to the group because the service plan is disabled.\nNow you can use this group to assign it to a call queue. Whenever you license newly created users for the service plan MCOEV, the agent list of the call queue will automatically be updated. From my experience it can take some time until the agent lists of call queues are updated if you‚Äôre using group or channel assignments. I will write another article on how to force an agent list sync for call queues which use group assignments. So stay tuned!\n","date":"2022-03-28T15:01:16.714Z","permalink":"https://heusser.pro/p/create-a-dynamic-azure-ad-group-with-all-teams-phone-standard-licensed-users-3a4194284739/","title":"Create a Dynamic Azure AD Group with all Teams Phone Standard Licensed Users"},{"content":"This is an interesting one. First of all, let‚Äôs give credits where they‚Äôre due. This blog post is inspired by this post by the great Alexander Holmeset.\nThe PowerShell code to generate the TOTP is forked from this repo. And the code from this repo is from this gist.\nThe code to create the interactive sign in window and to get the token is based of this example.\nDisclaimer Before we get into it, I should probably add a disclaimer that this is a proof of concept, at best. You should not use it in production as it uses some bad security practices (like sharing a user\u0026rsquo;s password). For real. Don‚Äôt say I didn‚Äôt warn you.\nWhat‚Äôs this about¬†again? However, being able to remotely change the opt in status of call queue agents seems to be quite a big ask from several Microsoft Teams admins and customers, so I decided to publish this piece anyway.\nChanging opt in status as a¬†user Can the opt in status of a user be changed as an admin? The answer is both yes and no. You can‚Äôt do it in any delegated way if that‚Äôs what you‚Äôre asking. You will need the user‚Äôs credentials.\nIf you‚Äôre a Teams User which is also a call queue agent, there are numerous ways to change your own opt in status for call queues. That is, if your admin allows opting out of queues of course. Let‚Äôs go through them.\nFrom Teams Desktop Client Settings From a Teams Voice Enabled Channel From Teams Web Client Settings From Teams Certified Desk Phones From Teams Mobile Apps (Android / iOS) From the good old https://aka.ms/cqsettings I‚Äôm an Admin, why can‚Äôt I change the damn opt in¬†status? From a Teams PowerShell session, we can only view the opt in status of a queue‚Äôs agents but not change it.\n(Get-CsCallQueue -Identity xxxxxxxx-f74b-46bb-9743-xxxxxxxxxxxx).Agents\nThis will spit out something like this.\nObjectId OptIn\n-\u0026mdash;\u0026mdash;- \u0026mdash;\u0026ndash;\nxxxxxxxx-4d28-4246-9c08-xxxxxxxxxxxx True\nxxxxxxxx-8bae-419d-a4eb-xxxxxxxxxxxx True\nxxxxxxxx-49db-40ee-9d05-xxxxxxxxxxxx False\nEvery attempt to change the returned PowerShell object failed. Miserably.\nHow can we at least do it as the user, but remotely? Similar to Alex‚Äôs approach of creating Teams Contacts from CLI we also have to acquire a user token to be able to change the opt in status of a user by CLI.\nIn his scenario, he‚Äôs mainly thinking about new users or even accounts which are used to sign into common area phones which might not be MFA enabled yet. In our case this might look different because we want to be able to alter the opt in state of already working staff.\nAt first, I also tried to use the AAD Internals PowerShell Module to receive a user token. In this case, however, it turned out to be much more complicated. When a user opens the Calls settings page in Teams, another token is requested from a different issuing service than the one which is used to access all the other features in Teams.\nAfter a long night of googling and binging (yes, I was this desperate) I finally was able to get a working token by modifying the example from the Docs Q\u0026amp;A which is linked in the intro of this article.\nPrerequisites Let‚Äôs get one thing straight. This approach ONLY works if you know the password of the user and / or the user agrees to share their password or even an MFA secret with you.\nI‚Äôm thinking of the following scenario: we want to be able to automatically and remotely opt in and opt out agents of call queues based on various criteria such as working schedules etc.\nTo have at least some kind of security, my script is encrypting the password and the MFA secret before it‚Äôs saved to the disk. Once they‚Äôre encrypted, they can only be decrypted by the same user account and the same Windows system which was used to encrypt them.\nWhy do we need to save the password to disk, when it‚Äôs an interactive login process anyway? Well, if you want to automate it by any means, we can use SendKeys to emulate a user\u0026rsquo;s keystrokes. To be completely honest, I only went so far because I wanted to see for myself if I can get it working‚Ä¶\nHow the script¬†works The script needs a few parameters to work. We need to provide a user principal name, a user object Id and a call queue Id.\nIt will then check the current directory for two or three files depending on whether the -MFA switch is used.\nYou will be prompted to enter the password and the MFA secret if these files do not already exist. The token will be saved to a file once you‚Äôve successfully logged in and acquired one. If the token is expired (happens every few hours or so), you will be prompted for credentials again and the token inside the file will be replaced with the new one. Since we also saved the password to disk, you do not need to enter the password again. The script will decrypt and enter the password by emulating automated keystrokes automatically.\nScript modes The script features a -QueryStatusOnly switch, which will only check if the user is opted in or out of a queue. This will not change anything.\nFor the sake of simplicity, I‚Äôve already stored the values of $UserId, $CallQueueId and $UserName as default values for the parameters. Of course, you can pass your own values if you call the script yourself.\nIn this video, you can see how the username and password are automatically entered, which will ultimately get us the token we need to call the API and query the user‚Äôs opt in status.\nIf we run the same thing again, we will already have a valid token.\nNow let‚Äôs take a look at an MFA enabled user. For this, we use the optional -MFA switch. Besides the password, this will also prompt us for the MFA secret. The script then pulls down the PowerShell Script from GitHub and uses it‚Äôs code to do some magic and generate the TOTP from the secret.\nOk‚Ää‚Äî‚ÄäBut how do we opt a user¬†out!? Since we can already see the opt in status of members either in Voice Enabled Channels or via PowerShell this is nothing new. Let‚Äôs opt a user out already!\nScript Here‚Äôs the script. Please notice that sometimes, activating the AAD Login Window does not always work, so you might have to cancel and run it again. For me, it usually worked the second time I ran the script.\nHere‚Äôs an example of running the script with parameters.\n1 .\\CallQueueOptInOptOutGist.ps1 -UserId \u0026#34;xxxxxxxx-8bae-419d-a4eb-xxxxxxxxxxxx\u0026#34; -UserName \u0026#34;user@domain.com\u0026#34; -CallQueueId \u0026#34;xxxxxxxx-f74b-46bb-9743-xxxxxxxxxxxx\u0026#34; -Action OptOut Conclusion Even though this method uses some real dirty tricks it still get‚Äôs the job done. Well, kind of, at least. I really hope that Microsoft will add the functionality to allow Queue managers to remotely opt in or opt out their agents in a more practical way. It‚Äôs a real pity that not even the new Set-CsUserCallingSettings or the Boss/Admin feature can do this!\n","date":"2022-03-24T21:10:13.471Z","permalink":"https://heusser.pro/p/opt-in-or-opt-out-teams-call-queue-agents-remotely-59fe6147f50d/","title":"Opt In or Opt Out Teams Call Queue Agents Remotely"},{"content":"Creating links for phone numbers on a desktop operating system is easy. Just like mailto: links, Windows PCs have link handlers for callto: or tel: URLs. These kinds of links are often found on websites or google search results and provide great convenience because a user just has to click a link to start dialing.\nEven though there are many different protocols, the most popular ones are:\ncallto:\ntel:\nIf you haven‚Äôt already configured a default App for calling on Windows, you‚Äôll be prompted to choose an app for calling links.\nAnd that‚Äôs it. Next time you click on a phone number link, your PC will automatically use Teams to make the call.\nUsing Deep Links on Mobile¬†Phones Mobile operating systems are a different story. Because they are very restricted in terms of customization, clicking on a callto: or tel: link will most likely start a call using your mobile number/network‚Ää‚Äî‚Ääwhich makes total sense.\nBut what if you have a business application or an internal website and would like your users to initiate calls using their business number configured in Microsoft Teams instead of their mobile number?\nIt‚Äôs definitely possible but it requires a bit of work. To be specific, to achieve this, we need a specific deep link. But what are deep links?\nBasically, they are just links followed by some application specific stuff which will not only open the App but also start an action inside said App. For example, we can use a deep link to open a specific channel or even a tab inside a channel in Teams.\nThis Microsoft Docs Article provides a detailed overview of all available deep links for Teams. As you can see, there are also deep links to initiate call actions within Teams.\nIf you want a link which will launch Teams and start a PSTN call, you need to create the link like this. The most important part is the ‚Äú4;‚Äù placed just before the phone number. This will tell Teams to call a PSTN participant.\nhttps://teams.microsoft.com/l/call/0/0?users=,4:\nThe part of the URL is actually optional. So a real world example would look something like this.\nhttps://teams.microsoft.com/l/call/0/0?users=4:+448719762819\nSince this is a simple URL, we can also prettify the link by giving it a title.\nCall Speaking Clock via Teams\nThis will start a call to a UK Speaking Clock. If you‚Äôre already using Teams Telephony you can try this by yourself. This link works on desktop and mobile devices. (Beware of the costs though! According to the site linked above, calls to this number cost 13p (Pence) per minute. If you‚Äôre calling from outside the UK, the cost may vary.) If you want to test this with a local number instead, just copy the URL and change the phone number.\nExample Gifs To finish off, here are some Gifs of how it looks on an iPhone and an Android device.\nClicking a Teams calling deep link from within the app on Android.\nClicking a Teams calling deep link from within the app on iOS.\nClicking a Teams calling deep link from another App/Website on Android (works on iOS too.)\nUpdate When launching a deep link starting with https:// as demonstrated above, it will always open your default browser, before the Teams App is launched. Unless, you‚Äôre clicking the deep link from within Teams as shown in the first two Gifs.\nTwitter User pilzi was kind enough to share some additional info. By adding the prefix msteams:// in front of the URL, we can open calling deep links directly in the Teams App without opening the browser first. It seems like the msteams:// URI scheme doesn‚Äôt like + signs though. We need to write the plus sign as ‚Äú%2b‚Äù for it to work.\nmsteams://teams.microsoft.com/l/call/0/0?users=4:%2b448719762819\nThanks again for the tip!\n","date":"2022-03-15T21:51:21.98Z","permalink":"https://heusser.pro/p/creating-microsoft-teams-calling-deep-links-f7c9d62eacdd/","title":"Creating Microsoft Teams Calling Deep Links"},{"content":"Analyzing PSTN usage reports in Teams Admin Center is a good start to troubleshoot issues with Direct Routing calls in Teams. You can either view the report directly in the browser or export it into a CSV file.\nTo access this report, head over to https://admin.teams.microsoft.com/ and click Usage reports under Analytics \u0026amp; Reports. Next, choose PSTN and SMS (preview) usage and select a date range. Finally, click on Run report.\nIt will default to Calling plans/SMS so you need to switch the tab to Direct Routing.\nViewing the logs in the browser is good enough if you just need to take a quick look at some calls. For example, you can quickly identify issues if you sort by the column Failure time (UTC). But keep in mind that cancelled calls are also shown as errors, as these are terminated with the SIP error code 487 (busy here). A duration of zero is also an indicator for failed calls.\nBesides obvious stuff like the display name, callee and caller numbers, the SIP address, or the call direction/type, you can also see which Direct Routing gateway and which Azure region for media or signaling was used.\nIf you need to take a deeper look at your call logs, it‚Äôs probably best to download the report as a CSV file. To do that, just click the Excel Icon in the upper right corner as shown in the first screenshot.\nOnce the report has been generated, it will trigger a download of a Zip file. Depending on your setup, the Zip file might also contain a CSV file for Calling Plans. I‚Äôm only interested in Direct Routing calls at the moment, so let‚Äôs open that file in Excel. It gives us all call records in the specified date range as comma separated values. But they are all in the same column, which is pretty useless until they‚Äôre formatted correctly.\nFor some reason, Excel always shows a warning, that there‚Äôs already data here, when I try to use the Text to Columns feature. Despite this warning, I‚Äôm still able to read the logs once the columns are separated.\nSince I don‚Äôt want to take the risk of missing important information in the logs, I wrote this handy PowerShell one-liner to convert the CSV file into a more human readable CSV file. This also saves me the time to turn text into columns first.\nJust fire up PowerShell or Windows Terminal by entering powershell or wt directly into the File Explorer‚Äôs address bar.\nThis will open PowerShell in the current directory. Now all you have to do is to paste this code.\nThis will read the original CSV, into a PowerShell object and export it to a new CSV file called ‚ÄúdrExport.csv‚Äù where the columns are already separated.\nI hope this little Gist also helps you formatting your logs a little quicker.\n","date":"2022-03-11T23:52:10.224Z","permalink":"https://heusser.pro/p/how-to-read-format-microsoft-teams-pstn-call-reports-3b0e56c422a2/","title":"How To Read/Format Microsoft Teams PSTN Call Reports"},{"content":"I am very pleased to announce version 2 of my ‚ÄúMicrosoft 365 Call Flow Visualizer‚Äù Script. Those who follow me on Twitter, might have already seen a glimpse of what I‚Äôve been working on in my spare time for the past few months.\nWhat am I talking¬†about? At work, I build or configure Microsoft Teams call flows almost daily. Even though the Teams Admin Center provides an easy-to-use graphical user interface to set up auto attendants and call queues, the solutions are not always that straight forward. If you‚Äôre creating your very first call flow, chances are that you will start by creating an auto attendant. Why wouldn‚Äôt you, it‚Äôs where the call first hits your system, isn‚Äôt it? Later on, you discover that you can‚Äôt even configure the most basic call flow, because you have not created your target call queue yet.\nLiving in a fast paced¬†world What if three months down the road somebody from the office or a customer asks you how their main number handles incoming calls? Are you still able to answer that without logging into the Teams Admin Center and clicking through all the nested auto attendants and call queues?\nThey probably want to know things like how long does it ring before a call is transferred? Where is it transferred to? And which users are configured to answer calls? Just to name a few. If you manage a lot of customers, or work for a large organization with dozens of call queues, answering these kinds of questions can cost quite some time and resources.\nWhat if I told you that you could just run a script which will render a diagram containing your call flows automatically? Would that be something you might be interested in? (Shout out to all the Entourage fans out there.)\nFinding inspiration in Microsoft Docs docs.microsoft.com is arguably one of the best product documentation sites on the web. Of course, that can differ from product to product but overall, it‚Äôs a very solid approach to documentation. When docs.microsoft.com was introduced in 2016 Microsoft even said that eye tracking studies have shown that content with a fixed width is easier to read. This really got my attention and made me believe that Microsoft has put some real effort into creating their product documentations.\nI am by no means a professional developer. I didn‚Äôt even really know what Markdown is at that time. After doing some research I quickly understood that all or most of their documentation content is based on Markdown files which are hosted on GitHub and rendered into a website.\nI started to pay attention and noticed that many other companies, like Bitwarden, my favorite password manager, also use Markdown based documentation websites. This underlined my hunch that Markdown based docs are the real deal.\nNo more confusing file versions, people creating and changing their own versions of documentations without telling anyone and so forth. With a Markdown based documentation solution, everything is stored in a central repository and every change is tracked with GIT. I need this too. But how do they do it?\nAnother quick research session led me to DocFx, a static website generator for Markdown files maintained by the¬†.NET team. After some tweaks here and there, my documentation site was already up and running.\nLazy is the new¬†smart Nobody likes writing documentations. Including me. But what if I could start to write some PowerShell scripts which will automatically retrieve specific information about a Microsoft 365 tenant and save it to Markdown files? Basically, let the scripts do the work for me? What at first was a proof of concept quickly turned into a full-fledged documentation website containing all sorts of data.\nOne tool down, two to¬†go With DocFx I was able to automatically structure and render information into a user friendly and comprehensible website. Next up are diagrams. I hate fiddling around with diagram drawing tools. Creating links between nodes, rearranging, and resizing shapes etc. can be a really frustrating and time-consuming chore. Once again, I searched the web for a tool or a technology which can render diagrams from code. That‚Äôs when I discovered Mermaid. Mermaid uses JavaScript to render diagrams and flow charts from code. The learning curve was quite big at first. I probably would have been faster if I had just drawn a call flow diagram in Visio. But since Mermaid also offers an excellent live editor, I essentially got the hang of it. Now I can create diagrams a hundred times faster and without the hassle of manually drawing them.\nThe final¬†piece The final step of my vision was to connect all the dots. Use PowerShell to read call flows from Microsoft Teams, save them to markdown files and generate a website which will display said call flows. Of course, all of this should happen automatically and update the contents of the website on a schedule. I‚Äôve got everything I need to achieve this except the tool to generate the flow charts.\nFor this one, I was sure that there‚Äôs no off the shelf solution. So I started writing some PowerShell code to get all the details needed in order to display a call flow. This was a mere proof of concept at first too. I soon discovered that this project would be much more complex than initially anticipated. But I just kept on coding, experimenting, and adding stuff to my script. After a few weeks of working on this project on weekends and evenings I published a first version of my script on GitHub.\nThe challenges kept on¬†coming Even though you can only create two different types of voice apps in Teams, the number of possibilities how they might be connected to each other seem limitless. I quickly realized that I will never achieve my goal with the current version. So, I started working on an updated version.\nLearnings I started learning PowerShell about three years ago. Since then, I‚Äôve created numerous smaller and larger scripts to automate things. But I‚Äôve never even attempted to write something as big and complex as this. Nor had I used functions a lot. Nevertheless, this feels like I was able to put almost everything I learned about PowerShell in the last years to good use. Once I realized that the script needs to be much more flexible and dynamic, I started to divide my first version of the script into separate functions. Even then, I hit several dead ends and had to rewrite a lot of the code.\nEven though it was a lot of work and I‚Äôm sure that it‚Äôs not the most efficient or clean code you will find on GitHub, I still learned a lot during the development of my tool. The most important part of this story is that you don‚Äôt necessarily have to be a pro dev to create something like this. We live in a world full of developers who create awesome tools, frameworks, or other technologies every day. Sometimes it‚Äôs just about vision, determination and being able to understand how different technologies can work together.\nI‚Äôm very proud of what I achieved and super happy with the result. Feel free to head over to GitHub and give the M365 Call Flow Visualizer a spin. I hope that you like what I‚Äôve done and that you may find it useful. Please contact me on Twitter if you have any questions or feedback.\n","date":"2022-01-04T20:50:28.102Z","permalink":"https://heusser.pro/p/automatically-render-microsoft-teams-call-flow-diagrams-607b89df4154/","title":"Automatically render Microsoft Teams Call Flow Diagrams"}]