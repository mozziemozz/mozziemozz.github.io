<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="\nUpdate 08.04.2023\nIâ€™ve updated this solution to V2 which includes the capability to assign, unassign and reserve phone numbers along with other improvements.\nPlease read this article when you have finished reading this one.\n/Update\nEvery Teams Voice Admin that has deployed Direct Routing knows the struggle. Thereâ€™s no way to manage Direct Routing numbers in Teams Admin Center. This makes it hard for us to get a clear overview of which numbers are still unassigned/free or even to see all the numbers we have.\n">
<title>Teams Phone Number Management on a Budget</title>

<link rel='canonical' href='https://heusser.pro/p/teams-phone-number-management-on-a-budget-e25d53f65caf/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="Teams Phone Number Management on a Budget">
<meta property='og:description' content="\nUpdate 08.04.2023\nIâ€™ve updated this solution to V2 which includes the capability to assign, unassign and reserve phone numbers along with other improvements.\nPlease read this article when you have finished reading this one.\n/Update\nEvery Teams Voice Admin that has deployed Direct Routing knows the struggle. Thereâ€™s no way to manage Direct Routing numbers in Teams Admin Center. This makes it hard for us to get a clear overview of which numbers are still unassigned/free or even to see all the numbers we have.\n">
<meta property='og:url' content='https://heusser.pro/p/teams-phone-number-management-on-a-budget-e25d53f65caf/'>
<meta property='og:site_name' content='HEUSSER.PRO'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2023-03-23T13:05:11&#43;00:00'/><meta property='article:modified_time' content='2023-03-23T13:05:11&#43;00:00'/>
<meta name="twitter:title" content="Teams Phone Number Management on a Budget">
<meta name="twitter:description" content="\nUpdate 08.04.2023\nIâ€™ve updated this solution to V2 which includes the capability to assign, unassign and reserve phone numbers along with other improvements.\nPlease read this article when you have finished reading this one.\n/Update\nEvery Teams Voice Admin that has deployed Direct Routing knows the struggle. Thereâ€™s no way to manage Direct Routing numbers in Teams Admin Center. This makes it hard for us to get a clear overview of which numbers are still unassigned/free or even to see all the numbers we have.\n">
    <link rel="shortcut icon" href="/favicon.png" />

    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "kozb6q2xjn");
    </script>

    <script id="cookieyes" type="text/javascript" src="https://cdn-cookieyes.com/client_data/322026ee4ec1c733948748bc/script.js"></script>

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_fe2816fc44d850d2.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ðŸ«¡</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">HEUSSER.PRO</a></h1>
            <h2 class="site-description">Martin Heusser | M365 MVP</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/mozziemozz'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://x.com/@mozzeph'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about-me/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About Me</span>
            </a>
        </li>
        
        
        <li >
            <a href='/advertise/' >
                
                
                
                    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-device-desktop-dollar"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M13 16h-9a1 1 0 0 1 -1 -1v-10a1 1 0 0 1 1 -1h16a1 1 0 0 1 1 1v5.5" /><path d="M7 20h6.5" /><path d="M9 16v4" /><path d="M21 15h-2.5a1.5 1.5 0 0 0 0 3h1a1.5 1.5 0 0 1 0 3h-2.5" /><path d="M19 21v1m0 -8v1" /></svg>
                
                <span>Advertise</span>
            </a>
        </li>
        
        
        <li >
            <a href='/support-me/' >
                
                
                
                    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-cup"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 11h14v-3h-14z" /><path d="M17.5 11l-1.5 10h-8l-1.5 -10" /><path d="M6 8v-1a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v1" /><path d="M15 5v-2" /></svg>
                
                <span>Support Me</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/imprint/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-info-circle" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0" /><path d="M12 9h.01" /><path d="M11 12h1v4h1" /></svg>
                
                <span>Imprint</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li>
      <ol>
        <li><a href="#the-list">The List</a>
          <ol>
            <li><a href="#the-columns">The Columns</a></li>
            <li><a href="#filtering">Filtering</a></li>
          </ol>
        </li>
        <li><a href="#deployment">Deployment</a>
          <ol>
            <li><a href="#clone-the-githubrepo">Clone The GitHubÂ Repo</a></li>
            <li><a href="#environmentjson">Environment.json</a></li>
            <li><a href="#directroutingnumberscsv">DirectRoutingNumbers.csv</a></li>
            <li><a href="#deployps1">Deploy.ps1</a></li>
            <li><a href="#setupps1">Setup.ps1</a></li>
            <li><a href="#azure-ad-app-registration--service-principal">Azure AD App Registration &amp; Service Principal</a></li>
            <li><a href="#provisioning-the-azure-resources">Provisioning the Azure Resources</a></li>
            <li><a href="#automation-account">Automation Account</a></li>
            <li><a href="#running-therunbook">Running theÂ Runbook</a></li>
          </ol>
        </li>
        <li><a href="#finishing-touches">Finishing Touches</a>
          <ol>
            <li><a href="#add-two-additional-columns">Add Two Additional Columns</a></li>
            <li><a href="#create-theflow"><strong>Create TheÂ Flow</strong></a></li>
          </ol>
        </li>
        <li><a href="#force-sync-thelist">Force Sync theÂ List</a>
          <ol>
            <li><a href="#updating-the-direct-routing-numbers-inazure">Updating the Direct Routing Numbers inÂ Azure</a></li>
          </ol>
        </li>
        <li><a href="#conclusion">Conclusion</a>
          <ol>
            <li><a href="#final-notes">Final Notes</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/phone-numbers/" >
                Phone Numbers
            </a>
        
            <a href="/categories/microsoft-teams/" >
                Microsoft Teams
            </a>
        
            <a href="/categories/azure-automation/" >
                Azure Automation
            </a>
        
            <a href="/categories/microsoft-lists/" >
                Microsoft Lists
            </a>
        
            <a href="/categories/sharepoint/" >
                SharePoint
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/">Teams Phone Number Management on a Budget</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Mar 23, 2023</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    20 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/0TNGGsjES22NTIbT.jpg"
	width="1024"
	height="1024"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/0TNGGsjES22NTIbT_hu_c6fd37b5c1ffc22.jpg 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/0TNGGsjES22NTIbT_hu_29351c288b401357.jpg 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="100"
		data-flex-basis="240px"
	
></p>
<p><strong>Update 08.04.2023</strong></p>
<blockquote>
<p>Iâ€™ve updated this solution to V2 which includes the capability to assign, unassign and reserve phone numbers along with other improvements.</p></blockquote>
<blockquote>
<p>Please read <a class="link" href="/p/teams-phone-number-management-list-part-2-b5385e348a3a" >this article</a> when you have finished reading this one.</p></blockquote>
<p><strong>/Update</strong></p>
<p>Every Teams Voice Admin that has deployed Direct Routing knows the struggle. Thereâ€™s no way to manage Direct Routing numbers in Teams Admin Center. This makes it hard for us to get a clear overview of which numbers are still unassigned/free or even to see all the numbers we have.</p>
<p>Obviously, thereâ€™s a solution for anything. We can use PowerShell to export numbers and create our own lists in Excel or whatever. The challenge with that is to keep the list up to date, error free and make it centrally available for all people who need to work with it.</p>
<p>There are also lots of vendors which offer Teams phone number management platforms. Here are some of them:</p>
<p><a class="link" href="https://callroute.com/features/number-management/"  target="_blank" rel="noopener"
    >Number Management for Microsoft Teams (callroute.com)</a></p>
<p><a class="link" href="https://www.codesoftware.net/clobba-rm/"  target="_blank" rel="noopener"
    >Clobba Range Managerâ€Šâ€”â€ŠDID Number Managementâ€Šâ€”â€ŠCode Software</a></p>
<p><a class="link" href="https://www.pure-ip.com/number-connect"  target="_blank" rel="noopener"
    >Number Connect (pure-ip.com)</a></p>
<p><a class="link" href="https://teamsboss.com/app/"  target="_blank" rel="noopener"
    >TeamsBoss</a></p>
<p>They all have powerful featuresâ€Šâ€”â€Šwhich come with a price. But what if we donâ€™t need a full-fledged management solution and just want a simple overview which is dynamically updated?</p>
<p>Thatâ€™s exactly what Iâ€™ve been building in my spare time over the last few weeks.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1bJzySshLFfuKEkIhfsSCQ.png"
	width="2789"
	height="1101"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1bJzySshLFfuKEkIhfsSCQ_hu_231c96e2be9ae68c.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1bJzySshLFfuKEkIhfsSCQ_hu_477efd58af7f58ce.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="253"
		data-flex-basis="607px"
	
></p>
<p>The final product is a SharePoint list which gets automatically updated by an Azure Automation Runbook every hour.</p>
<p>This time around, I tried to automate everything I could. This means less work for you if you want to deploy it yourself. But before we get into the technical details of it, letâ€™s look at the list.</p>
<p><strong>TL;DR</strong></p>
<p>If you donâ€™t care about the details and want to deploy straight away, you can grab the code from <a class="link" href="http://mozziemozz/TeamsPhoneAutomation:%20Automation%20Scripts%20for%20Microsoft%20Teams%20Phone%20%28github.com%29"  target="_blank" rel="noopener"
    >here</a>.</p>
<h3 id="the-list">The List
</h3><h4 id="the-columns">The Columns
</h4><p>The list can be viewed in SharePoint Online, Microsoft Lists or directly in Teams through Lists. It consists of the following columns.</p>
<ul>
<li><strong>Title</strong> = Phone Number</li>
<li><strong>Phone Extension</strong> = Extension if there is one configured</li>
<li><strong>Status</strong> = Assigned/Unassigned</li>
<li><strong>Number Type</strong> = Direct Routing / Calling Plan / Operator Connect</li>
<li><strong>User Name</strong> = Display Name of assigned account</li>
<li><strong>User Principal Name</strong> = UPN of assigned account</li>
<li><strong>Account Type</strong> = User Account / Resource Account / Conference Bridge</li>
<li><strong>Country</strong> = The country a number belongs to</li>
<li><strong>UserId</strong> = Object Id from Azure AD</li>
<li><strong>User Profile</strong> = Profile Card</li>
<li><strong>Teams Admin Center</strong> = Link to manage the user in TAC</li>
</ul>
<p>This should cover most of the relevant information somebody might want to know about their phone numbers.</p>
<h4 id="filtering">Filtering
</h4><p>Having all that information available allows us to easily filter numbers which meet certain criteria. In this example, I filtered the list for all unassigned numbers from the UK.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/14bBmRV7urUrZc22NiWUVDA.png"
	width="2100"
	height="272"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/14bBmRV7urUrZc22NiWUVDA_hu_2110504dc1ae7c21.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/14bBmRV7urUrZc22NiWUVDA_hu_3d44a68a14fabb6f.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="772"
		data-flex-basis="1852px"
	
></p>
<p>Because this number is unassigned and it could be assigned to a <strong>Resource Account</strong> or a <strong>Conference Bridge</strong>, both types are included in the list.</p>
<p>If we compare that to an assigned service number, we can see that the <strong>Account Type</strong> is shown as <strong>Resource Account</strong> because the number is assigned to one.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1wZdcr9ASB2hnmRdFT5w.png"
	width="2086"
	height="269"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1wZdcr9ASB2hnmRdFT5w_hu_7a557cd109c4fffd.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1wZdcr9ASB2hnmRdFT5w_hu_1a65d2ef0b0682b0.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="775"
		data-flex-basis="1861px"
	
></p>
<p>The most common thing which people probably want to see at glance is which <strong>direct routing</strong> numbers are unassigned from a specific country. This can also be achieved very easily.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1IUJX8fpDC3xi4wpcd5kfg.png"
	width="2280"
	height="520"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1IUJX8fpDC3xi4wpcd5kfg_hu_4ff2dcb2fb36f9f3.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1IUJX8fpDC3xi4wpcd5kfg_hu_a3bf0e3c7030bbe1.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="438"
		data-flex-basis="1052px"
	
></p>
<p>I learned a lot during the development of this project, and I now want to share that with you. Letâ€™s take a look at how the SharePoint list was built and how it automatically updates itself with the help of <strong>Azure Automation</strong>.</p>
<h3 id="deployment">Deployment
</h3><p>There are very few manual tasks required to get this set up. I built a deployment script which will create all the required resources in Azure for you.</p>
<h4 id="clone-the-githubrepo">Clone The GitHubÂ Repo
</h4><p>Start by cloning or downloading the GitHub Repo.</p>
<p><a class="link" href="https://github.com/mozziemozz/TeamsPhoneAutomation"  target="_blank" rel="noopener"
    >mozziemozz/TeamsPhoneAutomation: Automation Scripts for Microsoft Teams Phone (github.com)</a></p>
<p>If youâ€™ve never worked with GitHub before, I highly recommend trying it instead of just downloading the repository as a zip file. All you need to do is <a class="link" href="https://github.com/"  target="_blank" rel="noopener"
    >sign up</a> for an account, install the <a class="link" href="https://desktop.github.com/"  target="_blank" rel="noopener"
    >desktop client</a> and clone the repo.</p>
<p>Once you have signed into GitHub Desktop, just head over to the <a class="link" href="https://github.com/mozziemozz/TeamsPhoneAutomation"  target="_blank" rel="noopener"
    >repository URL</a> and open it in GitHub Desktop.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1Id3QSS2WJGsTfGqGPJ55Q.png"
	width="1390"
	height="588"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1Id3QSS2WJGsTfGqGPJ55Q_hu_ba81dfa996dc53d6.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1Id3QSS2WJGsTfGqGPJ55Q_hu_ce5b19c4dfc3afec.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="236"
		data-flex-basis="567px"
	
></p>
<p>Then choose your local folder and click on clone. Make sure to select a folder which isnâ€™t synchronized to any kind of cloud Storage like OneDrive. The constant syncing of files would impair your performance dramatically.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1tqEoryFHlOYEPKCBQaED6Q.png"
	width="736"
	height="446"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1tqEoryFHlOYEPKCBQaED6Q_hu_36d447bccadaffc3.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1tqEoryFHlOYEPKCBQaED6Q_hu_ca1c736a4e47ba53.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="165"
		data-flex-basis="396px"
	
></p>
<p>The repo contains the following files and folders.</p>
<p>C:\TEMP\GITHUB\TEAMSPHONEAUTOMATION<br>
â”‚   .gitignore<br>
â”‚   Deploy.ps1<br>
â”‚   README.md<br>
â”‚<br>
â”œâ”€â”€â”€Functions<br>
â”‚       Connect-MgGraphHTTP.ps1<br>
â”‚       Connect-MsTeamsServicePrincipal.ps1<br>
â”‚       Get-CountryFromPrefix.ps1<br>
â”‚       Get-CsOnlineNumbers.ps1<br>
â”‚<br>
â”œâ”€â”€â”€Resources<br>
â”‚       CountryLookupTable.json<br>
â”‚       CreateList.json<br>
â”‚       DirectRoutingNumbers.csv<br>
â”‚       Environment.json<br>
â”‚<br>
â”œâ”€â”€â”€Scripts<br>
â”‚       TeamsPhoneNumberOverview.ps1<br>
â”‚<br>
â””â”€â”€â”€Setup<br>
Setup.ps1<br>
UpdateDirectRoutingNumbers.ps1</p>
<h4 id="environmentjson">Environment.json
</h4><p>Before we do anything, we need to define a few things and names. InÂ <code>.\Resources</code> open the <code>Environment.json</code> file and fill in your own information.</p>
<p>{<br>
&ldquo;TenantId&rdquo;: &ldquo;4bffbf87-53a0-4fce-b58b-xxxxxxxxxxxx&rdquo;,<br>
&ldquo;GroupId&rdquo;: &ldquo;aff7d27f-878d-422c-83bd-xxxxxxxxxxxx&rdquo;,<br>
&ldquo;MSListName&rdquo;: &ldquo;Teams Phone Number Overview Demo&rdquo;,<br>
&ldquo;ResourceGroupName&rdquo;: &ldquo;mzz-rmg-001&rdquo;,<br>
&ldquo;AutomationAccountName&rdquo;: &ldquo;mzz-automation-account-001&rdquo;,<br>
&ldquo;AzLocation&rdquo;: &ldquo;West Europe&rdquo;<br>
}</p>
<p><strong>TenantId</strong> is your Tenant Id.</p>
<p><strong>GroupId</strong> is the Object Id of the Microsoft Teams Team which hosts the SharePoint site where the list should be created.</p>
<p><strong>MSListName</strong> will be the name of your List in SharePoint.</p>
<p><strong>ResourceGroupName</strong> will be the name of the resource group which is created in Azure.</p>
<p><strong>AutomationAccountName</strong> will be the name of the automation account which is created within the new resource group.</p>
<p><strong>AzLocation</strong> is the Azure region where you want to deploy the resources.</p>
<p>You can find a list of all available regions and their names <a class="link" href="https://azure.microsoft.com/en-us/explore/global-infrastructure/geographies/#geographies"  target="_blank" rel="noopener"
    >here</a>.</p>
<p>Make sure you save the file once youâ€™ve filled in all the information.</p>
<h4 id="directroutingnumberscsv">DirectRoutingNumbers.csv
</h4><p>Next, we need a list which contains all your direct routing numbers. This file can only contain one column called <strong>PhoneNumber</strong>. All the numbers must be in <strong>E.164</strong> format but without the leading <code>+</code>Â . The plus sign will be added by the script later. It just makes things easier in Excel if we donâ€™t need to bother about the plus.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1nnwTg3pq3UCddPisob7HqA.png"
	width="1461"
	height="969"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1nnwTg3pq3UCddPisob7HqA_hu_93be95d2178a90ba.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1nnwTg3pq3UCddPisob7HqA_hu_a2b8f8df5136a28a.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="150"
		data-flex-basis="361px"
	
></p>
<p>Thatâ€™s it for the preparation.</p>
<h4 id="deployps1">Deploy.ps1
</h4><p>Disclaimer: The script has been tested on a vanilla Windows 11 virtual machine where <strong>Windows Terminal</strong> is configured as default console host and sessions start in the parent process directory. No PowerShell modules were installed before the script was first executed on this system.</p>
<p><strong>You will need an account with Global Administrator rights to successfully run this script. You also need local admin rights and need to make sure that running scripts is allowed on your machine.</strong></p>
<p>In an elevated terminal, run the following code and close the terminal session once you have done so.</p>
<p>Set-ExecutionPolicy Bypass</p>
<p>To start the deployment, you need to run the <code>Deploy.ps1</code> file.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1WKugBxPGMHPFT71q8WUN1g.png"
	width="618"
	height="582"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1WKugBxPGMHPFT71q8WUN1g_hu_3857949ff8d0a6d7.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1WKugBxPGMHPFT71q8WUN1g_hu_d9a7c092679f0087.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="106"
		data-flex-basis="254px"
	
></p>
<p>This will just call theÂ <code>.\Setup\Setup.ps1</code> script which is the real deal.</p>
<h4 id="setupps1">Setup.ps1
</h4><p>After all the module and components checks have been completed or the missing components have been installed, you will be prompted to sign into the <a class="link" href="https://pnp.github.io/cli-microsoft365/"  target="_blank" rel="noopener"
    ><strong>M365 CLI</strong></a><strong>.</strong></p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1ZuLzxPnboF940mSkOnUFqA.png"
	width="2430"
	height="1392"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1ZuLzxPnboF940mSkOnUFqA_hu_d324a6bf7b2995f5.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1ZuLzxPnboF940mSkOnUFqA_hu_5fa45eb41453e037.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="174"
		data-flex-basis="418px"
	
></p>
<p>Let me explain whatâ€™s going on in the script. Our end goal is to have a SharePoint list. Since we need a script to automatically update the list anyway, we might as well just create the list through PowerShell and Microsoft Graph instead of creating it manually.</p>
<p>To provision all this stuff, we need a couple of <strong>Az.*</strong> PowerShell modules. We also need <strong>Node.JS</strong> so we can install the <strong>CLI for Microsoft 365</strong> through <strong>NPM</strong> (Node Package Manager). If you miss any of the components on your machine, they will automatically be installed, if you can provide local admin rights.</p>
<h4 id="azure-ad-app-registration--service-principal">Azure AD App Registration &amp; Service Principal
</h4><p>The M365 CLI will create a new Azure AD App Registration and a Service Principal. It will also assign the Microsoft Graph permission scopes we need to create and modify SharePoint lists and manage Microsoft Teams to the Service Principal.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1PKYwJDYOIAvgJi8us8uUMQ.png"
	width="1928"
	height="1395"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1PKYwJDYOIAvgJi8us8uUMQ_hu_a5f70cca8aacd39a.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1PKYwJDYOIAvgJi8us8uUMQ_hu_9637ae38be7cd0e.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="138"
		data-flex-basis="331px"
	
>
<img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1EvALgsWAXkRfjYM5WjZMGQ.png"
	width="2616"
	height="1297"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1EvALgsWAXkRfjYM5WjZMGQ_hu_b111f7b97325c4f9.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1EvALgsWAXkRfjYM5WjZMGQ_hu_42f74ca18f69e5ca.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="201"
		data-flex-basis="484px"
	
></p>
<p>Both the App Registration and the Service Principal will use the name of the Automation Account. This way itâ€™s easy to know where the assigned permissions are used within Azure.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1BFgrZUU3EnaOZDB1SutpQ.png"
	width="1303"
	height="115"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1BFgrZUU3EnaOZDB1SutpQ_hu_9d3563b73e82fade.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1BFgrZUU3EnaOZDB1SutpQ_hu_10971712106d607a.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="1133"
		data-flex-basis="2719px"
	
></p>
<p>The script also creates a new client secret for the App Registration.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1a2XyZpLjkpZ0HOfLCL32PA.png"
	width="1950"
	height="778"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1a2XyZpLjkpZ0HOfLCL32PA_hu_f0e3c354b8cdd719.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1a2XyZpLjkpZ0HOfLCL32PA_hu_ea8218146b7a5cb8.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="250"
		data-flex-basis="601px"
	
></p>
<p>Remember, a client secret can only be viewed once, after it has been created in the portal. Because we used the CLI to create it, we canâ€™t view it in the portal anymore. The secret is received by the script and saved in an encrypted state though. Youâ€™ll also be prompted if you want to view it in case you want to copy and store it in a safe place.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1zitK266ZKs6EST13zGeKCA.png"
	width="2207"
	height="120"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1zitK266ZKs6EST13zGeKCA_hu_89c391ed06643dd3.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1zitK266ZKs6EST13zGeKCA_hu_5f15aaa392cee6cf.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="1839"
		data-flex-basis="4414px"
	
></p>
<p>You donâ€™t have to do this if you donâ€™t want to. You can always decrypt it again, as long as you&rsquo;re using the same machine and user account which encrypted it. The secret is saved toÂ <code>.\.local\AppSecret.txt</code>Â .</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1tWTZ8tk39JcYjIvwgY5xeA.png"
	width="1891"
	height="825"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1tWTZ8tk39JcYjIvwgY5xeA_hu_d67c07e54af6d7bf.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1tWTZ8tk39JcYjIvwgY5xeA_hu_92cebef4ba0c4f12.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="229"
		data-flex-basis="550px"
	
></p>
<p>If you want to manually decrypt it later, you can use the following code.</p>
<p>$AppSecret = [Runtime.InteropServices.Marshal]::PtrToStringAuto([Runtime.InteropServices.Marshal]::SecureStringToBSTR((Get-Content -Path .\.local\AppSecret.txt | ConvertTo-SecureString))) | Out-String</p>
<p>Again, you donâ€™t have to if you donâ€™t want to. The script will be able to decrypt the secret and upload it to the Azure Automation Account once itâ€™s needed.</p>
<p>Once the permissions have been assigned to the Service Principal, the script uses the same Service Principal to connect to Microsoft Graph and assign the <strong>Skype for Business Administrator</strong> role to itself.</p>
<p>This is possible because the M365 CLI previously assigned the scope <strong>RoleManagement.ReadWrite.Directory</strong> to the Service Principal.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1dprD8JGRDPs2yAJnvlPlwQ.png"
	width="1927"
	height="594"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1dprD8JGRDPs2yAJnvlPlwQ_hu_592ef12e7633983.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1dprD8JGRDPs2yAJnvlPlwQ_hu_387a035ee51841cd.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="324"
		data-flex-basis="778px"
	
></p>
<p>The role is needed for the SP to be able to manage Microsoft Teams via PowerShell. I learned this from Christian Frohnâ€™s excellent <a class="link" href="https://www.christianfrohn.dk/2022/11/13/connect-to-microsoft-teams-powershell-using-azure-app-reg-service-principal/"  target="_blank" rel="noopener"
    >blog article</a>.</p>
<p>In case youâ€™re wondering why no <strong>Microsoft.Graph</strong> modules are required; this is because I chose to work with PowerShell native <code>Invoke-RestMethod</code> commands instead of the <code>*Mg*</code> Cmdlets.</p>
<h4 id="provisioning-the-azure-resources">Provisioning the Azure Resources
</h4><p>The previous steps complete rather fast. The next steps are going to take a bit longer. First you need to sign in with an Account which has the appropriate permissions to create Azure resources within your subscription.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1pOaJ1YELOvcHWdcLOuFeGQ.png"
	width="855"
	height="1173"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1pOaJ1YELOvcHWdcLOuFeGQ_hu_656b2f14217c3971.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1pOaJ1YELOvcHWdcLOuFeGQ_hu_d1633900ebee858f.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="72"
		data-flex-basis="174px"
	
></p>
<p>I guess it would have been possible to also assign some RBAC roles to the Service Principal which would allow us to use it to sign into Azure as well. Since the script is run locally on demand, I see no problem with using a normal user account for this part. It actually gives us time to review the created App Registration and Service Principal before the script starts to deploy any resources to Azure. Furthermore, we donâ€™t need to worry about being aware of yet another Service Principal which has permissions to deploy or remove Azure Resources.</p>
<p>The script will create a Resource Group with the name and location defined in <strong>Environment.json.</strong></p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1ZZGYVP7g2uj2hi3O08RlzA.png"
	width="1536"
	height="469"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1ZZGYVP7g2uj2hi3O08RlzA_hu_cc9819622a028c5c.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1ZZGYVP7g2uj2hi3O08RlzA_hu_d0a421792d944e25.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="327"
		data-flex-basis="786px"
	
></p>
<p>It will also create a new Automation Account within the Resource Group, also in the same region.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1RvDl30FW8xOAHs3EUA3Q.png"
	width="1508"
	height="889"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1RvDl30FW8xOAHs3EUA3Q_hu_51ccdc4ed37c97fa.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1RvDl30FW8xOAHs3EUA3Q_hu_539d4ddfd309dc04.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="169"
		data-flex-basis="407px"
	
></p>
<h4 id="automation-account">Automation Account
</h4><p><strong>Modules</strong></p>
<p>The <strong>MicrosoftTeams</strong> Module is not added to Automation Accounts by default. Thus, the script needs to add it. This usually takes a couple of Minutes.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1RnQgpNQ3dOLfk0aDigurUQ.png"
	width="1032"
	height="427"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1RnQgpNQ3dOLfk0aDigurUQ_hu_7d7c61a03f3a16e4.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1RnQgpNQ3dOLfk0aDigurUQ_hu_91177aacfe9cd132.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="241"
		data-flex-basis="580px"
	
></p>
<p>Once the module has finished importing, the script will continue.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1msSR1JykOc4mieC9hExE2g.png"
	width="1922"
	height="409"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1msSR1JykOc4mieC9hExE2g_hu_ab7e8314b060bc67.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1msSR1JykOc4mieC9hExE2g_hu_81ed07256b4f7475.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="469"
		data-flex-basis="1127px"
	
></p>
<p><strong>Variables</strong></p>
<p>The main script which will create/update our SharePoint List needs access to all the data we initially defined in <strong>Environment.josn</strong>. This information is stored in <strong>Automation Variables</strong> which can be accessed through Azure Runbooks.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1DBUuoXrqsTiu4XcayfA.png"
	width="2456"
	height="692"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1DBUuoXrqsTiu4XcayfA_hu_cd935a30445c9f6e.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1DBUuoXrqsTiu4XcayfA_hu_63b9f76fdab62d2e.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="354"
		data-flex-basis="851px"
	
></p>
<p>The client secret is stored as an encrypted variable and cannot be viewed or edited. Its content can only be accessed by using the internal Cmdlet <code>Get-AutomationVariable</code>Â .</p>
<p>We can also see that we have a variable called <strong>TeamsPhoneNumberOverview_DirectRoutingNumbers.</strong> This variable stores all Direct Routing numbers in <strong>Json</strong> format. Because I ran into some issues with storing the Json content as a string, I needed to get creative and enclose it in single quotes: <code>'{&quot;Json&quot;: &quot;Example&quot;}'</code>Â . These get removed when the variable is imported through the Runbook so that the Json can be converted to a PowerShell object.</p>
<p><strong>TeamsPhoneNumberOverview_CountryLookupTable</strong> contains a list with all countries and prefixes to determine the country of Direct Routing Numbers. To be consistent, this is also applied to Calling Plan and Operator Connect numbers, even though this information would be available through <code>Get-CsPhoneNumberAssignment</code>Â .</p>
<p>If you would like to learn more about these internal Cmdlets for Automation Variables or Azure Runbooks in general, I recommend this <a class="link" href="/p/fix-utf-8-encoding-when-calling-azure-child-runbooks-inline-78644e6af242" >article</a> of mine.</p>
<p><strong>Runbooks</strong></p>
<p>We also have a couple of Runbooks which were deployed by the <strong>Setup.ps1</strong> script. The main script logic sits in <strong>TeamsPhoneNumberOverview</strong>.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1cqbLWUjMSR1NhjCXqoCIg.png"
	width="1901"
	height="609"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1cqbLWUjMSR1NhjCXqoCIg_hu_d81eb0ebdc6165dc.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1cqbLWUjMSR1NhjCXqoCIg_hu_8bb6c09d03afc8cc.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="312"
		data-flex-basis="749px"
	
></p>
<p>To make the solution more modular some functions, like <strong>Connect-MgGraphHTTP</strong> or <strong>Connect-MsTeamsServicePrincipal</strong> are stored in separate Runbooks. This makes it easier to reuse them and means less work if we want to extend the Automation Account with other scripts.</p>
<p>For example, if you have another Runbook in the same Automation Account which needs to connect to MicrosoftTeams PowerShell as well, you can just use the following code.</p>
<p>. .\Connect-MsTeamsServicePrincipal.ps1</p>
<p>$TenantId = Get-AutomationVariable -Name &ldquo;TeamsPhoneNumberOverview_TenantId&rdquo;<br>
$AppId = Get-AutomationVariable -Name &ldquo;TeamsPhoneNumberOverview_AppId&rdquo;<br>
$AppSecret = Get-AutomationVariable -Name &ldquo;TeamsPhoneNumberOverview_AppSecret&rdquo;</p>
<p>. Connect-MsTeamsServicePrincipal -TenantId $TenantId -AppId $AppId -AppSecret $AppSecret</p>
<p>And if you ever need to adjust something in the login function, you only need to change it in one script (Connect-MsTeamsServicePrincipal) and not in all your Runbooks.</p>
<p><strong>Script Logic</strong></p>
<p>The code for the main script logic can be found here.</p>
<p><a class="link" href="https://github.com/mozziemozz/TeamsPhoneAutomation/blob/main/Scripts/TeamsPhoneNumberOverview.ps1"  target="_blank" rel="noopener"
    >TeamsPhoneAutomation/TeamsPhoneNumberOverview.ps1 at main Â· mozziemozz/TeamsPhoneAutomation (github.com)</a></p>
<p>I asked ChatGPT to explain what the script does. The result is astonishing.</p>
<blockquote>
<p>This PowerShell script is designed to gather information about Microsoft Teams users who have phone numbers assigned to them, and store this information in a SharePoint list.</p></blockquote>
<blockquote>
<p>The script starts by importing four external functions, which are used later in the script. It then sets some variables by retrieving values from Azure Automation variables. These variables include the name of the SharePoint list where the data will be stored, as well as the credentials needed to connect to the Microsoft Teams and Graph APIs.</p></blockquote>
<blockquote>
<p>Next, the script imports Direct Routing numbers and adds a leading plus sign to all of them. It also retrieves a list of existing SharePoint lists for a specific group ID, and checks if the desired SharePoint list already exists. If it does, the script retrieves its ID. If not, a new SharePoint list is created and its ID is retrieved.</p></blockquote>
<blockquote>
<p>The script then retrieves information about all Teams users who have a phone number assigned to them. For each user, the script determines if they are a user or resource account, and then extracts details about their phone number, such as the phone number itself, any extension, and the country associated with the number. The script also checks if the phone number is a Direct Routing number or a CsOnline number. Finally, it creates an object containing all of this information for each user, and adds this object to an array.</p></blockquote>
<blockquote>
<p>Once all of the user information has been gathered, the script writes it to the SharePoint list. Each object in the array is written to a new row in the list.</p></blockquote>
<p>The only thing I would have added is to mention that the script only adds new entries to the list, only updates changed entries with the new values and removes entries from the list which no longer exist.</p>
<p><strong>Schedules</strong></p>
<p>The setup script has also created a recurring schedule which runs every hour. The schedule is automatically linked to the <strong>TeamsPhoneNumberOverview</strong> Runbook by the script. This will result in the SharePoint list being updated once an hour.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1Iemob3BqBPX6OWWHvggsQ.png"
	width="2217"
	height="1137"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1Iemob3BqBPX6OWWHvggsQ_hu_a89080f523f91e17.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1Iemob3BqBPX6OWWHvggsQ_hu_82d9977c70ebe959.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="194"
		data-flex-basis="467px"
	
></p>
<p>Thatâ€™s it. These are all the resources and components we need to create and update the SharePoint List.</p>
<h4 id="running-therunbook">Running theÂ Runbook
</h4><p>The Runbook schedule is configured in UTC. The first start time needs to be at least 5 minutes after the scheduleâ€™s creation time. To be sure, I set the schedule to run at the next full hour + 2 hours. In case this does not work for you in your local time zone, please let me know.</p>
<p>This means that the SharePoint List wonâ€™t be created straight away. If you want to manually run the Runbook before the first scheduled start, just click on <strong>Start.</strong></p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1qROsEUEs8dXdkq8CwSOaxQ.png"
	width="1597"
	height="193"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1qROsEUEs8dXdkq8CwSOaxQ_hu_30461f537b0de432.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1qROsEUEs8dXdkq8CwSOaxQ_hu_be9dfc7547ca006b.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="827"
		data-flex-basis="1985px"
	
></p>
<p>The job will just take a couple of minutes to complete.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1mp22izPK5jCc85FUtfZAkQ.png"
	width="1120"
	height="188"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1mp22izPK5jCc85FUtfZAkQ_hu_298e803a602c3ad8.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1mp22izPK5jCc85FUtfZAkQ_hu_417753c9bf6b164c.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="595"
		data-flex-basis="1429px"
	
></p>
<p>You should then see the newly created List in SharePoint or Microsoft Lists.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1ER7l4q30cUIBaDndrjJfIQ.png"
	width="2846"
	height="1476"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1ER7l4q30cUIBaDndrjJfIQ_hu_82e1468fb2f35257.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1ER7l4q30cUIBaDndrjJfIQ_hu_7e82544d89b706f7.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="192"
		data-flex-basis="462px"
	
></p>
<h3 id="finishing-touches">Finishing Touches
</h3><p>Unfortunately, the Graph API has some limitations in terms of what types of fields can be added or updated in a list. I wanted to perfect my solution by also having a User Profile column and a link to Teams Admin Center for all assigned user numbers. These types can only be added manually.</p>
<p><strong>Important:</strong> For this and the next part, itâ€™s extremely important to follow my instructions very carefully. If the column names donâ€™t match up with the Flow it will not work.</p>
<h4 id="add-two-additional-columns">Add Two Additional Columns
</h4><p>Click on <strong>+ Add column</strong>.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1KBxfdw50SMnsnhVzMCx5A.png"
	width="831"
	height="634"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1KBxfdw50SMnsnhVzMCx5A_hu_2be62200ecc6985d.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1KBxfdw50SMnsnhVzMCx5A_hu_dc090fd4aad9601a.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="131"
		data-flex-basis="314px"
	
></p>
<p>Name the column <strong>User Profile</strong> and toggle <strong>Show profile photos</strong>.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1nYyOkp3UFJxGdomb1w4bDg.png"
	width="477"
	height="678"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1nYyOkp3UFJxGdomb1w4bDg_hu_c0fd6e6208ab6ace.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1nYyOkp3UFJxGdomb1w4bDg_hu_18309ecfb161f25.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="70"
		data-flex-basis="168px"
	
></p>
<p>Repeat the steps and choose <strong>Hyperlink</strong> this time.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1zQUl6GTYbNQymUbAQ9IU1g.png"
	width="835"
	height="634"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1zQUl6GTYbNQymUbAQ9IU1g_hu_94bd5f690d2d31ca.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1zQUl6GTYbNQymUbAQ9IU1g_hu_5caa26b8eb757bb1.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="131"
		data-flex-basis="316px"
	
></p>
<p>Name this column <strong>Teams Admin Center.</strong></p>
<p>Now letâ€™s create the final part of our Number Overview Solution: A Power Automate Flow.</p>
<h4 id="create-theflow"><strong>Create TheÂ Flow</strong>
</h4><p>Head over to <a class="link" href="https://make.powerautomate.com/"  target="_blank" rel="noopener"
    >Microsoft Power Automate</a> and create a new <strong>Automated Cloud Flow</strong>. Name your flow and select <strong>When an item is created or modified</strong> (SharePoint) as the trigger.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1eMzuzJ4sgXqtppTIWtTLbw.png"
	width="1334"
	height="841"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1eMzuzJ4sgXqtppTIWtTLbw_hu_5d68934f4dbba0c3.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1eMzuzJ4sgXqtppTIWtTLbw_hu_ec82539f2a1bb36a.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="158"
		data-flex-basis="380px"
	
></p>
<p>Select the Site/Team where your list has been created from the drop-down menu in <strong>Site Address.</strong> Then choose your list from the drop-down.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1ruBvckSCFoyJbi3abfZbCQ.png"
	width="929"
	height="320"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1ruBvckSCFoyJbi3abfZbCQ_hu_4da5f0b01ac17af6.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1ruBvckSCFoyJbi3abfZbCQ_hu_74f47b9c05e3b20c.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="290"
		data-flex-basis="696px"
	
></p>
<p>Next, click on the three dots and select <strong>Settings.</strong></p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1Kq7ExjGCW7nsIjO5gPMw.png"
	width="1347"
	height="742"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1Kq7ExjGCW7nsIjO5gPMw_hu_ca0eff5024be05a2.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1Kq7ExjGCW7nsIjO5gPMw_hu_1c7748595836c798.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="181"
		data-flex-basis="435px"
	
></p>
<p>Add a <strong>Trigger Condition</strong> and add the following code exactly as it is.</p>
<p>@or(and(not(equals(triggerOutputs()?[&lsquo;body/User_x0020_Principal_x0020_Name&rsquo;], &lsquo;Unassigned&rsquo;)),not(contains(triggerBody(), &lsquo;UserProfile&rsquo;))),not(equals(triggerOutputs()?[&lsquo;body/User_x0020_Principal_x0020_Name&rsquo;],triggerOutputs()?[&lsquo;body/UserProfile&rsquo;][&lsquo;Email&rsquo;])))</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1mC9t4BUoxiJfqTSIonWsA.png"
	width="920"
	height="1358"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1mC9t4BUoxiJfqTSIonWsA_hu_4c06dfb6e979b45f.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1mC9t4BUoxiJfqTSIonWsA_hu_fa3d2e5badabf1c6.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="67"
		data-flex-basis="162px"
	
></p>
<p>This is the most crucial step. Without a trigger condition, we would create an infinite trigger loop since we use <strong>When an item is created or modified</strong> as trigger and our final action will be <strong>Update item</strong>.</p>
<p>Add a <strong>Condition</strong> where it checks if the <strong>User Principal Name</strong> is equal to <strong>Unassigned.</strong></p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1ynIuEDsOPU7mh4mGx7VQw.png"
	width="945"
	height="331"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1ynIuEDsOPU7mh4mGx7VQw_hu_d39a7bc9bf35e38d.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1ynIuEDsOPU7mh4mGx7VQw_hu_f318cf3a6611faa1.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="285"
		data-flex-basis="685px"
	
></p>
<p>If the condition is <strong>True</strong> or in other words, if the value of the <strong>User Principal Name</strong> field is unassigned, we want to delete the list item.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1t4gRY6Gv6nOZqhgCQ9IF7w.png"
	width="970"
	height="609"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1t4gRY6Gv6nOZqhgCQ9IF7w_hu_74b99cbb77fbe98f.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1t4gRY6Gv6nOZqhgCQ9IF7w_hu_36f3a1dc78099f22.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="159"
		data-flex-basis="382px"
	
></p>
<p>Keep in mind that the flow is only triggered if our trigger condition is met. It took me quite some time and a lot of binging to figure out a working trigger condition for this scenario. (Yes, I really found the answer on Bing without any googling!).</p>
<p>The condition consists of an <strong>and</strong> operator and an <strong>or</strong> operator. In English, it checks for the following:</p>
<p>The <strong>User Principal Name</strong> is not <strong>Unassigned</strong> and the <strong>User Profile</strong> is empty.</p>
<p>This means that the flow will trigger if the number is assigned to a user, but the <strong>User Profile</strong> is not populated yet.</p>
<p>or</p>
<p>The <strong>User Principal Name</strong> is not the same as the <strong>User Profile.</strong></p>
<p>The flow also triggers if the <strong>User Profile</strong> is already populated but it doesnâ€™t match the <strong>User Principal Name</strong>.</p>
<p>I didnâ€™t find a way to delete the <strong>User Profile</strong> if any given number changes from <strong>Assigned</strong> to <strong>Unassigned.</strong> Unfortunately, setting the filed to <code>null</code> via the flow did not work. Because of that we just delete the list item using <strong>Delete item</strong>. The number will be added back to the list with its up to date information as soon as the Runbook runs again.</p>
<p>In the <strong>If no</strong> action of the condition, we need to add another condition. This time, we want to check if the <strong>Account Type</strong> is equal to <strong>User Account</strong>. We only want to include a link to Teams Admin Center if itâ€™s a user account.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1KSugJSu7Fc1kD6QiBAKPg.png"
	width="1966"
	height="413"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1KSugJSu7Fc1kD6QiBAKPg_hu_e476a433ba0f8d1e.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1KSugJSu7Fc1kD6QiBAKPg_hu_fd6bdbef5f7541d2.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="476"
		data-flex-basis="1142px"
	
></p>
<p>In this condition, we only configure actions if itâ€™s <strong>True</strong>. First, we update the list item. Select your <strong>Site Address</strong> and <strong>List Name</strong> again. Then fill in the <strong>ID</strong> and <strong>Title</strong> from dynamic content. And finally, in <strong>User Profile Claims</strong> select <strong>Enter custom value</strong> and choose <strong>User Principal Name</strong> from dynamic content. Leave all the other fields blank.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1THXkqvbzDa3lKzVmDmqHww.png"
	width="967"
	height="1245"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1THXkqvbzDa3lKzVmDmqHww_hu_774367a7f43c4fb0.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1THXkqvbzDa3lKzVmDmqHww_hu_feb4ed790a01116c.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="77"
		data-flex-basis="186px"
	
></p>
<p>Add another action and choose <strong>Send an HTTP request to SharePoint</strong>. The <strong>Update item</strong> action only supports hyperlinks without a description so it would show the entire URL instead of a friendly name in the list. Although itâ€™s more complicated, we can add a hyperlink with a friendly name using <strong>Send an HTTP request to SharePoint</strong>.</p>
<p>Fill in your <strong>Site Address</strong> again and set the <strong>Method</strong> to <strong>POST.</strong> The <strong>Uri</strong> must look like this:</p>
<p>_api/web/lists/GetByTitle(&lsquo;Teams Phone Number Overview Demo 10&rsquo;)/items(@{triggerOutputs()?[&lsquo;body/ID&rsquo;]})</p>
<p>Make sure to adjust the list name in case your list is named differently. Spaces inside the single quotes are supported in this field.</p>
<p>Click the little icon next to the <strong>Headers</strong> field to engage <strong>Switch Headers to text mode</strong> and paste the following Json:</p>
<p>{<br>
&ldquo;Content-Type&rdquo;: &ldquo;application/json;odata=verbose&rdquo;,<br>
&ldquo;X-HTTP-Method&rdquo;: &ldquo;MERGE&rdquo;,<br>
&ldquo;IF-MATCH&rdquo;: &ldquo;*&rdquo;<br>
}</p>
<p>Then paste the following Json content in the <strong>Body</strong>:</p>
<p>{<br>
&ldquo;__metadata&rdquo;: {<br>
&ldquo;type&rdquo;: &ldquo;SP.Data.Teams_x0020_Phone_x0020_Number_x0020_Demo_x0020_10ListItem&rdquo;<br>
},<br>
&ldquo;TeamsAdminCenter&rdquo;: {<br>
&ldquo;Description&rdquo;: &ldquo;Teams Admin Center&rdquo;,<br>
&ldquo;Url&rdquo;: &ldquo;<a class="link" href="https://admin.teams.microsoft.com/users/@%7btriggerOutputs%28%29"  target="_blank" rel="noopener"
    >https://admin.teams.microsoft.com/users/@{triggerOutputs()</a>?[&lsquo;body/UserId&rsquo;]}/account&rdquo;<br>
}<br>
}</p>
<p>Again, make sure to adjust the list name to your own. There is no space or any other character between the end of the list name and <code>ListItem</code>Â . All spaces in the list name must be replaced by <code>_x0020_</code>Â .</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1cfiipG861HDIM3jYlRBIVA.png"
	width="964"
	height="1381"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1cfiipG861HDIM3jYlRBIVA_hu_ee6448debccf2de8.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1cfiipG861HDIM3jYlRBIVA_hu_4a95096f07331ad2.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="69"
		data-flex-basis="167px"
	
></p>
<p>If you look at the trigger condition again, you might have noticed that the field names like <strong>User Principal Name</strong> are all written like this: <strong>User_x0020_Principal_x0020_Name.</strong> I noticed that all columns which contain spaces and have been created via the Graph API are named this way. <strong>Teams Admin Center</strong> on the other hand has been created manually via SharePoint Online. This column&rsquo;s reference name is now <strong>TeamsAdminCenter</strong> as you can see in the screenshot above.</p>
<p>Thatâ€™s it, we finished building our flow. For reference, hereâ€™s the complete layout of the flow without expanded actions.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/131pEBoBjwrnmLnXAWpI1fw.png"
	width="3004"
	height="1558"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/131pEBoBjwrnmLnXAWpI1fw_hu_628e3e9f0038b731.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/131pEBoBjwrnmLnXAWpI1fw_hu_8c232f68be2f5294.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="192"
		data-flex-basis="462px"
	
></p>
<h3 id="force-sync-thelist">Force Sync theÂ List
</h3><p>The only problem now is that it wonâ€™t be triggered unless the <strong>User Principal Name</strong> field changes on any of the list entries. The easiest way to get these fields populated is to just delete all list entries of assigned user numbers and re-run the Runbook.</p>
<p>Filter the list by <strong>Assigned</strong> numbers and Account Type: <strong>User Account</strong>.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1oy8uFABozWsg4AIlK3vuaA.png"
	width="2748"
	height="410"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1oy8uFABozWsg4AIlK3vuaA_hu_164cad1b81ac35.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1oy8uFABozWsg4AIlK3vuaA_hu_76a14c0f2ca543ce.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="670"
		data-flex-basis="1608px"
	
></p>
<p>Then delete all the entries and wait for the action to complete.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1MlCWdIO1Y8DSyWObydkRFw.png"
	width="955"
	height="530"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1MlCWdIO1Y8DSyWObydkRFw_hu_92ea612c6b8ee6c5.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1MlCWdIO1Y8DSyWObydkRFw_hu_8ddddc888b6cbbcd.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="180"
		data-flex-basis="432px"
	
></p>
<p>Now start the Runbook again or wait for the next scheduled job. Once the job has completed, wait another few minutes for the flow to be triggered.</p>
<p>In the flowâ€™s run history, you should then be able to see a couple of successful flow runs. One for each assigned user number which was previously deleted from the list.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1f5SBjLNb00UmmWwtZCQ.png"
	width="1604"
	height="360"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1f5SBjLNb00UmmWwtZCQ_hu_18347b99fb048ca8.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1f5SBjLNb00UmmWwtZCQ_hu_81d5f5d23948e80b.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="445"
		data-flex-basis="1069px"
	
></p>
<p>In the details of the flow run, we can see that both the item was updated, and that the HTTP request was made to SharePoint.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1Gf3bQf6h3rT6dZtQNarGw.png"
	width="2995"
	height="1322"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1Gf3bQf6h3rT6dZtQNarGw_hu_22b20a70985d8af.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1Gf3bQf6h3rT6dZtQNarGw_hu_f6cf1ed18cf5c18f.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="226"
		data-flex-basis="543px"
	
></p>
<p>In our SharePoint List, we can now see that both the <strong>User Profile</strong> and the link to <strong>Teams Admin Center</strong> have been populated.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1cBT73cmZmnoEZNRofNOWaQ.png"
	width="2750"
	height="393"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1cBT73cmZmnoEZNRofNOWaQ_hu_fd94c5f4e9da41c4.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1cBT73cmZmnoEZNRofNOWaQ_hu_e98b0993faf5cc63.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="699"
		data-flex-basis="1679px"
	
></p>
<h4 id="updating-the-direct-routing-numbers-inazure">Updating the Direct Routing Numbers inÂ Azure
</h4><p>Chances are that youâ€™re going to have more/new Direct Routing numbers at some point. For that scenario, I created another script inÂ <code>.\Setup\UpdateDirectRoutingNumbers.ps1</code>Â . This script will compare the contents of the local <strong>DirectRoutingNumbers.csv</strong> with whatâ€™s stored in the Azure Automation Variable. If the content is not the same, the script will <strong>overwrite</strong> the content of the Automation Variable with your new local source list. This means that you will always need to include all your Direct Routing numbers in the local CSV file, not just new numbers. If you remove numbers from the local source, they will also be removed from the Automation Variable. Hopefully, you wonâ€™t have to do this too often.</p>
<p><a class="link" href="https://github.com/mozziemozz/TeamsPhoneAutomation/blob/main/Setup/UpdateDirectRoutingNumbers.ps1"  target="_blank" rel="noopener"
    >TeamsPhoneAutomation/UpdateDirectRoutingNumbers.ps1 at main Â· mozziemozz/TeamsPhoneAutomation (github.com)</a></p>
<h3 id="conclusion">Conclusion
</h3><p>While this may be a read-only solution and it doesnâ€™t have any management capabilities such as assigning or unassigning phone numbers, I still believe that thereâ€™s tremendous value in this. I think that this could be an interesting approach for smaller companies or non-profit organizations which might not have the cash to purchase an expensive number management solution. The costs for running a Runbook job every now and then should be fairly low. According to <a class="link" href="https://azure.microsoft.com/en-us/pricing/details/automation/"  target="_blank" rel="noopener"
    >this website</a> 500 minutes of Job run time is free every month.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/109Skrvola5ZGSYdJONlA.png"
	width="1952"
	height="656"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/109Skrvola5ZGSYdJONlA_hu_e27289196e613dd3.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/109Skrvola5ZGSYdJONlA_hu_4dd92e0ddb1a0644.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="297"
		data-flex-basis="714px"
	
></p>
<p>Of course, this depends on the amount of numbers you have. The more numbers you have, the longer it will take for a job to complete. If we assume that each job requires 5 minutes to run, that would be about $ 6.5 per month if the job runs every hour every day of a month.</p>
<p>With this, we can finally have a complete, dynamically updated list of all our phone numbers and their state regarding their type. On top of that, we can make it accessible easily for all users or admins who need to work with this kind of information. For example, we could also add the list as a Tab in a Microsoft Teams Channel.</p>
<p><img src="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1pmmbdHeT9HfnoslqhEkrQ.png"
	width="3454"
	height="1117"
	srcset="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/1pmmbdHeT9HfnoslqhEkrQ_hu_acb2017dc2527324.png 480w, /p/teams-phone-number-management-on-a-budget-e25d53f65caf/1pmmbdHeT9HfnoslqhEkrQ_hu_50d2d78ed683570b.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="309"
		data-flex-basis="742px"
	
></p>
<h4 id="final-notes">Final Notes
</h4><p>I invested a lot of time to perfect this project and Iâ€™m incredibly happy to be finally able to share it with the community and my readers on Medium. I tested both the deployment to Azure and the Runbook logic quite a few times so Iâ€™m fairly confident that this should work in other Tenants as well. Since I donâ€™t have any Operator Connect numbers available, I couldnâ€™t test that yet. If you are an Operator Connect customer and want to try this solution, feel free to let me know if it worked for you.</p>
<p>I mainly tested populating and updating the list with about forty numbers of mixed types. I did make some quick tests (and adjustments) with a list of about 1000 Direct Routing numbers and that has worked well for me so far. If you manage a lot of phone numbers and want to try the solution yourself, Iâ€™m also happy if you can provide feedback on how it performs with even more numbers.</p>
<p>As always, I hope you like what Iâ€™ve been up to!</p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/teams-phone-number-management-list-part-3-e083a320004d/">
        
        

        <div class="article-details">
            <h2 class="article-title">Teams Phone Number Management List Part 3</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/teams-phone-number-management-list-part-2-b5385e348a3a/">
        
        

        <div class="article-details">
            <h2 class="article-title">Teams Phone Number Management List Part 2</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/get-teams-user-properties-from-microsoft-graph-api-93ql20to0nr6/">
        
        
            <div class="article-image">
                <img src="/p/get-teams-user-properties-from-microsoft-graph-api-93ql20to0nr6/cover.192ae10f8fb80b26c8d8dcebee673c6d_hu_a9a3ff452bdadaf6.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Get Teams User Properties (incl. Phone Number) from Microsoft Graph"
                        data-key="/get-teams-user-properties-from-microsoft-graph-api-93ql20to0nr6" 
                        data-hash="md5-GSrhD4&#43;4CybI2Nzr7mc8bQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Get Teams User Properties (incl. Phone Number) from Microsoft Graph</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/update-teams-shared-voicemail-for-basic-call-flows-fix-call-back-links-l4gwdggabxl8/">
        
        
            <div class="article-image">
                <img src="/p/update-teams-shared-voicemail-for-basic-call-flows-fix-call-back-links-l4gwdggabxl8/cover.4f5dc5f4c69fd51ebdd89114b3a5e2a7_hu_3bb00ff1f2be8422.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Update: Teams Shared Voicemail for Basic Call Flows (Fix Call Back Links)"
                        data-key="/update:-teams-shared-voicemail-for-basic-call-flows-(fix-call-back-links)-l4gwdggabxl8" 
                        data-hash="md5-T13F9Maf1R692JEUs6Xipw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Update: Teams Shared Voicemail for Basic Call Flows (Fix Call Back Links)</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/minimize-downtime-when-porting-numbers-to-microsoft-teams-calling-plans-ix1vcwlfjbyr/">
        
        

        <div class="article-details">
            <h2 class="article-title">Minimize Downtime when Porting Numbers to Microsoft Teams Calling Plans</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "heusser-pro" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2022 - 
        
        2025 HEUSSER.PRO
    </section>
    
    <section class="powerby">
        
            Hosted on GitHub Pages <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>

