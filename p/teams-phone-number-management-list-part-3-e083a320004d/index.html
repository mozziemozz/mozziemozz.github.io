<!DOCTYPE html>
<html lang="en-us" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="I think it‚Äôs safe to say by now that this project has been a success. I‚Äôve received lots of positive feedback about this from the‚Ä¶">
<title>Teams Phone Number Management List Part 3</title>

<link rel='canonical' href='https://heusser.pro/p/teams-phone-number-management-list-part-3-e083a320004d/'>

<link rel="stylesheet" href="/scss/style.min.663803bebe609202d5b39d848f2d7c2dc8b598a2d879efa079fa88893d29c49c.css"><meta property='og:title' content="Teams Phone Number Management List Part 3">
<meta property='og:description' content="I think it‚Äôs safe to say by now that this project has been a success. I‚Äôve received lots of positive feedback about this from the‚Ä¶">
<meta property='og:url' content='https://heusser.pro/p/teams-phone-number-management-list-part-3-e083a320004d/'>
<meta property='og:site_name' content='HEUSSER.PRO'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2023-11-16T10:30:16&#43;00:00'/><meta property='article:modified_time' content='2023-11-16T10:30:16&#43;00:00'/>
<meta name="twitter:title" content="Teams Phone Number Management List Part 3">
<meta name="twitter:description" content="I think it‚Äôs safe to say by now that this project has been a success. I‚Äôve received lots of positive feedback about this from the‚Ä¶">
    <link rel="shortcut icon" href="/favicon.png" />

    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "kozb6q2xjn");
    </script>    

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="Toggle Menu">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu_fe2816fc44d850d2.jpg" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ü´°</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">HEUSSER.PRO</a></h1>
            <h2 class="site-description">Martin Heusser | M365 MVP</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://github.com/mozziemozz'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://x.com/@mozzeph'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about-me/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>About Me</span>
            </a>
        </li>
        
        
        <li >
            <a href='/support-me/' >
                
                
                
                    <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-cup"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M5 11h14v-3h-14z" /><path d="M17.5 11l-1.5 10h-8l-1.5 -10" /><path d="M6 8v-1a2 2 0 0 1 2 -2h8a2 2 0 0 1 2 2v1" /><path d="M15 5v-2" /></svg>
                
                <span>Support Me</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/imprint/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-info-circle" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 12a9 9 0 1 0 18 0a9 9 0 0 0 -18 0" /><path d="M12 9h.01" /><path d="M11 12h1v4h1" /></svg>
                
                <span>Imprint</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>Dark Mode</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">Table of contents</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li>
      <ol>
        <li><a href="#new-features-and-improvements">New Features and Improvements</a>
          <ol>
            <li><a href="#localized--formatted-phonenumbers">Localized / Formatted Phone¬†Numbers</a></li>
            <li><a href="#write-back-teams-phone-number-to-entraid">Write back Teams Phone Number to Entra¬†ID</a></li>
            <li><a href="#previous-usercolumn">Previous User¬†Column</a></li>
            <li><a href="#unassigned-routingrules">Unassigned Routing¬†Rules</a></li>
            <li><a href="#improved-number-assignment-capabilities">Improved Number Assignment Capabilities</a></li>
            <li><a href="#operator-column">Operator Column</a></li>
          </ol>
        </li>
        <li><a href="#updating-all-the-components">Updating All the Components</a>
          <ol>
            <li><a href="#add-newcolumns">Add New¬†Columns</a></li>
            <li><a href="#add-the-phonenumbers-python-package-to-the-automation-account">Add the phonenumbers Python Package to the Automation Account</a></li>
            <li><a href="#add-automation-variables-to-automation-account">Add Automation Variables to Automation Account</a></li>
            <li><a href="#add-operator-info-to-your-direct-routingnumbers">Add Operator info to your Direct Routing¬†Numbers</a></li>
            <li><a href="#create-a-pythonrunbook">Create a Python¬†Runbook</a></li>
            <li><a href="#setup-a-managed-identity-and-permissions">Setup a Managed Identity and Permissions</a></li>
            <li><a href="#update-the-mainrunbook">Update the Main¬†Runbook</a></li>
            <li><a href="#update-theflow">Update the¬†Flow</a></li>
            <li><a href="#update-the-flow-trigger-condition">Update the Flow Trigger Condition</a></li>
          </ol>
        </li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/phone-numbers/" >
                Phone Numbers
            </a>
        
            <a href="/categories/microsoft-teams/" >
                Microsoft Teams
            </a>
        
            <a href="/categories/azure-automation/" >
                Azure Automation
            </a>
        
            <a href="/categories/microsoft-lists/" >
                Microsoft Lists
            </a>
        
            <a href="/categories/sharepoint/" >
                SharePoint
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/teams-phone-number-management-list-part-3-e083a320004d/">Teams Phone Number Management List Part 3</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            I think it‚Äôs safe to say by now that this project has been a success. I‚Äôve received lots of positive feedback about this from the‚Ä¶
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Nov 16, 2023</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    8 minute read
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>I think it‚Äôs safe to say by now that this project has been a success. I‚Äôve received lots of positive feedback about this from the community.</p>
<p>That didn‚Äôt stop me from going even further and adding more features to this project though.</p>
<p><img src="/p/teams-phone-number-management-list-part-3-e083a320004d/1VrXnQeg6wj3KJYetSCXQ.png"
	width="1080"
	height="1080"
	srcset="/p/teams-phone-number-management-list-part-3-e083a320004d/1VrXnQeg6wj3KJYetSCXQ_hu_e1d6baea0fece90e.png 480w, /p/teams-phone-number-management-list-part-3-e083a320004d/1VrXnQeg6wj3KJYetSCXQ_hu_5322f738578521d.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="100"
		data-flex-basis="240px"
	
></p>
<h3 id="new-features-and-improvements">New Features and Improvements
</h3><h4 id="localized--formatted-phonenumbers">Localized / Formatted Phone¬†Numbers
</h4><p>As you may know by now, I consider myself a data driven guy. What I really dig about Teams phone is the fact that every number is a full E.164 number in every case. This kind of absoluteness provides great safety because each number is unique. Just as with user principal names or GUIDs, there‚Äôs no funny business going on.</p>
<p>That safety comes at the cost of readability though. If you‚Äôve seen <a class="link" href="/p/prettify-and-sync-teams-phone-numbers-to-azure-ad-e973755f83d5" >this</a> article before, then you already know that I came up with a solution to format phone numbers in their local format using Python.</p>
<p>The runbook logic powering the list can now also leverage Python to store the formatted phone number in an additional column. This way you always have both, the E.164 number and a prettified version of it readily available.</p>
<p><img src="/p/teams-phone-number-management-list-part-3-e083a320004d/1eH5p9VVDZ9zlnSfb0G9A.png"
	width="999"
	height="488"
	srcset="/p/teams-phone-number-management-list-part-3-e083a320004d/1eH5p9VVDZ9zlnSfb0G9A_hu_7022d15e6eeaa66.png 480w, /p/teams-phone-number-management-list-part-3-e083a320004d/1eH5p9VVDZ9zlnSfb0G9A_hu_f4668b82a68aff8d.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="204"
		data-flex-basis="491px"
	
></p>
<p>For US numbers or numbers from other countries such as Japan or Israel which typically use hyphens, you might have noticed that I‚Äôm removing the hyphens, even though they‚Äôre included after a number has been formatted using the phonenumbers library. I do this so that every number in the list contains only digits and a plus sign. Also, it‚Äôs how Teams Admin Center displays the numbers.</p>
<p><img src="/p/teams-phone-number-management-list-part-3-e083a320004d/1eq5k3nw1Nd6nFTUTjoxFQ.png"
	width="1670"
	height="123"
	srcset="/p/teams-phone-number-management-list-part-3-e083a320004d/1eq5k3nw1Nd6nFTUTjoxFQ_hu_bc50ccfd5441646d.png 480w, /p/teams-phone-number-management-list-part-3-e083a320004d/1eq5k3nw1Nd6nFTUTjoxFQ_hu_c7113618fa5125fc.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="1357"
		data-flex-basis="3258px"
	
></p>
<h4 id="write-back-teams-phone-number-to-entraid">Write back Teams Phone Number to Entra¬†ID
</h4><p>When you view a user‚Äôs profile card in Teams, Outlook or anywhere else in Microsoft 365, it doesn‚Äôt display the phone number which is actually configured as <strong>LineURI</strong> in Teams. Instead, the information is taken from Entra ID. I‚Äôve created a variable inside the runbook which controls if the <strong>BusinessPhones</strong> property of Entra ID users should be set to the assigned <strong>LineUri</strong> in Teams. I‚Äôll explain how to turn this <strong>on</strong> or <strong>off</strong> later in this article.</p>
<p>With the current permissions/scopes assigned to the Entra ID App registration, this only works for users which don‚Äôt have any administrator roles assigned in Entra ID. If a user has an admin role, you‚Äôll get an error.</p>
<p><img src="/p/teams-phone-number-management-list-part-3-e083a320004d/1raGaYRAkmtuYw6eis0Y9A.png"
	width="1677"
	height="150"
	srcset="/p/teams-phone-number-management-list-part-3-e083a320004d/1raGaYRAkmtuYw6eis0Y9A_hu_89f4a19b579804a0.png 480w, /p/teams-phone-number-management-list-part-3-e083a320004d/1raGaYRAkmtuYw6eis0Y9A_hu_8a85757495e0ae5a.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="1118"
		data-flex-basis="2683px"
	
></p>
<h4 id="previous-usercolumn">Previous User¬†Column
</h4><p>I‚Äôve added a new column which shows the UPN of the previous user/owner of a number after it has been removed. This is achieved by an update I made to the Power Automate Flow. Note that the flow will now also retain the value of the <strong>Comment</strong> column.</p>
<p><img src="/p/teams-phone-number-management-list-part-3-e083a320004d/1BEWqNsDCKrY0BOBbMc9tkg.png"
	width="1455"
	height="255"
	srcset="/p/teams-phone-number-management-list-part-3-e083a320004d/1BEWqNsDCKrY0BOBbMc9tkg_hu_9420fcbe4ade5972.png 480w, /p/teams-phone-number-management-list-part-3-e083a320004d/1BEWqNsDCKrY0BOBbMc9tkg_hu_5cfca7fa890d7c20.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="570"
		data-flex-basis="1369px"
	
></p>
<p>The reason for this column is that you have a better overview over who has previously used a number. I‚Äôm sure you don‚Äôt want to assign the previous CEO‚Äôs number to a new intern.</p>
<h4 id="unassigned-routingrules">Unassigned Routing¬†Rules
</h4><p>When people leave, we sometimes want to forward their unassigned number to another person in the company or to the main number. This is done by routing rules. But do we typically remember or even know that such rules have been created in the past‚Ä¶? Now we do!</p>
<p><img src="/p/teams-phone-number-management-list-part-3-e083a320004d/1mazY1aTB8fOWSqHcKsnSrA.png"
	width="2160"
	height="518"
	srcset="/p/teams-phone-number-management-list-part-3-e083a320004d/1mazY1aTB8fOWSqHcKsnSrA_hu_b4080f47867d04a3.png 480w, /p/teams-phone-number-management-list-part-3-e083a320004d/1mazY1aTB8fOWSqHcKsnSrA_hu_95ed7411c80aaf45.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="416"
		data-flex-basis="1000px"
	
></p>
<p>Every number is checked against all routing rules a tenant has configured and if there are any matches, they‚Äôre reflected on the list. The name of the matching rule gets stored in the <strong>User Name</strong> column. (Because this column isn‚Äôt used for the flow trigger condition.)</p>
<p>This even works if a number is reserved. In this case, the status will be changed to <strong>Reserved (Routing Rule)</strong>.</p>
<p><img src="/p/teams-phone-number-management-list-part-3-e083a320004d/1nLAAAS1BoTH5RfGGN788Q.png"
	width="1767"
	height="615"
	srcset="/p/teams-phone-number-management-list-part-3-e083a320004d/1nLAAAS1BoTH5RfGGN788Q_hu_47c0c548165f9e87.png 480w, /p/teams-phone-number-management-list-part-3-e083a320004d/1nLAAAS1BoTH5RfGGN788Q_hu_2585d3cded3f7066.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="287"
		data-flex-basis="689px"
	
></p>
<h4 id="improved-number-assignment-capabilities">Improved Number Assignment Capabilities
</h4><p>I‚Äôve also made some improvements to assigning numbers. If a number has a status of <strong>Reserved (Routing Rule)</strong> or <strong>Assignment Error</strong>, the script will try to assign the number as well. In the case of an assignment error, the script will try to assign the number again with each new job. This is helpful in scenarios where e.g. a license hasn‚Äôt been assigned yet.</p>
<p>Furthermore, you can now also reserve a number and enter the user‚Äôs UPN in the <strong>User Principal Name</strong> column. This is great if the account does not exist yet (so you can‚Äôt fill in the <strong>User Profile</strong>) but you already know the UPN of a soon to be created user. All of these changes make it easier for you to plan ahead and have the runbook take care of everything automatically, once a user has been created and licensed.</p>
<h4 id="operator-column">Operator Column
</h4><p>Last but not least, the list now also displays the name of the <strong>Operator</strong>. This works for all types, including <strong>Direct Routing</strong>. You will have to manually list the operator name for each Direct Routing number in your source CSV though.</p>
<p><img src="/p/teams-phone-number-management-list-part-3-e083a320004d/1uGIXZRh99eE0prMLPkLnA.png"
	width="1874"
	height="612"
	srcset="/p/teams-phone-number-management-list-part-3-e083a320004d/1uGIXZRh99eE0prMLPkLnA_hu_16931b902547c67.png 480w, /p/teams-phone-number-management-list-part-3-e083a320004d/1uGIXZRh99eE0prMLPkLnA_hu_ca26602676017de3.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="306"
		data-flex-basis="734px"
	
></p>
<h3 id="updating-all-the-components">Updating All the Components
</h3><p>I will most likely update the deployment script at some point to deploy everything from scratch including all the updates. If I can find enough time, I may also create an update script to update an existing deployment.</p>
<p>But today, I‚Äôll show you how to implement all the changes manually in an existing deployment which consists of an Azure automation account, a list, a flow and your local source files.</p>
<p><strong>To do these steps, you should have followed and deployed everything as described in</strong> <a class="link" href="/p/teams-phone-number-management-on-a-budget-e25d53f65caf" ><strong>this</strong></a> <strong>article and implemented all the updates described in</strong> <a class="link" href="/p/teams-phone-number-management-list-part-2-b5385e348a3a" ><strong>this</strong></a> <strong>article.</strong></p>
<h4 id="add-newcolumns">Add New¬†Columns
</h4><p>Add the following columns to the SharePoint list. All columns must be of type <strong>text</strong>.</p>
<ul>
<li>Comment</li>
<li>Previous User</li>
<li>Operator</li>
<li>Phone Number</li>
</ul>
<h4 id="add-the-phonenumbers-python-package-to-the-automation-account">Add the phonenumbers Python Package to the Automation Account
</h4><p>Go to <a class="link" href="https://pypi.org/project/phonenumbers/#files"  target="_blank" rel="noopener"
    >this</a> website and download the built distribution (*.whl) file to your PC. Then go to your automation account in Azure Portal and upload the file under <strong>Python packages</strong>.</p>
<p><img src="/p/teams-phone-number-management-list-part-3-e083a320004d/1g7hFFDAp9c6HwdMFUIimw.png"
	width="1298"
	height="655"
	srcset="/p/teams-phone-number-management-list-part-3-e083a320004d/1g7hFFDAp9c6HwdMFUIimw_hu_da60db5a0d3062c8.png 480w, /p/teams-phone-number-management-list-part-3-e083a320004d/1g7hFFDAp9c6HwdMFUIimw_hu_90f9106826f60567.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="198"
		data-flex-basis="475px"
	
></p>
<h4 id="add-automation-variables-to-automation-account">Add Automation Variables to Automation Account
</h4><p>Add the following variables to your automation account. Since you‚Äôll need to enter a value, just type a dot (‚Äú.‚Äù). Leave the integer value at 0.</p>
<ul>
<li>TeamsPhoneNumberOverview_AllCsOnlineNumbers (String)</li>
<li>TeamsPhoneNumberOverview_PrettyNumbers (String)</li>
<li>TeamsPhoneNumberOverview_TotalNumberCount (Integer)</li>
</ul>
<p><img src="/p/teams-phone-number-management-list-part-3-e083a320004d/1A6uNqGeSwBjpEuMGTuhw.png"
	width="1524"
	height="842"
	srcset="/p/teams-phone-number-management-list-part-3-e083a320004d/1A6uNqGeSwBjpEuMGTuhw_hu_50edc387662a538b.png 480w, /p/teams-phone-number-management-list-part-3-e083a320004d/1A6uNqGeSwBjpEuMGTuhw_hu_7f11e91cb8c7947b.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="180"
		data-flex-basis="434px"
	
></p>
<h4 id="add-operator-info-to-your-direct-routingnumbers">Add Operator info to your Direct Routing¬†Numbers
</h4><p>If you have direct routing numbers, you‚Äôll need to update your source list. The old structure only had one column called <strong>PhoneNumber</strong>. Now there‚Äôs <strong>PhoneNumber</strong> and <strong>Operator</strong>.</p>
<p>PhoneNumber;Operator<br>
4144520xxxx;Test Provider 1<br>
4144512xxxx;Test Provider 2<br>
4144512xxxx;Test Provider 3</p>
<p>Place your updated CSV in¬†<code>.\Resources\DirectRoutingNumbers-V2.csv</code> and then run <a class="link" href="https://github.com/mozziemozz/TeamsPhoneAutomation/blob/main/Setup/UpdateDirectRoutingNumbers-V2.ps1"  target="_blank" rel="noopener"
    >this</a> script to update your automation variable in Azure.</p>
<p>Alternatively, you can also run the below code and paste the content into your <code>TeamsPhoneNumberOverview_DirectRoutingNumbers</code> automation variable.</p>
<p>&ldquo;&rsquo;&rdquo; + (Import-Csv -Path .\Resources\DirectRoutingNumbers-V2.csv -Delimiter &ldquo;;&rdquo; | ConvertTo-Json | Out-String) + &ldquo;&rsquo;&rdquo; | Set-Clipboard</p>
<h4 id="create-a-pythonrunbook">Create a Python¬†Runbook
</h4><p>Go to your runbooks in your automation account and click <strong>Create a runbook</strong>. Name it <code>Format-TeamsPhoneNumbers</code> and choose <strong>Python</strong> as runbook type and <strong>3.10 (preview)</strong> as runtime version.</p>
<p><img src="/p/teams-phone-number-management-list-part-3-e083a320004d/1rgIq7gWJ29Wa9rBctif0A.png"
	width="1226"
	height="590"
	srcset="/p/teams-phone-number-management-list-part-3-e083a320004d/1rgIq7gWJ29Wa9rBctif0A_hu_6d39c1ba538bfa2.png 480w, /p/teams-phone-number-management-list-part-3-e083a320004d/1rgIq7gWJ29Wa9rBctif0A_hu_1adbd065aeddfe1b.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="207"
		data-flex-basis="498px"
	
></p>
<p>Grab <a class="link" href="https://github.com/mozziemozz/TeamsPhoneAutomation/blob/main/Functions/Format-TeamsPhoneNumbers.py"  target="_blank" rel="noopener"
    >this</a> code and paste it into the Azure portal. Save and publish the runbook.</p>
<h4 id="setup-a-managed-identity-and-permissions">Setup a Managed Identity and Permissions
</h4><p>Every time the main runbook runs, it will check if the total number count is still the same by comparing the current count to the count of the previous job which is stored in the <strong>TeamsPhoneNumberOverview_TotalNumberCount</strong> variable. If the count of numbers is different compared to the previous job, the main runbook will start the python runbook. The python runbook will use the phonenumbers library to format all your phone numbers to their localized format.</p>
<p>However, we must first allow the runbook to start another runbook job using a managed identity. In the automation account, go to <strong>Identity</strong> and flip the toggle switch for <strong>System assigned</strong> (managed identity) to <strong>On</strong>. Then click <strong>Save</strong>.</p>
<p><img src="/p/teams-phone-number-management-list-part-3-e083a320004d/1EDBRytpBpi8HYFN2kwiLdA.png"
	width="2113"
	height="500"
	srcset="/p/teams-phone-number-management-list-part-3-e083a320004d/1EDBRytpBpi8HYFN2kwiLdA_hu_d7e0811a4bd90c1b.png 480w, /p/teams-phone-number-management-list-part-3-e083a320004d/1EDBRytpBpi8HYFN2kwiLdA_hu_c36238ca86dbb4ce.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="422"
		data-flex-basis="1014px"
	
></p>
<p>Click <strong>Azure role assignments</strong> and then <strong>Add role assignment (Preview)</strong>. Set the scope to <strong>Resource group</strong>, select your subscription and resource group and choose <strong>Automation Operator</strong> as role.</p>
<p><img src="/p/teams-phone-number-management-list-part-3-e083a320004d/1gnhE04XQSUDcagh8wASow.png"
	width="1256"
	height="504"
	srcset="/p/teams-phone-number-management-list-part-3-e083a320004d/1gnhE04XQSUDcagh8wASow_hu_4dea5d254f3b494f.png 480w, /p/teams-phone-number-management-list-part-3-e083a320004d/1gnhE04XQSUDcagh8wASow_hu_596ddc1f1398854.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="249"
		data-flex-basis="598px"
	
></p>
<p>Click <strong>Save</strong>.</p>
<h4 id="update-the-mainrunbook">Update the Main¬†Runbook
</h4><p>Replace the code in the <strong>TeamsPhoneOverview</strong> runbook with <a class="link" href="https://github.com/mozziemozz/TeamsPhoneAutomation/blob/main/Scripts/TeamsPhoneNumberOverview%20-V2.ps1"  target="_blank" rel="noopener"
    >this</a> code. <strong>Make sure to change the</strong> <code>**$localTestMode**</code> <strong>variable to</strong> <code>**$false**</code> <strong>before you save and publish the runbook. Also update the names of your automation account and resource group on lines 95‚Äì97.</strong></p>
<p><img src="/p/teams-phone-number-management-list-part-3-e083a320004d/1Szx2vDwh4929HXR4DPp4MA.png"
	width="522"
	height="79"
	srcset="/p/teams-phone-number-management-list-part-3-e083a320004d/1Szx2vDwh4929HXR4DPp4MA_hu_1f096338280888cb.png 480w, /p/teams-phone-number-management-list-part-3-e083a320004d/1Szx2vDwh4929HXR4DPp4MA_hu_3d29e348e84512f4.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="660"
		data-flex-basis="1585px"
	
></p>
<p>If you don‚Äôt want to write back user‚Äôs <strong>LineURIs</strong> to Entra ID <strong>BusinessPhones</strong>, change <code>syncTeamsPhoneNumbersToEntraIdBusinessPhones</code> to <code>$false</code> on line 6.</p>
<p><img src="/p/teams-phone-number-management-list-part-3-e083a320004d/1MFWbPjRVqUjXwHAw5HdDZg.png"
	width="415"
	height="20"
	srcset="/p/teams-phone-number-management-list-part-3-e083a320004d/1MFWbPjRVqUjXwHAw5HdDZg_hu_864f8be38dfd4cf1.png 480w, /p/teams-phone-number-management-list-part-3-e083a320004d/1MFWbPjRVqUjXwHAw5HdDZg_hu_b92fbcc2dcdcdffd.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="2075"
		data-flex-basis="4980px"
	
></p>
<h4 id="update-theflow">Update the¬†Flow
</h4><p>Finally, go to your flow and make the last small changes. In here, add the values for the new columns that we created. If you need a refresher, this is the part where the flow deletes numbers which were unassigned because there‚Äôs no way to remove the user profile. We then recreate the list entry with all the information <strong>except</strong> the <strong>User Profile Claims</strong>. Because the user profile stays, we can use the <strong>User Profile Email</strong> and write it to the <strong>Previous User</strong> column. Comments in the comment field will also be added again, once a deleted entry has been recreated.</p>
<p><img src="/p/teams-phone-number-management-list-part-3-e083a320004d/1BvLOlUfRBHAr1IFNxm7tYg.png"
	width="929"
	height="1374"
	srcset="/p/teams-phone-number-management-list-part-3-e083a320004d/1BvLOlUfRBHAr1IFNxm7tYg_hu_9f1ae3b393ae527b.png 480w, /p/teams-phone-number-management-list-part-3-e083a320004d/1BvLOlUfRBHAr1IFNxm7tYg_hu_8dfa75a1b319817b.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="67"
		data-flex-basis="162px"
	
></p>
<h4 id="update-the-flow-trigger-condition">Update the Flow Trigger Condition
</h4><p>The current trigger condition checks if a user‚Äôs email address is equal to the user principal name. As much as I want this to always be the case, the reality is sometimes different. Some readers have reported that their Flow gets stuck in an infinite trigger loop because of that.</p>
<p>I‚Äôve slightly tweaked the trigger condition, so it doesn‚Äôt compare the email address to the UPN anymore. Instead, the UPN is extracted from the user profile using a split operation and then compared to the UPN from the list column. Here‚Äôs the <a class="link" href="https://github.com/mozziemozz/TeamsPhoneAutomation/blob/main/Resources/FlowTriggerConditionRobustUpn.txt"  target="_blank" rel="noopener"
    >updated trigger condition</a>. Make sure to update it on your flow as well as it will be more robust than the old one.</p>
<p>@or(<br>
and(<br>
not(equals(triggerOutputs()?[&lsquo;body/User_x0020_Principal_x0020_Name&rsquo;], &lsquo;Unassigned&rsquo;)),<br>
not(contains(triggerBody(), &lsquo;UserProfile&rsquo;))<br>
),<br>
not(equals(toLower(triggerOutputs()?[&lsquo;body/User_x0020_Principal_x0020_Name&rsquo;]), split(toLower(triggerOutputs()?[&lsquo;body/UserProfile&rsquo;][&lsquo;Claims&rsquo;]),&rsquo;|&rsquo;)[2])),<br>
and(<br>
contains(triggerBody(), &lsquo;UserProfile&rsquo;),<br>
not(equals(triggerOutputs()?[&lsquo;body/User_x0020_Principal_x0020_Name&rsquo;], &lsquo;Unassigned&rsquo;)),<br>
not(contains(triggerBody(), &lsquo;TeamsAdminCenter&rsquo;))<br>
)<br>
)</p>
<p>That‚Äôs all. If you‚Äôve followed all the steps, you should now be able to make use of all the new features I created. Like I said, I‚Äôll try to find some time and create a new deployment script which deploys the version 2 from scratch. I hope you enjoy the list as much as I do.</p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Related content</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/teams-phone-number-management-list-part-2-b5385e348a3a/">
        
        

        <div class="article-details">
            <h2 class="article-title">Teams Phone Number Management List Part 2</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/teams-phone-number-management-on-a-budget-e25d53f65caf/">
        
        

        <div class="article-details">
            <h2 class="article-title">Teams Phone Number Management on a Budget</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/update-teams-shared-voicemail-for-basic-call-flows-fix-call-back-links-l4gwdggabxl8/">
        
        
            <div class="article-image">
                <img src="/p/update-teams-shared-voicemail-for-basic-call-flows-fix-call-back-links-l4gwdggabxl8/cover.4f5dc5f4c69fd51ebdd89114b3a5e2a7_hu_3bb00ff1f2be8422.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Update: Teams Shared Voicemail for Basic Call Flows (Fix Call Back Links)"
                        data-key="/update:-teams-shared-voicemail-for-basic-call-flows-(fix-call-back-links)-l4gwdggabxl8" 
                        data-hash="md5-T13F9Maf1R692JEUs6Xipw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Update: Teams Shared Voicemail for Basic Call Flows (Fix Call Back Links)</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/minimize-downtime-when-porting-numbers-to-microsoft-teams-calling-plans-ix1vcwlfjbyr/">
        
        

        <div class="article-details">
            <h2 class="article-title">Minimize Downtime when Porting Numbers to Microsoft Teams Calling Plans</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/teams-shared-voicemail-for-basic-call-flows-1qru2qqlx0ju/">
        
        
            <div class="article-image">
                <img src="/p/teams-shared-voicemail-for-basic-call-flows-1qru2qqlx0ju/cover.f4838225804739dad554c1b9648b2b8d_hu_2148ea1b70167764.png" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post Teams Shared Voicemail for Basic Call Flows"
                        data-key="/teams-shared-voicemail-for-basic-call-flows-1qru2qqlx0ju" 
                        data-hash="md5-9IOCJYBHOdrVVMG5ZIsrjQ==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">Teams Shared Voicemail for Basic Call Flows</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <div class="disqus-container">
    <div id="disqus_thread"></div>
<script>
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "heusser-pro" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

<style>
    .disqus-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
    }
</style>

<script>
    window.addEventListener('onColorSchemeChange', (e) => {
        if (typeof DISQUS == 'object') {
            DISQUS.reset({
                reload: true
            });
        }
    })
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2022 - 
        
        2025 HEUSSER.PRO
    </section>
    
    <section class="powerby">
        
            Hosted on GitHub Pages <br/>
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        Theme <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> designed by <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a>
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>

