<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Proof of Concept on HEUSSER.PRO</title>
        <link>https://heusser.pro/categories/proof-of-concept/</link>
        <description>Recent content in Proof of Concept on HEUSSER.PRO</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>en-us</language>
        <lastBuildDate>Wed, 05 Jun 2024 19:24:44 +0000</lastBuildDate><atom:link href="https://heusser.pro/categories/proof-of-concept/index.xml" rel="self" type="application/rss+xml" /><item>
        <title>Microsoft Graph: Get an Access Token from a PowerShell Session</title>
        <link>https://heusser.pro/p/microsoft-graph-get-an-access-token-from-an-established-powershell-session-zv37e1xmxr86/</link>
        <pubDate>Wed, 05 Jun 2024 19:24:44 +0000</pubDate>
        
        <guid>https://heusser.pro/p/microsoft-graph-get-an-access-token-from-an-established-powershell-session-zv37e1xmxr86/</guid>
        <description>&lt;p&gt;Authentication with the Microsoft Graph PowerShell SDK is pretty easy. All you have to do to establish a session is to run &lt;code&gt;Connect-MgGraph&lt;/code&gt;. After that, you can use all Cmdlets for which you&amp;rsquo;ve installed the necessary modules. It&amp;rsquo;s no secret that not all Cmdlets are as well documented as the REST API itself and in rare cases, the PowerShell Cmdlets might even have some limitations compared to their REST counterparts. In such cases, you can usually just use the universal &lt;a class=&#34;link&#34; href=&#34;https://learn.microsoft.com/en-us/powershell/module/microsoft.graph.authentication/invoke-mggraphrequest?view=graph-powershell-1.0&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;&lt;code&gt;Invoke-MgGraphRequest&lt;/code&gt;&lt;/a&gt; Cmdlet without providing your own access token. This Cmdlet will use the same authentication like any other &lt;strong&gt;&lt;code&gt;Mg*&lt;/code&gt;&lt;/strong&gt; Cmdlet.&lt;/p&gt;
&lt;p&gt;This is how Microsoft describes the &lt;code&gt;Invoke-MgGraphRequest&lt;/code&gt; Cmdlet on Microsoft Learn:&lt;/p&gt;
&lt;p&gt;&lt;em&gt;Invoke-MgGraphRequest issues REST API requests to the Graph API. It works for any Graph API if you know the REST URI, method, and optional body parameter. This command is especially useful for accessing APIs for which there isn&amp;rsquo;t an equivalent cmdlet yet.&lt;/em&gt;&lt;/p&gt;
&lt;p&gt;Note that there is also an alias called &lt;code&gt;Invoke-GraphRequest&lt;/code&gt; for this Cmdlet. A perfect example of where you would need &lt;code&gt;Invoke-MgGraphRequest&lt;/code&gt; is uploading a small file to SharePoint. I recently published a script example making use of this method &lt;a class=&#34;link&#34; href=&#34;https://heusser.pro/p/powershell-script-example-upload-small-files-via-microsoft-graph-z45tbunyoa85&#34; &gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;h2 id=&#34;what-is-mgcontext&#34;&gt;What is MgContext?&lt;/h2&gt;
&lt;p&gt;By running &lt;code&gt;Get-MgContext&lt;/code&gt; you can get some information about the current session. Unfortunately, this doesn&amp;rsquo;t reveal any kind of tokens used for requests to the Graph API. Then again, this is most likely by design, because tokens should always be handled with care.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/microsoft-graph-get-an-access-token-from-an-established-powershell-session-zv37e1xmxr86/image.png&#34;
	width=&#34;1734&#34;
	height=&#34;957&#34;
	srcset=&#34;https://heusser.pro/p/microsoft-graph-get-an-access-token-from-an-established-powershell-session-zv37e1xmxr86/image_hu754d71b654ea23e9f5c87bfe16932a68_1172389_480x0_resize_box_3.png 480w, https://heusser.pro/p/microsoft-graph-get-an-access-token-from-an-established-powershell-session-zv37e1xmxr86/image_hu754d71b654ea23e9f5c87bfe16932a68_1172389_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
		alt=&#34;Output of Get-MgContext&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;181&#34;
		data-flex-basis=&#34;434px&#34;
	
&gt;&lt;/p&gt;
&lt;h2 id=&#34;what-if-you-need-a-token-anyway&#34;&gt;What if you need a token anyway?&lt;/h2&gt;
&lt;p&gt;One option is to provide a client Id and a client secret and make a request to &lt;strong&gt;&lt;a class=&#34;link&#34; href=&#34;https://login.microsoftonline.com/%7bYour&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;https://login.microsoftonline.com/{Your&lt;/a&gt; Tenant Name}/oauth2/v2.0/token&lt;/strong&gt;. If I want to do that, I always come back to this blog post on &lt;a class=&#34;link&#34; href=&#34;https://adamtheautomator.com/powershell-graph-api/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;adamtheautomator.com&lt;/a&gt;. But when I do that, I also want to call the REST API directly for all requests that the script I&amp;rsquo;m working on is doing. In my case, I &lt;strong&gt;want&lt;/strong&gt; to use the SDK and only &lt;strong&gt;need&lt;/strong&gt; to call the API directly for one specific request.&lt;/p&gt;
&lt;p&gt;I recently was working on something where neither the &lt;code&gt;Get-Mg*&lt;/code&gt; nor the &lt;code&gt;Invoke-MgGraphRequest&lt;/code&gt; were working. I wanted to fetch a profile picture of an Entra ID user but wanted to keep the image in memory and not save it to disk. Both the Cmdlets, &lt;code&gt;Get-MgUserPhotoContent&lt;/code&gt; and &lt;code&gt;Invoke-MgGraphRequest&lt;/code&gt; expected a value for an output file though. I know I could have just used a temporary file but if I had given up this easily, I wouldn&amp;rsquo;t have discovered how to get an access token from a Microsoft Graph PowerShell session.&lt;/p&gt;
&lt;p&gt;When I was testing the &lt;code&gt;Invoke-MgGraphRequest&lt;/code&gt; Cmdlet, I noticed that there were different accepted values for the parameter &lt;code&gt;-OutputType&lt;/code&gt;. One of the accepted values is &lt;strong&gt;HttpResponseMessage&lt;/strong&gt; and if you select this, Graph will return the access token in the HTTP response.&lt;/p&gt;
&lt;p&gt;This is the Graph URI/endpoint that I was using:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$mgRequest&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;Invoke-MgGraphRequest&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-Uri&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;https://graph.microsoft.com/v1.0/users/&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;$(&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$userId&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;/photo/&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;`$&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;value&amp;#34;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-ContentType&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;image/jpeg&amp;#34;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-OutputType&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;HttpResponseMessage&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/microsoft-graph-get-an-access-token-from-an-established-powershell-session-zv37e1xmxr86/image-1.png&#34;
	width=&#34;1734&#34;
	height=&#34;957&#34;
	srcset=&#34;https://heusser.pro/p/microsoft-graph-get-an-access-token-from-an-established-powershell-session-zv37e1xmxr86/image-1_hu1f3a68c31f9f6d09b32402eaf728180d_992335_480x0_resize_box_3.png 480w, https://heusser.pro/p/microsoft-graph-get-an-access-token-from-an-established-powershell-session-zv37e1xmxr86/image-1_hu1f3a68c31f9f6d09b32402eaf728180d_992335_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
		alt=&#34;Graph access token retrieved using Invoke-MgGraphRequest&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;181&#34;
		data-flex-basis=&#34;434px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;To access the token directly, you can use: &lt;code&gt;$mgRequest.RequestMessage.Headers.Authorization.Parameter&lt;/code&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/microsoft-graph-get-an-access-token-from-an-established-powershell-session-zv37e1xmxr86/image-2.png&#34;
	width=&#34;1734&#34;
	height=&#34;957&#34;
	srcset=&#34;https://heusser.pro/p/microsoft-graph-get-an-access-token-from-an-established-powershell-session-zv37e1xmxr86/image-2_hu481e61ac623856a0fe9b6eff6bbbfa8f_621204_480x0_resize_box_3.png 480w, https://heusser.pro/p/microsoft-graph-get-an-access-token-from-an-established-powershell-session-zv37e1xmxr86/image-2_hu481e61ac623856a0fe9b6eff6bbbfa8f_621204_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
		alt=&#34;The access token is now stored in a variable&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;181&#34;
		data-flex-basis=&#34;434px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;If you want to build your own Authorization header to call the API directly without first requesting a dedicated token from &lt;strong&gt;&lt;a class=&#34;link&#34; href=&#34;https://login.microsoftonline.com&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;https://login.microsoftonline.com&lt;/a&gt;&lt;/strong&gt; you can use this code:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$authHeader&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;vm&#34;&gt;@&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;n&#34;&gt;Authorization&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;$(&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$mgRequest&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;RequestMessage&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;Headers&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;Authorization&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;Scheme&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt; &lt;/span&gt;&lt;span class=&#34;p&#34;&gt;$(&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$mgRequest&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;RequestMessage&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;Headers&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;Authorization&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Parameter&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;&amp;#34;&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$profilePhoto&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nb&#34;&gt;Invoke-WebRequest&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-Uri&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;https://graph.microsoft.com/v1.0/users/&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;$(&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$userId&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;/photo/&lt;/span&gt;&lt;span class=&#34;se&#34;&gt;`$&lt;/span&gt;&lt;span class=&#34;s2&#34;&gt;value&amp;#34;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-Headers&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$authHeader&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;).&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;Content&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;This allowed me to retrieve the profile photo as a byte array without saving it to disk first.&lt;/p&gt;
&lt;h2 id=&#34;summary&#34;&gt;Summary&lt;/h2&gt;
&lt;p&gt;This is a very niche use case but I&amp;rsquo;m glad that I discovered how to get an access token from an already authenticated Microsoft Graph PowerShell session. I&amp;rsquo;m sure that this will come in handy again some day and I hope that it will come in handy for you some day as well. I also published the entire example script including helpful comments in one of my GitHub &lt;a class=&#34;link&#34; href=&#34;https://github.com/mozziemozz/TeamsPhoneAutomation/blob/main/Scripts/MicrosoftGraph/Authentication/Get-AccessTokenFromEstablishedMgSession.ps1&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;repositories&lt;/a&gt;.&lt;/p&gt;
</description>
        </item>
        <item>
        <title>Automate Setting Work Location in Teams/Outlook [PoC]</title>
        <link>https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/</link>
        <pubDate>Sat, 08 Jul 2023 08:50:29 +0000</pubDate>
        
        <guid>https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/</guid>
        <description>&lt;p&gt;Warning: This is another one of those proof of concept &lt;em&gt;“because I can”&lt;/em&gt; kind of things. I’m going to do some things which shouldn’t be done in production. It was just for the fun of it.&lt;/p&gt;
&lt;p&gt;Microsoft recently released the new &lt;strong&gt;Work location&lt;/strong&gt; feature in Teams and the new Outlook/Outlook on the web. This allows users to set their work location so co-workers can see if their colleagues are working in the &lt;strong&gt;office&lt;/strong&gt; or &lt;strong&gt;remotely&lt;/strong&gt; on any specific day. You can find more information &lt;a class=&#34;link&#34; href=&#34;https://techcommunity.microsoft.com/t5/microsoft-365-blog/coordination-is-the-key-to-spontaneity-with-these-features-in/ba-p/3814143&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;here&lt;/a&gt; and &lt;a class=&#34;link&#34; href=&#34;https://support.microsoft.com/en-au/office/show-your-hybrid-work-location-availability-to-meet-work-hours-and-more-c861198d-f82e-41d7-88ec-c2e716be5ede&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;I was extremely disappointed when I learned that there is no support for Microsoft Graph or Power Automate yet, so we could automatically set this each day based on e.g., an IP address or even through geo-fencing on a mobile device.&lt;/p&gt;
&lt;p&gt;Off I went to try and find a way to do it anyway. First, I opened Teams in Microsoft Edge and used the browser dev tools to see what kind of requests are sent to which APIs when the work location is changed.&lt;/p&gt;
&lt;p&gt;Here we can see that a &lt;strong&gt;PUT&lt;/strong&gt; request is made to &lt;code&gt;https://presence.teams.microsoft.com/v1/me/workLocation&lt;/code&gt; when the location is edited.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1Ylwjq2bqJUws0kO0nI6SA.png&#34;
	width=&#34;1435&#34;
	height=&#34;902&#34;
	srcset=&#34;https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1Ylwjq2bqJUws0kO0nI6SA_hub93a2b6111ad17327cf969152c680b31_114987_480x0_resize_box_3.png 480w, https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1Ylwjq2bqJUws0kO0nI6SA_hub93a2b6111ad17327cf969152c680b31_114987_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;159&#34;
		data-flex-basis=&#34;381px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;In this case the location was cleared with the following JSON payload.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1TUd3bgXiIp7hyKQIWLDTdA.png&#34;
	width=&#34;975&#34;
	height=&#34;278&#34;
	srcset=&#34;https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1TUd3bgXiIp7hyKQIWLDTdA_hued347d18e67613c9cd99f725b4dc1f6d_37427_480x0_resize_box_3.png 480w, https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1TUd3bgXiIp7hyKQIWLDTdA_hued347d18e67613c9cd99f725b4dc1f6d_37427_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;350&#34;
		data-flex-basis=&#34;841px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;The value &lt;strong&gt;0&lt;/strong&gt; clears the location. &lt;strong&gt;1&lt;/strong&gt; is used to set it to &lt;strong&gt;Office&lt;/strong&gt; and &lt;strong&gt;2&lt;/strong&gt; will map to &lt;strong&gt;Remote.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Next, I inspected the token needed for this request with the help of &lt;a class=&#34;link&#34; href=&#34;https://jwt.ms&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;jwt.ms&lt;/a&gt;.&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;{  
  &amp;quot;typ&amp;quot;: &amp;quot;JWT&amp;quot;,  
  &amp;quot;nonce&amp;quot;: &amp;quot;xxxxxxxxxxxxxxxxxxxxxxxxx&amp;quot;,  
  &amp;quot;alg&amp;quot;: &amp;quot;RS256&amp;quot;,  
  &amp;quot;x5t&amp;quot;: &amp;quot;-xxxxxxxxxxxxxxxxxxxxxxxxx&amp;quot;,  
  &amp;quot;kid&amp;quot;: &amp;quot;-xxxxxxxxxxxxxxxxxxxxxxxxx&amp;quot;  
}.{  
  &amp;quot;aud&amp;quot;: &amp;quot;https://presence.teams.microsoft.com/&amp;quot;,  
  &amp;quot;iss&amp;quot;: &amp;quot;https://sts.windows.net/4bffbf87-53a0-4fce-b58b-4179cb3a3b7d/&amp;quot;,  
  &amp;quot;iat&amp;quot;: 1688763565,  
  &amp;quot;nbf&amp;quot;: 1688763565,  
  &amp;quot;exp&amp;quot;: 1688841846,  
  &amp;quot;acr&amp;quot;: &amp;quot;1&amp;quot;,  
  &amp;quot;aio&amp;quot;: &amp;quot;xxxxxxxxxxxxxxxxxxxxxxxxx&amp;quot;,  
  &amp;quot;amr&amp;quot;: [  
    &amp;quot;pwd&amp;quot;,  
    &amp;quot;mfa&amp;quot;  
  ],  
  &amp;quot;appid&amp;quot;: &amp;quot;5e3ce6c0-2b1f-4285-8d4b-75ee78787346&amp;quot;,  
  &amp;quot;appidacr&amp;quot;: &amp;quot;0&amp;quot;,  
  &amp;quot;family_name&amp;quot;: &amp;quot;Mozz&amp;quot;,  
  &amp;quot;given_name&amp;quot;: &amp;quot;Mozzie&amp;quot;,  
  &amp;quot;ipaddr&amp;quot;: &amp;quot;xxx.xxx.xxx.xxx&amp;quot;,  
  &amp;quot;name&amp;quot;: &amp;quot;Mozzism Admin&amp;quot;,  
  &amp;quot;oid&amp;quot;: &amp;quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&amp;quot;,  
  &amp;quot;puid&amp;quot;: &amp;quot;10032000330C6A66&amp;quot;,  
  &amp;quot;rh&amp;quot;: &amp;quot;xxxxxxxxxxxxxxxxxxxxxxxxx&amp;quot;,  
  &amp;quot;scp&amp;quot;: &amp;quot;user_impersonation&amp;quot;,  
  &amp;quot;sub&amp;quot;: &amp;quot;xxxxxxxxxxxxxxxxxxxxxxxxx&amp;quot;,  
  &amp;quot;tid&amp;quot;: &amp;quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&amp;quot;,  
  &amp;quot;unique_name&amp;quot;: &amp;quot;mozzie@mozzism.ch&amp;quot;,  
  &amp;quot;upn&amp;quot;: &amp;quot;mozzie@mozzism.ch&amp;quot;,  
  &amp;quot;uti&amp;quot;: &amp;quot;xxxxxxxxxxxxxxxxxxxxxxxxx&amp;quot;,  
  &amp;quot;ver&amp;quot;: &amp;quot;1.0&amp;quot;,  
  &amp;quot;xms_cc&amp;quot;: [  
    &amp;quot;CP1&amp;quot;  
  ],  
  &amp;quot;xms_ssm&amp;quot;: &amp;quot;1&amp;quot;  
}.[Signature]
&lt;/code&gt;&lt;/pre&gt;
&lt;h4 id=&#34;aadinternals&#34;&gt;AADInternals&lt;/h4&gt;
&lt;p&gt;Copying the token from the browser and using it to make a web request with PowerShell is easy. The hard thing was to figure out how I can obtain that token programmatically. Luckily, there’s this awesome PowerShell module called &lt;a class=&#34;link&#34; href=&#34;https://www.powershellgallery.com/packages/AADInternals/0.9.0&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;&lt;strong&gt;AADInternals&lt;/strong&gt;&lt;/a&gt; by one Dr. Nestori Syynimaa. This is an amazing resource to test almost anything related to Azure AD and Graph authentication.&lt;/p&gt;
&lt;p&gt;The documentation for this module can be found &lt;a class=&#34;link&#34; href=&#34;https://aadinternals.com/aadinternals/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;here&lt;/a&gt;. I discovered that the following command would give me a token for Teams.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$teamsToken&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;Get-AADIntAccessTokenForTeams&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;What’s really cool is that now, with PowerShell 7 the whole login process can be done through the CLI without any browser pop-ups! Even MFA is supported!&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1dsPmfR9rFSmCsWYKlb5mA.png&#34;
	width=&#34;1734&#34;
	height=&#34;957&#34;
	srcset=&#34;https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1dsPmfR9rFSmCsWYKlb5mA_hu57c1e88072b457ac988aef5100562695_436977_480x0_resize_box_3.png 480w, https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1dsPmfR9rFSmCsWYKlb5mA_hu57c1e88072b457ac988aef5100562695_436977_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;181&#34;
		data-flex-basis=&#34;434px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;Even though the audience for this token is &lt;a class=&#34;link&#34; href=&#34;https://api.spaces.skype.com&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;https://api.spaces.skype.com&lt;/a&gt; and not &lt;a class=&#34;link&#34; href=&#34;https://presence.teams.microsoft.com/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;https://presence.teams.microsoft.com&lt;/a&gt; it still works to change the work location in Teams.&lt;/p&gt;
&lt;p&gt;Because everything can be done through the CLI I wondered if I could pass the credentials and the MFA secret to the AADInternals functions so that the login process could be automated to be 100% unattended.&lt;/p&gt;
&lt;p&gt;After some trial and error, I had that figured out too. Not all functions of the AADInternals module are exposed to the user so the key is to make them available to your current PowerShell session by dot sourcing some of the *.ps1 files included in the module.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;9
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$functions&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;Get-ChildItem&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-Path&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;C:\\Program Files\\WindowsPowerShell\\Modules\\AADInternals\\0.9.0&amp;#34;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-Filter&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;\*.ps1&amp;#34;&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$functions&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$functions&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;|&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;Where-Object&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{$\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;Name&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-match&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;Teams&amp;#34;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-or&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;$\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;Name&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-match&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;AccessToken&amp;#34;&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-or&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;$\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;_&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;Name&lt;/span&gt; &lt;span class=&#34;o&#34;&gt;-match&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;CommonUtils&amp;#34;&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;k&#34;&gt;foreach&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;nv&#34;&gt;$function&lt;/span&gt; &lt;span class=&#34;k&#34;&gt;in&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$functions&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;{&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;    &lt;span class=&#34;p&#34;&gt;.&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$function&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;FullName&lt;/span&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;  
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;}&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;By executing this code which uses some of the not exposed functions from AADInternals, we can pass a credential object (and MFA secret) and then get an access token to write Teams presence.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;nv&#34;&gt;$teamsPresenceToken&lt;/span&gt; &lt;span class=&#34;p&#34;&gt;=&lt;/span&gt; &lt;span class=&#34;nb&#34;&gt;Prompt-Credentials&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-ClientId&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$ClientId&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-Resource&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;https://presence.teams.microsoft.com&amp;#34;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-Credentials&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$secureCreds&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-OTPSecretKey&lt;/span&gt; &lt;span class=&#34;nv&#34;&gt;$passwordDecrypted&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h4 id=&#34;credentials&#34;&gt;Credentials&lt;/h4&gt;
&lt;p&gt;I’ve put together a script which does everything for you. However, you must install the AADInternals module first and you also need to clone the repo from my &lt;a class=&#34;link&#34; href=&#34;https://github.com/mozziemozz/TeamsPhoneAutomation&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;GitHub&lt;/a&gt; account since it has dependencies on other functions.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;n&#34;&gt;git&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;clone&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;https&lt;/span&gt;&lt;span class=&#34;err&#34;&gt;:&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;//&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;github&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;com&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;mozziemozz&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;/&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;TeamsPhoneAutomation&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;git&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;Even though this was all part of some good Friday night hacking, we obviously don’t want to store the credentials and especially the MFA secret as plain text on our machines. Therefore, I’ve added a couple of &lt;a class=&#34;link&#34; href=&#34;https://github.com/mozziemozz/TeamsPhoneAutomation/blob/main/Modules/SecureCredsMgmt.ps1&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;functions&lt;/a&gt; to help handle encrypted credentials. We want to be better than &lt;a class=&#34;link&#34; href=&#34;https://www.theverge.com/2022/9/16/23356213/uber-hack-teen-slack-google-cloud-credentials-powershell&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;UBER&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;When encrypted credentials are stored on a Windows PC, they can only be decrypted using the same &lt;strong&gt;account&lt;/strong&gt; and the same &lt;strong&gt;machine&lt;/strong&gt; because of &lt;a class=&#34;link&#34; href=&#34;https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-identifiers&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;security identifiers&lt;/a&gt; (SID).&lt;/p&gt;
&lt;p&gt;If you don’t trust me, see for yourself. Here’ I’m retrieving the password I encrypted on my main PC using my user account.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1W628X8LBOfnUCpplMXMj4w.png&#34;
	width=&#34;1734&#34;
	height=&#34;957&#34;
	srcset=&#34;https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1W628X8LBOfnUCpplMXMj4w_hu6c0822f1e2f18d322b0568a75b2659c8_599321_480x0_resize_box_3.png 480w, https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1W628X8LBOfnUCpplMXMj4w_hu6c0822f1e2f18d322b0568a75b2659c8_599321_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;181&#34;
		data-flex-basis=&#34;434px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;I copied the file to a virtual machine where I’m logged in with the same user. This code will let you decrypt the password if the key matches.&lt;br&gt;
(I found this code years ago, unfortunately I don’t have the source anymore…)&lt;/p&gt;
&lt;pre&gt;&lt;code&gt;[Runtime.InteropServices.Marshal]::PtrToStringAuto([Runtime.InteropServices.Marshal]::SecureStringToBSTR((Get-Content -Path .\.local\SecureCreds\mozzie@mozzism.ch.txt | ConvertTo-SecureString))) | Out-String
&lt;/code&gt;&lt;/pre&gt;
&lt;p&gt;When I run this on another machine with the same logged in user, I get an error that the Key is invalid. Which is good.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1xHjGlNGoWxiJ3qTkRNsxBQ.png&#34;
	width=&#34;1758&#34;
	height=&#34;928&#34;
	srcset=&#34;https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1xHjGlNGoWxiJ3qTkRNsxBQ_huae7558fdf5fbe404f2179b835079b366_1073714_480x0_resize_box_3.png 480w, https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1xHjGlNGoWxiJ3qTkRNsxBQ_huae7558fdf5fbe404f2179b835079b366_1073714_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;189&#34;
		data-flex-basis=&#34;454px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;My Function &lt;code&gt;Get-MzzSecureCreds&lt;/code&gt; will automatically create a PS Credential Object when &lt;code&gt;-AdminUser &amp;quot;user@domain.com&amp;quot;&lt;/code&gt; is specified. The username will be set as file name, and it will also be used as the username of the credential object.&lt;/p&gt;
&lt;h4 id=&#34;the-finalscript&#34;&gt;The Final Script&lt;/h4&gt;
&lt;p&gt;Here’s the script to change your work location in Teams.&lt;/p&gt;
&lt;script src=&#34;https://gist.github.com/mozziemozz/bd60e4c77623b516333e329660e39142.js&#34;&gt;&lt;/script&gt;

&lt;p&gt;If you run it for the first time, you’ll need to provide the username and password and possibly the MFA secret of the user for which you want to change the work location.&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;At this point I want to make clear again that this is a proof of concept. Even though the credentials are encrypted, you should not store production passwords on the device and most importantly, you shouldn’t store the MFA secret in the same place as the password.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;You can determine if you’re working remotely or in the office by specifying either your local or public home/remote IP address.&lt;/p&gt;
&lt;p&gt;Since my private IP is &lt;strong&gt;192.168.127.117&lt;/strong&gt;, and I specified &lt;strong&gt;192.168.1.10&lt;/strong&gt; my work location is set to &lt;strong&gt;Office.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1H9Jn0x3GNJ1gglcfYmRg.png&#34;
	width=&#34;1734&#34;
	height=&#34;957&#34;
	srcset=&#34;https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1H9Jn0x3GNJ1gglcfYmRg_hu2c8b638c458bbce84759dbccf2722fbe_680907_480x0_resize_box_3.png 480w, https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1H9Jn0x3GNJ1gglcfYmRg_hu2c8b638c458bbce84759dbccf2722fbe_680907_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;181&#34;
		data-flex-basis=&#34;434px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;When I change the IP address to &lt;strong&gt;192.168.127.117&lt;/strong&gt; the work location is set to remote because that matches my local subnet.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1JCJNuJqCHz2FvGnYBkB0A.png&#34;
	width=&#34;1734&#34;
	height=&#34;957&#34;
	srcset=&#34;https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1JCJNuJqCHz2FvGnYBkB0A_hub0be134dccfead36822ec41a8a608fbe_638777_480x0_resize_box_3.png 480w, https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1JCJNuJqCHz2FvGnYBkB0A_hub0be134dccfead36822ec41a8a608fbe_638777_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;181&#34;
		data-flex-basis=&#34;434px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;In case your office and your home network both use the same private address space, you can use &lt;code&gt;-IpType Public&lt;/code&gt; and specify your home/remote public IP.&lt;/p&gt;
&lt;h4 id=&#34;the-result&#34;&gt;The Result&lt;/h4&gt;
&lt;p&gt;The updated work location is then visible in both Teams and Outlook.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1rgszjARcTFdFADtwPT9bUg.png&#34;
	width=&#34;490&#34;
	height=&#34;396&#34;
	srcset=&#34;https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1rgszjARcTFdFADtwPT9bUg_hu7f25fb382db34e38ec468b9bfb1740e6_32323_480x0_resize_box_3.png 480w, https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/1rgszjARcTFdFADtwPT9bUg_hu7f25fb382db34e38ec468b9bfb1740e6_32323_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;123&#34;
		data-flex-basis=&#34;296px&#34;
	
&gt;
&lt;img src=&#34;https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/16wcOq4ZGJ4e9Oy2J80Nyw.png&#34;
	width=&#34;686&#34;
	height=&#34;351&#34;
	srcset=&#34;https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/16wcOq4ZGJ4e9Oy2J80Nyw_hubd1a54d523e5c7a97cdfb2ddf825199a_16688_480x0_resize_box_3.png 480w, https://heusser.pro/p/automate-setting-work-location-in-teams-outlook-poc-deb7b05de08d/16wcOq4ZGJ4e9Oy2J80Nyw_hubd1a54d523e5c7a97cdfb2ddf825199a_16688_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;195&#34;
		data-flex-basis=&#34;469px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;Even though I won’t be using this in production, I had great fun developing this and I also learned a thing or two about AADInternals, Json Web Tokens and encrypted credentials in PowerShell.&lt;/p&gt;
</description>
        </item>
        <item>
        <title>Use Siri Shortcuts to make Microsoft Graph Requests</title>
        <link>https://heusser.pro/p/use-siri-shortcuts-to-make-microsoft-graph-requests-3804f80adbfa/</link>
        <pubDate>Sat, 16 Jul 2022 11:46:03 +0000</pubDate>
        
        <guid>https://heusser.pro/p/use-siri-shortcuts-to-make-microsoft-graph-requests-3804f80adbfa/</guid>
        <description>&lt;p&gt;Just two days ago I published &lt;a class=&#34;link&#34; href=&#34;https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6&#34; &gt;Set your Teams Status to In a Call when using other Calling &amp;amp; Meeting Apps on iOS&lt;/a&gt;. In this article, I explained how we can leverage Siri Shortcuts on iOS to call an Azure Function which then executes web requests against the Microsoft Graph API.&lt;/p&gt;
&lt;p&gt;Today I wanted to see if I’m able to get it working without the use of an Azure Function as a middleman. Spoiler alert: I totally was.&lt;/p&gt;
&lt;p&gt;You can import the Siri Shortcut from &lt;a class=&#34;link&#34; href=&#34;https://www.icloud.com/shortcuts/0c59afb62e5d401f80341e86e0492ad6&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Of course, you need to have an Azure App Registration with the desired permissions ready to use this. Once you’ve imported the shortcut, just fill in the required information in the text fileds. We need the App Id, the App secret and the name (domain) or Id of the tenant.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/use-siri-shortcuts-to-make-microsoft-graph-requests-3804f80adbfa/1e3EoKpzxjpK6m0Ii7Wsw.png&#34;
	width=&#34;750&#34;
	height=&#34;1334&#34;
	srcset=&#34;https://heusser.pro/p/use-siri-shortcuts-to-make-microsoft-graph-requests-3804f80adbfa/1e3EoKpzxjpK6m0Ii7Wsw_hu15cb2d495087f2f1d55235b328a8221e_150793_480x0_resize_box_3.png 480w, https://heusser.pro/p/use-siri-shortcuts-to-make-microsoft-graph-requests-3804f80adbfa/1e3EoKpzxjpK6m0Ii7Wsw_hu15cb2d495087f2f1d55235b328a8221e_150793_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;56&#34;
		data-flex-basis=&#34;134px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;Let’s take a detailed look of what’s going on inside the Shortcut.&lt;/p&gt;
&lt;p&gt;First, an http POST request is made to request the access token. Client_id and client_secret are passed to the request body as variables from the Text fields you populated at the top of the Shortcut.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/use-siri-shortcuts-to-make-microsoft-graph-requests-3804f80adbfa/1QlYK0AE2DSj3SKPpfSJaug.jpeg&#34;
	width=&#34;750&#34;
	height=&#34;917&#34;
	srcset=&#34;https://heusser.pro/p/use-siri-shortcuts-to-make-microsoft-graph-requests-3804f80adbfa/1QlYK0AE2DSj3SKPpfSJaug_hued510fab658db057612eff5fa2a88521_59509_480x0_resize_q75_box.jpeg 480w, https://heusser.pro/p/use-siri-shortcuts-to-make-microsoft-graph-requests-3804f80adbfa/1QlYK0AE2DSj3SKPpfSJaug_hued510fab658db057612eff5fa2a88521_59509_1024x0_resize_q75_box.jpeg 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;81&#34;
		data-flex-basis=&#34;196px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;The Microsoft authentication endpoint returns a JSON string which is similar to what you get when you use &lt;code&gt;Invoke-WebRequest&lt;/code&gt; instead of &lt;code&gt;Invoke-RestMethod&lt;/code&gt; in PowerShell.&lt;/p&gt;
&lt;p&gt;{&amp;ldquo;token_type&amp;rdquo;:&amp;ldquo;Bearer&amp;rdquo;,&amp;ldquo;expires_in&amp;rdquo;:3599,&amp;ldquo;ext_expires_in&amp;rdquo;:3599,&amp;ldquo;access_token&amp;rdquo;:&amp;ldquo;eyJ0eXAixboxOiJKV1QiLCJub25jZSI6ITUROWEtpblE4THcwNVN1Z1JMOU1aUUpwdXlqedasd1VpQXNjU3ciLseriesCJhbGciOiJSUzI1NiIsIng1dCI6IjJaUXBKM1VwYmpBWVhZR2FYRUpsOGxWMFRPSSIsImtpZCI6IXjJaUXBKM1VBWVhZR2FYRUp&amp;rdquo;}&lt;/p&gt;
&lt;p&gt;This means that we’ll have to get the &lt;code&gt;value&lt;/code&gt; of both the &lt;code&gt;keys&lt;/code&gt; “token_type” and “access_token”.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/use-siri-shortcuts-to-make-microsoft-graph-requests-3804f80adbfa/1VKksWkNAJ7ESWUEjkQWd7Q.jpeg&#34;
	width=&#34;750&#34;
	height=&#34;850&#34;
	srcset=&#34;https://heusser.pro/p/use-siri-shortcuts-to-make-microsoft-graph-requests-3804f80adbfa/1VKksWkNAJ7ESWUEjkQWd7Q_hu295ee41d856beca2d4778d0d41435d72_56266_480x0_resize_q75_box.jpeg 480w, https://heusser.pro/p/use-siri-shortcuts-to-make-microsoft-graph-requests-3804f80adbfa/1VKksWkNAJ7ESWUEjkQWd7Q_hu295ee41d856beca2d4778d0d41435d72_56266_1024x0_resize_q75_box.jpeg 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;88&#34;
		data-flex-basis=&#34;211px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;The access token is now stored in the variables &lt;code&gt;token_type&lt;/code&gt; (Bearer ) and &lt;code&gt;access_token&lt;/code&gt; (Actual token) and available to use in this Shortcut and subsequent web requests. To see if it’s working, we’re just going to make a GET request and return some Azure AD Users.&lt;/p&gt;
&lt;p&gt;Here you can see that we use both variables to include the access token in the &lt;code&gt;Authorization&lt;/code&gt; Header.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/use-siri-shortcuts-to-make-microsoft-graph-requests-3804f80adbfa/1RCYyCinwNHAg14Dd1DKWUw.jpeg&#34;
	width=&#34;750&#34;
	height=&#34;562&#34;
	srcset=&#34;https://heusser.pro/p/use-siri-shortcuts-to-make-microsoft-graph-requests-3804f80adbfa/1RCYyCinwNHAg14Dd1DKWUw_hud8d47da795b0e327addef39f804007f7_34068_480x0_resize_q75_box.jpeg 480w, https://heusser.pro/p/use-siri-shortcuts-to-make-microsoft-graph-requests-3804f80adbfa/1RCYyCinwNHAg14Dd1DKWUw_hud8d47da795b0e327addef39f804007f7_34068_1024x0_resize_q75_box.jpeg 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;133&#34;
		data-flex-basis=&#34;320px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;Because this is an OData query, the values will be stored in the &lt;code&gt;value&lt;/code&gt; key. So we need to get the value of the &lt;code&gt;value&lt;/code&gt; key one more time to see some results.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/use-siri-shortcuts-to-make-microsoft-graph-requests-3804f80adbfa/12rVXLaYUXZyyNAMla6kjGA.png&#34;
	width=&#34;750&#34;
	height=&#34;1334&#34;
	srcset=&#34;https://heusser.pro/p/use-siri-shortcuts-to-make-microsoft-graph-requests-3804f80adbfa/12rVXLaYUXZyyNAMla6kjGA_hu2e5576774935fc798c3461eb71d5e818_280158_480x0_resize_box_3.png 480w, https://heusser.pro/p/use-siri-shortcuts-to-make-microsoft-graph-requests-3804f80adbfa/12rVXLaYUXZyyNAMla6kjGA_hu2e5576774935fc798c3461eb71d5e818_280158_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;56&#34;
		data-flex-basis=&#34;134px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;Of course, this is just an example to prove that the authentication is working without an Azure Function or any PowerShell code. Everything is running on an iOS device. Receiving data from Graph on an iPhone is probably not what people want to use this for, but it was the easiest example.&lt;/p&gt;
&lt;p&gt;Using Shortcuts to make http Post requests is much more interesting. Think about all the possibilities here for a second. We could basically do any Post request we want. And then, we can add Shortcuts to the iPhone Homescreen, ask Siri to run Shortcuts or even launch them from an Apple Watch. Amazing.&lt;/p&gt;
</description>
        </item>
        <item>
        <title>Set your Teams Status to In a Call when using other Calling &amp; Meeting Apps on iOS</title>
        <link>https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/</link>
        <pubDate>Thu, 14 Jul 2022 21:59:48 +0000</pubDate>
        
        <guid>https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/</guid>
        <description>&lt;p&gt;Hello everybody. I try my best to blog about new and unique Microsoft Teams related stuff at least once a month. If you’re new to my stories, feel free to check out my previous articles &lt;a class=&#34;link&#34; href=&#34;https://heusser.pro/p&#34; &gt;here&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Today we’re going to take a look at something very cool. A few months ago, I wrote this little code snippet which lets you change a Teams user’s presence by using PowerShell and the Microsoft Graph API. The API endpoint is documented &lt;a class=&#34;link&#34; href=&#34;https://docs.microsoft.com/en-us/graph/api/presence-setpresence?view=graph-rest-1.0&amp;amp;tabs=http&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;here&lt;/a&gt;. You might be asking yourself: why would we want to do this in the first place? Teams already updates our presence if we’re in a call, a meeting or just busy because of an Outlook appointment, right?&lt;/p&gt;
&lt;h4 id=&#34;use-cases&#34;&gt;Use Cases&lt;/h4&gt;
&lt;p&gt;Setting the presence of a user can be very useful if for example not all your users are on Teams yet. Let’s say that we’ve still got a legacy PBX system with SIP devices registered to it, but we use Teams for internal calls. There’s no way to know that a user is already on the phone unless the user specifically updates his status to Busy or Do not disturb. A user can’t set his own status to “In a call” or “In a meeting” though.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1Z6KHSlNLLNCOK0AK8XeiyQ.png&#34;
	width=&#34;548&#34;
	height=&#34;680&#34;
	srcset=&#34;https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1Z6KHSlNLLNCOK0AK8XeiyQ_huce2d2f03c713521e4f452d4d43e9a1ce_48580_480x0_resize_box_3.png 480w, https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1Z6KHSlNLLNCOK0AK8XeiyQ_huce2d2f03c713521e4f452d4d43e9a1ce_48580_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;80&#34;
		data-flex-basis=&#34;193px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;If we’re using an &lt;a class=&#34;link&#34; href=&#34;https://www.anynode.de/supervision/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;anynode SBC&lt;/a&gt; for example, we could implement a Route Supervision which calls an Azure Function, whenever a user receives or starts a call on a legacy PBX system. The Azure Function would then send an http POST request to the Graph API to change the presence status of the user.&lt;/p&gt;
&lt;p&gt;Since Microsoft has now released the &lt;a class=&#34;link&#34; href=&#34;https://docs.microsoft.com/en-us/microsoftteams/sip-gateway-plan&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;SIP Gateway&lt;/a&gt; the need for such a solution has significantly decreased because the SIP Gateway already handles Teams presence out of the box. If you’re interested in learning more about the SIP Gateway for Teams, please check out this session from Commsverse from my colleague &lt;a class=&#34;link&#34; href=&#34;https://twitter.com/tpickhan&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Thorsten Pickhan&lt;/a&gt;.&lt;/p&gt;
&lt;h4 id=&#34;what-about-other-usecases&#34;&gt;What about other use cases?&lt;/h4&gt;
&lt;p&gt;I know, we all love Teams but sometimes we do need to use other calling and meeting apps such as Skype, Zoom, WhatsApp, or Discord. Don’t you just hate it that Teams doesn’t know when you’re already on a call in another app? Today, we’re going to change that!&lt;/p&gt;
&lt;h4 id=&#34;the-power-ofsiri&#34;&gt;The Power of Siri&lt;/h4&gt;
&lt;p&gt;If you have an iPhone or iPad you probably know about Siri Shortcuts and Automations. If you don’t know them already, I highly recommend checking them out. Shortcuts and automations are like local Power Automate Flows which are created and executed on your iOS device. Today I discovered that you can actually do http POST requests with Shortcuts. How cool is that?&lt;/p&gt;
&lt;p&gt;Granted, coding or building shortcuts is quite a hassle on such a small screen but there’s an easy workaround for that. We’re just using the Shortcut to call an Azure Function and let the Function do all the work for us.&lt;/p&gt;
&lt;h4 id=&#34;creating-an-azure-ad-app-registration&#34;&gt;Creating an Azure AD App Registration&lt;/h4&gt;
&lt;p&gt;First, we need an Azure AD App where we can grant the required permissions to set and clear the Teams presence. There’s an exceptional tutorial &lt;a class=&#34;link&#34; href=&#34;https://adamtheautomator.com/powershell-graph-api/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;here&lt;/a&gt;. (I also used the example code to acquire the token from this website.)&lt;/p&gt;
&lt;p&gt;“Presence.ReadWrite.All” is the permission we need.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1vWX5aB7074iXuLcnpJjGhA.png&#34;
	width=&#34;851&#34;
	height=&#34;537&#34;
	srcset=&#34;https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1vWX5aB7074iXuLcnpJjGhA_hu90c29336af7900a9bcc837fa4413389d_47241_480x0_resize_box_3.png 480w, https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1vWX5aB7074iXuLcnpJjGhA_hu90c29336af7900a9bcc837fa4413389d_47241_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;158&#34;
		data-flex-basis=&#34;380px&#34;
	
&gt;&lt;/p&gt;
&lt;h4 id=&#34;create-an-azurefunction&#34;&gt;Create an Azure Function&lt;/h4&gt;
&lt;p&gt;Next, we create an Azure Function. If you’re not familiar with Azure Functions, please read this &lt;a class=&#34;link&#34; href=&#34;https://heusser.pro/p/microsoft-teams-self-service-auto-attendants-without-premium-connectors-27e6f1281851&#34; &gt;article&lt;/a&gt;. The creating of a Function App and a Function is described under “Create the Refresh Card Function”.&lt;/p&gt;
&lt;p&gt;Copy and paste the following code into your function. Populate the variables on lines 10–14 with your tenant specific information.&lt;/p&gt;
&lt;script src=&#34;https://gist.github.com/mozziemozz/5b08518eff2dd7c579c61cab23e25e95.js&#34;&gt;&lt;/script&gt;

&lt;h4 id=&#34;create-the-sirishortcut&#34;&gt;Create the Siri Shortcut&lt;/h4&gt;
&lt;p&gt;Now, we’ll create a new Siri Shortcut. Choose “Get contents of URL” as your first action. Now go back to your Azure Function and copy its URL.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1VQBnbft1BSu02gpwe7Zl3g.png&#34;
	width=&#34;1840&#34;
	height=&#34;247&#34;
	srcset=&#34;https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1VQBnbft1BSu02gpwe7Zl3g_hu0a9d03c473db92f91ef58447bb04026d_43868_480x0_resize_box_3.png 480w, https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1VQBnbft1BSu02gpwe7Zl3g_hu0a9d03c473db92f91ef58447bb04026d_43868_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;744&#34;
		data-flex-basis=&#34;1787px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;Paste the URL into the Shortcut. I always use Sticky Notes to quickly synchronize text between my Windows PC and my iPhone.&lt;/p&gt;
&lt;p&gt;Next, expand the action by clicking on the circled arrow which points right. This will reveal additional options. Change the Method to POST and add a key and a value (Text) to the Request Body. I used “Name”: “Azure”.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1JPlHNIr6mVHsBIA1HLoOqA.jpeg&#34;
	width=&#34;750&#34;
	height=&#34;1334&#34;
	srcset=&#34;https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1JPlHNIr6mVHsBIA1HLoOqA_hua5b62d99282b5d18b9ce4747d29c0272_81300_480x0_resize_q75_box.jpeg 480w, https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1JPlHNIr6mVHsBIA1HLoOqA_hua5b62d99282b5d18b9ce4747d29c0272_81300_1024x0_resize_q75_box.jpeg 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;56&#34;
		data-flex-basis=&#34;134px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;That’s it for the shortcut. You should now be able to run the shortcut. Every time you do so, your iOS device will call the Azure Function which will request a token and then set the defined user&amp;rsquo;s presence to In a Call.&lt;/p&gt;
&lt;p&gt;By now, I hope you can understand why I didn’t bother to try and also build the authentication flow using only Shortcuts.&lt;/p&gt;
&lt;h4 id=&#34;building-the-siri-automation&#34;&gt;Building the Siri Automation&lt;/h4&gt;
&lt;p&gt;The last piece we need to do is to create an Automation which will trigger the Shortcut. Unfortunately, there aren’t as many triggers as I had wished but using “When an App is opened” does the trick, sort of.&lt;/p&gt;
&lt;p&gt;In Shortcuts, switch from My Shortcuts to Automation on the bottom. Click + to create a new Automation. You want to create a Personal Automation.&lt;/p&gt;
&lt;p&gt;Select “App” as your trigger and then select one or multiple calling Apps.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1Qi4dsjTt9HZZOb1tkTRRVA.png&#34;
	width=&#34;750&#34;
	height=&#34;1334&#34;
	srcset=&#34;https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1Qi4dsjTt9HZZOb1tkTRRVA_hub968f2c7cf86104968b4dbe83e65d0ea_52403_480x0_resize_box_3.png 480w, https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1Qi4dsjTt9HZZOb1tkTRRVA_hub968f2c7cf86104968b4dbe83e65d0ea_52403_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;56&#34;
		data-flex-basis=&#34;134px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;Then, add an action and search for “Run Shortcut”. Click on Shortcut and select the previously created Shortcut from the list.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1c9TA4amw9yA5TGJHnvOueA.png&#34;
	width=&#34;750&#34;
	height=&#34;1334&#34;
	srcset=&#34;https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1c9TA4amw9yA5TGJHnvOueA_huf2ced6342da4c84ab44a20c0be9377c1_125532_480x0_resize_box_3.png 480w, https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1c9TA4amw9yA5TGJHnvOueA_huf2ced6342da4c84ab44a20c0be9377c1_125532_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;56&#34;
		data-flex-basis=&#34;134px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;Click Next and then Done. Leave “Ask Before Running” enabled. This way you’ll be asked if you want to update your Teams presence each time you open one of the selected Apps. If you’re not making a call, you can just ignore or close the notification banner.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1xnsJrcVZZlXYiUnOFGfqfg.png&#34;
	width=&#34;750&#34;
	height=&#34;1334&#34;
	srcset=&#34;https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1xnsJrcVZZlXYiUnOFGfqfg_hu7eae1344531cb80e88c90e1ab05064f7_64626_480x0_resize_box_3.png 480w, https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1xnsJrcVZZlXYiUnOFGfqfg_hu7eae1344531cb80e88c90e1ab05064f7_64626_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;56&#34;
		data-flex-basis=&#34;134px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;Now you’re all set. Every time you open one of your selected Apps (just Skype in my case) the automation will be triggered and ask you, if you want to set your Teams presence to In a call.&lt;/p&gt;
&lt;p&gt;If you like, you can repeat all the steps and create another Function, Shortcut and Automation to clear the presence again, if you’re done with your call on the other App.&lt;/p&gt;
&lt;p&gt;In this case, just replace line 42–51 with this code in the “Clear Presence Function” and choose “When an App is closed” as the Siri Automation trigger.&lt;/p&gt;
&lt;p&gt;$Body = @&amp;quot;&lt;/p&gt;
&lt;p&gt;{&lt;/p&gt;
&lt;p&gt;&amp;ldquo;sessionId&amp;rdquo;: &amp;ldquo;bf3cbc08-e5b0-47bb-a4f0-89e3e3f7adac&amp;rdquo;,&lt;/p&gt;
&lt;p&gt;}&lt;/p&gt;
&lt;p&gt;&amp;ldquo;@&lt;/p&gt;
&lt;p&gt;Invoke-RestMethod -Method Post -Uri &amp;ldquo;&lt;a class=&#34;link&#34; href=&#34;https://graph.microsoft.com/v1.0/users/$UserId/presence/clearPresence%22&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;https://graph.microsoft.com/v1.0/users/$UserId/presence/clearPresence&#34;&lt;/a&gt; -Headers $Header -Body $Body -ContentType &amp;ldquo;application/json&amp;rdquo;&lt;/p&gt;
&lt;h4 id=&#34;demo&#34;&gt;Demo&lt;/h4&gt;
&lt;p&gt;Here you can see the Automation in Action. At first, the user’s Teams presence is “Available”. When Skype is opened, the Automation is triggered and confirmed by the user. When Teams is opened again, we can see that the status has changed from “Available” to “In a call”. Because Skype was closed/minimized when Teams was opened, the second Automation, which clears the Teams presence again is triggered and allowed to run. This resets the Teams presence to its original state. Teams is closed and opened again to force a refresh of the presence.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1WA9VV3zTsQF3ov8DnQGfog.gif&#34;
	width=&#34;600&#34;
	height=&#34;1067&#34;
	srcset=&#34;https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1WA9VV3zTsQF3ov8DnQGfog_hu01675812143c9f23e6321f2114a19f84_9202471_480x0_resize_box_1.gif 480w, https://heusser.pro/p/set-your-teams-status-to-in-a-call-when-using-other-calling-meeting-apps-on-ios-3409d68aceb6/1WA9VV3zTsQF3ov8DnQGfog_hu01675812143c9f23e6321f2114a19f84_9202471_1024x0_resize_box_1.gif 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;56&#34;
		data-flex-basis=&#34;134px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;What’s cool is that this even works when you’re getting an incoming call in an App like Skype, WhatsApp etc. When you accept the call, the App is opened and thus triggers the automation. I can’t record that on video because iOS screen recording is stopped if an incoming call gets accepted and the notification does not show up, when screen sharing through AirPlay is active.&lt;/p&gt;
&lt;h4 id=&#34;bonus&#34;&gt;Bonus&lt;/h4&gt;
&lt;p&gt;Because we now have Shortcuts to set our Teams presence to “In a call” or clear the presence again, we can also use Siri to execute these Shortcuts. All we have to say is Hey Siri, followed by the name of the Shortcut. E.g. “Hey Siri, Set Teams Presence” or “Hey Siri, Clear Teams Presence”.&lt;/p&gt;
</description>
        </item>
        <item>
        <title>Sync Local Outlook Contacts to a Teams Desk Phone</title>
        <link>https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/</link>
        <pubDate>Thu, 07 Apr 2022 21:44:54 +0000</pubDate>
        
        <guid>https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/</guid>
        <description>&lt;p&gt;This blog post is now obsolete. Microsoft has &lt;a class=&#34;link&#34; href=&#34;https://techcommunity.microsoft.com/t5/microsoft-teams-blog/what-s-new-in-microsoft-teams-april-2022/ba-p/3297881#devices&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;now added Outlook Contacts&lt;/a&gt; to Teams Desk Phones.&lt;/p&gt;
&lt;p&gt;Outlook Contacts finally do show up on Teams Desk Phones!&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1pP3r1oOQebJ2upO4HvWQ.png&#34;
	width=&#34;1894&#34;
	height=&#34;1020&#34;
	srcset=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1pP3r1oOQebJ2upO4HvWQ_hu5469e67c8aed19f272af2f856331d7c7_200515_480x0_resize_box_3.png 480w, https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1pP3r1oOQebJ2upO4HvWQ_hu5469e67c8aed19f272af2f856331d7c7_200515_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;185&#34;
		data-flex-basis=&#34;445px&#34;
	
&gt;
&lt;img src=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1QmgTr14RlgASVngE8T5cw.jpeg&#34;
	width=&#34;800&#34;
	height=&#34;480&#34;
	srcset=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1QmgTr14RlgASVngE8T5cw_hu2d61497381ba7c1222d1f1d3c266a45f_16149_480x0_resize_q75_box.jpeg 480w, https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1QmgTr14RlgASVngE8T5cw_hu2d61497381ba7c1222d1f1d3c266a45f_16149_1024x0_resize_q75_box.jpeg 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;166&#34;
		data-flex-basis=&#34;400px&#34;
	
&gt;&lt;/p&gt;
&lt;h3 id=&#34;original-story&#34;&gt;Original Story&lt;/h3&gt;
&lt;p&gt;Since the second generation of &lt;a class=&#34;link&#34; href=&#34;https://www.microsoft.com/en-us/microsoft-teams/across-devices/devices/category/desk-phones-teams-displays/34&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Teams certified desk phones&lt;/a&gt; have been released, many things have been improved. They’re now much faster and also got a lot of software updates. They still have one major flaw though. They’re only able to show your “native Teams contacts” instead of all contacts which are synchronized from Outlook to Teams.&lt;/p&gt;
&lt;p&gt;&lt;a class=&#34;link&#34; href=&#34;https://support.microsoft.com/en-us/office/what-s-new-in-microsoft-teams-devices-eabf4d81-acdd-4b23-afa1-9ee47bb7c5e2#ID0EBD=Desk_phones&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;This&lt;/a&gt; article states the following for a previous software update:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;Contacts whose numbers are saved in Outlook will be available in the &lt;strong&gt;People&lt;/strong&gt; section of the Teams phones with read-only access. You’ll still need to manually dial the number&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;No matter what I tried, I was not able to get any contacts which are synchronized by Outlook to Teams to show up on my desk phone.&lt;/p&gt;
&lt;p&gt;Let’s take a look at our contacts in the Teams client. Contacts which have been added using the Teams clients can be edited. Contacts which have been synchronized by outlook, can’t. You can see that the three dots are greyed out on the first entry while they’re not on the second entry.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1w2ezI7rEfC4GDVDAttluBA.png&#34;
	width=&#34;1734&#34;
	height=&#34;400&#34;
	srcset=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1w2ezI7rEfC4GDVDAttluBA_hu21557a0f20249dd89e2cb4eb7a0002a5_37567_480x0_resize_box_3.png 480w, https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1w2ezI7rEfC4GDVDAttluBA_hu21557a0f20249dd89e2cb4eb7a0002a5_37567_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;433&#34;
		data-flex-basis=&#34;1040px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;On my desk phone, I can’t see the first contact (synchronized one) anywhere.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1Je3mptWlwbVu1YNpExazNQ.png&#34;
	width=&#34;1197&#34;
	height=&#34;718&#34;
	srcset=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1Je3mptWlwbVu1YNpExazNQ_hu1ed59539412e4017e1a48432e7534f48_200348_480x0_resize_box_3.png 480w, https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1Je3mptWlwbVu1YNpExazNQ_hu1ed59539412e4017e1a48432e7534f48_200348_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;166&#34;
		data-flex-basis=&#34;400px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;I’m still not sure what that quoted sentence above means but I have an idea. Since they specifically say that numbers must be dialed manually, I believe that what they actually mean is that if you have synchronized contacts from outlook, their names (instead of their number) will be displayed if a saved contact calls your desk phone.&lt;/p&gt;
&lt;p&gt;A quick test confirmed this hunch. I created a contact with my work and my mobile number. I purposely set my work number as mobile and my mobile number as home phone. When synchronizing contacts from Outlook to Teams, Teams will always use the mobile number for the number shown in its contact list. If you’d like to learn more about this, Mark Vale has a great article covering this over at the &lt;a class=&#34;link&#34; href=&#34;https://www.commsverse.com/microsoft-teams-contacts-list/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Commsverse Blog&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;Here you can see the Outlook contact.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1wNLpmLyJGuePpk2TcX0QA.png&#34;
	width=&#34;1392&#34;
	height=&#34;763&#34;
	srcset=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1wNLpmLyJGuePpk2TcX0QA_hufbc8ae841f2955802a257b4289e77668_55168_480x0_resize_box_3.png 480w, https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1wNLpmLyJGuePpk2TcX0QA_hufbc8ae841f2955802a257b4289e77668_55168_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;182&#34;
		data-flex-basis=&#34;437px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;The number which is declared as Mobile will be showed in the Teams client.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1wyoq4EijSDIHOquVsqyXNg.png&#34;
	width=&#34;1788&#34;
	height=&#34;110&#34;
	srcset=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1wyoq4EijSDIHOquVsqyXNg_hubeb2733a6a28bdf8efb092f8273baec5_8583_480x0_resize_box_3.png 480w, https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1wyoq4EijSDIHOquVsqyXNg_hubeb2733a6a28bdf8efb092f8273baec5_8583_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;1625&#34;
		data-flex-basis=&#34;3901px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;If we right-click the call icon, the other numbers from the Outlook contact will also show up.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1ErWpGEhYOAvefoYxf1f0vQ.png&#34;
	width=&#34;1834&#34;
	height=&#34;486&#34;
	srcset=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1ErWpGEhYOAvefoYxf1f0vQ_hu87d95fd20dd2c5135c80ff321ea5ab08_37629_480x0_resize_box_3.png 480w, https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1ErWpGEhYOAvefoYxf1f0vQ_hu87d95fd20dd2c5135c80ff321ea5ab08_37629_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;377&#34;
		data-flex-basis=&#34;905px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;So, when I used my mobile to call my desk phone, the name of the Outlook contact indeed showed up on the desk phone, even though that contact is not visible anywhere on the desk phone. This also means that despite Teams is only showing, or at least preferring the mobile number of an Outlook contact in the contact list, it will still use numbers which are hidden behind a right-click for display name lookups.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/10ydaPFAkcIRQ4nfxCFpJQ.jpeg&#34;
	width=&#34;800&#34;
	height=&#34;480&#34;
	srcset=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/10ydaPFAkcIRQ4nfxCFpJQ_hu87b50c45143782f8691c31f4ca9124bd_12373_480x0_resize_q75_box.jpeg 480w, https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/10ydaPFAkcIRQ4nfxCFpJQ_hu87b50c45143782f8691c31f4ca9124bd_12373_1024x0_resize_q75_box.jpeg 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;166&#34;
		data-flex-basis=&#34;400px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;That’s why I assume that that’s what Microsoft actually meant by that vague statement.&lt;/p&gt;
&lt;h4 id=&#34;synchronize-outlook-contacts-toteams&#34;&gt;Synchronize Outlook Contacts to Teams&lt;/h4&gt;
&lt;p&gt;That’s nice and all but it still doesn’t let us select and call our contacts directly from our Teams desk phones. Depending on the number of contacts we need on our phone, manually adding them is not an option either.&lt;/p&gt;
&lt;p&gt;If Alexander Holmeset is able to &lt;a class=&#34;link&#34; href=&#34;https://alexholmeset.blog/2021/12/13/microsoft-teams-speed-dial-contacts-provisioning/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;add contacts to a user&amp;rsquo;s speed dial list&lt;/a&gt; by using PowerShell, why not use his method to read all our local contacts from Outlook and add them as native Teams contacts?&lt;/p&gt;
&lt;p&gt;With a little help from &lt;a class=&#34;link&#34; href=&#34;http://squareclouds.net/exporting-outlook-contacts-with-powershell&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;this article,&lt;/a&gt; I was able to get all the users local Outlook contacts and then add them to Teams programmatically.&lt;/p&gt;
&lt;p&gt;Since our contacts might have multiple number types like Business, Mobile, Home etc. stored in one object, but Teams contacts support only one number, the script will create one contact for each number type. The number type will then be added as a suffix enclosed in square brackets.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1KJYS5xwbIuZf7dXtl9A.png&#34;
	width=&#34;890&#34;
	height=&#34;554&#34;
	srcset=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1KJYS5xwbIuZf7dXtl9A_hud7a6bcd67871ed8d5f4c475cf7b31e9f_25740_480x0_resize_box_3.png 480w, https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1KJYS5xwbIuZf7dXtl9A_hud7a6bcd67871ed8d5f4c475cf7b31e9f_25740_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;160&#34;
		data-flex-basis=&#34;385px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;To reduce dependencies, I’m not using the AAD Internals modules to get the user token which is needed to add the contacts. I slightly modified the example from &lt;a class=&#34;link&#34; href=&#34;https://heusser.pro/p/opt-in-or-opt-out-teams-call-queue-agents-remotely-59fe6147f50d&#34; &gt;this post&lt;/a&gt;. Instead of requesting the token for the Call Queue Opt In / Opt Out service, we’re just requesting a token for normal access to the Teams Web Client. For this to work, you or another user needs to enter his credentials once the login prompt appears. You also need to specify your Teams region by Read-Host. In my case that’s “emea”.&lt;/p&gt;
&lt;h4 id=&#34;the-script&#34;&gt;The Script&lt;/h4&gt;
&lt;p&gt;The script will only add a contact to Teams, if the phone number or the name is not already saved to another Teams contact. It will only look for contacts stored in a user&amp;rsquo;s Contacts folder inside the personal mailbox.&lt;/p&gt;
&lt;script src=&#34;https://gist.github.com/mozziemozz/c3057fba9da212578601e0b12b0a95bf.js&#34;&gt;&lt;/script&gt;

&lt;h4 id=&#34;the-result&#34;&gt;The Result&lt;/h4&gt;
&lt;p&gt;Once the script has done its work. We can see that we now have editable contacts in Teams for all our local Outlook contacts. The downside is that there now are multiple entries because of the different sources.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1xaTcZzkZ4uGKdUWHiOujjA.png&#34;
	width=&#34;1842&#34;
	height=&#34;741&#34;
	srcset=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1xaTcZzkZ4uGKdUWHiOujjA_hu8a6023a34a2113d36c9277c80ef5f20e_77583_480x0_resize_box_3.png 480w, https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1xaTcZzkZ4uGKdUWHiOujjA_hu8a6023a34a2113d36c9277c80ef5f20e_77583_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;248&#34;
		data-flex-basis=&#34;596px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;The upside is that a Teams contact will always take precedent over a synchronized contact for incoming call notifications. This means that you’ll always see the number type a person is calling you from.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1zmrbJ9B7lyVzowWGS47yQ.jpeg&#34;
	width=&#34;800&#34;
	height=&#34;480&#34;
	srcset=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1zmrbJ9B7lyVzowWGS47yQ_hu4fa49c5b93c0d190afdd1584827f1432_14432_480x0_resize_q75_box.jpeg 480w, https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1zmrbJ9B7lyVzowWGS47yQ_hu4fa49c5b93c0d190afdd1584827f1432_14432_1024x0_resize_q75_box.jpeg 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;166&#34;
		data-flex-basis=&#34;400px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;And of course, the biggest upside is that you’ll finally have the comfort to use your desk phone to quickly call a contact from the tips of your fingers without manually entering the number first.&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1wEwlj71A3dFKMlZEIGnEpA.png&#34;
	width=&#34;1194&#34;
	height=&#34;719&#34;
	srcset=&#34;https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1wEwlj71A3dFKMlZEIGnEpA_hu779c6b26aa43939ca2fac6359c8d65aa_218191_480x0_resize_box_3.png 480w, https://heusser.pro/p/sync-local-outlook-contacts-to-a-teams-desk-phone-7f5dc2717d3/1wEwlj71A3dFKMlZEIGnEpA_hu779c6b26aa43939ca2fac6359c8d65aa_218191_1024x0_resize_box_3.png 1024w&#34;
	loading=&#34;lazy&#34;
	
	
		class=&#34;gallery-image&#34; 
		data-flex-grow=&#34;166&#34;
		data-flex-basis=&#34;398px&#34;
	
&gt;&lt;/p&gt;
&lt;p&gt;I hope that this script helps you improve the experience for your end users of Teams certified desk phones until Microsoft provides a better contact management solution.&lt;/p&gt;
</description>
        </item>
        <item>
        <title>Opt In or Opt Out Teams Call Queue Agents Remotely</title>
        <link>https://heusser.pro/p/opt-in-or-opt-out-teams-call-queue-agents-remotely-59fe6147f50d/</link>
        <pubDate>Thu, 24 Mar 2022 21:10:13 +0000</pubDate>
        
        <guid>https://heusser.pro/p/opt-in-or-opt-out-teams-call-queue-agents-remotely-59fe6147f50d/</guid>
        <description>&lt;p&gt;This is an interesting one. First of all, let’s give credits where they’re due. This blog post is inspired by &lt;a class=&#34;link&#34; href=&#34;https://alexholmeset.blog/2021/12/13/microsoft-teams-speed-dial-contacts-provisioning/&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;this post&lt;/a&gt; by the great &lt;a class=&#34;link&#34; href=&#34;https://twitter.com/AlexHolmeset&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Alexander Holmeset.&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;The PowerShell code to generate the TOTP is forked from this &lt;a class=&#34;link&#34; href=&#34;https://github.com/ecspresso/TOTPPowerShellModule&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;repo&lt;/a&gt;. And the code from this repo is from this &lt;a class=&#34;link&#34; href=&#34;https://gist.github.com/jonfriesen/234c7471c3e3199f97d5&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;gist&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;The code to create the interactive sign in window and to get the token is based of &lt;a class=&#34;link&#34; href=&#34;https://docs.microsoft.com/en-us/answers/questions/491498/invoke-webrequest-to-get-access-token.html&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;this example&lt;/a&gt;.&lt;/p&gt;
&lt;h4 id=&#34;disclaimer&#34;&gt;Disclaimer&lt;/h4&gt;
&lt;p&gt;Before we get into it, I should probably add a disclaimer that this is a proof of concept, at best. You should not use it in production as it uses some bad security practices (like sharing a user&amp;rsquo;s password). For real. Don’t say I didn’t warn you.&lt;/p&gt;
&lt;h4 id=&#34;whats-this-aboutagain&#34;&gt;What’s this about again?&lt;/h4&gt;
&lt;p&gt;However, being able to remotely change the opt in status of call queue agents seems to be quite a big ask from several Microsoft Teams admins and customers, so I decided to publish this piece anyway.&lt;/p&gt;
&lt;h4 id=&#34;changing-opt-in-status-as-auser&#34;&gt;Changing opt in status as a user&lt;/h4&gt;
&lt;p&gt;Can the opt in status of a user be changed as an admin? The answer is both yes and no. You can’t do it in any delegated way if that’s what you’re asking. You will need the user’s credentials.&lt;/p&gt;
&lt;p&gt;If you’re a Teams User which is also a call queue agent, there are numerous ways to change your own opt in status for call queues. That is, if your admin allows opting out of queues of course. Let’s go through them.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;From Teams Desktop Client Settings&lt;/li&gt;
&lt;li&gt;From a Teams Voice Enabled Channel&lt;/li&gt;
&lt;li&gt;From Teams Web Client Settings&lt;/li&gt;
&lt;li&gt;From Teams Certified Desk Phones&lt;/li&gt;
&lt;li&gt;From Teams Mobile Apps (Android / iOS)&lt;/li&gt;
&lt;li&gt;From the good old &lt;a class=&#34;link&#34; href=&#34;https://aka.ms/cqsettings&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;https://aka.ms/cqsettings&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h4 id=&#34;im-an-admin-why-cant-i-change-the-damn-opt-instatus&#34;&gt;I’m an Admin, why can’t I change the damn opt in status?&lt;/h4&gt;
&lt;p&gt;From a Teams PowerShell session, we can only view the opt in status of a queue’s agents but not change it.&lt;/p&gt;
&lt;p&gt;(Get-CsCallQueue -Identity xxxxxxxx-f74b-46bb-9743-xxxxxxxxxxxx).Agents&lt;/p&gt;
&lt;p&gt;This will spit out something like this.&lt;/p&gt;
&lt;p&gt;ObjectId                             OptIn&lt;br&gt;
-&amp;mdash;&amp;mdash;-                             &amp;mdash;&amp;ndash;&lt;br&gt;
xxxxxxxx-4d28-4246-9c08-xxxxxxxxxxxx  True&lt;br&gt;
xxxxxxxx-8bae-419d-a4eb-xxxxxxxxxxxx  True&lt;br&gt;
xxxxxxxx-49db-40ee-9d05-xxxxxxxxxxxx False&lt;/p&gt;
&lt;p&gt;Every attempt to change the returned PowerShell object failed. Miserably.&lt;/p&gt;
&lt;h3 id=&#34;how-can-we-at-least-do-it-as-the-user-but-remotely&#34;&gt;How can we at least do it as the user, but remotely?&lt;/h3&gt;
&lt;p&gt;Similar to Alex’s approach of creating Teams Contacts from CLI we also have to acquire a user token to be able to change the opt in status of a user by CLI.&lt;/p&gt;
&lt;p&gt;In his scenario, he’s mainly thinking about new users or even accounts which are used to sign into common area phones which might not be MFA enabled yet. In our case this might look different because we want to be able to alter the opt in state of already working staff.&lt;/p&gt;
&lt;p&gt;At first, I also tried to use the AAD Internals PowerShell Module to receive a user token. In this case, however, it turned out to be much more complicated. When a user opens the Calls settings page in Teams, another token is requested from a different issuing service than the one which is used to access all the other features in Teams.&lt;/p&gt;
&lt;p&gt;After a long night of googling and binging (yes, I was this desperate) I finally was able to get a working token by modifying the example from the Docs Q&amp;amp;A which is linked in the intro of this article.&lt;/p&gt;
&lt;h4 id=&#34;prerequisites&#34;&gt;Prerequisites&lt;/h4&gt;
&lt;p&gt;&lt;strong&gt;Let’s get one thing straight. This approach ONLY works if you know the password of the user and / or the user agrees to share their password or even an MFA secret with you.&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;I’m thinking of the following scenario: we want to be able to automatically and remotely opt in and opt out agents of call queues based on various criteria such as working schedules etc.&lt;/p&gt;
&lt;p&gt;To have at least some kind of security, my script is encrypting the password and the MFA secret before it’s saved to the disk. Once they’re encrypted, they can only be decrypted by the same user account and the same Windows system which was used to encrypt them.&lt;/p&gt;
&lt;p&gt;Why do we need to save the password to disk, when it’s an interactive login process anyway? Well, if you want to automate it by any means, we can use SendKeys to emulate a user&amp;rsquo;s keystrokes. To be completely honest, I only went so far because I wanted to see for myself if I can get it working…&lt;/p&gt;
&lt;h4 id=&#34;how-the-scriptworks&#34;&gt;How the script works&lt;/h4&gt;
&lt;p&gt;The script needs a few parameters to work. We need to provide a user principal name, a user object Id and a call queue Id.&lt;/p&gt;
&lt;p&gt;It will then check the current directory for two or three files depending on whether the -MFA switch is used.&lt;/p&gt;
&lt;p&gt;You will be prompted to enter the password and the MFA secret if these files do not already exist. The token will be saved to a file once you’ve successfully logged in and acquired one. If the token is expired (happens every few hours or so), you will be prompted for credentials again and the token inside the file will be replaced with the new one. Since we also saved the password to disk, you do not need to enter the password again. The script will decrypt and enter the password by emulating automated keystrokes automatically.&lt;/p&gt;
&lt;h4 id=&#34;script-modes&#34;&gt;Script modes&lt;/h4&gt;
&lt;p&gt;The script features a -QueryStatusOnly switch, which will only check if the user is opted in or out of a queue. This will not change anything.&lt;/p&gt;
&lt;p&gt;For the sake of simplicity, I’ve already stored the values of $UserId, $CallQueueId and $UserName as default values for the parameters. Of course, you can pass your own values if you call the script yourself.&lt;/p&gt;
&lt;p&gt;In this video, you can see how the username and password are automatically entered, which will ultimately get us the token we need to call the API and query the user’s opt in status.&lt;/p&gt;
&lt;p&gt;If we run the same thing again, we will already have a valid token.&lt;/p&gt;
&lt;p&gt;Now let’s take a look at an MFA enabled user. For this, we use the optional -MFA switch. Besides the password, this will also prompt us for the MFA secret. The script then pulls down the PowerShell Script from GitHub and uses it’s code to do some magic and generate the TOTP from the secret.&lt;/p&gt;
&lt;h4 id=&#34;okbut-how-do-we-opt-a-userout&#34;&gt;Ok — But how do we opt a user out!?&lt;/h4&gt;
&lt;p&gt;Since we can already see the opt in status of members either in Voice Enabled Channels or via PowerShell this is nothing new. Let’s opt a user out already!&lt;/p&gt;
&lt;h4 id=&#34;script&#34;&gt;Script&lt;/h4&gt;
&lt;p&gt;Here’s the script. Please notice that sometimes, activating the AAD Login Window does not always work, so you might have to cancel and run it again. For me, it usually worked the second time I ran the script.&lt;/p&gt;
&lt;script src=&#34;https://gist.github.com/mozziemozz/ce70f39f720bf17632f60a3d6b1be110.js&#34;&gt;&lt;/script&gt;

&lt;p&gt;Here’s an example of running the script with parameters.&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-powershell&#34; data-lang=&#34;powershell&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;&lt;span class=&#34;p&#34;&gt;.\&lt;/span&gt;&lt;span class=&#34;n&#34;&gt;CallQueueOptInOptOutGist&lt;/span&gt;&lt;span class=&#34;p&#34;&gt;.&lt;/span&gt;&lt;span class=&#34;py&#34;&gt;ps1&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-UserId&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;xxxxxxxx-8bae-419d-a4eb-xxxxxxxxxxxx&amp;#34;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-UserName&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;user@domain.com&amp;#34;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-CallQueueId&lt;/span&gt; &lt;span class=&#34;s2&#34;&gt;&amp;#34;xxxxxxxx-f74b-46bb-9743-xxxxxxxxxxxx&amp;#34;&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;-Action&lt;/span&gt; &lt;span class=&#34;n&#34;&gt;OptOut&lt;/span&gt;
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;h4 id=&#34;conclusion&#34;&gt;Conclusion&lt;/h4&gt;
&lt;p&gt;Even though this method uses some real dirty tricks it still get’s the job done. Well, kind of, at least. I really hope that Microsoft will add the functionality to allow Queue managers to remotely opt in or opt out their agents in a more practical way. It’s a real pity that not even the new &lt;a class=&#34;link&#34; href=&#34;https://docs.microsoft.com/en-us/powershell/module/teams/set-csusercallingsettings?view=teams-ps&#34;  target=&#34;_blank&#34; rel=&#34;noopener&#34;
    &gt;Set-CsUserCallingSettings&lt;/a&gt; or the Boss/Admin feature can do this!&lt;/p&gt;
</description>
        </item>
        
    </channel>
</rss>
